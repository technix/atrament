!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Atrament=e():t.Atrament=e()}("undefined"!=typeof self?self:this,function(){return function(n){var i={};function a(t){if(i[t])return i[t].exports;var e=i[t]={i:t,l:!1,exports:{}};return n[t].call(e.exports,e,e.exports,a),e.l=!0,e.exports}return a.m=n,a.c=i,a.d=function(t,e,n){a.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:n})},a.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},a.t=function(e,t){if(1&t&&(e=a(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var n=Object.create(null);if(a.r(n),Object.defineProperty(n,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var i in e)a.d(n,i,function(t){return e[t]}.bind(null,i));return n},a.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return a.d(e,"a",e),e},a.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},a.p="/",a(a.s=1)}([function(t,e,n){var a,r,o,s;function j(t,e){return!e||"object"!==M(e)&&"function"!=typeof e?function(t){if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(t):e}function D(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&l(t,e)}function B(t){var i="function"==typeof Map?new Map:void 0;return(B=function(t){if(null===t||(e=t,-1===Function.toString.call(e).indexOf("[native code]")))return t;var e;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==i){if(i.has(t))return i.get(t);i.set(t,n)}function n(){return u(t,arguments,G(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),l(n,t)})(t)}function u(t,e,n){return(u=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var a=new(Function.bind.apply(t,i));return n&&l(a,n.prototype),a}).apply(null,arguments)}function l(t,e){return(l=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function G(t){return(G=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function W(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function h(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function J(t,e,n){return e&&h(t.prototype,e),n&&h(t,n),t}function M(t){return(M="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}s=function(t){"use strict";var O=function(){function a(){W(this,a),this._isRelative,this._components=[],this._componentsString=null,"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof n&&arguments[1]instanceof a?(this._components.push(arguments[0]),this._components=this._components.concat(arguments[1]._components)):arguments[0]instanceof Array&&(this._components=this._components.concat(arguments[0]),this._isRelative=!!arguments[1])}return J(a,[{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(t){for(var e=new a,n=0,i=0;i<t._components.length&&t._components[i].isParent;++i)n++;for(i=0;i<this._components.length-n;++i)e._components.push(this._components[i]);for(i=n;i<t._components.length;++i)e._components.push(t._components[i]);return e}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(t){var e=new a;return e._components.push.apply(e._components,this._components),e._components.push(t),e}},{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return 0<this._components.length?this._components[0]:null}},{key:"tail",get:function(){return 2<=this._components.length?new a(this._components.slice(1,this._components.length)):a.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return 0<=t?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this.components.length;t<e;t++)if(!this.components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(t){var e=this;(this._components.length=0,this._componentsString=t,null!=this._componentsString&&""!=this._componentsString)&&("."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1)),this._componentsString.split(".").forEach(function(t){/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?e._components.push(new n(parseInt(t))):e._components.push(new n(t))}))}}],[{key:"self",get:function(){var t=new a;return t._isRelative=!0,t}}]),a}(),n=function(){function e(t){W(this,e),this._name="string"==typeof t?(this._index=-1,t):(this._index=parseInt(t),null)}return J(e,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}},{key:"index",get:function(){return this._index}},{key:"name",get:function(){return this._name}},{key:"isIndex",get:function(){return 0<=this.index}},{key:"isParent",get:function(){return this.name==O.parentId}}],[{key:"ToParent",value:function(){return new e(O.parentId)}}]),e}();O.parentId="^",O.Component=n;var a=function(){function t(){W(this,t),this.parent=null,this._path=null}return J(t,[{key:"ResolvePath",value:function(t){if(t.isRelative){var e=this;return e instanceof Container==!1&&(null==this.parent&&console.warn("Can't resolve relative path because we don't have a parent"),"Container"!==(e=this.parent).constructor.name&&console.warn("Expected parent to be a container"),t=t.tail),e.ContentAtPath(t)}return this.rootContentContainer.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.componentCount,e.componentCount),i=-1,a=0;a<n;++a){var r=e.GetComponent(a),o=t.GetComponent(a);if(!r.Equals(o))break;i=a}if(-1==i)return t;for(var s=e.componentCount-1-i,u=[],l=0;l<s;++l)u.push(O.Component.ToParent());for(var h=i+1;h<t.componentCount;++h)u.push(t.GetComponent(h));return new O(u,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString);return n.length<e.length?n:e}},{key:"Copy",value:function(){throw"Not Implemented"}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new O;else{for(var t=[],e=this,n=e.parent;n instanceof Container;){var i=e;i.name&&i.hasValidName?t.unshift(new O.Component(i.name)):t.unshift(new O.Component(n.content.indexOf(e))),n=(e=n).parent}this._path=new O(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return t}}]),t}(),nt=function(){function e(t){W(this,e),t=void 0!==t?t.toString():"",this._string=t}return J(e,[{key:"Append",value:function(t){this._string+=t}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this._string+="\n"}},{key:"AppendFormat",value:function(t){var n=Array.prototype.slice.call(arguments,1);this._string+=t.replace(/{(\d+)}/g,function(t,e){return void 0!==n[e]?n[e]:t})}},{key:"toString",value:function(){return this._string}},{key:"Length",get:function(){return this._string.length}}]),e}(),P=function(){function i(t,e){if(W(this,i),void 0!==e)this.originName=t,this.itemName=e;else{var n=t.toString().split(".");this.originName=n[0],this.itemName=n[1]}}return J(i,[{key:"isNull",value:function(){return null==this.originName&&null==this.itemName}},{key:"toString",value:function(){return this.fullname}},{key:"Equals",value:function(t){if(t instanceof i){var e=t;return e.itemName==this.itemName&&e.originName==this.originName}return!1}},{key:"toString",value:function(){var t="0",e=this.itemName?this.itemName.toString():"null";return null!=this.originName&&(t=this.originName.toString()),t+"."+e}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"Null",value:function(){return new i(null,null)}}]),i}(),x=function(){function o(t,e){var n=this;if(W(this,o),this._keys={},this._values={},this.origins=null,this._originNames=null,t)if(t instanceof o){var i=t;i.forEach(function(t){n.Add(t.Key,t.Value)}),this._originNames=i._originNames}else if("string"==typeof t){this.SetInitialOriginName(t);var a=null;if(!(a=e.listDefinitions.TryGetListDefinition(t,a)))throw new Error("InkList origin could not be found in story when constructing new list: "+singleOriginListName);this.origins=[a]}else if(t.hasOwnProperty("Key")&&t.hasOwnProperty("Value")){var r=t;this.Add(r.Key,r.Value)}}return J(o,[{key:"forEach",value:function(t){for(var e in this._values)t({Key:this._keys[e],Value:this._values[e]})}},{key:"AddItem",value:function(t){var n=this;if(t instanceof P){if(null==(a=t).originName)return void this.AddItem(a.itemName);throw this.origins.forEach(function(t){if(t.name==a.originName){var e;if(void 0!==(e=t.TryGetValueForItem(a,e)))return void n.Add(a,e);throw"Could not add the item "+a+" to this list because it doesn't exist in the original list definition in ink."}}),"Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found."}var e=t,i=null;if(this.origins.forEach(function(t){if(t.ContainsItemWithName(e)){if(null!=i)throw"Could not add the item "+e+" to this list because it could come from either "+t.name+" or "+i.name;i=t}}),null==i)throw"Could not add the item "+e+" to this list because it isn't known to any list definitions previously associated with this list.";var a=new P(i.name,e),r=i.ValueForItem(a);this.Add(a,r)}},{key:"ContainsItemNamed",value:function(e){var n=!1;return this.forEach(function(t){t.Key.itemName==e&&(n=!0)}),n}},{key:"ContainsKey",value:function(t){return t in this._values}},{key:"Add",value:function(t,e){this._keys[t]=t,this._values[t]=e}},{key:"Remove",value:function(t){delete this._values[t],delete this._keys[t]}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"Union",value:function(t){var e=new o(this);return t.forEach(function(t){e.Add(t.Key,t.Value)}),e}},{key:"Intersect",value:function(e){var n=new o;return this.forEach(function(t){e.ContainsKey(t.Key)&&n.Add(t.Key,t.Value)}),n}},{key:"Without",value:function(t){var e=new o(this);return t.forEach(function(t){e.Remove(t.Key)}),e}},{key:"Contains",value:function(t){var e=this,n=!0;return t.forEach(function(t){e.ContainsKey(t.Key)||(n=!1)}),n}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return 0<this.Count?new o(this.maxItem):new o}},{key:"MinAsList",value:function(){return 0<this.Count?new o(this.minItem):new o}},{key:"Equals",value:function(t){var e=t;if(e instanceof o==!1)return!1;if(e.Count!=this.Count)return!1;var n=!0;return this.forEach(function(t){e.ContainsKey(t.Key)||(n=!1)}),n}},{key:"toString",value:function(){var e=[];this.forEach(function(t){e.push(t)}),e=e.sort(function(t,e){return t.Value===e.Value?0:t.Value>e.Value?1:-1});for(var t=new nt,n=0;n<e.length;n++){0<n&&t.Append(", ");var i=e[n].Key;t.Append(i.itemName)}return t.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return Object.keys(this._values).length}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var e=this.maxItem.Key.originName,n=null;return this.origins.every(function(t){return t.name!=e||(n=t,!1)}),n}},{key:"originNames",get:function(){var e=this;return 0<this.Count&&(null==this._originNames&&0<this.Count?this._originNames=[]:this._originNames.length=0,this.forEach(function(t){e._originNames.push(t.Key.originName)})),this._originNames}},{key:"maxItem",get:function(){var e={Key:null,Value:null};return this.forEach(function(t){(null===e.Key||t.Value>e.Value)&&(e=t)}),e}},{key:"minItem",get:function(){var e={Key:null,Value:null};return this.forEach(function(t){(null===e.Key||t.Value<e.Value)&&(e=t)}),e}},{key:"inverse",get:function(){var e=this,n=new o;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.ContainsKey(t.Key)||n.Add(t.Key,t.Value)})}),n}},{key:"all",get:function(){var e=new o;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.Add(t.Key,t.Value)})}),e}}]),o}(),it=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this,t))).useEndLineNumber=!1,e.message=t,e.name="StoryException",e}return D(n,B(Error)),n}(),h=0,o=1,s=2,u=3,l=4,r=5,e=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this)))._valueType,e._isTruthy,e._valueObject,e}return D(n,a),J(n,[{key:"Cast",value:function(t){throw"Trying to casting an AbstractValue"}},{key:"Copy",value:function(t){return n.Create(t)}},{key:"BadCastException",value:function(t){return new it("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}},{key:"valueType",get:function(){return this._valueType}},{key:"isTruthy",get:function(){return this._isTruthy}},{key:"valueObject",get:function(){return this._valueObject}}],[{key:"Create",value:function(t){"boolean"==typeof t&&(t=!!t?1:0);return Number.isInteger(Number(t))?new at(t):isNaN(t)?"string"==typeof t?new rt(t):t instanceof O?new ot(t):t instanceof x?new st(t):null:new p(t)}}]),n}(),N=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this))).value=t,e}return D(n,e),J(n,[{key:"toString",value:function(){return this.value.toString()}},{key:"value",get:function(){return this._value},set:function(t){this._value=t}},{key:"valueObject",get:function(){return this.value}}]),n}(),at=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this,t||0)))._valueType=h,e}return D(n,N),J(n,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==o)return new p(parseFloat(this.value));if(t==u)return new rt(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return h}}]),n}(),p=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this,t||0)))._valueType=o,e}return D(n,N),J(n,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==h)return new at(parseInt(this.value));if(t==u)return new rt(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this._value}},{key:"valueType",get:function(){return o}}]),n}(),rt=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this,t||"")))._valueType=u,e._isNewline="\n"==e.value,e._isInlineWhitespace=!0,e.value.split().every(function(t){return" "==t||"\t"==t||(e._isInlineWhitespace=!1)}),e}return D(n,N),J(n,[{key:"Cast",value:function(t){if(t==this.valueType)return this;var e,n;if(t==h)return(e=parseInt(value))?new at(e):null;if(t!=o)throw this.BadCastException(t);return(n=n(value))?new p(n):null}},{key:"valueType",get:function(){return u}},{key:"isTruthy",get:function(){return 0<this.value.length}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),n}(),ot=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this,t)))._valueType=l,e}return D(n,N),J(n,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"targetPath",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a divert target"}}]),n}(),A=function(t){function i(t,e){var n;return W(this,i),(n=j(this,G(i).call(this,t)))._valueType=r,n.contextIndex=void 0!==e?e:-1,n}return D(i,N),J(i,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new i(this.variableName,this.contextIndex)}},{key:"variableName",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a variable pointer"}}]),i}(),st=function(t){function a(t,e){var n;return W(this,a),(n=j(this,G(a).call(this,null)))._valueType=s,n.value=t instanceof x?new x(t):void 0!==t&&void 0!==e?new x({Key:t,Value:e}):new x,n}return D(a,N),J(a,[{key:"Cast",value:function(t){var e;if(t==h)return(e=this.value.maxItem).Key.isNull?new at(0):new at(e.Value);if(t==o)return(e=this.value.maxItem).Key.isNull?new p(0):new p(parseFloat(e.Value));if(t==u)return(e=value.maxItem).Key.isNull?new rt(""):new rt(e.Key.toString());if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"valueType",get:function(){return s}},{key:"isTruthy",get:function(){var e=!1;return this.value.forEach(function(t){0!=t.Value&&(e=!0)}),e}}]),J(a,null,[{key:"RetainListOriginsForAssignment",value:function(t,e){var n=t,i=e;n instanceof a&&i instanceof a&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}}]),a}(),c=function(){function e(){W(this,e),this.obj,this.approximate}return J(e,[{key:"copy",value:function(){var t=new e;return t.obj=this.obj,t.approximate=this.approximate,t}},{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof Container?this.obj:null}}]),e}(),Container=function(t){function Container(){var t;return W(this,Container),(t=j(this,G(Container).call(this))).name="",t._content=[],t.namedContent={},t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t.CountFlags={Visits:1,Turns:2,CountStartOnly:4},t._pathToFirstLeafContent=null,t}return D(Container,a),J(Container,[{key:"AddContent",value:function(t){var e=this;if(t instanceof Array)t.forEach(function(t){e.AddContent(t)});else{if(this._content.push(t),t.parent)throw"content is already in "+t.parent;(t.parent=this).TryAddNamedContent(t)}}},{key:"TryAddNamedContent",value:function(t){t.hasValidName&&t.name&&this.AddToNamedContentOnly(t)}},{key:"AddToNamedContentOnly",value:function(t){t instanceof a==!1&&console.warn("Can only add Runtime.Objects to a Runtime.Container"),(t.parent=this).namedContent[t.name]=t}},{key:"ContentAtPath",value:function(t,e,n){e=void 0!==e?e:0,n=void 0!==n?n:t.length;var i=new c;i.approximate=!1;for(var a=this,r=this,o=e;o<n;++o){var s=t.GetComponent(o);if(null==a){i.approximate=!0;break}var u=a.ContentWithPathComponent(s);if(null==u){i.approximate=!0;break}a=(r=u)instanceof Container?u:null}return i.obj=r,i}},{key:"InsertContent",value:function(t,e){if((this.content[i]=t).parent)throw"content is already in "+t.parent;(t.parent=this).TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){var e=this;this.content=this.content.concat(t.content),t.content.forEach(function(t){(t.parent=e).TryAddNamedContent(t)})}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return 0<=t.index&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;var e;return(e=this.namedContent[t.name])?e:null}},{key:"BuildStringOfHierarchy",value:function(e,n,t){if(0==arguments.length){e=new nt;return this.BuildStringOfHierarchy(e,0,null),e.toString()}function i(){for(var t=0;t<4*n;++t)e.Append(" ")}i(),e.Append("["),this.hasValidName&&e.AppendFormat(" ({0})",this.name),this==t&&e.Append("  <---"),e.AppendLine(),n++;for(var a=0;a<this.content.length;++a){var r=this.content[a];if(r instanceof Container)r.BuildStringOfHierarchy(e,n,t);else i(),r instanceof rt?(e.Append('"'),e.Append(r.toString().replace("\n","\\n")),e.Append('"')):e.Append(r.toString());a!=this.content.length-1&&e.Append(","),r instanceof Container||r!=t||e.Append("  <---"),e.AppendLine()}var o={};for(var s in this.namedContent)0<=this.content.indexOf(this.namedContent[s])||(o[s]=this.namedContent[s]);if(0<Object.keys(o).length)for(var s in i(),e.AppendLine("-- named: --"),o){o[s]instanceof Container||console.warn("Can only print out named Containers"),o[s].BuildStringOfHierarchy(e,n,t),e.Append("\n")}n--,i(),e.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&0<this.name.length}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var n={};for(var t in this.namedContent)n[t]=this.namedContent[t];return this.content.forEach(function(t){var e=t;e.name&&e.hasValidName&&delete n[e.name]}),0==Object.keys(n).length&&(n=null),n},set:function(t){var e=this.namedOnlyContent;if(null!=e)for(var n in e)delete this.namedContent[n];if(null!=t)for(var n in t){var i=t[n];i.name&&void 0!==i.hasValidName&&this.AddToNamedContentOnly(i)}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=this.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=this.CountFlags.Turns),this.countingAtStartOnly&&(t|=this.CountFlags.CountStartOnly),t==this.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;0<(e&this.CountFlags.Visits)&&(this.visitsShouldBeCounted=!0),0<(e&this.CountFlags.Turns)&&(this.turnIndexShouldBeCounted=!0),0<(e&this.CountFlags.CountStartOnly)&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=[],e=this;e instanceof Container;)0<e.content.length&&(t.push(new Path.Component(0)),e=e.content[0]);return new Path(t)}}]),Container}(),I=function(t){function e(){return W(this,e),j(this,G(e).apply(this,arguments))}return D(e,a),J(e,[{key:"toString",value:function(){return"Glue"}}]),e}(),ut=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this)))._commandType=void 0!==t?t:f.NotSet,e}return D(n,a),J(n,[{key:"copy",value:function(){return new n(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}},{key:"commandType",get:function(){return this._commandType}}],[{key:"EvalStart",value:function(){return new n(f.EvalStart)}},{key:"EvalOutput",value:function(){return new n(f.EvalOutput)}},{key:"EvalEnd",value:function(){return new n(f.EvalEnd)}},{key:"Duplicate",value:function(){return new n(f.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new n(f.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new n(f.PopFunction)}},{key:"PopTunnel",value:function(){return new n(f.PopTunnel)}},{key:"BeginString",value:function(){return new n(f.BeginString)}},{key:"EndString",value:function(){return new n(f.EndString)}},{key:"NoOp",value:function(){return new n(f.NoOp)}},{key:"ChoiceCount",value:function(){return new n(f.ChoiceCount)}},{key:"TurnsSince",value:function(){return new n(f.TurnsSince)}},{key:"ReadCount",value:function(){return new n(f.ReadCount)}},{key:"Random",value:function(){return new n(f.Random)}},{key:"SeedRandom",value:function(){return new n(f.SeedRandom)}},{key:"VisitIndex",value:function(){return new n(f.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new n(f.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new n(f.StartThread)}},{key:"Done",value:function(){return new n(f.Done)}},{key:"End",value:function(){return new n(f.End)}},{key:"ListFromInt",value:function(){return new n(f.ListFromInt)}},{key:"ListRange",value:function(){return new n(f.ListRange)}}]),n}(),f={NotSet:-1,EvalStart:0,EvalOutput:1,EvalEnd:2,Duplicate:3,PopEvaluatedValue:4,PopFunction:5,PopTunnel:6,BeginString:7,EndString:8,NoOp:9,ChoiceCount:10,TurnsSince:11,Random:12,SeedRandom:13,VisitIndex:14,SequenceShuffleIndex:15,StartThread:16,Done:17,End:18,ListFromInt:19,ListRange:20,ReadCount:21};f.TOTAL_VALUES=Object.keys(f).length-1,ut.CommandType=f;var lt=0,ht=1,v=2,ct=function(){function n(t,e){W(this,n),this.container=t,this.index=e}return J(n,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new n(this.container,this.index)}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:0<=this.index?this.container.path.PathByAppendingComponent(new O.Component(this.index)):this.container.path}}],[{key:"StartOf",value:function(t){return new n(t,0)}},{key:"Null",get:function(){return new n(null,-1)}}]),n}(),ft=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this)))._targetPath,e._targetPointer,e.variableDivertName,e.pushesToStack,e.stackPushType,e.isExternal,e.isConditional,e.externalArgs,e.pushesToStack=!1,t&&(e.pushesToStack=!0,e.stackPushType=t),e}return D(n,a),J(n,[{key:"Equals",value:function(t){var e=t;return e instanceof n&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:this.targetPath.Equals(e.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new nt,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==ht?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=ct.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;this._targetPath.lastComponent.isIndex?(this._targetPointer.container=t.parent instanceof Container?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index):this._targetPointer=ct.StartOf(t instanceof Container?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new O(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),n}(),V=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this)))._pathOnChoice,e.hasCondition,e.hasStartContent,e.hasChoiceOnlyContent,e.onceOnly,e.isInvisibleDefault,e.onceOnly=!!t,e}return D(n,a),J(n,[{key:"toString",value:function(){return"Choice: -> "+this.pathOnChoice.toString()}},{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new O(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=0<(1&t),this.hasStartContent=0<(2&t),this.hasChoiceOnlyContent=0<(4&t),this.isInvisibleDefault=0<(8&t),this.onceOnly=0<(16&t)}}]),n}(),vt=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this))).name=t,e.pathForCount,e}return D(n,a),J(n,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null==this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null==t?null:new O(t)}}]),n}(),dt=function(t){function i(t,e){var n;return W(this,i),(n=j(this,G(i).call(this)))._variableName=t||null,n._isNewDeclaration=!!e,n.isGlobal,n}return D(i,a),J(i,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}},{key:"variableName",get:function(){return this._variableName}},{key:"isNewDeclaration",get:function(){return this._isNewDeclaration}}]),i}(),pt=function(t){function e(){return W(this,e),j(this,G(e).apply(this,arguments))}return D(e,a),e}(),yt=function(t){function r(t){var e;return W(this,r),(e=j(this,G(r).call(this))).name=t,e._numberOfParameters,e._prototype,e._isPrototype,e._operationFuncs=null,r.GenerateNativeFunctionsIfNecessary(),e}return D(r,a),J(r,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw"Unexpected number of parameters";var e=!1;if(t.forEach(function(t){if(t instanceof pt)throw new it("Attempting to perform operation on a void value. Did you forget to 'return' a value from a function you called here?");t instanceof st&&(e=!0)}),2==t.length&&e)return this.CallBinaryListOperation(t);var n=this.CoerceValuesToSingleType(t),i=n[0].valueType;return i==h?this.CallType(n):i==o?this.CallType(n):i==u?this.CallType(n):i==l?this.CallType(n):i==s?this.CallType(n):null}},{key:"CallType",value:function(t){var e=t[0],n=e.valueType,i=e,a=t.length;if(2!=a&&1!=a)throw"Unexpected number of parameters to NativeFunctionCall: "+t.length;var r=this._operationFuncs[n];if(!r)throw new it("Cannot perform operation '"+this.name+"' on "+n);if(2==a){var o=t[1],s=r(i.value,o.value);return N.Create(s)}s=r(i.value);return N.Create(s)}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof st&&t[1]instanceof at)return this.CallListIncrementOperation(t);var e=t[0],n=t[1];if(!("&&"!=this.name&&"||"!=this.name||e.valueType==s&&n.valueType==s)){var i=(0,this._operationFuncs[h])(e.isTruthy?1:0,n.isTruthy?1:0);return new at(i)}if(e.valueType==s&&n.valueType==s)return this.CallType([e,n]);throw new it("Can not call use '"+this.name+"' operation on "+e.valueType+" and "+n.valueType)}},{key:"CallListIncrementOperation",value:function(t){var o=this,s=t[0],u=t[1],l=new x;return s.value.forEach(function(t){var e=t.Key,n=t.Value,i=(0,o._operationFuncs[h])(n,u.value),a=null;if(s.value.origins.forEach(function(t){if(t.name==e.originName)return a=t,!1}),null!=a){var r=a.TryGetItemWithValue(i);r.exists&&l.Add(r.item,i)}}),new st(l)}},{key:"CoerceValuesToSingleType",value:function(t){var n=h,r=null;t.forEach(function(t){var e=t;e.valueType>n&&(n=e.valueType),e.valueType==s&&(r=e)});var o=[];return n==s?t.forEach(function(t){if(t.valueType==s)o.push(t);else{if(t.valueType!=h)throw new it("Cannot mix Lists and "+t.valueType+" values in this operation");var e=parseInt(t.valueObject),n=r.value.originOfMaxItem,i=n.TryGetItemWithValue(e);if(!i.exists)throw new it("Could not find List item with the value "+e+" in "+n.name);var a=new st(i.item,e);o.push(a)}}):t.forEach(function(t){var e=t.Cast(n);o.push(e)}),o}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs={}),this._operationFuncs[t]=e}},{key:"toString",value:function(){return"Native '"+this.name+"'"}},{key:"name",get:function(){return this._name},set:function(t){this._name=t,this._isPrototype||(this._prototype=r._nativeFunctions[this._name])}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"internalConstructor",value:function(t,e){var n=new r(t);return n._isPrototype=!0,n.numberOfParameters=e,n}},{key:"CallWithName",value:function(t){return new r(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions[t]}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){if(null==this._nativeFunctions){this._nativeFunctions={},this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return parseInt(t/e)}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddIntBinaryOp(this.Greater,function(t,e){return e<t?1:0}),this.AddIntBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return e<=t?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddIntUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddFloatBinaryOp(this.Greater,function(t,e){return e<t?1:0}),this.AddFloatBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return e<=t?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e?1:0}),this.AddStringBinaryOp(this.NotEquals,function(t,e){return t!==e?1:0}),this.AddStringBinaryOp(this.Has,function(t,e){return t.includes(e)?1:0}),this.AddStringBinaryOp(this.Hasnt,function(t,e){return t.includes(e)?0:1}),this.AddListBinaryOp(this.Add,function(t,e){return t.Union(e)}),this.AddListBinaryOp(this.Subtract,function(t,e){return t.Without(e)}),this.AddListBinaryOp(this.Has,function(t,e){return t.Contains(e)?1:0}),this.AddListBinaryOp(this.Hasnt,function(t,e){return t.Contains(e)?0:1}),this.AddListBinaryOp(this.Intersect,function(t,e){return t.Intersect(e)}),this.AddListBinaryOp(this.Equal,function(t,e){return t.Equals(e)?1:0}),this.AddListBinaryOp(this.Greater,function(t,e){return t.GreaterThan(e)?1:0}),this.AddListBinaryOp(this.Less,function(t,e){return t.LessThan(e)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(t,e){return t.GreaterThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,function(t,e){return t.LessThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.NotEquals,function(t,e){return t.Equals(e)?0:1}),this.AddListBinaryOp(this.And,function(t,e){return 0<t.Count&&0<e.Count?1:0}),this.AddListBinaryOp(this.Or,function(t,e){return 0<t.Count||0<e.Count?1:0}),this.AddListUnaryOp(this.Not,function(t){return 0==t.Count?1:0}),this.AddListUnaryOp(this.Invert,function(t){return t.inverse}),this.AddListUnaryOp(this.All,function(t){return t.all}),this.AddListUnaryOp(this.ListMin,function(t){return t.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(t){return t.MaxAsList()}),this.AddListUnaryOp(this.Count,function(t){return t.Count}),this.AddListUnaryOp(this.ValueOfList,function(t){return t.maxItem.Value});this.AddOpToNativeFunc(this.Equal,2,l,function(t,e){return t.Equals(e)?1:0})}}},{key:"AddOpToNativeFunc",value:function(t,e,n,i){var a=this._nativeFunctions[t];a||(a=r.internalConstructor(t,e),this._nativeFunctions[t]=a),a.AddOpFuncForType(n,i)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,h,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,h,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,o,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,o,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,u,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,s,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,s,e)}}]),r}();yt.Add="+",yt.Subtract="-",yt.Divide="/",yt.Multiply="*",yt.Mod="%",yt.Negate="_",yt.Equal="==",yt.Greater=">",yt.Less="<",yt.GreaterThanOrEquals=">=",yt.LessThanOrEquals="<=",yt.NotEquals="!=",yt.Not="!",yt.And="&&",yt.Or="||",yt.Min="MIN",yt.Max="MAX",yt.Has="?",yt.Hasnt="!?",yt.Intersect="^",yt.ListMin="LIST_MIN",yt.ListMax="LIST_MAX",yt.All="LIST_ALL",yt.Count="LIST_COUNT",yt.ValueOfList="LIST_VALUE",yt.Invert="LIST_INVERT",yt._nativeFunctions=null;var F=function(t){function n(t){var e;return W(this,n),(e=j(this,G(n).call(this)))._text=t.toString()||"",e}return D(n,a),J(n,[{key:"toString",value:function(){return"# "+this._text}},{key:"text",get:function(){return this._text}}]),n}(),y=function(){function t(){W(this,t),this.text,this.index,this.choicePoint,this.threadAtGeneration,this.sourcePath,this.targetPath,this.isInvisibleDefault=!1,this._originalThreadIndex}return J(t,[{key:"pathStringOnChoice",get:function(){return this.targetPath.toString()},set:function(t){this.targetPath=new O(t)}}]),t}(),d=function(){function n(t,e){W(this,n),this._name=t||"",this._items=null,this._rawListItemsKeys=null,this._itemNameToValues=e||{}}return J(n,[{key:"forEachItems",value:function(t){for(var e in this._rawListItemsKeys)t({Key:this._rawListItemsKeys[e],Value:this._items[e]})}},{key:"ValueForItem",value:function(t){var e=this._itemNameToValues[t.itemName];return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return t.originName==this.name&&t.itemName in this._itemNameToValues}},{key:"ContainsItemWithName",value:function(t){return void 0!==this._itemNameToValues[t]}},{key:"TryGetItemWithValue",value:function(t,e){for(var n in this._itemNameToValues)if(this._itemNameToValues[n]==t)return{item:new P(this.name,n),exists:!0};return{item:P.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t,e){return intVal=this._itemNameToValues[t.itemName],intVal}},{key:"ListRange",value:function(t,e){var n=new x;for(var i in this._itemNameToValues)if(this._itemNameToValues[i]>=t&&this._itemNameToValues[i]<=e){var a=new P(this.name,i);n.Add(a,this._itemNameToValues[i])}return new st(n)}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items)for(var t in this._items={},this._rawListItemsKeys={},this._itemNameToValues){var e=new P(this.name,t);this._rawListItemsKeys[e]=e,this._items[e]=this._itemNameToValues[t]}return this._items.forEach=this.forEachItems.bind(this),this._items}}]),n}(),m=function(){function e(t){var a=this;W(this,e),this._lists={},this._allUnambiguousListValueCache={},t.forEach(function(t){(a._lists[t.name]=t).items.forEach(function(t){var e=t.Key,n=t.Value,i=new st(e,n);a._allUnambiguousListValueCache[e.itemName]=i,a._allUnambiguousListValueCache[e.fullName]=i})})}return J(e,[{key:"TryListGetDefinition",value:function(t,e){return t in this._lists?this._lists[t]:e}},{key:"FindSingleItemListWithName",value:function(t){var e=null;return void 0!==this._allUnambiguousListValueCache[t]&&(e=this._allUnambiguousListValueCache[t]),e}},{key:"lists",get:function(){var t=[];for(var e in this._lists)t.push(this._lists[e]);return t}}]),e}(),g=function(){function t(){W(this,t)}return J(t,null,[{key:"ListToJArray",value:function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.RuntimeObjectToJToken(t))}),n}},{key:"JArrayToRuntimeObjList",value:function(t,e){var n=t.length;e&&n--;for(var i=[],a=0;a<n;a++){var r=t[a],o=this.JTokenToRuntimeObject(r);i.push(o)}return i}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e={};for(var n in t)e[n]=this.JTokenToRuntimeObject(t[n]);return e}},{key:"DictionaryRuntimeObjsToJObject",value:function(t){var e={};for(var n in t){var i=t[n];i instanceof a&&(e[n]=this.RuntimeObjectToJToken(i))}return e}},{key:"JObjectToIntDictionary",value:function(t){var e={};for(var n in t)e[n]=parseInt(t[n]);return e}},{key:"IntDictionaryToJObject",value:function(t){var e={};for(var n in t)e[n]=t[n];return e}},{key:"JTokenToRuntimeObject",value:function(t){if(!isNaN(t)&&"\n"!==t)return N.Create(t);if("string"==typeof t){var e=t.toString(),n=e[0];if("^"==n)return new rt(e.substring(1));if("\n"==n&&1==e.length)return new rt("\n");if("<>"==e)return new I;for(var i=0;i<L.length;++i){if(e==L[i])return new ut(i)}if("L^"==e&&(e="^"),yt.CallExistsWithName(e))return yt.CallWithName(e);if("->->"==e)return ut.PopTunnel();if("~ret"==e)return ut.PopFunction();if("void"==e)return new pt}if("object"===M(t)&&t instanceof Array==!1){var a,r=t;if(r["^->"])return a=r["^->"],new ot(new O(a.toString()));if(r["^var"]){a=r["^var"];var o=new A(a.toString());return"ci"in r&&(a=r.ci,o.contextIndex=parseInt(a)),o}var s=!1,u=!1,l=ht,h=!1;if((a=r["->"])?s=!0:(a=r["f()"])?(u=s=!0,l=ht):(a=r["->t->"])?(u=s=!0,l=lt):(a=r["x()"])&&(u=!(h=s=!0),l=ht),s){var c=new ft;c.pushesToStack=u,c.stackPushType=l,c.isExternal=h;var f=a.toString();return(a=r.var)?c.variableDivertName=f:c.targetPathString=f,c.isConditional=!!r.c,h&&(a=r.exArgs)&&(c.externalArgs=parseInt(a)),c}if(a=r["*"]){var v=new V;return v.pathStringOnChoice=a.toString(),(a=r.flg)&&(v.flags=parseInt(a)),v}if(a=r["VAR?"])return new vt(a.toString());if(a=r["CNT?"]){var d=new vt;return d.pathStringForCount=a.toString(),d}var p=!1,y=!1;if((a=r["VAR="])?y=p=!0:(a=r["temp="])&&(y=!(p=!0)),p){var m=a.toString(),g=!r.re,k=new dt(m,g);return k.isGlobal=y,k}if(void 0!==r["#"])return a=r["#"],new F(a.toString());if(a=r.list){var S=a,C=new x;if(a=r.origins){var b=a;C.SetInitialOriginNames(b)}for(var _ in S){var T=S[_],E=new P(_),w=parseInt(T);C.Add(E,w)}return new st(C)}if(null!=r.originalChoicePath)return this.JObjectToChoice(r)}if(t instanceof Array)return this.JArrayToContainer(t);if(null==t)return null;throw"Failed to convert token to runtime object: "+JSON.stringify(t)}},{key:"RuntimeObjectToJToken",value:function(t){var e=t;if(e instanceof Container)return this.ContainerToJArray(e);var n=t;if(n instanceof ft){var i,a="->";return n.isExternal?a="x()":n.pushesToStack&&(n.stackPushType==ht?a="f()":n.stackPushType==lt&&(a="->t->")),i=n.hasVariableTarget?n.variableDivertName:n.targetPathString,(c={})[a]=i,n.hasVariableTarget&&(c.var=!0),n.isConditional&&(c.c=!0),0<n.externalArgs&&(c.exArgs=n.externalArgs),c}var r=t;if(r instanceof V)return(c={})["*"]=r.pathStringOnChoice,c.flg=r.flags,c;if(t instanceof at)return t.value;if(t instanceof p)return t.value;var o=t;if(o instanceof rt)return o.isNewline?"\n":"^"+o.value;var s=t;if(s instanceof st)return this.InkListToJObject(s);if(t instanceof ot)return{"^->":t.value.componentsString};var u=t;if(u instanceof A)return{"^var":u.value,ci:u.contextIndex};if(t instanceof I)return"<>";if(t instanceof ut)return L[parseInt(t.commandType)];if(t instanceof yt){var l=t.name;return"^"==l&&(l="L^"),l}var h=t;if(h instanceof vt){var c={},f=h.pathStringForCount;return null!=f?c["CNT?"]=f:c["VAR?"]=h.name,c}var v=t;if(v instanceof dt)return(c={})[v.isGlobal?"VAR=":"temp="]=v.variableName,v.isNewDeclaration||(c.re=!0),c;if(t instanceof pt)return"void";if(t instanceof F)return(c={})["#"]=t.text,c;var d=t;if(d instanceof y)return this.ChoiceToJObject(d);throw"Failed to convert runtime object to Json token: "+t}},{key:"ContainerToJArray",value:function(t){var e=this.ListToJArray(t.content),n=t.namedOnlyContent,i=t.countFlags;if(null!=n&&0<n.length||0<i||null!=t.name){var a;if(null!=n)for(var r in a=this.DictionaryRuntimeObjsToJObject(n)){var o=a[r];if(null!=o){var s=o[o.length-1];null!=s&&(delete s["#n"],0==Object.keys(s).length&&(o[o.length-1]=null))}}else a={};0<i&&(a["#f"]=i),null!=t.name&&(a["#n"]=t.name),e.push(a)}else e.push(null);return e}},{key:"JArrayToContainer",value:function(t){var e=new Container;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i={};for(var a in n)if("#f"==a)e.countFlags=parseInt(n[a]);else if("#n"==a)e.name=n[a].toString();else{var r=this.JTokenToRuntimeObject(n[a]);r instanceof Container&&(r.name=a),i[a]=r}e.namedOnlyContent=i}return e}},{key:"JObjectToChoice",value:function(t){var e=new y;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}},{key:"ChoiceToJObject",value:function(t){var e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.sourcePath,e.originalThreadIndex=t.originalThreadIndex,e.targetPath=t.pathStringOnChoice,e}},{key:"InkListToJObject",value:function(t){var e=t.value,n={},i={};return e.forEach(function(t){var e=t.Key,n=t.Value;i[e.toString()]=n}),n.list=i,0==e.Count&&null!=e.originNames&&0<e.originNames.length&&(n.origins=e.originNames),n}},{key:"ListDefinitionsToJToken",value:function(t){var e={};return t.lists.forEach(function(t){var i={};t.items.forEach(function(t){var e=t.Key,n=t.Value;i[e.itemName]=n}),e[t.name]=i}),e}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e){var a=i.toString(),r=e[i],o={};for(var s in r){var u=r[s];o[s]=parseInt(u)}var l=new d(a,o);n.push(l)}return new m(n)}}]),t}(),L=[];L[ut.CommandType.EvalStart]="ev",L[ut.CommandType.EvalOutput]="out",L[ut.CommandType.EvalEnd]="/ev",L[ut.CommandType.Duplicate]="du",L[ut.CommandType.PopEvaluatedValue]="pop",L[ut.CommandType.PopFunction]="~ret",L[ut.CommandType.PopTunnel]="->->",L[ut.CommandType.BeginString]="str",L[ut.CommandType.EndString]="/str",L[ut.CommandType.NoOp]="nop",L[ut.CommandType.ChoiceCount]="choiceCnt",L[ut.CommandType.TurnsSince]="turns",L[ut.CommandType.ReadCount]="readc",L[ut.CommandType.Random]="rnd",L[ut.CommandType.SeedRandom]="srnd",L[ut.CommandType.VisitIndex]="visit",L[ut.CommandType.SequenceShuffleIndex]="seq",L[ut.CommandType.StartThread]="thread",L[ut.CommandType.Done]="done",L[ut.CommandType.End]="end",L[ut.CommandType.ListFromInt]="listInt",L[ut.CommandType.ListRange]="range";for(var k=0;k<ut.CommandType.TOTAL_VALUES;++k)if(null==L[k])throw"Control command not accounted for in serialisation";var S=function(){function i(t,e,n){W(this,i),this.currentPointer=e.copy(),this.inExpressionEvaluation=n||!1,this.temporaryVariables={},this.type=t,this.evaluationStackHeightWhenPushed=0,this.functionStartInOuputStream=0}return J(i,[{key:"Copy",value:function(){var t=new i(this.type,this.currentPointer,this.inExpressionEvaluation);return Object.assign(t.temporaryVariables,this.temporaryVariables),t.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,t.functionStartInOuputStream=this.functionStartInOuputStream,t}}]),i}(),C=function(){function a(t,h){var c=this;if(W(this,a),this.callstack=[],this.threadIndex=0,this.previousPointer=ct.Null,t&&h){var e=t;this.threadIndex=parseInt(e.threadIndex),e.callstack.forEach(function(t){var e=t,n=parseInt(e.type),i=ct.Null,a=null,r=e.cPath;if(void 0!==r){a=r.toString();var o=h.ContentAtPath(new O(a));if(i.container=o.container,i.index=parseInt(e.idx),null==o.obj)throw"When loading state, internal story location couldn't be found: "+a+". Has the story changed since this save data was created?";o.approximate&&h.Warning("When loading state, exact internal story location couldn't be found: '"+a+"', so it was approximated to '"+i.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}var s=!!e.exp,u=new S(n,i,s),l=e.temp;u.temporaryVariables=g.JObjectToDictionaryRuntimeObjs(l),c.callstack.push(u)});var n=e.previousContentObject;if(void 0!==n){var i=new O(n.toString());this.previousPointer=h.PointerAtPath(i)}}}return J(a,[{key:"Copy",value:function(){var e=new a;return e.threadIndex=this.threadIndex,this.callstack.forEach(function(t){e.callstack.push(t.Copy())}),e.previousPointer=this.previousPointer.copy(),e}},{key:"jsonToken",get:function(){var t={},n=[];return this.callstack.forEach(function(t){var e={};t.currentPointer.isNull||(e.cPath=t.currentPointer.container.path.componentsString,e.idx=t.currentPointer.index),e.exp=t.inExpressionEvaluation,e.type=parseInt(t.type),e.temp=g.DictionaryRuntimeObjsToJObject(t.temporaryVariables),n.push(e)}),t.callstack=n,t.threadIndex=this.threadIndex,this.previousPointer.isNull||(t.previousContentObject=this.previousPointer.Resolve().path.toString()),t}}]),a}(),b=function(){function n(t){var e=this;W(this,n),this._threads=[],this._threadCounter=0,this._threads.push(new C),t instanceof n?(this._threads=[],t._threads.forEach(function(t){e._threads.push(t.Copy())})):this._threads[0].callstack.push(new S(lt,ct.StartOf(t)))}return J(n,[{key:"CanPop",value:function(t){return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(t){if(!this.CanPop(t))throw"Mismatched push/pop in Callstack";this.callStack.pop()}},{key:"Push",value:function(t,e,n){e=void 0!==e?e:0,n=void 0!==n?n:0;var i=new S(t,this.currentElement.currentPointer,!1);i.evaluationStackHeightWhenPushed=e,i.functionStartInOuputStream=n,this.callStack.push(i)}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"PopThread",value:function(){if(!this.canPopThread)throw"Can't pop thread";this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"SetJsonToken",value:function(t,n){var i=this;this._threads.length=0;var e=t;e.threads.forEach(function(t){var e=new C(t,n);i._threads.push(e)}),this._threadCounter=parseInt(e.threadCounter)}},{key:"GetJsonToken",value:function(){var t={},e=[];return this._threads.forEach(function(t){e.push(t.jsonToken)}),t.threads=e,t.threadCounter=this._threadCounter,t}},{key:"GetTemporaryVariableWithName",value:function(t,e){-1==(e=void 0===e?-1:e)&&(e=this.currentElementIndex+1);var n;return(n=this.callStack[e-1].temporaryVariables[t])?n:null}},{key:"SetTemporaryVariable",value:function(t,e,n,i){-1==(i=void 0===i?-1:i)&&(i=this.currentElementIndex+1);var a,r=this.callStack[i-1];if(!n&&!r.temporaryVariables[t])throw new it("Could not find temporary variable to set: "+t);(a=r.temporaryVariables[t])&&st.RetainListOriginsForAssignment(a,e),r.temporaryVariables[t]=e}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables[t]?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(e){return this._threads.filter(function(t){if(t.threadIndex==e)return t})[0]}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){1!=this._threads.length&&console.warn("Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new nt,e=0;e<this._threads.length;e++){var n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(var a=0;a<n.callstack.length;a++){n.callstack[a].type==ht?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");var r=n.callstack[a].currentPointer;r.isNull||(t.Append("<SOMEWHERE IN "),t.Append(r.container.path.toString()),t.AppendLine(">"))}}return t.toString()}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"canPop",get:function(){return 1<this.callStack.length}},{key:"canPopThread",get:function(){return 1<this._threads.length&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==v}}]),n}(),_=function(){function n(t,e){W(this,n),this._globalVariables={},this._defaultGlobalVariables={},this._callStack=t,this._listDefsOrigin=e,this._batchObservingVariableChanges=null,this._changedVariables=null,this.variableChangedEvent=null,this.variableChangedEventCallbacks=[];try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(t){}}return J(n,[{key:"ObserveVariableChange",value:function(t){var i=this;null==this.variableChangedEvent&&(this.variableChangedEvent=function(e,n){i.variableChangedEventCallbacks.forEach(function(t){t(e,n)})}),this.variableChangedEventCallbacks.push(t)}},{key:"CopyFrom",value:function(t){this._globalVariables=Object.assign({},t._globalVariables),this._defaultGlobalVariables=Object.assign({},t._defaultGlobalVariables),this.variableChangedEvent=t.variableChangedEvent,t.batchObservingVariableChanges!=this.batchObservingVariableChanges&&(t.batchObservingVariableChanges?(this._batchObservingVariableChanges=!0,this._changedVariables=t._changedVariables):(this._batchObservingVariableChanges=!1,this._changedVariables=null))}},{key:"GlobalVariableExistsWithName",value:function(t){return void 0!==this._globalVariables[t]}},{key:"GetVariableWithName",value:function(t,e){void 0===e&&(e=-1);var n=this.GetRawVariableWithName(t,e),i=n;return i instanceof A&&(n=this.ValueAtVariablePointer(i)),n}},{key:"TryGetDefaultVariableValue",value:function(t){var e=_defaultGlobalVariables[t];return void 0===e&&(e=null),e}},{key:"GetRawVariableWithName",value:function(t,e){var n=null;if(0==e||-1==e){if(n=this._globalVariables[t])return n;var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return n=this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName,i=-1,a=!1;if(a=t.isNewDeclaration?t.isGlobal:!!this._globalVariables[n],t.isNewDeclaration){var r=e;if(r instanceof A)e=this.ResolveVariablePointer(r)}else for(var o=null;(o=this.GetRawVariableWithName(n,i))instanceof A&&(n=o.variableName,a=0==(i=o.contextIndex)),o instanceof A;);a?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=Object.assign({},this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=t,i=e;n instanceof st&&i instanceof st&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n;n=this._globalVariables[t],st.RetainListOriginsForAssignment(n,e),this._globalVariables[t]=e,null!=this.variableChangedEvent&&e!==n&&(this.batchObservingVariableChanges?this._changedVariables.push(t):this.variableChangedEvent(t,e))}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=this.GetRawVariableWithName(t.variableName,e);return n instanceof A?n:new A(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this._globalVariables[t]?0:this._callStack.currentElementIndex}},{key:"$",value:function(t,e){if(void 0===e){var n=this._globalVariables[t];return void 0===n&&(n=this._defaultGlobalVariables[t]),void 0!==n?n.valueObject:null}if(void 0===this._defaultGlobalVariables[t])throw new it("Cannot assign to a variable that hasn't been declared in the story");var i=N.Create(e);if(null==i)throw new it(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){var n=this;t=!!t,this._batchObservingVariableChanges=t,this._changedVariables=t?[]:(null!=this._changedVariables&&this._changedVariables.forEach(function(t){var e=n._globalVariables[t];n.variableChangedEvent(t,e)}),null)}},{key:"jsonToken",get:function(){return g.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(t){this._globalVariables=g.JObjectToDictionaryRuntimeObjs(t)}}]),n}(),mt=function(){function e(t){W(this,e),this._seed=t%2147483647,this._seed<=0&&(this._seed+=2147483646)}return J(e,[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),e}(),T=function(){function s(t){W(this,s),this.story=t,this._outputStream=[],this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new b(t.rootContentContainer),this._variablesState=new _(this.callStack,t.listDefinitions),this._visitCounts={},this._turnIndices={},this._currentTurnIndex=-1,this.divertedPointer=ct.Null;var e=(new Date).getTime();this.storySeed=new mt(e).next()%100,this.previousRandom=0,this._currentChoices=[],this._currentText=null,this._currentTags=null,this._currentErrors=null,this._currentWarnings=null,this.didSafeExit=!1,this.GoToStart()}return J(s,[{key:"CleanOutputWhitespace",value:function(t){for(var e=new nt,n=-1,i=0;i<t.length;i++){var a=t.charAt(i),r=" "==a||"\t"==a;r&&-1==n&&(n=i),r||("\n"!=a&&0<n&&e.Append(t.substr(n,i-n)),n=-1),r||e.Append(a)}return e.toString()}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=ct.StartOf(this.story.mainContentContainer)}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(t){t=void 0!==t?t:null,this._outputStream.length=0,null!=t&&this._outputStream.push.apply(this._outputStream,t),this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(t){var n=this;if(t instanceof st){var i=t.value;null!=i.originNames&&(i.origins||(i.origins=[]),i.origins.length=0,i.originNames.forEach(function(t){var e=null;e=n.story.listDefinitions.TryListGetDefinition(t,e),i.origins.indexOf(e)<0&&i.origins.push(e)}))}this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(t){if(t>this.evaluationStack.length)throw"trying to pop too many objects";return this.evaluationStack.splice(this.evaluationStack.length-t,t)}return this.evaluationStack.pop()}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"PushToOutputStream",value:function(t){var e=this,n=t;if(n instanceof rt){var i=this.TrySplittingHeadTailWhitespace(n);if(null!=i)return i.forEach(function(t){e.PushToOutputStreamIndividual(t)}),void this.OutputStreamDirty()}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){for(var e=t.value,n=-1,i=-1,a=0;a<e.length;++a){if("\n"!=(s=e[a])){if(" "==s||"\t"==s)continue;break}-1==n&&(n=a),i=a}var r=-1,o=-1;for(a=0;a<e.length;++a){var s;if("\n"!=(s=e[a])){if(" "==s||"\t"==s)continue;break}-1==r&&(r=a),o=a}if(-1==n&&-1==r)return null;var u=[],l=0,h=e.length;if(-1!=n){if(0<n){var c=e.substring(0,n);u.push(c)}u.push(new rt("\n")),l=i+1}if(-1!=r&&(h=o),l<h){var f=e.substring(l,h-l);u.push(new rt(f))}if(-1!=r&&i<o&&(u.push(new rt("\n")),r<e.length-1)){var v=e.length-r-1,d=new rt(e.substring(r+1,v));u.push(d)}return u}},{key:"PushToOutputStreamIndividual",value:function(t){var e=t,n=!0;if(t instanceof I)this.TrimNewlinesFromOutputStream(),n=!0;else if(e instanceof rt){var i=-1,a=this.callStack.currentElement;a.type==ht&&(i=a.functionStartInOutputStream);for(var r=-1,o=this._outputStream.length-1;0<=o;o--){var s=this._outputStream[o],u=s instanceof ut?s:null;if(null!=(s instanceof I?s:null)){r=o;break}if(null!=u&&u.commandType==ut.CommandType.BeginString){i<=o&&(i=-1);break}}if(-1!=(-1!=r&&-1!=i?Math.min(i,r):-1!=r?r:i)){if(e.isNewline)n=!1;else if(e.isNonWhitespace&&(-1<r&&this.RemoveExistingGlue(),-1<i)){var l=this.callStack.elements;for(o=l.length-1;0<=o;o--){var h=l[o];if(h.type!=ht)break;h.functionStartInOutputStream=-1}}}else e.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(n=!1))}n&&(this._outputStream.push(t),this.OutputStreamDirty())}},{key:"TrimNewlinesFromOutputStream",value:function(t){for(var e=-1,n=this._outputStream.length-1;0<=n;){var i=this._outputStream[n],a=i instanceof rt?i:null;if(null!=(i instanceof ut?i:null)||null!=a&&a.isNonWhitespace)break;null!=a&&a.isNewline&&(e=n),n--}if(0<=e)for(n=e;n<this._outputStream.length;){this._outputStream[n]instanceof rt?this._outputStream.splice(n,1):n++}this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;0<=t;t--){var e=this._outputStream[t];if(e instanceof I)this._outputStream.splice(t,1);else if(e instanceof ut)break}this.OutputStreamDirty()}},{key:"ForceEnd",value:function(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.PopCallStack();this._currentChoices.length=0,this.currentPointer=ct.Null,this.previousPointer=ct.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var e=this._outputStream.length-1;t<=e;e--){var n=this._outputStream[e],i=n instanceof rt?n:null;if(null!=i){if(n instanceof ut?n:null)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(t){t=void 0!==t?t:null,this.callStack.currentElement.type==ht&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(t)}},{key:"SetChosenPath",value:function(t){this._currentChoices.length=0;var e=this.story.PointerAtPath(t);e.isNull||-1!=e.index||(e.index=0),this.currentPointer=e,this._currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(v,this.evaluationStack.length),this.callStack.currentElement.currentPointer=ct.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!=t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw"ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string";this.PushEvaluationStack(N.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==v&&(this.currentPointer=ct.Null,this.didSafeExit=!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=v)throw new it("Expected external function evaluation to be complete. Stack trace: "+callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var n=this.PopEvaluationStack();null==e&&(e=n)}if(this.PopCallStack(v),e){if(e instanceof pt)return null;var i=e;return i.valueType==l?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"VisitCountAtPathString",value:function(t){var e;return(e=this.visitCounts[t])?e:0}},{key:"Copy",value:function(){var t=new s(this.story);for(var e in t.outputStream.push.apply(t.outputStream,this._outputStream),this.OutputStreamDirty(),t._currentChoices.push.apply(t._currentChoices,this._currentChoices),this.hasError&&(t._currentErrors=[],t._currentErrors.push.apply(t._currentErrors,this.currentErrors)),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push.apply(t._currentWarnings,this.currentWarnings)),t.callStack=new b(this.callStack),t._variablesState=new _(t.callStack,this.story.listDefinitions),t.variablesState.CopyFrom(this.variablesState),t.evaluationStack.push.apply(t.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts={},this._visitCounts)t._visitCounts[e]=this._visitCounts[e];for(var e in t._turnIndices={},this._turnIndices)t._turnIndices[e]=this._turnIndices[e];return t._currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}},{key:"ToJson",value:function(t){return JSON.stringify(this.jsonToken,null,t?2:0)}},{key:"toJson",value:function(t){return this.ToJson(t)}},{key:"LoadJson",value:function(t){this.jsonToken=JSON.parse(t)}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"variablesState",get:function(){return this._variablesState}},{key:"currentContentObject",get:function(){return this.callStack.currentElement.currentObject},set:function(t){this.callStack.currentElement.currentObject=t}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&0<this.currentErrors.length}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&0<this.currentWarnings.length}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"outputStreamEndsInNewline",get:function(){if(0<this._outputStream.length)for(var t=this._outputStream.length-1;0<=t;t--){if(this._outputStream[t]instanceof ut)break;var e=this._outputStream[t];if(e instanceof rt){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof rt)return!0;return!1}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;0<=t;t--){var e=this._outputStream[t];if(e instanceof ut&&e.commandType==ut.CommandType.BeginString)return!0}return!1}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var n=new nt;this._outputStream.forEach(function(t){var e=t;e instanceof rt&&n.Append(e.value)}),this._currentText=this.CleanOutputWhitespace(n.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){var n=this;return this._outputStreamTagsDirty&&(this._currentTags=[],this._outputStream.forEach(function(t){var e=t;e instanceof F&&n._currentTags.push(e.text)}),this._outputStreamTagsDirty=!1),this._currentTags}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"jsonToken",get:function(){var e=this,t={},n=null;return this._currentChoices.forEach(function(t){t.originalThreadIndex=t.threadAtGeneration.threadIndex,null==e.callStack.ThreadWithIndex(t.originalThreadIndex)&&(null==n&&(n={}),n[t.originalThreadIndex.toString()]=t.threadAtGeneration.jsonToken)}),null!=this.choiceThreads&&(t.choiceThreads=this.choiceThreads),t.callstackThreads=this.callStack.GetJsonToken(),t.variablesState=this.variablesState.jsonToken,t.evalStack=g.ListToJArray(this.evaluationStack),t.outputStream=g.ListToJArray(this._outputStream),t.currentChoices=g.ListToJArray(this._currentChoices),this.divertedPointer.isNull||(t.currentDivertTarget=this.divertedPointer.path.componentsString),t.visitCounts=g.IntDictionaryToJObject(this.visitCounts),t.turnIndices=g.IntDictionaryToJObject(this.turnIndices),t.turnIdx=this.currentTurnIndex,t.storySeed=this.storySeed,t.inkSaveVersion=s.kInkSaveStateVersion,t.inkFormatVersion=this.story.inkVersionCurrent,t},set:function(t){var i=this,e=t,n=e.inkSaveVersion;if(null==n)throw new it("ink save format incorrect, can't load.");if(parseInt(n)<s.kMinCompatibleLoadVersion)throw new it("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+s.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(e.callstackThreads,this.story),this.variablesState.jsonToken=e.variablesState,this._evaluationStack=g.JArrayToRuntimeObjList(e.evalStack),this._outputStream=g.JArrayToRuntimeObjList(e.outputStream),this.OutputStreamDirty(),this._currentChoices=g.JArrayToRuntimeObjList(e.currentChoices);var a=e.currentDivertTarget;if(null!=a){var r=new O(a.toString());this.divertedPointer=this.story.PointerAtPath(r)}this._visitCounts=g.JObjectToIntDictionary(e.visitCounts),this._turnIndices=g.JObjectToIntDictionary(e.turnIndices),this._currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed);var o=e.choiceThreads;this._currentChoices.forEach(function(t){var e=i.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=e)t.threadAtGeneration=e;else{var n=o[t.originalThreadIndex.toString()];t.threadAtGeneration=new b.Thread(n,i.story)}})}}]),s}();T.kInkSaveStateVersion=8,T.kMinCompatibleLoadVersion=8;var E=function(){function t(){W(this,t),this.startTime}return J(t,[{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}},{key:"ElapsedMilliseconds",get:function(){return(new Date).getTime()-this.startTime}}]),t}();Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&-9007199254740992<t&&t<9007199254740992&&Math.floor(t)===t});var w=function(t){function u(t,e){var n;if(W(this,u),e=e||null,(n=j(this,G(u).call(this))).inkVersionCurrent=18,n.inkVersionMinimumCompatible=18,n._variableObservers=null,n._externals={},n._prevContainers=[],n._listDefinitions=null,n._asyncContinueActive,n._stateAtLastNewline=null,n._recursiveContinueCount=0,n._temporaryEvaluationContainer=null,n._profiler=null,t instanceof Container)n._mainContentContainer=t,null!=e&&(n._listDefinitions=new m(e));else{var i="string"==typeof t?JSON.parse(t):t,a=i.inkVersion;if(null==a)throw"ink version number not found. Are you sure it's a valid .ink.json file?";var r=parseInt(a);if(r>n.inkVersionCurrent)throw"Version of ink used to build story was newer than the current version of the engine";if(r<n.inkVersionMinimumCompatible)throw"Version of ink used to build story is too old to be loaded by this version of the engine";r!=n.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var o,s=i.root;if(null==s)throw"Root node for ink not found. Are you sure it's a valid .ink.json file?";(o=i.listDefs)&&(n._listDefinitions=g.JTokenToListDefinitions(o)),n._mainContentContainer=g.JTokenToRuntimeObject(s),n._hasValidatedExternals=null,n.allowExternalFunctionFallbacks=!1,n.ResetState()}return n}return D(u,a),J(u,[{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJsonString",value:function(){var t=g.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,null!=this._listDefinitions&&(e.listDefs=g.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(e)}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new T(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){this.IfAsyncWeCant("ResetCallstack"),this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent["global decl"]){var t=this.state.currentPointer.copy();this.ChoosePathString("global decl",!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(t){t=void 0!==t?t:0,null!=this._profiler&&this._profiler.PreContinue();var e=0<t;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=e,!this.canContinue)throw new it("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var n=new E;n.Start();var i=!1;do{try{i=this.ContinueSingleStep()}catch(t){if(!(t instanceof it))throw t;this.AddError(t.Message,void 0,t.useEndLineNumber);break}if(i)break;if(this._asyncContinueActive&&n.ElapsedMilliseconds>t)break}while(this.canContinue);n.Stop(),!i&&this.canContinue||(null!=this._stateAtLastNewline&&(this.RestoreStateSnapshot(this._stateAtLastNewline),this._stateAtLastNewline=null),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(lt)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(ht)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!=this._stateAtLastNewline){var t=this.CalculateNewlineOutputStateChange(this._stateAtLastNewline.currentText,this.state.currentText,this._stateAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==R.ExtendedBeyondNewline)return this.RestoreStateSnapshot(this._stateAtLastNewline),!0;t==R.NewlineRemoved&&(this._stateAtLastNewline=null)}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateAtLastNewline&&(this._stateAtLastNewline=this.StateSnapshot()):this._stateAtLastNewline=null)}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(t,e,n,i){var a=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==i&&t.length==e.length&&a)return R.NoChange;if(!a)return R.NewlineRemoved;if(n<i)return R.ExtendedBeyondNewline;for(var r=t.length;r<e.length;r++){var o=e.charAt(r);if(" "!=o&&"\t"!=o)return R.ExtendedBeyondNewline}return R.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new nt;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){var e=this.mainContentContainer.namedContent[t];return e instanceof Container?e:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return ct.Null;var e=new ct,n=t.length,i=null;return t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&0<n?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(t){this._state=t}},{key:"Step",value:function(){var t=!0,e=this.state.currentPointer.copy();if(!e.isNull){for(var n=e.Resolve();n instanceof Container&&(this.VisitContainer(n,!0),0!=n.content.length);)n=(e=ct.StartOf(n)).Resolve();this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(state.callStack);var i=e.Resolve(),a=this.PerformLogicAndFlowControl(i);if(!this.state.currentPointer.isNull){a&&(t=!1);var r=i;if(r instanceof V){var o=this.ProcessChoice(r);o&&this.state.generatedChoices.push(o),i=null,t=!1}if(i instanceof Container&&(t=!1),t){var s=i;if(s instanceof A&&-1==s.contextIndex){var u=this.state.callStack.ContextForVariableNamed(s.variableName);i=new A(s.variableName,u)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();i instanceof ut&&i.commandType==ut.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(!e.isNull&&-1!=e.index){if(this._prevContainers.length=0,!t.isNull)for(var n=t.Resolve(),i=n instanceof Container?n:t.container;i instanceof Container;)this._prevContainers.push(i),i=i.parent;var a=e.Resolve();if(null!=a)for(var r=a.parent;r instanceof Container&&this._prevContainers.indexOf(r)<0;){var o=0<r.content.length&&a==r.content[0];this.VisitContainer(r,o),r=(a=r).parent}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var i="",a="";t.hasChoiceOnlyContent&&(a=this.state.PopEvaluationStack().value);t.hasStartContent&&(i=this.state.PopEvaluationStack().value);t.onceOnly&&(0<this.VisitCountForContainer(t.choiceTarget)&&(e=!1));if(!e)return null;var r=new y;return r.targetPath=t.pathOnChoice,r.sourcePath=t.path.toString(),r.isInvisibleDefault=t.isInvisibleDefault,r.threadAtGeneration=this.state.callStack.currentThread.Copy(),r.text=(i+a).replace(/^[ \t]+|[ \t]+$/g,""),r}},{key:"IsTruthy",value:function(t){if(t instanceof N){var e=t;if(e instanceof ot){var n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof ft){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i=e.variableDivertName,a=this.state.variablesState.GetVariableWithName(i);if(null==a)this.Error("Tried to divert using a target from a variable that could not be found ("+i+")");else if(!(a instanceof ot)){var r="Tried to divert to a target from a variable, but the variable ("+i+") didn't contain a divert target, it ";a instanceof at&&0==a.value?r+="was empty/null (the value 0).":r+="contained '"+a+"'.",this.Error(r)}var o=a;this.state.divertedPointer=this.PointerAtPath(o.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof ut){var s=t;switch(s.commandType){case ut.CommandType.EvalStart:this.state.inExpressionEvaluation&&console.warn("Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case ut.CommandType.EvalEnd:this.state.inExpressionEvaluation||console.warn("Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case ut.CommandType.EvalOutput:if(0<this.state.evaluationStack.length){var u=this.state.PopEvaluationStack();if(!(u instanceof pt)){var l=new rt(u.toString());this.state.PushToOutputStream(l)}}break;case ut.CommandType.NoOp:break;case ut.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case ut.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case ut.CommandType.PopFunction:case ut.CommandType.PopTunnel:var h=s.commandType==ut.CommandType.PopFunction?ht:lt,c=null;if(h==lt){var f=this.state.PopEvaluationStack();if((c=f)instanceof ot==!1){if(f instanceof pt==!1)throw"Expected void if ->-> doesn't override target";c=null}}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==h&&this.state.callStack.canPop)this.state.PopCallStack(),c&&(this.state.divertedPointer=this.PointerAtPath(c.targetPath));else{var v={};v[ht]="function return statement (~ return)",v[lt]="tunnel onwards statement (->->)";var d=v[this.state.callStack.currentElement.type];this.state.callStack.canPop||(d="end of flow (-> END or choice)");var p="Found "+v[h]+", when expected "+d;this.Error(p)}break;case ut.CommandType.BeginString:this.state.PushToOutputStream(s),this.state.inExpressionEvaluation||console.warn("Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case ut.CommandType.EndString:for(var y=[],m=0,g=this.state.outputStream.length-1;0<=g;--g){var k=this.state.outputStream[g];m++;if(k instanceof ut&&k.commandType==ut.CommandType.BeginString)break;k instanceof rt&&y.push(k)}this.state.PopFromOutputStream(m),y=y.reverse();var S=new nt;y.forEach(function(t){S.Append(t.toString())}),this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new rt(S.toString()));break;case ut.CommandType.ChoiceCount:var C=this.state.generatedChoices.length;this.state.PushEvaluationStack(new at(C));break;case ut.CommandType.TurnsSince:case ut.CommandType.ReadCount:if(!((o=this.state.PopEvaluationStack())instanceof ot)){var b="";o instanceof at&&(b=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+o+b);break}var _,T=o,E=this.ContentAtPath(T.targetPath).correctObj;null!=(Y=E instanceof Container?E:null)?_=s.commandType==ut.CommandType.TurnsSince?this.TurnsSinceForContainer(Y):this.VisitCountForContainer(Y):(_=s.commandType==ut.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+s.toString()+" lookup at "+T.targetPath.toString())),this.state.PushEvaluationStack(new at(_));break;case ut.CommandType.Random:var w=this.state.PopEvaluationStack(),O=this.state.PopEvaluationStack();null!=O&&O instanceof at!=!1||this.Error("Invalid value for minimum parameter of RANDOM(min, max)"),null!=w&&O instanceof at!=!1||this.Error("Invalid value for maximum parameter of RANDOM(min, max)");var P=w.value-O.value+1;P<=0&&this.Error("RANDOM was called with minimum as "+O.value+" and maximum as "+w.value+". The maximum must be larger");var x=this.state.storySeed+this.state.previousRandom,N=new mt(x).next(),A=N%P+O.value;this.state.PushEvaluationStack(new at(A)),this.state.previousRandom=N;break;case ut.CommandType.SeedRandom:var I=this.state.PopEvaluationStack();null!=I&&I instanceof at!=!1||this.Error("Invalid value passed to SEED_RANDOM"),this.state.storySeed=I.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new pt);break;case ut.CommandType.VisitIndex:var V=this.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new at(V));break;case ut.CommandType.SequenceShuffleIndex:var F=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new at(F));break;case ut.CommandType.StartThread:break;case ut.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=ct.Null);break;case ut.CommandType.End:this.state.ForceEnd();break;case ut.CommandType.ListFromInt:var L=parseInt(this.state.PopEvaluationStack()),R=this.state.PopEvaluationStack().toString();if(null==L)throw new it("Passed non-integer when creating a list element from a numerical value.");var j,D=null;if(!(j=this.listDefinitions.TryListGetDefinition(R,j)))throw new it("Failed to find LIST called "+R.value);var B=j.TryGetItemWithValue(L);B.exists&&(D=new st(B.item,L)),null==D&&(D=new st),this.state.PushEvaluationStack(D);break;case ut.CommandType.ListRange:var G=this.state.PopEvaluationStack(),W=this.state.PopEvaluationStack(),J=this.state.PopEvaluationStack();if(J instanceof st==!1||null==J||null==W||null==G)throw new it("Expected list, minimum and maximum for LIST_RANGE");var M=function(t){if(t instanceof st)return parseInt(t.value.maxItem.Value);return t instanceof at?t.value:-1},K=M(W),q=M(G);if(-1==K)throw new it("Invalid min range bound passed to LIST_VALUE(): "+W);if(-1==q)throw new it("Invalid max range bound passed to LIST_VALUE(): "+G);var U=new st,H=J.value.origins;null!=H&&H.forEach(function(t){t.ListRange(K,q).value.forEach(function(t){U.value.Add(t.Key,t.Value)})}),this.state.PushEvaluationStack(U);break;default:this.Error("unhandled ControlCommand: "+s)}return!0}if(t instanceof dt){var $=t,X=this.state.PopEvaluationStack();return this.state.variablesState.Assign($,X),!0}if(t instanceof vt){var z=t,Q=null;if(null!=z.pathForCount){var Y=z.containerForCount;V=this.VisitCountForContainer(Y);Q=new at(V)}else if(null==(Q=this.state.variablesState.GetVariableWithName(z.name))){var Z=this.state.variablesState.TryGetDefaultVariableValue(z.name);null!=Z?(this.Warning("Variable not found in save state: '"+z.name+"', but seems to have been newly created. Assigning value from latest ink's declaration: "+Z),Q=Z,state.variablesState.SetGlobal(z.name,Q)):(this.Warning("Variable not found: '"+z.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit."),Q=new at(0))}return this.state.PushEvaluationStack(Q),!0}if(t instanceof yt){var tt=t,et=this.state.PopEvaluationStack(tt.numberOfParameters);U=tt.Call(et);return this.state.PushEvaluationStack(U),!0}return!1}},{key:"ChoosePathString",value:function(t,e,n){if(e=void 0===e||e,n=n||[],this.IfAsyncWeCant("call ChoosePathString right now"),e)this.ResetCallstack();else if(this.state.callStack.currentElement.type==ht){var i="",a=this.state.callStack.currentElement.currentPointer.container;throw null!=a&&(i="("+a.path.toString()+") "),"Story was running a function "+i+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace}this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new O(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw"Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand."}},{key:"ChoosePath",value:function(t){this.state.SetChosenPath(t),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;(t<0||t>e.length)&&console.warn("choice out of range");var n=e[t];this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath)}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t,e,n){if(n=!!n,this.IfAsyncWeCant("evaluate a function"),null==t)throw"Function is null";if(""==t||""==t.trim())throw"Function is empty or white space.";var i=this.KnotContainerWithName(t);if(null==i)throw"Function doesn't exist: '"+t+"'";var a=[];a.push.apply(a,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(i,e);for(var r=new nt;this.canContinue;)r.Append(this.Continue());var o=r.toString();this._state.ResetOutput(a);var s=this.state.CompleteFunctionEvaluationFromGame();return n?{returned:s,output:o}:s}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(lt),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),n<this.state.evaluationStack.length?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,e){var n=this._externals[t],i=null;if(!(void 0!==n)){if(this.allowExternalFunctionFallbacks)return(i=this.KnotContainerWithName(t))instanceof Container||console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(ht,void 0,this.state.outputStream.length),void(this.state.divertedPointer=ct.StartOf(i));console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var a=[],r=0;r<e;++r){var o=this.state.PopEvaluationStack().valueObject;a.push(o)}a.reverse();var s=n(a),u=null;null!=s?null==(u=N.Create(s))&&console.warn("Could not create ink value from returned object of type "+M(s)):u=new pt,this.state.PushEvaluationStack(u)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunctionGeneral",value:function(t,e){this.IfAsyncWeCant("bind an external function"),this._externals[t]&&console.warn("Function '"+t+"' has already been bound."),this._externals[t]=e}},{key:"BindExternalFunction",value:function(t,a){var r=this;a||console.warn("Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){t.length<a.length&&console.warn("External function expected "+a.length+" arguments");for(var e=[],n=0,i=t.length;n<i;n++)e[n]=r.TryCoerce(t[n]);return a.apply(null,e)})}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),void 0===this._externals[t]&&console.warn("Function '"+t+"' has not been bound."),delete this._externals[t]}},{key:"ValidateExternalBindings",value:function(t,e){var n=this;if(t)if(t instanceof Container){var i=t;for(var a in i.content.forEach(function(t){n.ValidateExternalBindings(t,e)}),i.namedContent)this.ValidateExternalBindings(i.namedContent[a],e)}else{var r=t;if(r instanceof ft&&r.isExternal){var o=r.targetPathString;if(!this._externals[o])if(this.allowExternalFunctionFallbacks)!!this.mainContentContainer.namedContent[o]||e.push(o);else e.push(o)}}else{e=[];if(this.ValidateExternalBindings(this._mainContentContainer,e),this._hasValidatedExternals=!0,0==e.length)this._hasValidatedExternals=!0;else{var s="Error: Missing function binding for external";s+=1<e.length?"s":"",s+=": '",s+=e.join("', '"),s+="' ",s+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(s)}}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null==this._variableObservers&&(this._variableObservers={}),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new it("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers[t]?this._variableObservers[t].push(e):this._variableObservers[t]=[e]}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!=this._variableObservers)if(void 0!==e)this._variableObservers[e]&&this._variableObservers[e].splice(this._variableObservers[e].indexOf(t),1);else for(var n in this._variableObservers)this._variableObservers[n].splice(this._variableObservers[n].indexOf(t),1)}},{key:"VariableStateDidChangeEvent",value:function(e,t){if(null!=this._variableObservers){var n=this._variableObservers[e];if(void 0!==n){if(!(t instanceof N))throw"Tried to get the value of a variable that isn't a standard type";var i=t;n.forEach(function(t){t(e,i.valueObject)})}}}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){for(var e=new O(t),n=this.ContentAtPath(e).container;;){var i=n.content[0];if(!(i instanceof Container))break;n=i}var a=null;return n.content.every(function(t){var e=t;return e instanceof F&&(null==a&&(a=[]),a.push(e.text),!0)}),a}},{key:"BuildStringOfHierarchy",value:function(){var t=new nt;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new nt;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){if((this.state.previousPointer=this.state.currentPointer.copy(),this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=ct.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(ht)?(this.state.PopCallStack(ht),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new pt),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement.currentPointer.copy();for(e.index++;e.index>=e.container.content.length;){t=!1;var n=e.container.parent;if(n instanceof Container==!1)break;var i=n.content.indexOf(e.container);if(-1==i)break;(e=new ct(n,i)).index++,t=!0}return t||(e=ct.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.isInvisibleDefault});if(0==e.length||t.length>e.length)return!1;var n=e[0];return this.ChoosePath(n.targetPath),!0}},{key:"VisitCountForContainer",value:function(t){if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var e=0,n=t.path.toString();return e=this.state.visitCounts[n]||e}},{key:"IncrementVisitCountForContainer",value:function(t){var e=0,n=t.path.toString();this.state.visitCounts[n]&&(e=this.state.visitCounts[n]),e++,this.state.visitCounts[n]=e}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e=t.path.toString();this.state.turnIndices[e]=this.state.currentTurnIndex}},{key:"TurnsSinceForContainer",value:function(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var e=t.path.toString(),n=this.state.turnIndices[e];return void 0!==n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var t=this.state.PopEvaluationStack();if(!(t instanceof at))return this.Error("expected number of elements in sequence for shuffle index"),0;for(var e=this.state.currentPointer.container,n=t.value,i=this.state.PopEvaluationStack().value,a=i/n,r=i%n,o=e.path.toString(),s=0,u=0,l=o.length;u<l;u++)s+=o.charCodeAt(u)||0;var h=s+a+this.state.storySeed,c=new mt(parseInt(h)),f=[];for(u=0;u<n;++u)f.push(u);for(u=0;u<=r;++u){var v=c.next()%f.length,d=f[v];if(f.splice(v,1),u==r)return d}throw"Should never reach here"}},{key:"Error",value:function(t,e){throw new it(t)}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t,e,n){var i=e?"WARNING":"ERROR";t=this.state.currentPointer.isNull?"RUNTIME "+i+": "+t:"RUNTIME "+i+": ("+this.state.currentPath+"): "+t,this.state.AddError(t,e),e||this.state.ForceEnd()}},{key:"currentChoices",get:function(){var e=[];return this._state.currentChoices.forEach(function(t){t.isInvisibleDefault||(t.index=e.length,e.push(t))}),e}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}}]),u}(),R={NoChange:0,ExtendedBeyondNewline:1,NewlineRemoved:2};t.Story=w,t.InkList=x,Object.defineProperty(t,"__esModule",{value:!0})},"object"===M(e)&&void 0!==t?s(e):(r=[e],void 0===(o="function"==typeof(a=s)?a.apply(e,r):a)||(t.exports=o))},function(t,e,n){t.exports=n(2)},function(t,e,n){"use strict";n.r(e);var r=n(0);function o(t){var r={};return t.forEach(function(t){var e=t.split(":"),n=e[0].trim(),i=e.slice(1).join(":").trim(),a=i.substr(0,1);"{"!==a&&"["!==a||(i=JSON.parse(i)),r[n]=i}),r}var s=function(t,e){for(var n={type:"text",content:[],text:[],tags:{},choices:[]};t.canContinue;){t.Continue();var i=t.currentText;if(0===i.indexOf(">>>")){var a=e.run(i,t);a&&n.text.push(a)}else n.text.push(i);var r=o(t.currentTags);r.scene&&(n.type=r.scene),n.tags=Object.assign({},n.tags,r),n.content.push({text:i,tags:r})}return t.currentChoices.forEach(function(t,e){n.choices.push({id:e,choice:t.text})}),n};function i(t){return(i="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function u(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function l(t,e){return!e||"object"!==i(e)&&"function"!=typeof e?function(t){if(void 0!==t)return t;throw new ReferenceError("this hasn't been initialised - super() hasn't been called")}(t):e}function h(t){return(h=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function c(t,e){return(c=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}var a=function(t){function n(t){var e;return function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,n),(e=l(this,h(n).call(this,t))).$episode=[],e.$sceneId=-1,e}var e,i,a;return function(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&c(t,e)}(n,r["Story"]),e=n,(i=[{key:"clearEpisode",value:function(){this.$episode.splice(0),this.$sceneId=-1}},{key:"getCurrentEpisode",value:function(){return this.$episode}},{key:"getCurrentScene",value:function(){return this.$episode[this.$episode.length-1]}},{key:"renderScene",value:function(t){var e=s(this,t);return this.updateEpisode(e)}},{key:"updateEpisode",value:function(t){return 0<=this.$sceneId&&(this.$episode[this.$sceneId].isActive=!1),this.$sceneId+=1,t.isActive=!0,t.id=this.$sceneId,this.$episode.push(t),t}},{key:"getState",value:function(){return{episode:this.$episode,story:JSON.parse(this.state.toJson())}}},{key:"restoreState",value:function(t){this.$episode=t.episode,this.state.LoadJson(JSON.stringify(t.story))}},{key:"getVar",value:function(t){return this.variablesState[t]}},{key:"getVars",value:function(){var e=this.variablesState,n={};return Object.keys(e._globalVariables).forEach(function(t){n[t]=e[t]}),n}},{key:"setVar",value:function(t,e){this.variablesState[t]=e}},{key:"setVars",value:function(e){var n=this;Object.keys(e).forEach(function(t){n.variablesState[t]=e[t]})}},{key:"getVisitCount",value:function(t){this.state.VisitCountAtPathString(t)}}])&&u(e.prototype,i),a&&u(e,a),n}();function f(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var v=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.commands={}}var e,n,i;return e=t,(n=[{key:"register",value:function(t,e){this.commands[t]=e}},{key:"run",value:function(t,e){var n=t.replace(/(\r\n\t|\n|\r\t)/gm,"").split(" "),i=n[1],a=n.slice(2);return i in this.commands?this.commands[i](a,e,i):t}}])&&f(e.prototype,n),i&&f(e,i),t}();function d(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var p=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.observers={}}var e,n,i;return e=t,(n=[{key:"register",value:function(e){var n=this;Object.keys(e).forEach(function(t){n.observers[t]=e[t]})}},{key:"attach",value:function(e){var n=this;Object.keys(this.observers).forEach(function(t){e.ObserveVariable(t,n.observers[t])})}}])&&d(e.prototype,n),i&&d(e,i),t}();function y(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var m=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.functions={}}var e,n,i;return e=t,(n=[{key:"register",value:function(e){var n=this;Object.keys(e).forEach(function(t){n.functions[t]=e[t]})}},{key:"attach",value:function(e){var n=this;Object.keys(this.functions).forEach(function(t){e.BindExternalFunction(t,n.functions[t])})}}])&&y(e.prototype,n),i&&y(e,i),t}();function g(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function k(t){return new Promise(function(){throw new Error("".concat(t," is not implemented"))})}var S=function(){function e(t){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,e),this.game=t,this.events={loadStory:function(){return k("loadStory")},loadGame:function(){return k("loadGame")},saveGame:function(){return k("saveGame")},error:function(){return k("error")}},this.inkObservers=new p,this.inkFunctions=new m,this.inkCommands=new v,this.story={},this.transcript=[]}var t,n,i;return t=e,(n=[{key:"startGame",value:function(){var t=this;return this.loadStoryFile().then(function(){t.story.clearEpisode()})}},{key:"loadGame",value:function(t){var e=this,n={};return this.dispatch("loadGame",t).then(function(t){return n=JSON.parse(t),e.loadStoryFile()}).then(function(){e.story.restoreState(n)})}},{key:"saveGame",value:function(t){return this.dispatch("saveGame",{id:t,data:this.story.getState()})}},{key:"renderScene",value:function(){var t=this.story.renderScene(this.inkCommands);return this.game.transcript&&this.transcript.push(t),t}},{key:"getTranscript",value:function(){return this.transcript}},{key:"makeChoice",value:function(n){var i=this;return new Promise(function(t,e){try{i.game.transcript&&(i.transcript[i.transcript.length-1].chosen=n),i.story.ChooseChoiceIndex(n)}catch(t){i.dispatch("error",t),e(t)}t()})}},{key:"loadStoryFile",value:function(){var i=this;return this.dispatch("loadStory",this.game.storyFile).then(function(t){var e=t;if("string"==typeof t){var n=t.replace("\ufeff","");e=JSON.parse(n)}i.initEpisode(e)})}},{key:"initEpisode",value:function(t){var e=new a(t);this.inkObservers.attach(e),this.inkFunctions.attach(e),this.story=e}},{key:"on",value:function(t,e){this.events[t]=e}},{key:"dispatch",value:function(t,e){return this.events[t](e)}},{key:"registerFunctions",value:function(t){this.inkFunctions.register(t)}},{key:"registerObservers",value:function(t){this.inkObservers.register(t)}},{key:"registerCommand",value:function(t,e){this.inkCommands.register(t,e)}},{key:"debug",value:function(){return this.story.state}}])&&g(t.prototype,n),i&&g(t,i),e}();e.default=S}])});
//# sourceMappingURL=atrament.js.map