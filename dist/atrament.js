!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Atrament=e():t.Atrament=e()}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var a=e[i]={i:i,l:!1,exports:{}};return t[i].call(a.exports,a,a.exports,n),a.l=!0,a.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var a in t)n.d(i,a,function(e){return t[e]}.bind(null,a));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/",n(n.s=8)}([function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var a=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.functions={}}return i(t,[{key:"register",value:function(t){var e=this;Object.keys(t).forEach(function(n){e.functions[n]=t[n]})}},{key:"attach",value:function(t){var e=this;Object.keys(this.functions).forEach(function(n){t.bindFunction(n,e.functions[n])})}}]),t}();e.default=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var a=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.observers={}}return i(t,[{key:"register",value:function(t){var e=this;Object.keys(t).forEach(function(n){e.observers[n]=t[n]})}},{key:"attach",value:function(t){var e=this;Object.keys(this.observers).forEach(function(n){t.observeVar(n,e.observers[n])})}}]),t}();e.default=a},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}();var a=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.dependencies=e,this.commands={}}return i(t,[{key:"register",value:function(t,e,n){this.commands[t]={callback:e,deps:n}}},{key:"run",value:function(t){var e=this,n=t.replace(/(\r\n\t|\n|\r\t)/gm,"").split(" "),i=n[1],a=n.slice(2);if(!(i in this.commands))return t;var r=this.commands[i],o=[];return r.deps&&r.deps.forEach(function(t){o.push(e.dependencies[t])}),r.callback.apply(r,[a].concat(o))}}]),t}();e.default=a},function(t,e,n){"use strict";function i(t){var e={};return t.forEach(function(t){var n=t.split(":"),i=n[0].trim(),a=n.slice(1).join(":").trim();"{"===a.substr(0,1)&&(a=JSON.parse(a)),e[i]=a}),e}Object.defineProperty(e,"__esModule",{value:!0}),e.default=function(t,e){for(var n={type:"text",text:[],tags:{},choices:[]};t.canContinue;){t.Continue();var a=t.currentText;if(0===a.indexOf(">>>")){var r=e.run(a);r&&n.text.push(r)}else n.text.push(a);var o=i(t.currentTags);o.scene&&(n.type=o.scene),n.tags=Object.assign({},n.tags,o)}return t.currentChoices.forEach(function(t,e){n.choices.push({id:e,choice:t.text})}),n}},function(t,e,n){"use strict";var a,r,o,s=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),u="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t};function l(t,e){if(!t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return!e||"object"!=typeof e&&"function"!=typeof e?t:e}function h(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function, not "+typeof e);t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,enumerable:!1,writable:!0,configurable:!0}}),e&&(Object.setPrototypeOf?Object.setPrototypeOf(t,e):t.__proto__=e)}function c(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}!function(n,i){"object"===u(e)&&void 0!==t?i(e):(r=[e],void 0===(o="function"==typeof(a=i)?a.apply(e,r):a)||(t.exports=o))}(0,function(t){var e=function(){function t(){c(this,t),this._isRelative,this._components=[],"string"==typeof arguments[0]?this.componentsString=arguments[0]:arguments[0]instanceof n&&arguments[1]instanceof t?(this._components.push(arguments[0]),this._components=this._components.concat(arguments[1])):arguments[0]instanceof Array&&(this._components=this._components.concat(arguments[0]),this._isRelative=!!arguments[1])}return s(t,[{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,a=0;a<e.components.length&&e.components[a].isParent;++a)i++;for(a=0;a<this.components.length-i;++a)n.components.push(this.components[a]);for(a=i;a<e.components.length;++a)n.components.push(e.components[a]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t.components.length!=this.components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t.components.length;e<n;e++)if(!t.components[e].Equals(this.components[e]))return!1;return!0}},{key:"isRelative",get:function(){return this._isRelative}},{key:"components",get:function(){return this._components}},{key:"head",get:function(){return this.components.length>0?this.components[0]:null}},{key:"tail",get:function(){return this.components.length>=2?new t(this.components.slice(1,this.components.length)):t.self}},{key:"length",get:function(){return this.components.length}},{key:"lastComponent",get:function(){return this.components.length>0?this.components[this.components.length-1]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this.components.length;t<e;t++)if(!this.components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){var t=this.components.join(".");return this.isRelative?"."+t:t},set:function(t){var e=this;this.components.length=0;var i=t;null!=i&&""!=i&&("."==i[0]&&(this._isRelative=!0,i=i.substring(1)),i.split(".").forEach(function(t){/^(\-|\+)?([0-9]+|Infinity)$/.test(t)?e.components.push(new n(parseInt(t))):e.components.push(new n(t))}))}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}(),n=function(){function t(e){c(this,t),"string"==typeof e?(this._index=-1,this._name=e):(this._index=parseInt(e),this._name=null)}return s(t,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}},{key:"index",get:function(){return this._index}},{key:"name",get:function(){return this._name}},{key:"isIndex",get:function(){return this.index>=0}},{key:"isParent",get:function(){return this.name==e.parentId}}],[{key:"ToParent",value:function(){return new t(e.parentId)}}]),t}();e.parentId="^",e.Component=n;var a=function(){function t(){c(this,t),this.parent=null,this._path=null}return s(t,[{key:"ResolvePath",value:function(t){if(t.isRelative){var e=this;return e instanceof Container==!1&&(null==this.parent&&console.warn("Can't resolve relative path because we don't have a parent"),"Container"!==(e=this.parent).constructor.name&&console.warn("Expected parent to be a container"),t=t.tail),e.ContentAtPath(t)}return this.rootContentContainer.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var n=this.path,i=Math.min(t.components.length,n.components.length),a=-1,r=0;r<i;++r){var o=n.components[r],s=t.components[r];if(!o.Equals(s))break;a=r}if(-1==a)return t;for(var u=n.components.length-1-a,l=[],h=0;h<u;++h)l.push(e.Component.ToParent());for(var c=a+1;c<t.components.length;++c)l.push(t.components[c]);return new e(l,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString);return n.Length<e.Length?n:e}},{key:"Copy",value:function(){throw"Not Implemented"}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new e;else{for(var t=[],n=this,i=n.parent;i instanceof Container;){var a=n;a.name&&a.hasValidName?t.unshift(new e.Component(a.name)):t.unshift(new e.Component(i.content.indexOf(n))),n=i,i=i.parent}this._path=new e(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return t}}]),t}(),r=function(){function t(e){c(this,t),e=void 0!==e?e.toString():"",this._string=e}return s(t,[{key:"Append",value:function(t){this._string+=t}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this._string+="\n"}},{key:"AppendFormat",value:function(t){var e=Array.prototype.slice.call(arguments,1);return t.replace(/{(\d+)}/g,function(t,n){return void 0!==e[n]?e[n]:t})}},{key:"toString",value:function(){return this._string}},{key:"Length",get:function(){return this._string.length}}]),t}(),o=function(){function t(e,n){if(c(this,t),void 0!==n)this.originName=e,this.itemName=n;else{var i=e.toString().split(".");this.originName=i[0],this.itemName=i[1]}}return s(t,[{key:"isNull",value:function(){return null==this.originName&&null==this.itemName}},{key:"toString",value:function(){return this.fullname}},{key:"Equals",value:function(e){if(e instanceof t){var n=e;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"toString",value:function(){var t="0",e=this.itemName?this.itemName.toString():"null";return null!=this.originName&&(t=this.originName.toString()),t+e}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"Null",value:function(){return new t(null,null)}}]),t}(),f=function(){function t(e,n){var i=this;if(c(this,t),this._keys={},this._values={},this.origins=null,this._originNames=null,e)if(e instanceof t){var a=e;a.forEach(function(t){i.Add(t.Key,t.Value)}),this._originNames=a._originNames}else if("string"==typeof e){this.SetInitialOriginName(e);var r=null;if(!(r=n.listDefinitions.TryGetDefinition(e,r)))throw new Error("InkList origin could not be found in story when constructing new list: "+singleOriginListName);this.origins=[r]}else if(e.hasOwnProperty("Key")&&e.hasOwnProperty("Value")){var o=e;this.Add(o.Key,o.Value)}}return s(t,[{key:"forEach",value:function(t){for(var e in this._values)t({Key:this._keys[e],Value:this._values[e]})}},{key:"AddItem",value:function(t){var e=this;if(t instanceof o){if(null==(a=t).originName)return void this.AddItem(a.itemName);throw this.origins.forEach(function(t){if(t.name==a.originName){var n;if(void 0!==(n=t.TryGetValueForItem(a,n)))return void e.Add(a,n);throw"Could not add the item "+a+" to this list because it doesn't exist in the original list definition in ink."}}),"Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found."}var n=t,i=null;if(this.origins.forEach(function(t){if(t.ContainsItemWithName(n)){if(null!=i)throw"Could not add the item "+n+" to this list because it could come from either "+t.name+" or "+i.name;i=t}}),null==i)throw"Could not add the item "+n+" to this list because it isn't known to any list definitions previously associated with this list.";var a=new o(i.name,n),r=i.ValueForItem(a);this.Add(a,r)}},{key:"ContainsItemNamed",value:function(t){var e=!1;return this.forEach(function(n){n.Key.itemName==t&&(e=!0)}),e}},{key:"ContainsKey",value:function(t){return t in this._values}},{key:"Add",value:function(t,e){this._keys[t]=t,this._values[t]=e}},{key:"Remove",value:function(t){delete this._values[t],delete this._keys[t]}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"Union",value:function(e){var n=new t(this);return e.forEach(function(t){n.Add(t.Key,t.Value)}),n}},{key:"Intersect",value:function(e){var n=new t;return this.forEach(function(t){e.ContainsKey(t.Key)&&n.Add(t.Key,t.Value)}),n}},{key:"Without",value:function(e){var n=new t(this);return e.forEach(function(t){n.Remove(t.Key)}),n}},{key:"Contains",value:function(t){var e=this,n=!0;return t.forEach(function(t){e.ContainsKey(t.Key)||(n=!1)}),n}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return this.Count>0?new t(this.maxItem):new t}},{key:"MinAsList",value:function(){return this.Count>0?new t(this.minItem):new t}},{key:"Equals",value:function(e){var n=e;if(n instanceof t==!1)return!1;if(n.Count!=this.Count)return!1;var i=!0;return this.forEach(function(t){n.ContainsKey(t.Key)||(i=!1)}),i}},{key:"toString",value:function(){var t=[];this.forEach(function(e){t.push(e)}),t=t.sort(function(t,e){return t.Value===e.Value?0:t.Value>e.Value?1:-1});for(var e=new r,n=0;n<t.length;n++){n>0&&e.Append(", ");var i=t[n].Key;e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return Object.keys(this._values).length}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every(function(n){return n.name!=t||(e=n,!1)}),e}},{key:"originNames",get:function(){var t=this;return this.Count>0&&(null==this._originNames&&this.Count>0?this._originNames=[]:this._originNames.length=0,this.forEach(function(e){t._originNames.push(e.Key.originName)})),this._originNames}},{key:"maxItem",get:function(){var t={Key:null,Value:null};return this.forEach(function(e){(null===t.Key||e.Value>t.Value)&&(t=e)}),t}},{key:"minItem",get:function(){var t={Key:null,Value:null};return this.forEach(function(e){(null===t.Key||e.Value<t.Value)&&(t=e)}),t}},{key:"inverse",get:function(){var e=this,n=new t;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.ContainsKey(t.Key)||n.Add(t.Key,t.Value)})}),n}},{key:"all",get:function(){var e=new t;return null!=this.origins&&this.origins.forEach(function(t){t.items.forEach(function(t){e.Add(t.Key,t.Value)})}),e}}]),t}(),v={Int:0,Float:1,List:2,String:3,DivertTarget:4,VariablePointer:5},d=function(t){function n(t){c(this,n);var e=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._valueType,e._isTruthy,e._valueObject,e}return h(n,a),s(n,[{key:"Cast",value:function(t){throw"Trying to casting an AbstractValue"}},{key:"Copy",value:function(t){return n.Create(t)}},{key:"valueType",get:function(){return this._valueType}},{key:"isTruthy",get:function(){return this._isTruthy}},{key:"valueObject",get:function(){return this._valueObject}}],[{key:"Create",value:function(t){"boolean"==typeof t&&(t=!!t?1:0);return Number.isInteger(Number(t))?new y(t):isNaN(t)?"string"==typeof t?new g(t):t instanceof e?new k(t):t instanceof f?new b(t):null:new m(t)}}]),n}(),p=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.value=t,n}return h(e,d),s(e,[{key:"toString",value:function(){return this.value.toString()}},{key:"value",get:function(){return this._value},set:function(t){this._value=t}},{key:"valueObject",get:function(){return this.value}}]),e}(),y=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||0));return n._valueType=v.Int,n}return h(e,p),s(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==v.Float)return new m(parseFloat(this.value));if(t==v.String)return new g(""+this.value);throw"Unexpected type cast of Value to new ValueType"}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return v.Int}}]),e}(),m=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||0));return n._valueType=v.Float,n}return h(e,p),s(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==v.Int)return new y(parseInt(this.value));if(t==v.String)return new g(""+this.value);throw"Unexpected type cast of Value to new ValueType"}},{key:"isTruthy",get:function(){return 0!=this._value}},{key:"valueType",get:function(){return v.Float}}]),e}(),g=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t||""));return n._valueType=v.String,n._isNewline="\n"==n.value,n._isInlineWhitespace=!0,n.value.split().every(function(t){return" "==t||"\t"==t||(n._isInlineWhitespace=!1,!1)}),n}return h(e,p),s(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;var e,n;if(t==v.Int)return(e=parseInt(value))?new y(e):null;if(t==v.Float)return(n=n(value))?new m(n):null;throw"Unexpected type cast of Value to new ValueType"}},{key:"valueType",get:function(){return v.String}},{key:"isTruthy",get:function(){return this.value.length>0}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),e}(),k=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n._valueType=v.DivertTarget,n}return h(e,p),s(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"targetPath",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a divert target"}}]),e}(),C=function(t){function e(t,n){c(this,e);var i=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return i._valueType=v.VariablePointer,i.contextIndex=void 0!==n?n:-1,i}return h(e,p),s(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new e(this.variableName,this.contextIndex)}},{key:"variableName",get:function(){return this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw"Shouldn't be checking the truthiness of a variable pointer"}}]),e}(),b=function(t){function e(t,n){c(this,e);var i=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,null));return i._valueType=v.List,i.value=t instanceof f?new f(t):void 0!==t&&void 0!==n?new f({Key:t,Value:n}):new f,i}return h(e,p),s(e,[{key:"Cast",value:function(t){var e;if(t==v.Int)return(e=this.value.maxItem).Key.isNull?new y(0):new y(e.Value);if(t==v.Float)return(e=this.value.maxItem).Key.isNull?new m(0):new m(parseFloat(e.Value));if(t==v.String)return(e=value.maxItem).Key.isNull?new g(""):new g(e.Key.toString());if(t==this.valueType)return this;throw"Unexpected type cast of Value to new ValueType"}},{key:"valueType",get:function(){return v.List}},{key:"isTruthy",get:function(){var t=!1;return this.value.forEach(function(e){0!=e.Value&&(t=!0)}),t}}]),s(e,null,[{key:"RetainListOriginsForAssignment",value:function(t,n){var i=t,a=n;i instanceof e&&a instanceof e&&0==a.value.Count&&a.value.SetInitialOriginNames(i.value.originNames)}}]),e}(),S=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this,t));return n.message=t,n.name="StoryException",n}return h(e,Error),e}(),Container=function(t){function Container(){c(this,Container);var t=l(this,(Container.__proto__||Object.getPrototypeOf(Container)).call(this));return t.name="",t._content=[],t.namedContent={},t.visitsShouldBeCounted=!1,t.turnIndexShouldBeCounted=!1,t.countingAtStartOnly=!1,t.CountFlags={Visits:1,Turns:2,CountStartOnly:4},t._pathToFirstLeafContent=null,t}return h(Container,a),s(Container,[{key:"AddContent",value:function(t){var e=this;if(t instanceof Array)t.forEach(function(t){e.AddContent(t)});else{if(this._content.push(t),t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}}},{key:"TryAddNamedContent",value:function(t){t.hasValidName&&t.name&&this.AddToNamedContentOnly(t)}},{key:"AddToNamedContentOnly",value:function(t){t instanceof a==!1&&console.warn("Can only add Runtime.Objects to a Runtime.Container"),t.parent=this,this.namedContent[t.name]=t}},{key:"ContentAtPath",value:function(t,e){e=void 0!==e?e:t.components.length;for(var n=this,i=this,a=0;a<e;++a){var r=t.components[a];if(!(n instanceof Container))throw"Path continued, but previous object wasn't a container: "+i;n=i=n.ContentWithPathComponent(r)}return i}},{key:"InsertContent",value:function(t,e){if(this.content[i]=t,t.parent)throw"content is already in "+t.parent;t.parent=this,this.TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){var e=this;this.content=this.content.concat(t.content),t.content.forEach(function(t){t.parent=e,e.TryAddNamedContent(t)})}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return t.index>=0&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;var e;if(e=this.namedContent[t.name])return e;throw new S("Content '"+t.name+"' not found at path: '"+this.path+"'")}},{key:"BuildStringOfHierarchy",value:function(t,e,n){if(0==arguments.length){t=new r;return this.BuildStringOfHierarchy(t,0,null),t.toString()}function i(){for(var n=0;n<4*e;++n)t.Append(" ")}i(),t.Append("["),this.hasValidName&&t.AppendFormat(" ({0})",this.name),this==n&&t.Append("  <---"),t.AppendLine(),e++;for(var a=0;a<this.content.length;++a){var o=this.content[a];if(o instanceof Container)o.BuildStringOfHierarchy(t,e,n);else i(),o instanceof g?(t.Append('"'),t.Append(o.toString().replace("\n","\\n")),t.Append('"')):t.Append(o.toString());a!=this.content.length-1&&t.Append(","),o instanceof Container||o!=n||t.Append("  <---"),t.AppendLine()}var s={};for(var u in this.namedContent)this.content.indexOf(this.namedContent[u])>=0||(s[u]=this.namedContent[u]);if(Object.keys(s).length>0)for(var u in i(),t.AppendLine("-- named: --"),s){s[u]instanceof Container||console.warn("Can only print out named Containers"),s[u].BuildStringOfHierarchy(t,e,n),t.Append("\n")}e--,i(),t.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&this.name.length>0}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t={};for(var e in this.namedContent)t[e]=this.namedContent[e];return this.content.forEach(function(e){var n=e;n.name&&n.hasValidName&&delete t[n.name]}),0==Object.keys(t).length&&(t=null),t},set:function(t){var e=this.namedOnlyContent;if(null!=e)for(var n in e)delete this.namedContent[n];if(null!=t)for(var n in t){var i=t[n];i.name&&void 0!==i.hasValidName&&this.AddToNamedContentOnly(i)}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=this.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=this.CountFlags.Turns),this.countingAtStartOnly&&(t|=this.CountFlags.CountStartOnly),t==this.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var e=t;(e&this.CountFlags.Visits)>0&&(this.visitsShouldBeCounted=!0),(e&this.CountFlags.Turns)>0&&(this.turnIndexShouldBeCounted=!0),(e&this.CountFlags.CountStartOnly)>0&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=new Path,e=this;e instanceof Container;)e.content.length>0&&(t.components.push(new Path.Component(0)),e=e.content[0]);return t}}]),Container}(),_=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.glueType=t,n}return h(e,a),s(e,[{key:"toString",value:function(){switch(this.glueType){case T.Bidirectional:return"BidirGlue";case T.Left:return"LeftGlue";case T.Right:return"RightGlue"}return"UnexpectedGlueType"}},{key:"isLeft",get:function(){return this.glueType==T.Left}},{key:"isBi",get:function(){return this.glueType==T.Bidirectional}},{key:"isRight",get:function(){return this.glueType==T.Right}}]),e}(),T={Bidirectional:0,Left:1,Right:2},O=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n._commandType=void 0!==t?t:E.NotSet,n}return h(e,a),s(e,[{key:"copy",value:function(){return new e(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}},{key:"commandType",get:function(){return this._commandType}}],[{key:"EvalStart",value:function(){return new e(E.EvalStart)}},{key:"EvalOutput",value:function(){return new e(E.EvalOutput)}},{key:"EvalEnd",value:function(){return new e(E.EvalEnd)}},{key:"Duplicate",value:function(){return new e(E.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new e(E.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new e(E.PopFunction)}},{key:"PopTunnel",value:function(){return new e(E.PopTunnel)}},{key:"BeginString",value:function(){return new e(E.BeginString)}},{key:"EndString",value:function(){return new e(E.EndString)}},{key:"NoOp",value:function(){return new e(E.NoOp)}},{key:"ChoiceCount",value:function(){return new e(E.ChoiceCount)}},{key:"TurnsSince",value:function(){return new e(E.TurnsSince)}},{key:"ReadCount",value:function(){return new e(E.ReadCount)}},{key:"Random",value:function(){return new e(E.Random)}},{key:"SeedRandom",value:function(){return new e(E.SeedRandom)}},{key:"VisitIndex",value:function(){return new e(E.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new e(E.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new e(E.StartThread)}},{key:"Done",value:function(){return new e(E.Done)}},{key:"End",value:function(){return new e(E.End)}},{key:"ListFromInt",value:function(){return new e(E.ListFromInt)}},{key:"ListRange",value:function(){return new e(E.ListRange)}}]),e}(),E={NotSet:-1,EvalStart:0,EvalOutput:1,EvalEnd:2,Duplicate:3,PopEvaluatedValue:4,PopFunction:5,PopTunnel:6,BeginString:7,EndString:8,NoOp:9,ChoiceCount:10,TurnsSince:11,Random:12,SeedRandom:13,VisitIndex:14,SequenceShuffleIndex:15,StartThread:16,Done:17,End:18,ListFromInt:19,ListRange:20,ReadCount:21};E.TOTAL_VALUES=Object.keys(E).length-1,O.CommandType=E;var w={Tunnel:0,Function:1},x=function(t){function n(t){c(this,n);var e=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._targetPath,e._targetContent,e.variableDivertName,e.pushesToStack,e.stackPushType,e.isExternal,e.isConditional,e.externalArgs,e.pushesToStack=!1,t&&(e.pushesToStack=!0,e.stackPushType=t),e}return h(n,a),s(n,[{key:"Equals",value:function(t){var e=t;return e instanceof n&&this.hasVariableTarget==e.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==e.variableDivertName:this.targetPath.Equals(e.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new r,e=this.targetPath.toString();return t.Append("Divert"),this.pushesToStack&&(this.stackPushType==w.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetContent;t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetContent=null}},{key:"targetContent",get:function(){return null==this._targetContent&&(this._targetContent=this.ResolvePath(this._targetPath)),this._targetContent}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new e(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),n}(),I=function(t){function n(t){c(this,n);var e=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e._pathOnChoice,e.hasCondition,e.hasStartContent,e.hasChoiceOnlyContent,e.onceOnly,e.isInvisibleDefault,e.onceOnly=!!t,e}return h(n,a),s(n,[{key:"toString",value:function(){var t=this.pathOnChoice.toString();return"Choice: -> "+t}},{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return this.ResolvePath(this._pathOnChoice)}},{key:"pathStringOnChoice",get:function(){return this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new e(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=(1&t)>0,this.hasStartContent=(2&t)>0,this.hasChoiceOnlyContent=(4&t)>0,this.isInvisibleDefault=(8&t)>0,this.onceOnly=(16&t)>0}}]),n}(),P=function(t){function n(t){c(this,n);var e=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));return e.name=t,e.pathForCount,e}return h(n,a),s(n,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return this.ResolvePath(this.pathForCount)}},{key:"pathStringForCount",get:function(){return null==this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null==t?null:new e(t)}}]),n}(),A=function(t){function e(t,n){c(this,e);var i=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return i._variableName=t||null,i._isNewDeclaration=!!n,i.isGlobal,i}return h(e,a),s(e,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}},{key:"variableName",get:function(){return this._variableName}},{key:"isNewDeclaration",get:function(){return this._isNewDeclaration}}]),e}(),V=function(t){function e(){return c(this,e),l(this,(e.__proto__||Object.getPrototypeOf(e)).apply(this,arguments))}return h(e,a),e}(),N=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n.name=t,n._numberOfParameters,n._prototype,n._isPrototype,n._operationFuncs=null,e.GenerateNativeFunctionsIfNecessary(),n}return h(e,a),s(e,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw"Unexpected number of parameters";var e=!1;if(t.forEach(function(t){if(t instanceof V)throw new S("Attempting to perform operation on a void value. Did you forget to 'return' a value from a function you called here?");t instanceof b&&(e=!0)}),2==t.length&&e)return this.CallBinaryListOperation(t);var n=this.CoerceValuesToSingleType(t),i=n[0].valueType;return i==v.Int?this.CallType(n):i==v.Float?this.CallType(n):i==v.String?this.CallType(n):i==v.DivertTarget?this.CallType(n):i==v.List?this.CallType(n):null}},{key:"CallType",value:function(t){var e=t[0],n=e.valueType,i=e,a=t.length;if(2==a||1==a){var r=this._operationFuncs[n];if(!r)throw new S("Cannot perform operation '"+this.name+"' on "+n);if(2==a){var o=t[1],s=r(i.value,o.value);return p.Create(s)}s=r(i.value);return p.Create(s)}throw"Unexpected number of parameters to NativeFunctionCall: "+t.length}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof b&&t[1]instanceof y)return this.CallListIncrementOperation(t);var e=t[0],n=t[1];if(!("&&"!=this.name&&"||"!=this.name||e.valueType==v.List&&n.valueType==v.List)){var i=(0,this._operationFuncs[v.Int])(e.isTruthy?1:0,n.isTruthy?1:0);return new y(i)}if(e.valueType==v.List&&n.valueType==v.List)return this.CallType([e,n]);throw new S("Can not call use '"+this.name+"' operation on "+e.valueType+" and "+n.valueType)}},{key:"CallListIncrementOperation",value:function(t){var e=this,n=t[0],i=t[1],a=new f;return n.value.forEach(function(t){var r=t.Key,o=t.Value,s=(0,e._operationFuncs[v.Int])(o,i.value),u=null;if(n.value.origins.forEach(function(t){if(t.name==r.originName)return u=t,!1}),null!=u){var l=u.TryGetItemWithValue(s);l.exists&&a.Add(l.item,s)}}),new b(a)}},{key:"CoerceValuesToSingleType",value:function(t){var e=v.Int,n=null;t.forEach(function(t){var i=t;i.valueType>e&&(e=i.valueType),i.valueType==v.List&&(n=i)});var i=[];return e==v.List?t.forEach(function(t){if(t.valueType==v.List)i.push(t);else{if(t.valueType!=v.Int)throw new S("Cannot mix Lists and "+t.valueType+" values in this operation");var e=parseInt(t.valueObject),a=n.value.originOfMaxItem,r=a.TryGetItemWithValue(e);if(!r.exists)throw new S("Could not find List item with the value "+e+" in "+a.name);var o=new b(r.item,e);i.push(o)}}):t.forEach(function(t){var n=t.Cast(e);i.push(n)}),i}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs={}),this._operationFuncs[t]=e}},{key:"toString",value:function(){return"Native '"+this.name+"'"}},{key:"name",get:function(){return this._name},set:function(t){this._name=t,this._isPrototype||(this._prototype=e._nativeFunctions[this._name])}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"internalConstructor",value:function(t,n){var i=new e(t);return i._isPrototype=!0,i.numberOfParameters=n,i}},{key:"CallWithName",value:function(t){return new e(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions[t]}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){if(null==this._nativeFunctions){this._nativeFunctions={},this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return parseInt(t/e)}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddIntBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddIntBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddIntUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddFloatBinaryOp(this.Greater,function(t,e){return t>e?1:0}),this.AddFloatBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return t>=e?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e?1:0}),this.AddStringBinaryOp(this.NotEquals,function(t,e){return t!==e?1:0}),this.AddListBinaryOp(this.Add,function(t,e){return t.Union(e)}),this.AddListBinaryOp(this.Subtract,function(t,e){return t.Without(e)}),this.AddListBinaryOp(this.Has,function(t,e){return t.Contains(e)?1:0}),this.AddListBinaryOp(this.Hasnt,function(t,e){return t.Contains(e)?0:1}),this.AddListBinaryOp(this.Intersect,function(t,e){return t.Intersect(e)}),this.AddListBinaryOp(this.Equal,function(t,e){return t.Equals(e)?1:0}),this.AddListBinaryOp(this.Greater,function(t,e){return t.GreaterThan(e)?1:0}),this.AddListBinaryOp(this.Less,function(t,e){return t.LessThan(e)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(t,e){return t.GreaterThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,function(t,e){return t.LessThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.NotEquals,function(t,e){return t.Equals(e)?0:1}),this.AddListBinaryOp(this.And,function(t,e){return t.Count>0&&e.Count>0?1:0}),this.AddListBinaryOp(this.Or,function(t,e){return t.Count>0||e.Count>0?1:0}),this.AddListUnaryOp(this.Not,function(t){return 0==t.Count?1:0}),this.AddListUnaryOp(this.Invert,function(t){return t.inverse}),this.AddListUnaryOp(this.All,function(t){return t.all}),this.AddListUnaryOp(this.ListMin,function(t){return t.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(t){return t.MaxAsList()}),this.AddListUnaryOp(this.Count,function(t){return t.Count}),this.AddListUnaryOp(this.ValueOfList,function(t){return t.maxItem.Value});this.AddOpToNativeFunc(this.Equal,2,v.DivertTarget,function(t,e){return t.Equals(e)?1:0})}}},{key:"AddOpToNativeFunc",value:function(t,n,i,a){var r=this._nativeFunctions[t];r||(r=e.internalConstructor(t,n),this._nativeFunctions[t]=r),r.AddOpFuncForType(i,a)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,v.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,v.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,v.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,v.List,e)}}]),e}();N.Add="+",N.Subtract="-",N.Divide="/",N.Multiply="*",N.Mod="%",N.Negate="_",N.Equal="==",N.Greater=">",N.Less="<",N.GreaterThanOrEquals=">=",N.LessThanOrEquals="<=",N.NotEquals="!=",N.Not="!",N.And="&&",N.Or="||",N.Min="MIN",N.Max="MAX",N.Has="?",N.Hasnt="!?",N.Intersect="^",N.ListMin="LIST_MIN",N.ListMax="LIST_MAX",N.All="LIST_ALL",N.Count="LIST_COUNT",N.ValueOfList="LIST_VALUE",N.Invert="LIST_INVERT",N._nativeFunctions=null;var F=function(t){function e(t){c(this,e);var n=l(this,(e.__proto__||Object.getPrototypeOf(e)).call(this));return n._text=t.toString()||"",n}return h(e,a),s(e,[{key:"toString",value:function(){return"# "+this._text}},{key:"text",get:function(){return this._text}}]),e}(),j=function(){function t(e){c(this,t),this.text,this.index,this.choicePoint,this.threadAtGeneration,this._originalThreadIndex,this._originalChoicePath,e&&(this.choicePoint=e)}return s(t,[{key:"pathStringOnChoice",get:function(){return this.choicePoint.pathStringOnChoice}},{key:"sourcePath",get:function(){return this.choicePoint.path.componentsString}}]),t}(),L=function(){function t(e,n){c(this,t),this._name=e||"",this._items=null,this._rawListItemsKeys=null,this._itemNameToValues=n||{}}return s(t,[{key:"forEachItems",value:function(t){for(var e in this._rawListItemsKeys)t({Key:this._rawListItemsKeys[e],Value:this._items[e]})}},{key:"ValueForItem",value:function(t){var e=this._itemNameToValues[t.itemName];return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return t.originName==this.name&&t.itemName in this._itemNameToValues}},{key:"ContainsItemWithName",value:function(t){return void 0!==this._itemNameToValues[t]}},{key:"TryGetItemWithValue",value:function(t,e){for(var n in this._itemNameToValues)if(this._itemNameToValues[n]==t)return{item:new o(this.name,n),exists:!0};return{item:o.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t,e){return intVal=this._itemNameToValues[t.itemName],intVal}},{key:"ListRange",value:function(t,e){var n=new f;for(var i in this._itemNameToValues)if(this._itemNameToValues[i]>=t&&this._itemNameToValues[i]<=e){var a=new o(this.name,i);n.Add(a,this._itemNameToValues[i])}return new b(n)}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items)for(var t in this._items={},this._rawListItemsKeys={},this._itemNameToValues){var e=new o(this.name,t);this._rawListItemsKeys[e]=e,this._items[e]=this._itemNameToValues[t]}return this._items.forEach=this.forEachItems.bind(this),this._items}}]),t}(),R=function(){function t(e){var n=this;c(this,t),this._lists={},e.forEach(function(t){n._lists[t.name]=t})}return s(t,[{key:"TryGetDefinition",value:function(t,e){return t in this._lists?this._lists[t]:e}},{key:"FindSingleItemListWithName",value:function(t){var e=o.Null,n=null,i=t.split(".");if(2==i.length)e=new o(i[0],i[1]),n=this.TryGetDefinition(e.originName,n);else for(var a in this._lists){var r=this._lists[a];if(e=new o(a,t),r.ContainsItem(e)){n=r;break}}if(null!=n){var s=n.ValueForItem(e);return new b(e,s)}return null}},{key:"lists",get:function(){var t=[];for(var e in this._lists)t.push(this._lists[e]);return t}}]),t}(),D=function(){function t(){c(this,t)}return s(t,null,[{key:"ListToJArray",value:function(t){var e=this,n=[];return t.forEach(function(t){n.push(e.RuntimeObjectToJToken(t))}),n}},{key:"JArrayToRuntimeObjList",value:function(t,e){var n=t.length;e&&n--;for(var i=[],a=0;a<n;a++){var r=t[a],o=this.JTokenToRuntimeObject(r);i.push(o)}return i}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e={};for(var n in t)e[n]=this.JTokenToRuntimeObject(t[n]);return e}},{key:"DictionaryRuntimeObjsToJObject",value:function(t){var e={};for(var n in t){var i=t[n];i instanceof a&&(e[n]=this.RuntimeObjectToJToken(i))}return e}},{key:"JObjectToIntDictionary",value:function(t){var e={};for(var n in t)e[n]=parseInt(t[n]);return e}},{key:"IntDictionaryToJObject",value:function(t){var e={};for(var n in t)e[n]=t[n];return e}},{key:"JTokenToRuntimeObject",value:function(t){if(!isNaN(t)&&"\n"!==t)return p.Create(t);if("string"==typeof t){var n=t.toString(),i=n[0];if("^"==i)return new g(n.substring(1));if("\n"==i&&1==n.length)return new g("\n");if("<>"==n)return new _(T.Bidirectional);if("G<"==n)return new _(T.Left);if("G>"==n)return new _(T.Right);for(var a=0;a<B.length;++a){if(n==B[a])return new O(a)}if("L^"==n&&(n="^"),N.CallExistsWithName(n))return N.CallWithName(n);if("->->"==n)return O.PopTunnel();if("~ret"==n)return O.PopFunction();if("void"==n)return new V}if("object"===(void 0===t?"undefined":u(t))&&t instanceof Array==!1){var r,s=t;if(s["^->"])return r=s["^->"],new k(new e(r.toString()));if(s["^var"]){r=s["^var"];var l=new C(r.toString());return s.ci&&(r=s.ci,l.contextIndex=parseInt(r)),l}var h=!1,c=!1,v=w.Function,d=!1;if((r=s["->"])?h=!0:(r=s["f()"])?(h=!0,c=!0,v=w.Function):(r=s["->t->"])?(h=!0,c=!0,v=w.Tunnel):(r=s["x()"])&&(h=!0,d=!0,c=!1,v=w.Function),h){var y=new x;y.pushesToStack=c,y.stackPushType=v,y.isExternal=d;var m=r.toString();return(r=s.var)?y.variableDivertName=m:y.targetPathString=m,y.isConditional=!!s.c,d&&(r=s.exArgs)&&(y.externalArgs=parseInt(r)),y}if(r=s["*"]){var S=new I;return S.pathStringOnChoice=r.toString(),(r=s.flg)&&(S.flags=parseInt(r)),S}if(r=s["VAR?"])return new P(r.toString());if(r=s["CNT?"]){var E=new P;return E.pathStringForCount=r.toString(),E}var j=!1,L=!1;if((r=s["VAR="])?(j=!0,L=!0):(r=s["temp="])&&(j=!0,L=!1),j){var R=r.toString(),D=!s.re,G=new A(R,D);return G.isGlobal=L,G}if(void 0!==s["#"])return r=s["#"],new F(r.toString());if(r=s.list){var J=r,M=new f;if(r=s.origins){var W=r;M.SetInitialOriginNames(W)}for(var q in J){var K=J[q],U=new o(q),$=parseInt(K);M.Add(U,$)}return new b(M)}if(null!=s.originalChoicePath)return this.JObjectToChoice(s)}if(t instanceof Array)return this.JArrayToContainer(t);if(null==t)return null;throw"Failed to convert token to runtime object: "+JSON.stringify(t)}},{key:"RuntimeObjectToJToken",value:function(t){var e=t;if(e instanceof Container)return this.ContainerToJArray(e);var n=t;if(n instanceof x){var i,a="->";return n.isExternal?a="x()":n.pushesToStack&&(n.stackPushType==w.Function?a="f()":n.stackPushType==w.Tunnel&&(a="->t->")),i=n.hasVariableTarget?n.variableDivertName:n.targetPathString,(f={})[a]=i,n.hasVariableTarget&&(f.var=!0),n.isConditional&&(f.c=!0),n.externalArgs>0&&(f.exArgs=n.externalArgs),f}var r=t;if(r instanceof I)return(f={})["*"]=r.pathStringOnChoice,f.flg=r.flags,f;if(t instanceof y)return t.value;if(t instanceof m)return t.value;var o=t;if(o instanceof g)return o.isNewline?"\n":"^"+o.value;var s=t;if(s instanceof b)return this.InkListToJObject(s);if(t instanceof k)return{"^->":t.value.componentsString};var u=t;if(u instanceof C)return{"^var":u.value,ci:u.contextIndex};var l=t;if(l instanceof _)return l.isBi?"<>":l.isLeft?"G<":"G>";if(t instanceof O)return B[parseInt(t.commandType)];if(t instanceof N){var h=t.name;return"^"==h&&(h="L^"),h}var c=t;if(c instanceof P){var f={},v=c.pathStringForCount;return null!=v?f["CNT?"]=v:f["VAR?"]=c.name,f}var d=t;if(d instanceof A)return(f={})[d.isGlobal?"VAR=":"temp="]=d.variableName,d.isNewDeclaration||(f.re=!0),f;if(t instanceof V)return"void";if(t instanceof F)return(f={})["#"]=t.text,f;var p=t;if(p instanceof j)return this.ChoiceToJObject(p);throw"Failed to convert runtime object to Json token: "+t}},{key:"ContainerToJArray",value:function(t){var e=this.ListToJArray(t.content),n=t.namedOnlyContent,i=t.countFlags;if(null!=n&&n.length>0||i>0||null!=t.name){var a;if(null!=n)for(var r in a=this.DictionaryRuntimeObjsToJObject(n)){var o=a[r];if(null!=o){var s=o[o.length-1];null!=s&&(delete s["#n"],0==Object.keys(s).length&&(o[o.length-1]=null))}}else a={};i>0&&(a["#f"]=i),null!=t.name&&(a["#n"]=t.name),e.push(a)}else e.push(null);return e}},{key:"JArrayToContainer",value:function(t){var e=new Container;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i={};for(var a in n)if("#f"==a)e.countFlags=parseInt(n[a]);else if("#n"==a)e.name=n[a].toString();else{var r=this.JTokenToRuntimeObject(n[a]);r instanceof Container&&(r.name=a),i[a]=r}e.namedOnlyContent=i}return e}},{key:"JObjectToChoice",value:function(t){var e=new j;return e.text=t.text.toString(),e.index=parseInt(t.index),e.originalChoicePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e}},{key:"ChoiceToJObject",value:function(t){var e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.originalChoicePath,e.originalThreadIndex=t.originalThreadIndex,e}},{key:"InkListToJObject",value:function(t){var e=t.value,n={},i={};return e.forEach(function(t){var e=t.Key,n=t.Value;i[e.toString()]=n}),n.list=i,0==e.Count&&null!=e.originNames&&e.originNames.length>0&&(n.origins=e.originNames),n}},{key:"ListDefinitionsToJToken",value:function(t){var e={};return t.lists.forEach(function(t){var n={};t.items.forEach(function(t){var e=t.Key,i=t.Value;n[e.itemName]=i}),e[t.name]=n}),e}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e){var a=i.toString(),r=e[i],o={};for(var s in r){var u=r[s];o[s]=parseInt(u)}var l=new L(a,o);n.push(l)}return new R(n)}}]),t}(),B=[];B[O.CommandType.EvalStart]="ev",B[O.CommandType.EvalOutput]="out",B[O.CommandType.EvalEnd]="/ev",B[O.CommandType.Duplicate]="du",B[O.CommandType.PopEvaluatedValue]="pop",B[O.CommandType.PopFunction]="~ret",B[O.CommandType.PopTunnel]="->->",B[O.CommandType.BeginString]="str",B[O.CommandType.EndString]="/str",B[O.CommandType.NoOp]="nop",B[O.CommandType.ChoiceCount]="choiceCnt",B[O.CommandType.TurnsSince]="turns",B[O.CommandType.ReadCount]="readc",B[O.CommandType.Random]="rnd",B[O.CommandType.SeedRandom]="srnd",B[O.CommandType.VisitIndex]="visit",B[O.CommandType.SequenceShuffleIndex]="seq",B[O.CommandType.StartThread]="thread",B[O.CommandType.Done]="done",B[O.CommandType.End]="end",B[O.CommandType.ListFromInt]="listInt",B[O.CommandType.ListRange]="range";for(var G=0;G<O.CommandType.TOTAL_VALUES;++G)if(null==B[G])throw"Control command not accounted for in serialisation";var J=function(){function t(e,n,i,a){c(this,t),this.currentContainer=n,this.currentContentIndex=i,this.inExpressionEvaluation=a||!1,this.temporaryVariables={},this.type=e}return s(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentContainer,this.currentContentIndex,this.inExpressionEvaluation);return Object.assign(e.temporaryVariables,this.temporaryVariables),e}},{key:"currentObject",get:function(){return this.currentContainer&&this.currentContentIndex<this.currentContainer.content.length?this.currentContainer.content[this.currentContentIndex]:null},set:function(t){var e=t;if(null==e)return this.currentContainer=null,void(this.currentContentIndex=0);this.currentContainer=e.parent,this.currentContainer instanceof Container&&(this.currentContentIndex=this.currentContainer.content.indexOf(e)),this.currentContainer instanceof Container!=!1&&-1!=this.currentContentIndex||(this.currentContainer=e,this.currentContentIndex=0)}}]),t}(),M=function(){function t(n,i){var a=this;if(c(this,t),this.callstack=[],this.threadIndex=0,this.previousContentObject=null,n&&i){var r=n;this.threadIndex=parseInt(r.threadIndex),r.callstack.forEach(function(t){var n=t,r=parseInt(n.type),o=null,s=0,u=null,l=n.cPath;void 0!==l&&(u=l.toString(),o=i.ContentAtPath(new e(u)),s=parseInt(n.idx));var h=!!n.exp,c=new J(r,o,s,h),f=n.temp;c.temporaryVariables=D.JObjectToDictionaryRuntimeObjs(f),a.callstack.push(c)});var o=r.previousContentObject;if(void 0!==o){var s=new e(o.toString());this.previousContentObject=i.ContentAtPath(s)}}}return s(t,[{key:"Copy",value:function(){var e=new t;return e.threadIndex=this.threadIndex,this.callstack.forEach(function(t){e.callstack.push(t.Copy())}),e.previousContentObject=this.previousContentObject,e}},{key:"jsonToken",get:function(){var t={},e=[];return this.callstack.forEach(function(t){var n={};t.currentContainer&&(n.cPath=t.currentContainer.path.componentsString,n.idx=t.currentContentIndex),n.exp=t.inExpressionEvaluation,n.type=parseInt(t.type),n.temp=D.DictionaryRuntimeObjsToJObject(t.temporaryVariables),e.push(n)}),t.callstack=e,t.threadIndex=this.threadIndex,null!=this.previousContentObject&&(t.previousContentObject=this.previousContentObject.path.toString()),t}}]),t}(),W=function(){function t(e){var n=this;c(this,t),this._threads=[],this._threadCounter=0,this._threads.push(new M),e instanceof t?(this._threads=[],e._threads.forEach(function(t){n._threads.push(t.Copy())})):this._threads[0].callstack.push(new J(w.Tunnel,e,0))}return s(t,[{key:"CanPop",value:function(t){return!!this.canPop&&(null==t||this.currentElement.type==t)}},{key:"Pop",value:function(t){if(!this.CanPop(t))throw"Mismatched push/pop in Callstack";this.callStack.pop()}},{key:"Push",value:function(t){this.callStack.push(new J(t,this.currentElement.currentContainer,this.currentElement.currentContentIndex,!1))}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"PopThread",value:function(){if(!this.canPopThread)throw"Can't pop thread";this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"SetJsonToken",value:function(t,e){var n=this;this._threads.length=0;var i=t;i.threads.forEach(function(t){var i=new M(t,e);n._threads.push(i)}),this._threadCounter=parseInt(i.threadCounter)}},{key:"GetJsonToken",value:function(){var t={},e=[];return this._threads.forEach(function(t){e.push(t.jsonToken)}),t.threads=e,t.threadCounter=this._threadCounter,t}},{key:"GetTemporaryVariableWithName",value:function(t,e){-1==(e=void 0===e?-1:e)&&(e=this.currentElementIndex+1);var n;return(n=this.callStack[e-1].temporaryVariables[t])?n:null}},{key:"SetTemporaryVariable",value:function(t,e,n,i){-1==(i=void 0===i?-1:i)&&(i=this.currentElementIndex+1);var a,r=this.callStack[i-1];if(!n&&!r.temporaryVariables[t])throw new S("Could not find temporary variable to set: "+t);(a=r.temporaryVariables[t])&&b.RetainListOriginsForAssignment(a,e),r.temporaryVariables[t]=e}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables[t]?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){return this._threads.filter(function(e){if(e.threadIndex==t)return e})[0]}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){1!=this._threads.length&&console.warn("Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){return this.callStack[this.callStack.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"canPop",get:function(){return this.callStack.length>1}},{key:"canPopThread",get:function(){return this._threads.length>1}}]),t}(),q=function(){function t(e,n){c(this,t),this._globalVariables={},this._callStack=e,this._listDefsOrigin=n,this._batchObservingVariableChanges=null,this._changedVariables=null,this.variableChangedEvent=null,this.variableChangedEventCallbacks=[];try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(t){}}return s(t,[{key:"ObserveVariableChange",value:function(t){var e=this;null==this.variableChangedEvent&&(this.variableChangedEvent=function(t,n){e.variableChangedEventCallbacks.forEach(function(e){e(t,n)})}),this.variableChangedEventCallbacks.push(t)}},{key:"CopyFrom",value:function(t){this._globalVariables=Object.assign({},t._globalVariables),this.variableChangedEvent=t.variableChangedEvent,t.batchObservingVariableChanges!=this.batchObservingVariableChanges&&(t.batchObservingVariableChanges?(this._batchObservingVariableChanges=!0,this._changedVariables=t._changedVariables):(this._batchObservingVariableChanges=!1,this._changedVariables=null))}},{key:"GetVariableWithName",value:function(t,e){void 0===e&&(e=-1);var n=this.GetRawVariableWithName(t,e),i=n;return i instanceof C&&(n=this.ValueAtVariablePointer(i)),n}},{key:"GetRawVariableWithName",value:function(t,e){var n=null;if(0==e||-1==e){if(n=this._globalVariables[t])return n;var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}if(null==(n=this._callStack.GetTemporaryVariableWithName(t,e)))throw"RUNTIME ERROR: Variable '"+t+"' could not be found in context '"+e+"'. This shouldn't be possible so is a bug in the ink engine. Please try to construct a minimal story that reproduces the problem and report to inkle, thank you!";return n}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName,i=-1,a=!1;if(a=t.isNewDeclaration?t.isGlobal:!!this._globalVariables[n],t.isNewDeclaration){var r=e;if(r instanceof C)e=this.ResolveVariablePointer(r)}else{var o=null;do{(o=this.GetRawVariableWithName(n,i))instanceof C&&(n=o.variableName,a=0==(i=o.contextIndex))}while(o instanceof C)}a?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=t,i=e;n instanceof b&&i instanceof b&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n;n=this._globalVariables[t],b.RetainListOriginsForAssignment(n,e),this._globalVariables[t]=e,null!=this.variableChangedEvent&&e!==n&&(this.batchObservingVariableChanges?this._changedVariables.push(t):this.variableChangedEvent(t,e))}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=this.GetRawVariableWithName(t.variableName,e);return n instanceof C?n:new C(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this._globalVariables[t]?0:this._callStack.currentElementIndex}},{key:"$",value:function(t,e){if(void 0===e){var n=this._globalVariables[t];return void 0!==n?n.valueObject:null}if(void 0===this._globalVariables[t])throw new S("Variable '"+t+"' doesn't exist, so can't be set.");var i=p.Create(e);if(null==i)throw new S(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){var e=this;t=!!t,this._batchObservingVariableChanges=t,t?this._changedVariables=[]:(null!=this._changedVariables&&this._changedVariables.forEach(function(t){var n=e._globalVariables[t];e.variableChangedEvent(t,n)}),this._changedVariables=null)}},{key:"jsonToken",get:function(){return D.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(t){this._globalVariables=D.JObjectToDictionaryRuntimeObjs(t)}}]),t}(),K=function(){function t(e){c(this,t),this._seed=e%2147483647,this._seed<=0&&(this._seed+=2147483646)}return s(t,[{key:"next",value:function(){return this._seed=16807*this._seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),U=function(){function t(e){c(this,t),this.story=e,this._outputStream=[],this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new W(e.rootContentContainer),this._variablesState=new q(this.callStack,e.listDefinitions),this._visitCounts={},this._turnIndices={},this._currentTurnIndex=-1,this.divertedTargetObject=null;var n=(new Date).getTime();this.storySeed=new K(n).next()%100,this.previousRandom=0,this._currentChoices=[],this._currentText=null,this._currentTags=null,this._currentErrors=null,this.didSafeExit=!1,this._isExternalFunctionEvaluation=!1,this._originalCallstack=null,this._originalEvaluationStackHeight=0,this.GoToStart()}return s(t,[{key:"MatchRightGlueForLeftGlue",value:function(t){if(!t.isLeft)return null;for(var e=this._outputStream.length-1;e>=0;e--){var n=this._outputStream[e],i=n;if(i instanceof _&&i.isRight&&i.parent==t.parent)return i;if(n instanceof O)break}return null}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentContainer=this.story.mainContentContainer,this.callStack.currentElement.currentContentIndex=0}},{key:"ResetErrors",value:function(){this._currentErrors=null}},{key:"ResetOutput",value:function(){this._outputStream.length=0,this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(t){var e=this;if(t instanceof b){var n=t.value,i=n.originNames;if(null!=i){var a=[];i.forEach(function(t){var n=null;n=e.story.listDefinitions.TryGetDefinition(t,n),a.indexOf(n)<0&&a.push(n)}),n.origins=a}}this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(t){if(t>this.evaluationStack.length)throw"trying to pop too many objects";return this.evaluationStack.splice(this.evaluationStack.length-t,t)}return this.evaluationStack.pop()}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"PushToOutputStream",value:function(t){var e=this,n=t;if(n instanceof g){var i=this.TrySplittingHeadTailWhitespace(n);if(null!=i)return void i.forEach(function(t){e.PushToOutputStreamIndividual(t)})}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){for(var e=t.value,n=-1,i=-1,a=0;a<e.length;++a){if("\n"!=(s=e[a])){if(" "==s||"\t"==s)continue;break}-1==n&&(n=a),i=a}var r=-1,o=-1;for(a=0;a<e.length;++a){var s;if("\n"!=(s=e[a])){if(" "==s||"\t"==s)continue;break}-1==r&&(r=a),o=a}if(-1==n&&-1==r)return null;var u=[],l=0,h=e.length;if(-1!=n){if(n>0){var c=e.substring(0,n);u.push(c)}u.push(new g("\n")),l=i+1}if(-1!=r&&(h=o),h>l){var f=e.substring(l,h-l);u.push(new g(f))}if(-1!=r&&o>i&&(u.push(new g("\n")),r<e.length-1)){var v=e.Length-r-1,d=new g(e.substring(r+1,v));u.push(d)}return u}},{key:"PushToOutputStreamIndividual",value:function(t){var e=t,n=t,i=!0;if(e instanceof _){var a=this.currentRightGlue,r=(!e.isLeft||!a||(e.parent,a.parent),null);e.isLeft&&(r=this.MatchRightGlueForLeftGlue(e)),(e.isLeft||e.isBi)&&this.TrimNewlinesFromOutputStream(r),i=e.isBi||e.isRight}else n instanceof g&&(-1!=this.currentGlueIndex?n.isNewline?(this.TrimFromExistingGlue(),i=!1):n.isNonWhitespace&&this.RemoveExistingGlue():n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1)));i&&(this._outputStream.push(t),this.OutputStreamDirty())}},{key:"TrimNewlinesFromOutputStream",value:function(t){for(var e=-1,n=-1,i=!1,a=this._outputStream.length-1;a>=0;){var r=this._outputStream[a],o=r,s=r;if(r instanceof O||o instanceof g&&o.isNonWhitespace){if(i=!0,null==t)break}else{if(t&&s instanceof _&&s==t){n=a;break}o instanceof g&&o.isNewline&&!i&&(e=a)}a--}if(e>=0)for(a=e;a<this._outputStream.length;){this._outputStream[a]instanceof g?this._outputStream.splice(a,1):a++}if(t&&n>-1)for(a=n;a<this._outputStream.length;)this._outputStream[a]instanceof _&&this._outputStream[a].isRight?this.outputStream.splice(a,1):a++;this.OutputStreamDirty()}},{key:"TrimFromExistingGlue",value:function(){for(var t=this.currentGlueIndex;t<this._outputStream.length;){var e=this._outputStream[t];e instanceof g&&!e.isNonWhitespace?this._outputStream.splice(t,1):t++}this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof _)this._outputStream.splice(t,1);else if(e instanceof O)break}this.OutputStreamDirty()}},{key:"ForceEnd",value:function(){for(;this.callStack.canPopThread;)this.callStack.PopThread();for(;this.callStack.canPop;)this.callStack.Pop();this._currentChoices.length=0,this.currentContentObject=null,this.previousContentObject=null,this.didSafeExit=!0}},{key:"SetChosenPath",value:function(t){this._currentChoices.length=0,this.currentPath=t,this._currentTurnIndex++}},{key:"StartExternalFunctionEvaluation",value:function(t,e){this._originalCallstack=this.callStack,this._originalEvaluationStackHeight=this.evaluationStack.length,this.callStack=new W(t),this.callStack.currentElement.type=w.Function,this._variablesState.callStack=this.callStack,this._isExternalFunctionEvaluation=!0,this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!=t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw"ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string";this.PushEvaluationStack(p.Create(t[e]))}}},{key:"TryExitExternalFunctionEvaluation",value:function(){return!(!this._isExternalFunctionEvaluation||1!=this.callStack.elements.length||this.callStack.currentElement.type!=w.Function)&&(this.currentContentObject=null,this.didSafeExit=!0,!0)}},{key:"CompleteExternalFunctionEvaluation",value:function(){for(var t=null;this.evaluationStack.length>this._originalEvaluationStackHeight;){var e=this.PopEvaluationStack();null==t&&(t=e)}if(this.callStack=this._originalCallstack,this._originalCallstack=null,this._originalEvaluationStackHeight=0,this._variablesState.callStack=this.callStack,t){if(t instanceof V)return null;var n=t;return n.valueType==v.DivertTarget?n.valueObject.toString():n.valueObject}return null}},{key:"AddError",value:function(t){null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t)}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"VisitCountAtPathString",value:function(t){var e;return(e=this.visitCounts[t])?e:0}},{key:"Copy",value:function(){var e=new t(this.story);for(var n in e.outputStream.push.apply(e.outputStream,this._outputStream),this.OutputStreamDirty(),e._currentChoices.push.apply(e._currentChoices,this._currentChoices),this.hasError&&(e.currentErrors=[],e.currentErrors.push.apply(e.currentErrors,this.currentErrors)),e.callStack=new W(this.callStack),this._originalCallstack&&(e._originalCallstack=new W(this._originalCallstack)),e._variablesState=new q(e.callStack,this.story.listDefinitions),e.variablesState.CopyFrom(this.variablesState),e.evaluationStack.push.apply(e.evaluationStack,this.evaluationStack),e._originalEvaluationStackHeight=this._originalEvaluationStackHeight,null!=this.divertedTargetObject&&(e.divertedTargetObject=this.divertedTargetObject),e.previousContentObject=this.previousContentObject,e._isExternalFunctionEvaluation=this._isExternalFunctionEvaluation,e._visitCounts={},this._visitCounts)e._visitCounts[n]=this._visitCounts[n];for(var n in e._turnIndices={},this._turnIndices)e._turnIndices[n]=this._turnIndices[n];return e._currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}},{key:"toJson",value:function(t){return JSON.stringify(this.jsonToken,null,t?2:0)}},{key:"LoadJson",value:function(t){this.jsonToken=JSON.parse(t)}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"variablesState",get:function(){return this._variablesState}},{key:"currentContentObject",get:function(){return this.callStack.currentElement.currentObject},set:function(t){this.callStack.currentElement.currentObject=t}},{key:"canContinue",get:function(){return null!=this.currentContentObject&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&this.currentErrors.length>0}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"outputStreamEndsInNewline",get:function(){if(this._outputStream.length>0)for(var t=this._outputStream.length-1;t>=0;t--){if(this._outputStream[t]instanceof O)break;var e=this._outputStream[t];if(e instanceof g){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof g)return!0;return!1}},{key:"currentGlueIndex",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof _)return t;if(e instanceof O)break}return-1}},{key:"currentRightGlue",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t],n=e;if(n instanceof _&&n.isRight)return n;if(e instanceof O)break}return null}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;t>=0;t--){var e=this._outputStream[t];if(e instanceof O&&e.commandType==O.CommandType.BeginString)return!0}return!1}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t=new r;this._outputStream.forEach(function(e){var n=e;n instanceof g&&t.Append(n.value)}),this._currentText=t.toString(),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){var t=this;return this._outputStreamTagsDirty&&(this._currentTags=[],this._outputStream.forEach(function(e){var n=e;n instanceof F&&t._currentTags.push(n.text)}),this._outputStreamTagsDirty=!1),this._currentTags}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentPath",get:function(){return null==this.currentContentObject?null:this.currentContentObject.path},set:function(t){this.currentContentObject=null!=t?this.story.ContentAtPath(t):null}},{key:"currentContainer",get:function(){return this.callStack.currentElement.currentContainer}},{key:"previousContentObject",get:function(){return this.callStack.currentThread.previousContentObject},set:function(t){this.callStack.currentThread.previousContentObject=t}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"jsonToken",get:function(){var e=this,n={},i=null;return this._currentChoices.forEach(function(t){t.originalChoicePath=t.choicePoint.path.componentsString,t.originalThreadIndex=t.threadAtGeneration.threadIndex,null==e.callStack.ThreadWithIndex(t.originalThreadIndex)&&(null==i&&(i={}),i[t.originalThreadIndex.toString()]=t.threadAtGeneration.jsonToken)}),null!=this.choiceThreads&&(n.choiceThreads=this.choiceThreads),n.callstackThreads=this.callStack.GetJsonToken(),n.variablesState=this.variablesState.jsonToken,n.evalStack=D.ListToJArray(this.evaluationStack),n.outputStream=D.ListToJArray(this._outputStream),n.currentChoices=D.ListToJArray(this._currentChoices),null!=this.divertedTargetObject&&(n.currentDivertTarget=this.divertedTargetObject.path.componentsString),n.visitCounts=D.IntDictionaryToJObject(this.visitCounts),n.turnIndices=D.IntDictionaryToJObject(this.turnIndices),n.turnIdx=this.currentTurnIndex,n.storySeed=this.storySeed,n.inkSaveVersion=t.kInkSaveStateVersion,n.inkFormatVersion=this.story.inkVersionCurrent,n},set:function(n){var i=this,a=n,r=a.inkSaveVersion;if(null==r)throw new S("ink save format incorrect, can't load.");if(parseInt(r)<t.kMinCompatibleLoadVersion)throw new S("Ink save format isn't compatible with the current version (saw '"+r+"', but minimum is "+t.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(a.callstackThreads,this.story),this.variablesState.jsonToken=a.variablesState,this._evaluationStack=D.JArrayToRuntimeObjList(a.evalStack),this._outputStream=D.JArrayToRuntimeObjList(a.outputStream),this.OutputStreamDirty(),this._currentChoices=D.JArrayToRuntimeObjList(a.currentChoices);var o=a.currentDivertTarget;if(null!=o){var s=new e(o.toString());this.divertedTargetObject=this.story.ContentAtPath(s)}this._visitCounts=D.JObjectToIntDictionary(a.visitCounts),this._turnIndices=D.JObjectToIntDictionary(a.turnIndices),this._currentTurnIndex=parseInt(a.turnIdx),this.storySeed=parseInt(a.storySeed);var u=a.choiceThreads;this._currentChoices.forEach(function(t){t.choicePoint=i.story.ContentAtPath(new e(t.originalChoicePath));var n=i.callStack.ThreadWithIndex(t.originalThreadIndex);if(null!=n)t.threadAtGeneration=n;else{var a=u[t.originalThreadIndex.toString()];t.threadAtGeneration=new W.Thread(a,i.story)}})}}]),t}();U.kInkSaveStateVersion=7,U.kMinCompatibleLoadVersion=6,Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&t>-9007199254740992&&t<9007199254740992&&Math.floor(t)===t});var $=function(t){function n(t,e){c(this,n);var i=l(this,(n.__proto__||Object.getPrototypeOf(n)).call(this));if(e=e||null,i.inkVersionCurrent=17,i.inkVersionMinimumCompatible=16,i._variableObservers=null,i._externals={},i._prevContainerSet=null,i._listDefinitions=null,t instanceof Container)i._mainContentContainer=t,null!=e&&(i._listDefinitions=new R(e));else{var a="string"==typeof t?JSON.parse(t):t,r=a.inkVersion;if(null==r)throw"ink version number not found. Are you sure it's a valid .ink.json file?";var o=parseInt(r);if(o>i.inkVersionCurrent)throw"Version of ink used to build story was newer than the current verison of the engine";if(o<i.inkVersionMinimumCompatible)throw"Version of ink used to build story is too old to be loaded by this verison of the engine";o!=i.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var s,u=a.root;if(null==u)throw"Root node for ink not found. Are you sure it's a valid .ink.json file?";(s=a.listDefs)&&(i._listDefinitions=D.JTokenToListDefinitions(s)),i._mainContentContainer=D.JTokenToRuntimeObject(u),i._hasValidatedExternals=null,i.allowExternalFunctionFallbacks=!1,i.ResetState()}return i}return h(n,a),s(n,[{key:"ToJsonString",value:function(){var t=D.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,null!=this._listDefinitions&&(e.listDefs=D.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(e)}},{key:"ResetState",value:function(){this._state=new U(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent["global decl"]){var t=this.state.currentPath;this.ChoosePathString("global decl"),this.ContinueInternal(),this.state.currentPath=t}}},{key:"Continue",value:function(){return this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal()}},{key:"ContinueInternal",value:function(){if(!this.canContinue)throw new S("Can't continue - should check canContinue before calling Continue");this._state.ResetOutput(),this._state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!0;try{var t=null;do{if(this.Step(),this.canContinue||this.TryFollowDefaultInvisibleChoice(),!this.state.inStringEvaluation){if(null!=t){var e=this.currentText,n=t.currentText.length,i=t.currentTags.length;if(e!==t.currentText||i!=this.currentTags.length){if(e.length>=n&&"\n"==e[n-1]){this.RestoreStateSnapshot(t);break}t=null}}this.state.outputStreamEndsInNewline&&(this.canContinue?null==t&&(t=this.StateSnapshot()):t=null)}}while(this.canContinue);null!=t&&this.RestoreStateSnapshot(t),this.canContinue||(this.state.callStack.canPopThread&&this.Error("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(w.Tunnel)?this.Error("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(w.Function)?this.Error("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.Error("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.Error("ran out of content. Do you need a '-> DONE' or '-> END'?")))}catch(t){throw t}finally{this.state.didSafeExit=!1,this._state.variablesState.batchObservingVariableChanges=!1}return this.currentText}},{key:"ContinueMaximally",value:function(){for(var t=new r;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(t){this._state=t}},{key:"Step",value:function(){var t=!0,e=this.state.currentContentObject;if(null!=e){for(var n=e;n instanceof Container&&(this.VisitContainer(n,!0),0!=n.content.length);)e=n.content[0],this.state.callStack.currentElement.currentContentIndex=0,this.state.callStack.currentElement.currentContainer=n,n=e;n=this.state.callStack.currentElement.currentContainer;var i=this.PerformLogicAndFlowControl(e);if(null!=this.state.currentContentObject){i&&(t=!1);var a=e;if(a instanceof I){var r=this.ProcessChoice(a);r&&this.state.generatedChoices.push(r),e=null,t=!1}if(e instanceof Container&&(t=!1),t){var o=e;if(o instanceof C&&-1==o.contextIndex){var s=this.state.callStack.ContextForVariableNamed(o.variableName);e=new C(o.variableName,s)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(e):this.state.PushToOutputStream(e)}this.NextContent();e instanceof O&&e.commandType==O.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousContentObject,e=this.state.currentContentObject;if(e){if(this._prevContainerSet=[],t)for(var n=t instanceof Container?t:t.parent;n instanceof Container;)this._prevContainerSet.push(n),n=n.parent;for(var i=e,a=i.parent;a instanceof Container&&this._prevContainerSet.indexOf(a)<0;){var r=a.content.length>0&&i==a.content[0];this.VisitContainer(a,r),i=a,a=a.parent}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var i="",a="";t.hasChoiceOnlyContent&&(a=this.state.PopEvaluationStack().value);t.hasStartContent&&(i=this.state.PopEvaluationStack().value);t.onceOnly&&(this.VisitCountForContainer(t.choiceTarget)>0&&(e=!1));var r=new j(t);return r.threadAtGeneration=this.state.callStack.currentThread.Copy(),e?(r.text=i+a,r):null}},{key:"IsTruthy",value:function(t){if(t instanceof p){var e=t;if(e instanceof k){var n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof x){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i=e.variableDivertName,a=this.state.variablesState.GetVariableWithName(i);if(!(a instanceof k)){var o="Tried to divert to a target from a variable, but the variable ("+i+") didn't contain a divert target, it ";a instanceof y&&0==a.value?o+="was empty/null (the value 0).":o+="contained '"+a+"'.",this.Error(o)}var s=a;this.state.divertedTargetObject=this.ContentAtPath(s.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedTargetObject=e.targetContent}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType),null!=this.state.divertedTargetObject||e.isExternal||(e&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof O){var u=t;switch(u.commandType){case O.CommandType.EvalStart:this.state.inExpressionEvaluation&&console.warn("Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case O.CommandType.EvalEnd:this.state.inExpressionEvaluation||console.warn("Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case O.CommandType.EvalOutput:if(this.state.evaluationStack.length>0){var l=this.state.PopEvaluationStack();if(null!=l&&!(l instanceof V)){var h=new g(l.toString());this.state.PushToOutputStream(h)}}break;case O.CommandType.NoOp:break;case O.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case O.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case O.CommandType.PopFunction:case O.CommandType.PopTunnel:var c=u.commandType==O.CommandType.PopFunction?w.Function:w.Tunnel,f=null;if(c==w.Tunnel){var v=this.state.PopEvaluationStack();if((f=v)instanceof k==!1){if(v instanceof V==!1)throw"Expected void if ->-> doesn't override target";f=null}}if(this.state.TryExitExternalFunctionEvaluation())break;if(this.state.callStack.currentElement.type==c&&this.state.callStack.canPop)this.state.callStack.Pop(),f&&(this.state.divertedTargetObject=this.ContentAtPath(f.targetPath));else{var d={};d[w.Function]="function return statement (~ return)",d[w.Tunnel]="tunnel onwards statement (->->)";var p=d[this.state.callStack.currentElement.type];this.state.callStack.canPop||(p="end of flow (-> END or choice)");var m="Found "+d[c]+", when expected "+p;this.Error(m)}break;case O.CommandType.BeginString:this.state.PushToOutputStream(u),this.state.inExpressionEvaluation||console.warn("Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case O.CommandType.EndString:for(var C=[],_=0,T=this.state.outputStream.length-1;T>=0;--T){var E=this.state.outputStream[T];_++;if(E instanceof O&&E.commandType==O.CommandType.BeginString)break;E instanceof g&&C.push(E)}this.state.outputStream.splice(this.state.outputStream.length-_,_),C=C.reverse();var I=new r;C.forEach(function(t){I.Append(t.toString())}),this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new g(I.toString()));break;case O.CommandType.ChoiceCount:var F=this.state.generatedChoices.length;this.state.PushEvaluationStack(new y(F));break;case O.CommandType.TurnsSince:case O.CommandType.ReadCount:if(!((s=this.state.PopEvaluationStack())instanceof k)){var j="";s instanceof y&&(j=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+s+j);break}var L,R=s,D=this.ContentAtPath(R.targetPath);L=u.commandType==O.CommandType.TurnsSince?this.TurnsSinceForContainer(D):this.VisitCountForContainer(D),this.state.PushEvaluationStack(new y(L));break;case O.CommandType.Random:var B=this.state.PopEvaluationStack(),G=this.state.PopEvaluationStack();null!=G&&G instanceof y!=!1||this.Error("Invalid value for minimum parameter of RANDOM(min, max)"),null!=B&&G instanceof y!=!1||this.Error("Invalid value for maximum parameter of RANDOM(min, max)");var J=B.value-G.value+1;J<=0&&this.Error("RANDOM was called with minimum as "+G.value+" and maximum as "+B.value+". The maximum must be larger");var M=this.state.storySeed+this.state.previousRandom,W=new K(M).next(),q=W%J+G.value;this.state.PushEvaluationStack(new y(q)),this.state.previousRandom=W;break;case O.CommandType.SeedRandom:var U=this.state.PopEvaluationStack();null!=U&&U instanceof y!=!1||this.Error("Invalid value passed to SEED_RANDOM"),this.state.storySeed=U.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new V);break;case O.CommandType.VisitIndex:var $=this.VisitCountForContainer(this.state.currentContainer)-1;this.state.PushEvaluationStack(new y($));break;case O.CommandType.SequenceShuffleIndex:var H=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new y(H));break;case O.CommandType.StartThread:break;case O.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentContentObject=null);break;case O.CommandType.End:this.state.ForceEnd();break;case O.CommandType.ListFromInt:var X,z=parseInt(this.state.PopEvaluationStack()),Q=this.state.PopEvaluationStack().toString(),Y=null;if(!(X=this.listDefinitions.TryGetDefinition(Q,X)))throw new S("Failed to find LIST called "+Q.value);var Z=X.TryGetItemWithValue(z.value);Z.exists&&(Y=new b(Z.item,z.value)),null==Y&&(Y=new b),this.state.PushEvaluationStack(Y);break;case O.CommandType.ListRange:var tt=this.state.PopEvaluationStack(),et=this.state.PopEvaluationStack(),nt=this.state.PopEvaluationStack();if(nt instanceof b==!1||null==nt||null==et||null==tt)throw new S("Expected list, minimum and maximum for LIST_RANGE");var it=function(t){if(t instanceof b)return parseInt(t.value.maxItem.Value);return t instanceof y?t.value:-1},at=it(et),rt=it(tt);if(-1==at)throw new S("Invalid min range bound passed to LIST_VALUE(): "+et);if(-1==rt)throw new S("Invalid max range bound passed to LIST_VALUE(): "+tt);var ot=new b,st=nt.value.origins;null!=st&&st.forEach(function(t){t.ListRange(at,rt).value.forEach(function(t){ot.value.Add(t.Key,t.Value)})}),this.state.PushEvaluationStack(ot);break;default:this.Error("unhandled ControlCommand: "+u)}return!0}if(t instanceof A){var ut=t,lt=this.state.PopEvaluationStack();return this.state.variablesState.Assign(ut,lt),!0}if(t instanceof P){var ht=t,ct=null;if(null!=ht.pathForCount){D=ht.containerForCount,$=this.VisitCountForContainer(D);ct=new y($)}else null==(ct=this.state.variablesState.GetVariableWithName(ht.name))&&(this.Error("Uninitialised variable: "+ht.name),ct=new y(0));return this.state.PushEvaluationStack(ct),!0}if(t instanceof N){var ft=t,vt=this.state.PopEvaluationStack(ft.numberOfParameters);ot=ft.Call(vt);return this.state.PushEvaluationStack(ot),!0}return!1}},{key:"ChoosePathString",value:function(t,n){n=n||[],this.state.PassArgumentsToEvaluationStack(n),this.ChoosePath(new e(t))}},{key:"ChoosePath",value:function(t){this.state.SetChosenPath(t),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;(t<0||t>e.length)&&console.warn("choice out of range");var n=e[t];this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.choicePoint.choiceTarget.path)}},{key:"HasFunction",value:function(t){try{return this.ContentAtPath(new e(t))instanceof Container}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t,n,i){if(i=!!i,null==t)throw"Function is null";if(""==t||""==t.trim())throw"Function is empty or white space.";var a=null;try{a=this.ContentAtPath(new e(t))}catch(e){throw e.message.indexOf("not found")>=0?"Function doesn't exist: '"+t+"'":e}this.state.StartExternalFunctionEvaluation(a,n);for(var o=new r;this.canContinue;)o.Append(this.Continue());var s=o.toString(),u=this.state.CompleteExternalFunctionEvaluation();return i?{returned:u,output:s}:u}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(w.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.callStack.Pop(),this.state.evaluationStack.length>n?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,n){var i=this._externals[t],a=null;if(!(void 0!==i)){if(this.allowExternalFunctionFallbacks)return(a=this.ContentAtPath(new e(t)))instanceof Container||console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(w.Function),void(this.state.divertedTargetObject=a);console.warn("Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var r=[],o=0;o<n;++o){var s=this.state.PopEvaluationStack().valueObject;r.push(s)}r.reverse();var l=i(r),h=null;null!=l?null==(h=p.Create(l))&&console.warn("Could not create ink value from returned object of type "+(void 0===l?"undefined":u(l))):h=new V,this.state.PushEvaluationStack(h)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunctionGeneral",value:function(t,e){this._externals[t]&&console.warn("Function '"+t+"' has already been bound."),this._externals[t]=e}},{key:"BindExternalFunction",value:function(t,e){var n=this;e||console.warn("Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){t.length<e.length&&console.warn("External function expected "+e.length+" arguments");for(var i=[],a=0,r=t.length;a<r;a++)i[a]=n.TryCoerce(t[a]);return e.apply(null,i)})}},{key:"UnbindExternalFunction",value:function(t){void 0===this._externals[t]&&console.warn("Function '"+t+"' has not been bound."),delete this._externals[t]}},{key:"ValidateExternalBindings",value:function(t,e){var n=this;if(t)if(t instanceof Container){var i=t;for(var a in i.content.forEach(function(t){n.ValidateExternalBindings(t,e)}),i.namedContent)this.ValidateExternalBindings(i.namedContent[a],e)}else{var r=t;if(r instanceof x&&r.isExternal){var o=r.targetPathString;if(!this._externals[o])if(this.allowExternalFunctionFallbacks)!!this.mainContentContainer.namedContent[o]||e.push(o);else e.push(o)}}else{e=[];if(this.ValidateExternalBindings(this._mainContentContainer,e),this._hasValidatedExternals=!0,0==e.length)this._hasValidatedExternals=!0;else{var s="Error: Missing function binding for external";s+=e.length>1?"s":"",s+=": '",s+=e.join("', '"),s+="' ",s+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(s)}}}},{key:"ObserveVariable",value:function(t,e){null==this._variableObservers&&(this._variableObservers={}),this._variableObservers[t]?this._variableObservers[t].push(e):this._variableObservers[t]=[e]}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(null!=this._variableObservers)if(void 0!==e)this._variableObservers[e]&&this._variableObservers[e].splice(this._variableObservers[e].indexOf(t),1);else for(var n in this._variableObservers)this._variableObservers[n].splice(this._variableObservers[n].indexOf(t),1)}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!=this._variableObservers){var n=this._variableObservers[t];if(void 0!==n){if(!(e instanceof p))throw"Tried to get the value of a variable that isn't a standard type";var i=e;n.forEach(function(e){e(t,i.valueObject)})}}}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){for(var n=new e(t),i=this.ContentAtPath(n);;){var a=i.content[0];if(!(a instanceof Container))break;i=a}var r=null;return i.content.every(function(t){var e=t;return e instanceof F&&(null==r&&(r=[]),r.push(e.text),!0)}),r}},{key:"BuildStringOfHierarchy",value:function(){var t=new r;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentContentObject),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new r;return t.BuildStringOfHierarchy(e,0,this.state.currentContentObject),e.toString()}},{key:"NextContent",value:function(){if((this.state.previousContentObject=this.state.currentContentObject,null==this.state.divertedTargetObject||(this.state.currentContentObject=this.state.divertedTargetObject,this.state.divertedTargetObject=null,this.VisitChangedContainersDueToDivert(),null==this.state.currentContentObject))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(w.Function)?(this.state.callStack.Pop(w.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new V),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitExternalFunctionEvaluation(),t&&null!=this.state.currentContentObject&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement;for(e.currentContentIndex++;e.currentContentIndex>=e.currentContainer.content.length;){t=!1;var n=e.currentContainer.parent;if(n instanceof Container==!1)break;var i=n.content.indexOf(e.currentContainer);if(-1==i)break;e.currentContainer=n,e.currentContentIndex=i+1,t=!0}return t||(e.currentContainer=null),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.choicePoint.isInvisibleDefault});if(0==e.length||t.length>e.length)return!1;var n=e[0];return this.ChoosePath(n.choicePoint.choiceTarget.path),!0}},{key:"VisitCountForContainer",value:function(t){if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var e=0,n=t.path.toString();return e=this.state.visitCounts[n]||e}},{key:"IncrementVisitCountForContainer",value:function(t){var e=0,n=t.path.toString();this.state.visitCounts[n]&&(e=this.state.visitCounts[n]),e++,this.state.visitCounts[n]=e}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e=t.path.toString();this.state.turnIndices[e]=this.state.currentTurnIndex}},{key:"TurnsSinceForContainer",value:function(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var e=t.path.toString(),n=this.state.turnIndices[e];return void 0!==n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var t=this.state.PopEvaluationStack();if(!(t instanceof y))return this.Error("expected number of elements in sequence for shuffle index"),0;for(var e=this.state.currentContainer,n=t.value,i=this.state.PopEvaluationStack().value,a=i/n,r=i%n,o=e.path.toString(),s=0,u=0,l=o.length;u<l;u++)s+=o.charCodeAt[u]||0;var h=s+a+this.state.storySeed,c=new K(parseInt(h)),f=[];for(u=0;u<n;++u)f.push(u);for(u=0;u<=r;++u){var v=c.next()%f.length,d=f[v];if(f.splice(v,1),u==r)return d}throw"Should never reach here"}},{key:"Error",value:function(t,e){throw new S(t)}},{key:"AddError",value:function(t,e){t="RUNTIME ERROR: "+t,this.state.AddError(t),this.state.ForceEnd()}},{key:"currentChoices",get:function(){var t=[];return this._state.currentChoices.forEach(function(e){e.choicePoint.isInvisibleDefault||(e.index=t.length,t.push(e))}),t}},{key:"currentText",get:function(){return this.state.currentText}},{key:"currentTags",get:function(){return this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"hasError",get:function(){return this.state.hasError}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}}]),n}();t.Story=$,Object.defineProperty(t,"__esModule",{value:!0})})},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),a=n(4),r=function(t){return t&&t.__esModule?t:{default:t}}(n(3));var o=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.story=new a.Story(e)}return i(t,[{key:"getScene",value:function(t){return(0,r.default)(this.story,t)}},{key:"makeChoice",value:function(t){this.story.ChooseChoiceIndex(t)}},{key:"saveState",value:function(){return this.story.state.toJson()}},{key:"loadState",value:function(t){this.story.state.LoadJson(t)}},{key:"globalTags",value:function(){return this.story.globalTags}},{key:"tagsForKnot",value:function(t){return this.story.TagsForContentAtPath(t)}},{key:"goTo",value:function(t){this.story.ChoosePathString(t)}},{key:"getVar",value:function(t){return this.story.variablesState[t]}},{key:"getVars",value:function(){var t=this.story.variablesState,e={};return Object.keys(t._globalVariables).forEach(function(n){e[n]=t[n]}),e}},{key:"setVar",value:function(t,e){this.story.variablesState[t]=e}},{key:"setVars",value:function(t){var e=this;Object.keys(t).forEach(function(n){e.story.variablesState[n]=t[n]})}},{key:"getVisitCount",value:function(t){this.story.state.VisitCountAtPathString(t)}},{key:"observeVar",value:function(t,e){this.story.ObserveVariable(t,e)}},{key:"bindFunction",value:function(t,e){this.story.BindExternalFunction(t,e)}},{key:"state",get:function(){return this.story.state}}]),t}();e.default=o},function(t,e,n){"use strict";Object.defineProperty(e,"__esModule",{value:!0});var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),a=function(t){return t&&t.__esModule?t:{default:t}}(n(5));var r=function(){function t(e,n,i,r){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.id=e,this.$episode=[],this.$story=new a.default(n),this.sceneId=-1,i.attach(this.$story),r.attach(this.$story)}return i(t,[{key:"reset",value:function(){this.$episode.splice(0),this.sceneId=-1}},{key:"renderScene",value:function(t){var e=this.$story.getScene(t);return this.updateEpisode(e)}},{key:"getCurrentScene",value:function(){return this.$episode[this.$episode.length-1]}},{key:"makeChoice",value:function(t){this.$story.makeChoice(t)}},{key:"updateEpisode",value:function(t){return this.sceneId>=0&&(this.$episode[this.sceneId].isActive=!1),this.sceneId+=1,t.isActive=!0,t.id=this.sceneId,this.$episode.push(t),t}},{key:"getState",value:function(){return{filename:this.id,episode:this.$episode,story:JSON.parse(this.$story.saveState())}}},{key:"restoreState",value:function(t){this.id=t.filename,this.$episode=t.episode,this.$story.loadState(JSON.stringify(t.story))}},{key:"story",get:function(){return this.$story}},{key:"content",get:function(){return this.$episode}}]),t}();e.default=r},function(t,e,n){"use strict";var i=function(){function t(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}return function(e,n,i){return n&&t(e.prototype,n),i&&t(e,i),e}}(),a=u(n(6)),r=u(n(2)),o=u(n(1)),s=u(n(0));function u(t){return t&&t.__esModule?t:{default:t}}function l(t){return new Promise(function(){throw new Error(t+" is not implemented")})}var h=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.events={loadStory:function(){return l("loadStory")},loadGame:function(){return l("loadGame")},saveGame:function(){return l("saveGame")},error:function(){return l("error")}},this.inkObservers=new o.default,this.inkFunctions=new s.default,this.inkCommands={},this.episode={},this.command={},this.transcript=[]}return i(t,[{key:"startGame",value:function(){var t=this;return this.loadEpisode(this.game.episodes[0]).then(function(){t.episode.reset()})}},{key:"loadGame",value:function(t){var e=this,n={};return this.dispatch("loadGame",t).then(function(t){return n=JSON.parse(t),e.loadEpisode(n.episode.filename)}).then(function(){e.episode.restoreState(n.episode)})}},{key:"saveGame",value:function(t){return this.dispatch("saveGame",{id:t,data:this.getGameState()})}},{key:"renderScene",value:function(){var t=this.episode.renderScene(this.command);return this.game.transcript&&this.transcript.push(t),t}},{key:"getCurrentEpisode",value:function(){return this.episode.content}},{key:"getCurrentScene",value:function(){return this.episode.getCurrentScene()}},{key:"getTranscript",value:function(){return this.transcript}},{key:"makeChoice",value:function(t){var e=this;return new Promise(function(n,i){try{e.game.transcript&&(e.transcript[e.transcript.length-1].chosen=t),e.episode.makeChoice(t)}catch(t){e.dispatch("error",t),i(t)}n()})}},{key:"loadEpisode",value:function(t){var e=this;return this.dispatch("loadStory",t).then(function(n){var i=JSON.parse(n);e.initEpisode(t,i)})}},{key:"initEpisode",value:function(t,e){var n=this,i=new a.default(t,e,this.inkObservers,this.inkFunctions);this.episode=i,this.command=new r.default({episode:this.episode,story:this.episode.story}),Object.keys(this.inkCommands).forEach(function(t){var e=n.inkCommands[t];n.command.register(t,e.callback,e.deps)})}},{key:"getGameState",value:function(){return{episode:this.episode.getState()}}},{key:"on",value:function(t,e){this.events[t]=e}},{key:"dispatch",value:function(t,e){return this.events[t](e)}},{key:"registerFunctions",value:function(t){this.inkFunctions.register(t)}},{key:"registerObservers",value:function(t){this.inkObservers.register(t)}},{key:"registerCommand",value:function(t,e,n){this.inkCommands[t]={callback:e,deps:n}}},{key:"debug",value:function(){return this.episode.story.state}}]),t}();t.exports=h},function(t,e,n){t.exports=n(7)}])});
//# sourceMappingURL=atrament.js.map