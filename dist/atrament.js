!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Atrament=e():t.Atrament=e()}("undefined"!=typeof self?self:this,function(){return function(t){var e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={i:i,l:!1,exports:{}};return t[i].call(r.exports,r,r.exports,n),r.l=!0,r.exports}return n.m=t,n.c=e,n.d=function(t,e,i){n.o(t,e)||Object.defineProperty(t,e,{enumerable:!0,get:i})},n.r=function(t){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n.t=function(t,e){if(1&e&&(t=n(t)),8&e)return t;if(4&e&&"object"==typeof t&&t&&t.__esModule)return t;var i=Object.create(null);if(n.r(i),Object.defineProperty(i,"default",{enumerable:!0,value:t}),2&e&&"string"!=typeof t)for(var r in t)n.d(i,r,function(e){return t[e]}.bind(null,r));return i},n.n=function(t){var e=t&&t.__esModule?function(){return t.default}:function(){return t};return n.d(e,"a",e),e},n.o=function(t,e){return Object.prototype.hasOwnProperty.call(t,e)},n.p="/",n(n.s=1)}([function(t,e,n){!function(t){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&u(t,e)}function o(t){return(o=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function u(t,e){return(u=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function s(t,e,n){return(s=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],function(){})),!0}catch(t){return!1}}()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&u(r,n.prototype),r}).apply(null,arguments)}function l(t){var e="function"==typeof Map?new Map:void 0;return(l=function(t){if(null===t||!function(t){return-1!==Function.toString.call(t).indexOf("[native code]")}(t))return t;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,n)}function n(){return s(t,arguments,o(this).constructor)}return n.prototype=Object.create(t.prototype,{constructor:{value:n,enumerable:!1,writable:!0,configurable:!0}}),u(n,t)})(t)}function h(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function c(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],i=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done)&&(n.push(o.value),!e||n.length!==e);i=!0);}catch(t){r=!0,a=t}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}var f,v,d,y,p=function(){function t(){if(n(this,t),this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]){var e=arguments[0];this.componentsString=e}else if(arguments[0]instanceof t.Component&&arguments[1]instanceof t){var i=arguments[0],r=arguments[1];this._components.push(i),this._components=this._components.concat(r._components)}else if(arguments[0]instanceof Array){var a=arguments[0],o=!!arguments[1];this._components=this._components.concat(a),this._isRelative=o}}return r(t,[{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,r=0;r<e._components.length&&e._components[r].isParent;++r)i++;for(var a=0;a<this._components.length-i;++a)n._components.push(this._components[a]);for(var o=i;o<e._components.length;++o)n._components.push(e._components[o]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(e){var n=new t;return n._components.push.apply(n._components,this._components),n._components.push(e),n}},{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return 0<this._components.length?this._components[0]:null}},{key:"tail",get:function(){return 2<=this._components.length?new t(this._components.slice(1,this._components.length)):t.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return 0<=t?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(e){if(this._components.length=0,this._componentsString=e,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));var n=this._componentsString.split("."),i=!0,r=!1,a=void 0;try{for(var o,u=n[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;/^(\-|\+)?([0-9]+|Infinity)$/.test(s)?this._components.push(new t.Component(parseInt(s))):this._components.push(new t.Component(s))}}catch(e){r=!0,a=e}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}}}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}();function m(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),""}function g(t,e){return t instanceof e?w(t):null}function S(t,e){if(t instanceof e)return w(t);throw new Error("".concat(t," is not of type ").concat(e))}function k(t){if("number"==typeof t)return t;throw new Error("".concat(t," is not a number"))}function C(t){return t.hasValidName&&t.name?t:null}function b(t){return void 0===t?null:t}function w(t){return t}p.parentId="^",f=p=p||{},v=function(){function t(e){n(this,t),this.index=-1,this.name=null,"string"==typeof e?this.name=e:this.index=e}return r(t,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}},{key:"isIndex",get:function(){return 0<=this.index}},{key:"isParent",get:function(){return this.name==f.parentId}}],[{key:"ToParent",value:function(){return new t(f.parentId)}}]),t}(),f.Component=v,(y=d=d||{}).AssertType=function(t,e,n){m(t instanceof e,n)},y.Assert=m;var T=function(){function t(){return n(this,t),h(this,o(t).apply(this,arguments))}return a(t,l(Error)),t}();function _(t){throw new T("".concat(t," is null or undefined"))}var x=function(){function t(){n(this,t),this.parent=null,this._debugMetadata=null,this._path=null}return r(t,[{key:"DebugLineNumberOfPath",value:function(t){if(null===t)return null;var e=this.rootContentContainer;if(e){var n=e.ContentAtPath(t).obj;if(n){var i=n.debugMetadata;if(null!==i)return i.startLineNumber}}return null}},{key:"ResolvePath",value:function(t){if(null===t)return _("path");if(t.isRelative){var e=g(this,K);return null===e&&(d.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=g(this.parent,K),d.Assert(null!==e,"Expected parent to be a container"),d.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?_("nearestContainer"):e.ContentAtPath(t)}var n=this.rootContentContainer;return null===n?_("contentContainer"):n.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.length,e.length),i=-1,r=0;r<n;++r){var a=e.GetComponent(r),o=t.GetComponent(r);if(!a.Equals(o))break;i=r}if(-1==i)return t;for(var u=e.componentCount-1-i,s=[],l=0;l<u;++l)s.push(p.Component.ToParent());for(var h=i+1;h<t.componentCount;++h)s.push(t.GetComponent(h));return new p(s,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;return t.isRelative?(n=t.componentsString,e=this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,e=t.componentsString),n.length<e.length?n:e}},{key:"Copy",value:function(){throw Error("Not Implemented: Doesn't support copying")}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(t){this._debugMetadata=t}},{key:"ownDebugMetadata",get:function(){return this._debugMetadata}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new p;else{for(var t=[],e=this,n=g(e.parent,K);null!==n;){var i=C(e);null!=i&&i.hasValidName?t.unshift(new p.Component(i.name)):t.unshift(new p.Component(n.content.indexOf(e))),n=g((e=n).parent,K)}this._path=new p(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return g(t,K)}}]),t}(),E=function(){function t(e){n(this,t),e=void 0!==e?e.toString():"",this.string=e}return r(t,[{key:"Append",value:function(t){null!==t&&(this.string+=t)}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this.string+="\n"}},{key:"AppendFormat",value:function(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,function(t,e){return void 0!==n[e]?n[e]:t})}},{key:"toString",value:function(){return this.string}},{key:"Length",get:function(){return this.string.length}}]),t}(),O=function(){function t(){if(n(this,t),this.originName=null,this.itemName=null,void 0!==arguments[1]){var e=arguments[0],i=arguments[1];this.originName=e,this.itemName=i}else if(arguments[0]){var r=arguments[0].toString().split(".");this.originName=r[0],this.itemName=r[1]}}return r(t,[{key:"toString",value:function(){return this.fullName}},{key:"Equals",value:function(e){if(e instanceof t){var n=e;return n.itemName==this.itemName&&n.originName==this.originName}return!1}},{key:"copy",value:function(){return new t(this.originName,this.itemName)}},{key:"serialized",value:function(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}},{key:"isNull",get:function(){return null==this.originName&&null==this.itemName}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"fromSerializedKey",value:function(e){var n=JSON.parse(e);if(!t.isLikeInkListItem(n))return t.Null;var i=n;return new t(i.originName,i.itemName)}},{key:"isLikeInkListItem",value:function(t){return!("object"!==e(t)||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}},{key:"Null",get:function(){return new t(null,null)}}]),t}(),N=function(){function t(){var i,r=arguments;if(n(this,t),(i=h(this,o(t).call(this,r[0]instanceof t?r[0]:void 0))).origins=null,i._originNames=[],arguments[0]instanceof t){var a=arguments[0];a._originNames&&(i._originNames=a._originNames.slice())}else if("string"==typeof arguments[0]){var u=arguments[0],s=arguments[1];i.SetInitialOriginName(u);var l=s.listDefinitions.TryListGetDefinition(u,null);if(!l.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+u);i.origins=[l.result]}else if("object"===e(arguments[0])&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")){var c=arguments[0];i.Add(c.Key,c.Value)}return i}return a(t,l(Map)),r(t,[{key:"AddItem",value:function(t){if(t instanceof O){var e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return _("this.origins");var n=!0,i=!1,r=void 0;try{for(var a,o=this.origins[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;if(u.name==e.originName){var s=u.TryGetValueForItem(e,0);if(s.exists)return void this.Add(e,s.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}var l=t,h=null;if(null===this.origins)return _("this.origins");var c=!0,f=!1,v=void 0;try{for(var d,y=this.origins[Symbol.iterator]();!(c=(d=y.next()).done);c=!0){var p=d.value;if(null===l)return _("itemName");if(p.ContainsItemWithName(l)){if(null!=h)throw new Error("Could not add the item "+l+" to this list because it could come from either "+p.name+" or "+h.name);h=p}}}catch(t){f=!0,v=t}finally{try{c||null==y.return||y.return()}finally{if(f)throw v}}if(null==h)throw new Error("Could not add the item "+l+" to this list because it isn't known to any list definitions previously associated with this list.");var m=new O(h.name,l),g=h.ValueForItem(m);this.Add(m,g)}},{key:"ContainsItemNamed",value:function(t){var e=!0,n=!1,i=void 0;try{for(var r,a=this[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=c(r.value,2),u=o[0];if(o[1],O.fromSerializedKey(u).itemName==t)return!0}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return!1}},{key:"ContainsKey",value:function(t){return this.has(t.serialized())}},{key:"Add",value:function(t,e){var n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(t));this.set(n,e)}},{key:"Remove",value:function(t){return this.delete(t.serialized())}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"Union",value:function(e){var n=new t(this),i=!0,r=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=c(o.value,2),l=s[0],h=s[1];n.set(l,h)}}catch(e){r=!0,a=e}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return n}},{key:"Intersect",value:function(e){var n=new t,i=!0,r=!1,a=void 0;try{for(var o,u=this[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=c(o.value,2),l=s[0],h=s[1];e.has(l)&&n.set(l,h)}}catch(e){r=!0,a=e}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return n}},{key:"Without",value:function(e){var n=new t(this),i=!0,r=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=c(o.value,2),l=s[0];s[1],n.delete(l)}}catch(e){r=!0,a=e}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return n}},{key:"Contains",value:function(t){var e=!0,n=!1,i=void 0;try{for(var r,a=t[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=c(r.value,2),u=o[0];if(o[1],!this.has(u))return!1}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return!0}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return 0<this.Count?new t(this.maxItem):new t}},{key:"MinAsList",value:function(){return 0<this.Count?new t(this.minItem):new t}},{key:"ListWithSubRange",value:function(e,n){if(0==this.Count)return new t;var i=this.orderedItems,r=0,a=Number.MAX_SAFE_INTEGER;Number.isInteger(e)?r=e:e instanceof t&&0<e.Count&&(r=e.minItem.Value),Number.isInteger(n)?a=n:e instanceof t&&0<e.Count&&(a=n.maxItem.Value);var o=new t;o.SetInitialOriginNames(this.originNames);var u=!0,s=!1,l=void 0;try{for(var h,c=i[Symbol.iterator]();!(u=(h=c.next()).done);u=!0){var f=h.value;f.Value>=r&&f.Value<=a&&o.Add(f.Key,f.Value)}}catch(e){s=!0,l=e}finally{try{u||null==c.return||c.return()}finally{if(s)throw l}}return o}},{key:"Equals",value:function(e){if(e instanceof t==0)return!1;if(e.Count!=this.Count)return!1;var n=!0,i=!1,r=void 0;try{for(var a,o=this[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=c(a.value,2),s=u[0];if(u[1],!e.has(s))return!1}}catch(e){i=!0,r=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return!0}},{key:"toString",value:function(){for(var t=this.orderedItems,e=new E,n=0;n<t.length;n++){0<n&&e.Append(", ");var i=t[n].Key;if(null===i.itemName)return _("item.itemName");e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return this.size}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every(function(n){return n.name!=t||(e=n,!1)}),e}},{key:"originNames",get:function(){if(0<this.Count){null==this._originNames&&0<this.Count?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);var t=!0,e=!1,n=void 0;try{for(var i,r=this[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var a=c(i.value,2),o=a[0],u=(a[1],O.fromSerializedKey(o));if(null===u.originName)return _("item.originName");this._originNames.push(u.originName)}}catch(t){e=!0,n=t}finally{try{t||null==r.return||r.return()}finally{if(e)throw n}}}return this._originNames}},{key:"maxItem",get:function(){var t={Key:O.Null,Value:0},e=!0,n=!1,i=void 0;try{for(var r,a=this[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=c(r.value,2),u=o[0],s=o[1],l=O.fromSerializedKey(u);(t.Key.isNull||s>t.Value)&&(t={Key:l,Value:s})}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return t}},{key:"minItem",get:function(){var t={Key:O.Null,Value:0},e=!0,n=!1,i=void 0;try{for(var r,a=this[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=c(r.value,2),u=o[0],s=o[1],l=O.fromSerializedKey(u);(t.Key.isNull||s<t.Value)&&(t={Key:l,Value:s})}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return t}},{key:"inverse",get:function(){var e=new t;if(null!=this.origins){var n=!0,i=!1,r=void 0;try{for(var a,o=this.origins[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value,s=!0,l=!1,h=void 0;try{for(var f,v=u.items[Symbol.iterator]();!(s=(f=v.next()).done);s=!0){var d=c(f.value,2),y=d[0],p=d[1],m=O.fromSerializedKey(y);this.ContainsKey(m)||e.Add(m,p)}}catch(e){l=!0,h=e}finally{try{s||null==v.return||v.return()}finally{if(l)throw h}}}}catch(e){i=!0,r=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}return e}},{key:"all",get:function(){var e=new t;if(null!=this.origins){var n=!0,i=!1,r=void 0;try{for(var a,o=this.origins[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value,s=!0,l=!1,h=void 0;try{for(var f,v=u.items[Symbol.iterator]();!(s=(f=v.next()).done);s=!0){var d=c(f.value,2),y=d[0],p=d[1],m=O.fromSerializedKey(y);e.set(m.serialized(),p)}}catch(e){l=!0,h=e}finally{try{s||null==v.return||v.return()}finally{if(l)throw h}}}}catch(e){i=!0,r=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}return e}},{key:"orderedItems",get:function(){var t=new Array,e=!0,n=!1,i=void 0;try{for(var r,a=this[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=c(r.value,2),u=o[0],s=o[1],l=O.fromSerializedKey(u);t.push({Key:l,Value:s})}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return t.sort(function(t,e){return null===t.Key.originName?_("x.Key.originName"):null===e.Key.originName?_("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0}),t}}]),t}(),P=function(){function t(e){var i;return n(this,t),(i=h(this,o(t).call(this,e))).useEndLineNumber=!1,i.message=e,i.name="StoryException",i}return a(t,l(Error)),t}();function A(t,e,n){if(null===t)return{result:n,exists:!1};var i=t.get(e);return i?{result:i,exists:!0}:{result:n,exists:!1}}var I,F,V=function(){function t(){return n(this,t),h(this,o(t).apply(this,arguments))}return a(t,x),r(t,[{key:"Copy",value:function(){return S(t.Create(this),x)}},{key:"BadCastException",value:function(t){return new P("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}],[{key:"Create",value:function(t){return"boolean"==typeof t&&(t=t?1:0),Number.isInteger(Number(t))?new R(Number(t)):isNaN(t)?"string"==typeof t?new j(String(t)):t instanceof p?new G(S(t,p)):t instanceof N?new B(S(t,N)):null:new D(Number(t))}}]),t}(),L=function(){function t(e){var i;return n(this,t),(i=h(this,o(t).call(this))).value=e,i}return a(t,V),r(t,[{key:"toString",value:function(){return null===this.value?_("Value.value"):this.value.toString()}},{key:"valueObject",get:function(){return this.value}}]),t}(),R=function(){function t(e){return n(this,t),h(this,o(t).call(this,e||0))}return a(t,L),r(t,[{key:"Cast",value:function(t){if(null===this.value)return _("Value.value");if(t==this.valueType)return this;if(t==I.Float)return new D(this.value);if(t==I.String)return new j(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return I.Int}}]),t}(),D=function(){function t(e){return n(this,t),h(this,o(t).call(this,e||0))}return a(t,L),r(t,[{key:"Cast",value:function(t){if(null===this.value)return _("Value.value");if(t==this.valueType)return this;if(t==I.Int)return new R(this.value);if(t==I.String)return new j(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return I.Float}}]),t}(),j=function(){function t(e){var i;return n(this,t),(i=h(this,o(t).call(this,e||"")))._isNewline="\n"==i.value,i._isInlineWhitespace=!0,null===i.value?h(i,_("Value.value")):(0<i.value.length&&i.value.split("").every(function(t){return" "==t||"\t"==t||(i._isInlineWhitespace=!1)}),i)}return a(t,L),r(t,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==I.Int){var e=function(t,e){var n=1<arguments.length&&void 0!==e?e:0,i=parseInt(t);return Number.isNaN(i)?{result:n,exists:!1}:{result:i,exists:!0}}(this.value);if(e.exists)return new R(e.result);throw this.BadCastException(t)}if(t!=I.Float)throw this.BadCastException(t);var n=function(t,e){var n=1<arguments.length&&void 0!==e?e:0,i=parseFloat(t);return Number.isNaN(i)?{result:n,exists:!1}:{result:i,exists:!0}}(this.value);if(n.exists)return new D(n.result);throw this.BadCastException(t)}},{key:"valueType",get:function(){return I.String}},{key:"isTruthy",get:function(){return null===this.value?_("Value.value"):0<this.value.length}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),t}(),G=function(){function t(e){return n(this,t),h(this,o(t).call(this,e))}return a(t,L),r(t,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"valueType",get:function(){return I.DivertTarget}},{key:"targetPath",get:function(){return null===this.value?_("Value.value"):this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a divert target")}}]),t}(),M=function(){function t(e){var i,r=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;return n(this,t),(i=h(this,o(t).call(this,e)))._contextIndex=r,i}return a(t,L),r(t,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new t(this.variableName,this.contextIndex)}},{key:"contextIndex",get:function(){return this._contextIndex},set:function(t){this._contextIndex=t}},{key:"variableName",get:function(){return null===this.value?_("Value.value"):this.value},set:function(t){this.value=t}},{key:"valueType",get:function(){return I.VariablePointer}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}}]),t}(),B=function(){function t(e,i){var r;return n(this,t),r=h(this,o(t).call(this,null)),e||i?e instanceof N?r.value=new N(e):e instanceof O&&"number"==typeof i&&(r.value=new N({Key:e,Value:i})):r.value=new N,r}return a(t,L),r(t,[{key:"Cast",value:function(t){if(null===this.value)return _("Value.value");if(t==I.Int){var e=this.value.maxItem;return e.Key.isNull?new R(0):new R(e.Value)}if(t==I.Float){var n=this.value.maxItem;return n.Key.isNull?new D(0):new D(n.Value)}if(t==I.String){var i=this.value.maxItem;return i.Key.isNull?new j(""):new j(i.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return null===this.value?_("this.value"):0<this.value.Count}},{key:"valueType",get:function(){return I.List}}]),r(t,null,[{key:"RetainListOriginsForAssignment",value:function(e,n){var i=g(e,t),r=g(n,t);return r&&null===r.value?_("newList.value"):i&&null===i.value?_("oldList.value"):void(i&&r&&0==r.value.Count&&r.value.SetInitialOriginNames(i.value.originNames))}}]),t}();(F=I=I||{})[F.Int=0]="Int",F[F.Float=1]="Float",F[F.List=2]="List",F[F.String=3]="String",F[F.DivertTarget=4]="DivertTarget",F[F.VariablePointer=5]="VariablePointer";var W,J,q=function(){function t(){n(this,t),this.obj=null,this.approximate=!1}return r(t,[{key:"copy",value:function(){var e=new t;return e.obj=this.obj,e.approximate=this.approximate,e}},{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof K?this.obj:null}}]),t}(),K=function(){function t(){var e;return n(this,t),(e=h(this,o(t).apply(this,arguments))).name="",e._content=[],e.namedContent=new Map,e.visitsShouldBeCounted=!1,e.turnIndexShouldBeCounted=!1,e.countingAtStartOnly=!1,e._pathToFirstLeafContent=null,e}return a(t,x),r(t,[{key:"AddContent",value:function(t){if(t instanceof Array){var e=t,n=!0,i=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;this.AddContent(u)}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}else{var s=t;if(this._content.push(s),s.parent)throw new Error("content is already in "+s.parent);(s.parent=this).TryAddNamedContent(s)}}},{key:"TryAddNamedContent",value:function(t){var e=C(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}},{key:"AddToNamedContentOnly",value:function(t){d.AssertType(t,x,"Can only add Runtime.Objects to a Runtime.Container"),(S(t,x).parent=this).namedContent.set(t.name,t)}},{key:"ContentAtPath",value:function(e,n,i){var r=1<arguments.length&&void 0!==n?n:0,a=2<arguments.length&&void 0!==i?i:-1;-1==a&&(a=e.length);var o=new q;o.approximate=!1;for(var u=this,s=this,l=r;l<a;++l){var h=e.GetComponent(l);if(null==u){o.approximate=!0;break}var c=u.ContentWithPathComponent(h);if(null==c){o.approximate=!0;break}u=g(s=c,t)}return o.obj=s,o}},{key:"InsertContent",value:function(t,e){if((this.content[e]=t).parent)throw new Error("content is already in "+t.parent);(t.parent=this).TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){this.content=this.content.concat(t.content);var e=!0,n=!1,i=void 0;try{for(var r,a=t.content[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=r.value;(o.parent=this).TryAddNamedContent(o)}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return 0<=t.index&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;if(null===t.name)return _("component.name");var e=A(this.namedContent,t.name,null);return e.exists?S(e.result,x):null}},{key:"BuildStringOfHierarchy",value:function(e,n,i){var r;if(0==arguments.length)return r=new E,this.BuildStringOfHierarchy(r,0,null),r.toString();r=e;var a=n,o=i;function u(){for(var t=0;t<4*a;++t)r.Append(" ")}u(),r.Append("["),this.hasValidName&&r.AppendFormat(" ({0})",this.name),this==o&&r.Append("  <---"),r.AppendLine(),a++;for(var s=0;s<this.content.length;++s){var l=this.content[s];l instanceof t?l.BuildStringOfHierarchy(r,a,o):(u(),l instanceof j?(r.Append('"'),r.Append(l.toString().replace("\n","\\n")),r.Append('"')):r.Append(l.toString())),s!=this.content.length-1&&r.Append(","),l instanceof t||l!=o||r.Append("  <---"),r.AppendLine()}var h=new Map,f=!0,v=!1,y=void 0;try{for(var p,m=this.namedContent[Symbol.iterator]();!(f=(p=m.next()).done);f=!0){var g=c(p.value,2),k=g[0],C=g[1];0<=this.content.indexOf(S(C,x))||h.set(k,C)}}catch(e){v=!0,y=e}finally{try{f||null==m.return||m.return()}finally{if(v)throw y}}if(0<h.size){u(),r.AppendLine("-- named: --");var b=!0,w=!1,T=void 0;try{for(var _,O=h[Symbol.iterator]();!(b=(_=O.next()).done);b=!0){var N=c(_.value,2);k=N[0],C=N[1],d.AssertType(C,t,"Can only print out named Containers"),C.BuildStringOfHierarchy(r,a,o),r.AppendLine()}}catch(e){w=!0,T=e}finally{try{b||null==O.return||O.return()}finally{if(w)throw T}}}a--,u(),r.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&0<this.name.length}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t=new Map,e=!0,n=!1,i=void 0;try{for(var r,a=this.namedContent[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=c(r.value,2),u=o[0],s=S(o[1],x);t.set(u,s)}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}var l=!0,h=!1,f=void 0;try{for(var v,d=this.content[Symbol.iterator]();!(l=(v=d.next()).done);l=!0){var y=C(v.value);null!=y&&y.hasValidName&&t.delete(y.name)}}catch(t){h=!0,f=t}finally{try{l||null==d.return||d.return()}finally{if(h)throw f}}return 0==t.size&&(t=null),t},set:function(t){var e=this.namedOnlyContent;if(null!=e){var n=!0,i=!1,r=void 0;try{for(var a,o=e[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=c(a.value,2),s=u[0];u[1],this.namedContent.delete(s)}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}if(null!=t){var l=!0,h=!1,f=void 0;try{for(var v,d=t[Symbol.iterator]();!(l=(v=d.next()).done);l=!0){var y=c(v.value,2),p=(s=y[0],C(y[1]));null!=p&&this.AddToNamedContentOnly(p)}}catch(t){h=!0,f=t}finally{try{l||null==d.return||d.return()}finally{if(h)throw f}}}}},{key:"countFlags",get:function(){var e=0;return this.visitsShouldBeCounted&&(e|=t.CountFlags.Visits),this.turnIndexShouldBeCounted&&(e|=t.CountFlags.Turns),this.countingAtStartOnly&&(e|=t.CountFlags.CountStartOnly),e==t.CountFlags.CountStartOnly&&(e=0),e},set:function(e){var n=e;0<(n&t.CountFlags.Visits)&&(this.visitsShouldBeCounted=!0),0<(n&t.CountFlags.Turns)&&(this.turnIndexShouldBeCounted=!0),0<(n&t.CountFlags.CountStartOnly)&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var e=[],n=this;n instanceof t;)0<n.content.length&&(e.push(new p.Component(0)),n=n.content[0]);return new p(e)}}]),t}();W=K=K||{},(J=W.CountFlags||(W.CountFlags={}))[J.Visits=1]="Visits",J[J.Turns=2]="Turns",J[J.CountStartOnly=4]="CountStartOnly";var U,$,z,H,X=function(){function t(){return n(this,t),h(this,o(t).apply(this,arguments))}return a(t,x),r(t,[{key:"toString",value:function(){return"Glue"}}]),t}(),Q=function(){function t(){var e,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:t.CommandType.NotSet;return n(this,t),(e=h(this,o(t).call(this)))._commandType=i,e}return a(t,x),r(t,[{key:"commandType",get:function(){return this._commandType}}]),r(t,[{key:"Copy",value:function(){return new t(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}}],[{key:"EvalStart",value:function(){return new t(t.CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new t(t.CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new t(t.CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new t(t.CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new t(t.CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new t(t.CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new t(t.CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new t(t.CommandType.BeginString)}},{key:"EndString",value:function(){return new t(t.CommandType.EndString)}},{key:"NoOp",value:function(){return new t(t.CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new t(t.CommandType.ChoiceCount)}},{key:"Turns",value:function(){return new t(t.CommandType.Turns)}},{key:"TurnsSince",value:function(){return new t(t.CommandType.TurnsSince)}},{key:"ReadCount",value:function(){return new t(t.CommandType.ReadCount)}},{key:"Random",value:function(){return new t(t.CommandType.Random)}},{key:"SeedRandom",value:function(){return new t(t.CommandType.SeedRandom)}},{key:"VisitIndex",value:function(){return new t(t.CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new t(t.CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new t(t.CommandType.StartThread)}},{key:"Done",value:function(){return new t(t.CommandType.Done)}},{key:"End",value:function(){return new t(t.CommandType.End)}},{key:"ListFromInt",value:function(){return new t(t.CommandType.ListFromInt)}},{key:"ListRange",value:function(){return new t(t.CommandType.ListRange)}},{key:"ListRandom",value:function(){return new t(t.CommandType.ListRandom)}}]),t}();U=Q=Q||{},($=U.CommandType||(U.CommandType={}))[$.NotSet=-1]="NotSet",$[$.EvalStart=0]="EvalStart",$[$.EvalOutput=1]="EvalOutput",$[$.EvalEnd=2]="EvalEnd",$[$.Duplicate=3]="Duplicate",$[$.PopEvaluatedValue=4]="PopEvaluatedValue",$[$.PopFunction=5]="PopFunction",$[$.PopTunnel=6]="PopTunnel",$[$.BeginString=7]="BeginString",$[$.EndString=8]="EndString",$[$.NoOp=9]="NoOp",$[$.ChoiceCount=10]="ChoiceCount",$[$.Turns=11]="Turns",$[$.TurnsSince=12]="TurnsSince",$[$.Random=13]="Random",$[$.SeedRandom=14]="SeedRandom",$[$.VisitIndex=15]="VisitIndex",$[$.SequenceShuffleIndex=16]="SequenceShuffleIndex",$[$.StartThread=17]="StartThread",$[$.Done=18]="Done",$[$.End=19]="End",$[$.ListFromInt=20]="ListFromInt",$[$.ListRange=21]="ListRange",$[$.ListRandom=22]="ListRandom",$[$.ReadCount=23]="ReadCount",$[$.TOTAL_VALUES=24]="TOTAL_VALUES",(H=z=z||{})[H.Tunnel=0]="Tunnel",H[H.Function=1]="Function",H[H.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame";var Y=function(){function t(){n(this,t),this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}return r(t,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new t(this.container,this.index)}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:0<=this.index?this.container.path.PathByAppendingComponent(new p.Component(this.index)):this.container.path}}],[{key:"StartOf",value:function(e){return new t(e,0)}},{key:"Null",get:function(){return new t(null,-1)}}]),t}(),Z=function(){function t(e){var i;return n(this,t),(i=h(this,o(t).call(this)))._targetPath=null,i._targetPointer=Y.Null,i.variableDivertName=null,i.pushesToStack=!1,i.stackPushType=0,i.isExternal=!1,i.externalArgs=0,i.isConditional=!1,i.pushesToStack=!1,void 0!==e&&(i.pushesToStack=!0,i.stackPushType=e),i}return a(t,x),r(t,[{key:"Equals",value:function(e){var n=e;return n instanceof t&&this.hasVariableTarget==n.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==n.variableDivertName:null===this.targetPath?_("this.targetPath"):this.targetPath.Equals(n.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new E,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==z.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}},{key:"targetPath",get:function(){if(null!=this._targetPath&&this._targetPath.isRelative){var t=this.targetPointer.Resolve();t&&(this._targetPath=t.path)}return this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=Y.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return _("this._targetPath");if(null===this._targetPath.lastComponent)return _("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return _("targetObj");this._targetPointer.container=t.parent instanceof K?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=Y.StartOf(t instanceof K?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new p(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),t}(),tt=function(){function t(){var e,i=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];return n(this,t),(e=h(this,o(t).call(this)))._pathOnChoice=null,e.hasCondition=!1,e.hasStartContent=!1,e.hasChoiceOnlyContent=!1,e.isInvisibleDefault=!1,e.onceOnly=!0,e.onceOnly=i,e}return a(t,x),r(t,[{key:"toString",value:function(){return null===this.pathOnChoice?_("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}},{key:"pathOnChoice",get:function(){if(null!=this._pathOnChoice&&this._pathOnChoice.isRelative){var t=this.choiceTarget;t&&(this._pathOnChoice=t.path)}return this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return null===this._pathOnChoice?_("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return null===this.pathOnChoice?_("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new p(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=0<(1&t),this.hasStartContent=0<(2&t),this.hasChoiceOnlyContent=0<(4&t),this.isInvisibleDefault=0<(8&t),this.onceOnly=0<(16&t)}}]),t}(),et=function(){function t(){var e,i=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return n(this,t),(e=h(this,o(t).call(this))).pathForCount=null,e.name=i,e}return a(t,x),r(t,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null===t?null:new p(t)}}]),t}(),nt=function(){function t(e,i){var r;return n(this,t),(r=h(this,o(t).call(this))).variableName=e||null,r.isNewDeclaration=!!i,r.isGlobal=!1,r}return a(t,x),r(t,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}}]),t}(),it=function(){function t(){return n(this,t),h(this,o(t).apply(this,arguments))}return a(t,x),t}(),rt=function(){function t(){var e;if(n(this,t),(e=h(this,o(t).call(this)))._name=null,e._numberOfParameters=0,e._prototype=null,e._isPrototype=!1,e._operationFuncs=null,0===arguments.length)t.GenerateNativeFunctionsIfNecessary();else if(1===arguments.length){var i=arguments[0];t.GenerateNativeFunctionsIfNecessary(),e.name=i}else if(2===arguments.length){var r=arguments[0],a=arguments[1];e._isPrototype=!0,e.name=r,e.numberOfParameters=a}return e}return a(t,x),r(t,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");var e=!1,n=!0,i=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;if(u instanceof it)throw new P('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');u instanceof B&&(e=!0)}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}if(2==t.length&&e)return this.CallBinaryListOperation(t);var s=this.CoerceValuesToSingleType(t),l=s[0].valueType;return l==I.Int?this.CallType(s):l==I.Float?this.CallType(s):l==I.String?this.CallType(s):l==I.DivertTarget?this.CallType(s):l==I.List?this.CallType(s):null}},{key:"CallType",value:function(t){var e=S(t[0],L),n=e.valueType,i=e,r=t.length;if(2!=r&&1!=r)throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length);if(null===this._operationFuncs)return _("NativeFunctionCall._operationFuncs");var a=this._operationFuncs.get(n);if(!a)throw new P("Cannot perform operation "+this.name+" on "+n);if(2==r){var o=S(t[1],L),u=a;if(null===i.value||null===o.value)return _("NativeFunctionCall.Call BinaryOp values");var s=u(i.value,o.value);return L.Create(s)}var l=a;if(null===i.value)return _("NativeFunctionCall.Call UnaryOp value");var h=l(i.value);return L.Create(h)}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof B&&t[1]instanceof R)return this.CallListIncrementOperation(t);var e=S(t[0],L),n=S(t[1],L);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==I.List&&n.valueType==I.List)){if(null===this._operationFuncs)return _("NativeFunctionCall._operationFuncs");var i=this._operationFuncs.get(I.Int);if(null===i)return _("NativeFunctionCall.CallBinaryListOperation op");var r=i(e.isTruthy?1:0,n.isTruthy?1:0);return new R(r)}if(e.valueType==I.List&&n.valueType==I.List)return this.CallType([e,n]);throw new P("Can not call use "+this.name+" operation on "+e.valueType+" and "+n.valueType)}},{key:"CallListIncrementOperation",value:function(t){var e=S(t[0],B),n=S(t[1],R),i=new N;if(null===e.value)return _("NativeFunctionCall.CallListIncrementOperation listVal.value");var r=!0,a=!1,o=void 0;try{for(var u,s=e.value[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=c(u.value,2),h=l[0],f=l[1],v=O.fromSerializedKey(h);if(null===this._operationFuncs)return _("NativeFunctionCall._operationFuncs");var d=this._operationFuncs.get(I.Int);if(null===n.value)return _("NativeFunctionCall.CallListIncrementOperation intVal.value");var y=d(f,n.value),p=null;if(null===e.value.origins)return _("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");var m=!0,g=!1,k=void 0;try{for(var C,b=e.value.origins[Symbol.iterator]();!(m=(C=b.next()).done);m=!0){var w=C.value;if(w.name==v.originName){p=w;break}}}catch(t){g=!0,k=t}finally{try{m||null==b.return||b.return()}finally{if(g)throw k}}if(null!=p){var T=p.TryGetItemWithValue(y,O.Null);T.exists&&i.Add(T.result,y)}}}catch(t){a=!0,o=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return new B(i)}},{key:"CoerceValuesToSingleType",value:function(t){var e=I.Int,n=null,i=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=S(o.value,L);s.valueType>e&&(e=s.valueType),s.valueType==I.List&&(n=g(s,B))}}catch(t){r=!0,a=t}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}var l=[];if(I[e]==I[I.List]){var h=!0,c=!1,f=void 0;try{for(var v,d=t[Symbol.iterator]();!(h=(v=d.next()).done);h=!0){var y=S(v.value,L);if(y.valueType==I.List)l.push(y);else{if(y.valueType!=I.Int)throw new P("Cannot mix Lists and "+y.valueType+" values in this operation");var p=parseInt(y.valueObject);if(null===(n=S(n,B)).value)return _("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var m=n.value.originOfMaxItem;if(null===m)return _("NativeFunctionCall.CoerceValuesToSingleType list");var k=m.TryGetItemWithValue(p,O.Null);if(!k.exists)throw new P("Could not find List item with the value "+p+" in "+m.name);var C=new B(k.result,p);l.push(C)}}}catch(t){c=!0,f=t}finally{try{h||null==d.return||d.return()}finally{if(c)throw f}}}else{var b=!0,w=!1,T=void 0;try{for(var x,E=t[Symbol.iterator]();!(b=(x=E.next()).done);b=!0){var N=S(x.value,L).Cast(e);l.push(N)}}catch(t){w=!0,T=t}finally{try{b||null==E.return||E.return()}finally{if(w)throw T}}}return l}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}},{key:"toString",value:function(){return'Native "'+this.name+'"'}},{key:"name",get:function(){return null===this._name?_("NativeFunctionCall._name"):this._name},set:function(e){this._name=e,this._isPrototype||(null===t._nativeFunctions?_("NativeFunctionCall._nativeFunctions"):this._prototype=t._nativeFunctions.get(this._name)||null)}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"CallWithName",value:function(e){return new t(e)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}},{key:"Identity",value:function(t){return t}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,function(t,e){return t+e}),this.AddIntBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddIntBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddIntBinaryOp(this.Divide,function(t,e){return Math.round(t/e)}),this.AddIntBinaryOp(this.Mod,function(t,e){return t%e}),this.AddIntUnaryOp(this.Negate,function(t){return-t}),this.AddIntBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddIntBinaryOp(this.Greater,function(t,e){return e<t?1:0}),this.AddIntBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddIntBinaryOp(this.GreaterThanOrEquals,function(t,e){return e<=t?1:0}),this.AddIntBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddIntBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddIntUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddIntBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddIntBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddIntBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddIntBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddIntBinaryOp(this.Pow,function(t,e){return Math.pow(t,e)}),this.AddIntUnaryOp(this.Floor,t.Identity),this.AddIntUnaryOp(this.Ceiling,t.Identity),this.AddIntUnaryOp(this.Int,t.Identity),this.AddIntUnaryOp(this.Float,function(t){return t}),this.AddFloatBinaryOp(this.Add,function(t,e){return t+e}),this.AddFloatBinaryOp(this.Subtract,function(t,e){return t-e}),this.AddFloatBinaryOp(this.Multiply,function(t,e){return t*e}),this.AddFloatBinaryOp(this.Divide,function(t,e){return t/e}),this.AddFloatBinaryOp(this.Mod,function(t,e){return t%e}),this.AddFloatUnaryOp(this.Negate,function(t){return-t}),this.AddFloatBinaryOp(this.Equal,function(t,e){return t==e?1:0}),this.AddFloatBinaryOp(this.Greater,function(t,e){return e<t?1:0}),this.AddFloatBinaryOp(this.Less,function(t,e){return t<e?1:0}),this.AddFloatBinaryOp(this.GreaterThanOrEquals,function(t,e){return e<=t?1:0}),this.AddFloatBinaryOp(this.LessThanOrEquals,function(t,e){return t<=e?1:0}),this.AddFloatBinaryOp(this.NotEquals,function(t,e){return t!=e?1:0}),this.AddFloatUnaryOp(this.Not,function(t){return 0==t?1:0}),this.AddFloatBinaryOp(this.And,function(t,e){return 0!=t&&0!=e?1:0}),this.AddFloatBinaryOp(this.Or,function(t,e){return 0!=t||0!=e?1:0}),this.AddFloatBinaryOp(this.Max,function(t,e){return Math.max(t,e)}),this.AddFloatBinaryOp(this.Min,function(t,e){return Math.min(t,e)}),this.AddFloatBinaryOp(this.Pow,function(t,e){return Math.pow(t,e)}),this.AddFloatUnaryOp(this.Floor,function(t){return Math.floor(t)}),this.AddFloatUnaryOp(this.Ceiling,function(t){return Math.ceil(t)}),this.AddFloatUnaryOp(this.Int,function(t){return Math.floor(t)}),this.AddFloatUnaryOp(this.Float,t.Identity),this.AddStringBinaryOp(this.Add,function(t,e){return t+e}),this.AddStringBinaryOp(this.Equal,function(t,e){return t===e?1:0}),this.AddStringBinaryOp(this.NotEquals,function(t,e){return t!==e?1:0}),this.AddStringBinaryOp(this.Has,function(t,e){return t.includes(e)?1:0}),this.AddStringBinaryOp(this.Hasnt,function(t,e){return t.includes(e)?0:1}),this.AddListBinaryOp(this.Add,function(t,e){return t.Union(e)}),this.AddListBinaryOp(this.Subtract,function(t,e){return t.Without(e)}),this.AddListBinaryOp(this.Has,function(t,e){return t.Contains(e)?1:0}),this.AddListBinaryOp(this.Hasnt,function(t,e){return t.Contains(e)?0:1}),this.AddListBinaryOp(this.Intersect,function(t,e){return t.Intersect(e)}),this.AddListBinaryOp(this.Equal,function(t,e){return t.Equals(e)?1:0}),this.AddListBinaryOp(this.Greater,function(t,e){return t.GreaterThan(e)?1:0}),this.AddListBinaryOp(this.Less,function(t,e){return t.LessThan(e)?1:0}),this.AddListBinaryOp(this.GreaterThanOrEquals,function(t,e){return t.GreaterThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.LessThanOrEquals,function(t,e){return t.LessThanOrEquals(e)?1:0}),this.AddListBinaryOp(this.NotEquals,function(t,e){return t.Equals(e)?0:1}),this.AddListBinaryOp(this.And,function(t,e){return 0<t.Count&&0<e.Count?1:0}),this.AddListBinaryOp(this.Or,function(t,e){return 0<t.Count||0<e.Count?1:0}),this.AddListUnaryOp(this.Not,function(t){return 0==t.Count?1:0}),this.AddListUnaryOp(this.Invert,function(t){return t.inverse}),this.AddListUnaryOp(this.All,function(t){return t.all}),this.AddListUnaryOp(this.ListMin,function(t){return t.MinAsList()}),this.AddListUnaryOp(this.ListMax,function(t){return t.MaxAsList()}),this.AddListUnaryOp(this.Count,function(t){return t.Count}),this.AddListUnaryOp(this.ValueOfList,function(t){return t.maxItem.Value}),this.AddOpToNativeFunc(this.Equal,2,I.DivertTarget,function(t,e){return t.Equals(e)?1:0}),this.AddOpToNativeFunc(this.NotEquals,2,I.DivertTarget,function(t,e){return t.Equals(e)?0:1}))}},{key:"AddOpToNativeFunc",value:function(e,n,i,r){if(null===this._nativeFunctions)return _("NativeFunctionCall._nativeFunctions");var a=this._nativeFunctions.get(e);a||(a=new t(e,n),this._nativeFunctions.set(e,a)),a.AddOpFuncForType(i,r)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,I.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,I.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,I.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,I.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,I.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,I.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,I.List,e)}}]),t}();rt.Add="+",rt.Subtract="-",rt.Divide="/",rt.Multiply="*",rt.Mod="%",rt.Negate="_",rt.Equal="==",rt.Greater=">",rt.Less="<",rt.GreaterThanOrEquals=">=",rt.LessThanOrEquals="<=",rt.NotEquals="!=",rt.Not="!",rt.And="&&",rt.Or="||",rt.Min="MIN",rt.Max="MAX",rt.Pow="POW",rt.Floor="FLOOR",rt.Ceiling="CEILING",rt.Int="INT",rt.Float="FLOAT",rt.Has="?",rt.Hasnt="!?",rt.Intersect="^",rt.ListMin="LIST_MIN",rt.ListMax="LIST_MAX",rt.All="LIST_ALL",rt.Count="LIST_COUNT",rt.ValueOfList="LIST_VALUE",rt.Invert="LIST_INVERT",rt._nativeFunctions=null;var at=function(){function t(e){var i;return n(this,t),(i=h(this,o(t).call(this))).text=e.toString()||"",i}return a(t,x),r(t,[{key:"toString",value:function(){return"# "+this.text}}]),t}(),ot=function(){function t(){var e;return n(this,t),(e=h(this,o(t).apply(this,arguments))).text="",e.index=0,e.threadAtGeneration=null,e.sourcePath="",e.targetPath=null,e.isInvisibleDefault=!1,e.originalThreadIndex=0,e}return a(t,x),r(t,[{key:"pathStringOnChoice",get:function(){return null===this.targetPath?_("Choice.targetPath"):this.targetPath.toString()},set:function(t){this.targetPath=new p(t)}}]),t}(),ut=function(){function t(e,i){n(this,t),this._name=e||"",this._items=null,this._itemNameToValues=i||new Map}return r(t,[{key:"ValueForItem",value:function(t){if(!t.itemName)return 0;var e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}},{key:"ContainsItemWithName",value:function(t){return this._itemNameToValues.has(t)}},{key:"TryGetItemWithValue",value:function(t,e){var n=!0,i=!1,r=void 0;try{for(var a,o=this._itemNameToValues[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=c(a.value,2),s=u[0];if(u[1]==t)return{result:new O(this.name,s),exists:!0}}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return{result:O.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t,e){if(!t.itemName)return{result:0,exists:!1};var n=this._itemNameToValues.get(t.itemName);return n?{result:n,exists:!0}:{result:0,exists:!1}}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items){this._items=new Map;var t=!0,e=!1,n=void 0;try{for(var i,r=this._itemNameToValues[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var a=c(i.value,2),o=a[0],u=a[1],s=new O(this.name,o);this._items.set(s.serialized(),u)}}catch(t){e=!0,n=t}finally{try{t||null==r.return||r.return()}finally{if(e)throw n}}}return this._items}}]),t}(),st=function(){function t(e){n(this,t),this._lists=new Map,this._allUnambiguousListValueCache=new Map;var i=!0,r=!1,a=void 0;try{for(var o,u=e[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;this._lists.set(s.name,s);var l=!0,h=!1,f=void 0;try{for(var v,d=s.items[Symbol.iterator]();!(l=(v=d.next()).done);l=!0){var y=c(v.value,2),p=y[0],m=y[1],g=O.fromSerializedKey(p),S=new B(g,m);if(!g.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(g.itemName,S),this._allUnambiguousListValueCache.set(g.fullName,S)}}catch(e){h=!0,f=e}finally{try{l||null==d.return||d.return()}finally{if(h)throw f}}}}catch(e){r=!0,a=e}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}}return r(t,[{key:"TryListGetDefinition",value:function(t,e){if(null===t)return{result:e,exists:!1};var n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}},{key:"FindSingleItemListWithName",value:function(t){if(null===t)return _("name");var e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}},{key:"lists",get:function(){var t=[],e=!0,n=!1,i=void 0;try{for(var r,a=this._lists[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=c(r.value,2),u=(o[0],o[1]);t.push(u)}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return t}}]),t}(),lt=function(){function t(){n(this,t)}return r(t,null,[{key:"ListToJArray",value:function(t){var e=[],n=!0,i=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;e.push(this.RuntimeObjectToJToken(u))}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return e}},{key:"JArrayToRuntimeObjList",value:function(t,e){var n=1<arguments.length&&void 0!==e&&e,i=t.length;n&&i--;for(var r=[],a=0;a<i;a++){var o=t[a],u=this.JTokenToRuntimeObject(o);if(null===u)return _("runtimeObj");r.push(u)}return r}},{key:"DictionaryRuntimeObjsToJObject",value:function(t){var e={},n=!0,i=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=c(a.value,2),s=u[0],l=g(u[1],x);null!=l&&(e[s]=this.RuntimeObjectToJToken(l))}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return e}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e=new Map;for(var n in t)if(t.hasOwnProperty(n)){var i=this.JTokenToRuntimeObject(t[n]);if(null===i)return _("inkObject");e.set(n,i)}return e}},{key:"JObjectToIntDictionary",value:function(t){var e=new Map;for(var n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}},{key:"IntDictionaryToJObject",value:function(t){var e={},n=!0,i=!1,r=void 0;try{for(var a,o=t[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=c(a.value,2),s=u[0],l=u[1];e[s]=k(l)}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return e}},{key:"JTokenToRuntimeObject",value:function(n){if("number"==typeof n&&!isNaN(n))return L.Create(n);if("string"==typeof n){var i=n.toString(),r=i[0];if("^"==r)return new j(i.substring(1));if("\n"==r&&1==i.length)return new j("\n");if("<>"==i)return new X;for(var a=0;a<t._controlCommandNames.length;++a)if(i==t._controlCommandNames[a])return new Q(a);if("L^"==i&&(i="^"),rt.CallExistsWithName(i))return rt.CallWithName(i);if("->->"==i)return Q.PopTunnel();if("~ret"==i)return Q.PopFunction();if("void"==i)return new it}if("object"===e(n)&&!Array.isArray(n)){var o,u=n;if(u["^->"])return o=u["^->"],new G(new p(o.toString()));if(u["^var"]){o=u["^var"];var s=new M(o.toString());return"ci"in u&&(o=u.ci,s.contextIndex=parseInt(o)),s}var l=!1,h=!1,c=z.Function,f=!1;if((o=u["->"])?l=!0:(o=u["f()"])?(h=l=!0,c=z.Function):(o=u["->t->"])?(h=l=!0,c=z.Tunnel):(o=u["x()"])&&(h=!(f=l=!0),c=z.Function),l){var v=new Z;v.pushesToStack=h,v.stackPushType=c,v.isExternal=f;var d=o.toString();return(o=u.var)?v.variableDivertName=d:v.targetPathString=d,v.isConditional=!!u.c,f&&(o=u.exArgs)&&(v.externalArgs=parseInt(o)),v}if(o=u["*"]){var y=new tt;return y.pathStringOnChoice=o.toString(),(o=u.flg)&&(y.flags=parseInt(o)),y}if(o=u["VAR?"])return new et(o.toString());if(o=u["CNT?"]){var m=new et;return m.pathStringForCount=o.toString(),m}var g=!1,S=!1;if((o=u["VAR="])?S=g=!0:(o=u["temp="])&&(S=!(g=!0)),g){var k=o.toString(),C=!u.re,b=new nt(k,C);return b.isGlobal=S,b}if(void 0!==u["#"])return o=u["#"],new at(o.toString());if(o=u.list){var w=o,T=new N;if(o=u.origins){var _=o;T.SetInitialOriginNames(_)}for(var x in w)if(w.hasOwnProperty(x)){var E=w[x],P=new O(x),A=parseInt(E);T.Add(P,A)}return new B(T)}if(null!=u.originalChoicePath)return this.JObjectToChoice(u)}if(Array.isArray(n))return this.JArrayToContainer(n);if(null==n)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(n))}},{key:"RuntimeObjectToJToken",value:function(e){var n=g(e,K);if(n)return this.ContainerToJArray(n);var i=g(e,Z);if(i){var r,a="->";i.isExternal?a="x()":i.pushesToStack&&(i.stackPushType==z.Function?a="f()":i.stackPushType==z.Tunnel&&(a="->t->")),r=i.hasVariableTarget?i.variableDivertName:i.targetPathString;var o={};return o[a]=r,i.hasVariableTarget&&(o.var=!0),i.isConditional&&(o.c=!0),0<i.externalArgs&&(o.exArgs=i.externalArgs),o}var u=g(e,tt);if(u){var s={};return s["*"]=u.pathStringOnChoice,s.flg=u.flags,s}var l=g(e,R);if(l)return l.value;var h=g(e,D);if(h)return h.value;var c=g(e,j);if(c)return c.isNewline?"\n":"^"+c.value;var f=g(e,B);if(f)return this.InkListToJObject(f);var v=g(e,G);if(v){var d={};return null===v.value?_("divTargetVal.value"):(d["^->"]=v.value.componentsString,d)}var y=g(e,M);if(y){var p={};return p["^var"]=y.value,p.ci=y.contextIndex,p}if(g(e,X))return"<>";var m=g(e,Q);if(m)return t._controlCommandNames[m.commandType];var S=g(e,rt);if(S){var k=S.name;return"^"==k&&(k="L^"),k}var C=g(e,et);if(C){var b={},w=C.pathStringForCount;return null!=w?b["CNT?"]=w:b["VAR?"]=C.name,b}var T=g(e,nt);if(T){var x={};return x[T.isGlobal?"VAR=":"temp="]=T.variableName,T.isNewDeclaration||(x.re=!0),x}if(g(e,it))return"void";var E=g(e,at);if(E){var O={};return O["#"]=E.text,O}var N=g(e,ot);if(N)return this.ChoiceToJObject(N);throw new Error("Failed to convert runtime object to Json token: "+e)}},{key:"ContainerToJArray",value:function(t){var e=this.ListToJArray(t.content),n=t.namedOnlyContent,i=t.countFlags;if(null!=n&&0<n.size||0<i||null!=t.name){var r;if(null!=n){for(var a in r=this.DictionaryRuntimeObjsToJObject(n))if(r.hasOwnProperty(a)){var o=r[a];if(null!=o){var u=o[o.length-1];null!=u&&(delete u["#n"],0==Object.keys(u).length&&(o[o.length-1]=null))}}}else r={};0<i&&(r["#f"]=i),null!=t.name&&(r["#n"]=t.name),e.push(r)}else e.push(null);return e}},{key:"JArrayToContainer",value:function(t){var e=new K;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i=new Map;for(var r in n)if("#f"==r)e.countFlags=parseInt(n[r]);else if("#n"==r)e.name=n[r].toString();else{var a=this.JTokenToRuntimeObject(n[r]),o=g(a,K);o&&(o.name=r),i.set(r,a)}e.namedOnlyContent=i}return e}},{key:"JObjectToChoice",value:function(t){var e=new ot;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}},{key:"ChoiceToJObject",value:function(t){var e={};return e.text=t.text,e.index=t.index,e.originalChoicePath=t.sourcePath,e.originalThreadIndex=t.originalThreadIndex,e.targetPath=t.pathStringOnChoice,e}},{key:"InkListToJObject",value:function(t){var e=t.value;if(null===e)return _("rawList");var n={},i={},r=!0,a=!1,o=void 0;try{for(var u,s=e[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=c(u.value,2),h=l[0],f=l[1];i[O.fromSerializedKey(h).toString()]=f}}catch(t){a=!0,o=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}return n.list=i,0==e.Count&&null!=e.originNames&&0<e.originNames.length&&(n.origins=e.originNames),n}},{key:"ListDefinitionsToJToken",value:function(t){var e={},n=!0,i=!1,r=void 0;try{for(var a,o=t.lists[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value,s={},l=!0,h=!1,f=void 0;try{for(var v,d=u.items[Symbol.iterator]();!(l=(v=d.next()).done);l=!0){var y=c(v.value,2),p=y[0],m=y[1],g=O.fromSerializedKey(p);if(null===g.itemName)return _("item.itemName");s[g.itemName]=m}}catch(t){h=!0,f=t}finally{try{l||null==d.return||d.return()}finally{if(h)throw f}}e[u.name]=s}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return e}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e)if(e.hasOwnProperty(i)){var r=i.toString(),a=e[i],o=new Map;for(var u in a)if(e.hasOwnProperty(i)){var s=a[u];o.set(u,parseInt(s))}var l=new ut(r,o);n.push(l)}return new st(n)}}]),t}();lt._controlCommandNames=function(){var t=[];t[Q.CommandType.EvalStart]="ev",t[Q.CommandType.EvalOutput]="out",t[Q.CommandType.EvalEnd]="/ev",t[Q.CommandType.Duplicate]="du",t[Q.CommandType.PopEvaluatedValue]="pop",t[Q.CommandType.PopFunction]="~ret",t[Q.CommandType.PopTunnel]="->->",t[Q.CommandType.BeginString]="str",t[Q.CommandType.EndString]="/str",t[Q.CommandType.NoOp]="nop",t[Q.CommandType.ChoiceCount]="choiceCnt",t[Q.CommandType.Turns]="turn",t[Q.CommandType.TurnsSince]="turns",t[Q.CommandType.ReadCount]="readc",t[Q.CommandType.Random]="rnd",t[Q.CommandType.SeedRandom]="srnd",t[Q.CommandType.VisitIndex]="visit",t[Q.CommandType.SequenceShuffleIndex]="seq",t[Q.CommandType.StartThread]="thread",t[Q.CommandType.Done]="done",t[Q.CommandType.End]="end",t[Q.CommandType.ListFromInt]="listInt",t[Q.CommandType.ListRange]="range",t[Q.CommandType.ListRandom]="lrnd";for(var e=0;e<Q.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t}();var ht=function(){function e(){if(n(this,e),this._threadCounter=0,this._startOfRoot=Y.Null,arguments[0]instanceof t.Story){var i=arguments[0];this._startOfRoot=Y.StartOf(i.rootContentContainer),this.Reset()}else{var r=arguments[0],a=!0,o=!(this._threads=[]),u=void 0;try{for(var s,l=r._threads[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var h=s.value;this._threads.push(h.Copy())}}catch(i){o=!0,u=i}finally{try{a||null==l.return||l.return()}finally{if(o)throw u}}this._startOfRoot=r._startOfRoot}}return r(e,[{key:"Reset",value:function(){this._threads=[],this._threads.push(new e.Thread),this._threads[0].callstack.push(new e.Element(z.Tunnel,this._startOfRoot))}},{key:"SetJsonToken",value:function(t,n){this._threads.length=0;var i=t.threads,r=!0,a=!1,o=void 0;try{for(var u,s=i[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=u.value,h=new e.Thread(l,n);this._threads.push(h)}}catch(t){a=!0,o=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=Y.StartOf(n.rootContentContainer)}},{key:"GetJsonToken",value:function(){var t={},e=[],n=!0,i=!1,r=void 0;try{for(var a,o=this._threads[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;e.push(u.jsonToken)}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return t.threads=e,t.threadCounter=this._threadCounter,t}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"ForkThread",value:function(){var t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}},{key:"PopThread",value:function(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"Push",value:function(t,n,i){var r=1<arguments.length&&void 0!==n?n:0,a=2<arguments.length&&void 0!==i?i:0,o=new e.Element(t,this.currentElement.currentPointer,!1);o.evaluationStackHeightWhenPushed=r,o.functionStartInOutputStream=a,this.callStack.push(o)}},{key:"CanPop",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;return!!this.canPop&&(null==e||this.currentElement.type==e)}},{key:"Pop",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;if(!this.CanPop(e))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}},{key:"GetTemporaryVariableWithName",value:function(t,e){var n=1<arguments.length&&void 0!==e?e:-1;-1==n&&(n=this.currentElementIndex+1);var i=A(this.callStack[n-1].temporaryVariables,t,null);return i.exists?i.result:null}},{key:"SetTemporaryVariable",value:function(t,e,n,i){var r=3<arguments.length&&void 0!==i?i:-1;-1==r&&(r=this.currentElementIndex+1);var a=this.callStack[r-1];if(!n&&!a.temporaryVariables.get(t))throw new P("Could not find temporary variable to set: "+t);var o=A(a.temporaryVariables,t,null);o.exists&&B.RetainListOriginsForAssignment(o.result,e),a.temporaryVariables.set(t,e)}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){return this._threads.filter(function(e){if(e.threadIndex==t)return e})[0]}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){d.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"canPop",get:function(){return 1<this.callStack.length}},{key:"canPopThread",get:function(){return 1<this._threads.length&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==z.FunctionEvaluationFromGame}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new E,e=0;e<this._threads.length;e++){var n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(var r=0;r<n.callstack.length;r++){n.callstack[r].type==z.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");var a=n.callstack[r].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),null===a.container)return _("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}]),e}();!function(t){var e=function(){function t(e,i){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2];n(this,t),this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=i.copy(),this.inExpressionEvaluation=r,this.temporaryVariables=new Map,this.type=e}return r(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return e.temporaryVariables=new Map(this.temporaryVariables),e.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,e.functionStartInOutputStream=this.functionStartInOutputStream,e}}]),t}();t.Element=e;var i=function(){function t(){if(n(this,t),this.threadIndex=0,this.previousPointer=Y.Null,this.callstack=[],arguments[0]&&arguments[1]){var i=arguments[0],r=arguments[1];this.threadIndex=parseInt(i.threadIndex);var a=i.callstack,o=!0,u=!1,s=void 0;try{for(var l,h=a[Symbol.iterator]();!(o=(l=h.next()).done);o=!0){var c=l.value,f=parseInt(c.type),v=Y.Null,d=void 0,y=c.cPath;if(void 0!==y){d=y.toString();var m=r.ContentAtPath(new p(d));if(v.container=m.container,v.index=parseInt(c.idx),null==m.obj)throw new Error("When loading state, internal story location couldn't be found: "+d+". Has the story changed since this save data was created?");if(m.approximate){if(null===v.container)return _("pointer.container");r.Warning("When loading state, exact internal story location couldn't be found: '"+d+"', so it was approximated to '"+v.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}var g=!!c.exp,S=new e(f,v,g),k=c.temp;S.temporaryVariables=lt.JObjectToDictionaryRuntimeObjs(k),this.callstack.push(S)}}catch(i){u=!0,s=i}finally{try{o||null==h.return||h.return()}finally{if(u)throw s}}var C=i.previousContentObject;if(void 0!==C){var b=new p(C.toString());this.previousPointer=r.PointerAtPath(b)}}}return r(t,[{key:"Copy",value:function(){var e=new t;e.threadIndex=this.threadIndex;var n=!0,i=!1,r=void 0;try{for(var a,o=this.callstack[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;e.callstack.push(u.Copy())}}catch(e){i=!0,r=e}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}return e.previousPointer=this.previousPointer.copy(),e}},{key:"jsonToken",get:function(){var t={},e=[],n=!0,i=!1,r=void 0;try{for(var a,o=this.callstack[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value,s={};if(!u.currentPointer.isNull){if(null===u.currentPointer.container)return _("el.currentPointer.container");s.cPath=u.currentPointer.container.path.componentsString,s.idx=u.currentPointer.index}s.exp=u.inExpressionEvaluation,s.type=u.type,s.temp=lt.DictionaryRuntimeObjsToJObject(u.temporaryVariables),e.push(s)}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}if(t.callstack=e,t.threadIndex=this.threadIndex,!this.previousPointer.isNull){var l=this.previousPointer.Resolve();if(null===l)return _("this.previousPointer.Resolve()");t.previousContentObject=l.path.toString()}return t}}]),t}();t.Thread=i}(ht=ht||{});var ct,ft,vt=function(){function t(e,i){n(this,t),this.variableChangedEventCallbacks=[],this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariables=new Set,this._globalVariables=new Map,this._callStack=e,this._listDefsOrigin=i;try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(e){}}return r(t,[{key:"variableChangedEvent",value:function(t,e){var n=!0,i=!1,r=void 0;try{for(var a,o=this.variableChangedEventCallbacks[Symbol.iterator]();!(n=(a=o.next()).done);n=!0)(0,a.value)(t,e)}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}}},{key:"$",value:function(t,e){if(void 0===e){var n=this._globalVariables.get(t);return void 0===n&&(n=this._defaultGlobalVariables.get(t)),void 0!==n?n.valueObject:null}if(void 0===this._defaultGlobalVariables.get(t))throw new P("Cannot assign to a variable ("+t+") that hasn't been declared in the story");var i=L.Create(e);if(null==i)throw new P(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"CopyFrom",value:function(t){if(this._globalVariables=new Map(t._globalVariables),this._defaultGlobalVariables=new Map(t._defaultGlobalVariables),this.variableChangedEvent=t.variableChangedEvent,this.variableChangedEventCallbacks=t.variableChangedEventCallbacks,t.batchObservingVariableChanges!=this.batchObservingVariableChanges)if(t.batchObservingVariableChanges){if(this._batchObservingVariableChanges=!0,null===t._changedVariables)return _("toCopy._changedVariables");this._changedVariables=new Set(t._changedVariables)}else this._batchObservingVariableChanges=!1,this._changedVariables=null}},{key:"TryGetDefaultVariableValue",value:function(t){var e=A(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}},{key:"GlobalVariableExistsWithName",value:function(t){return this._globalVariables.has(t)}},{key:"GetVariableWithName",value:function(t,e){var n=1<arguments.length&&void 0!==e?e:-1,i=this.GetRawVariableWithName(t,n),r=g(i,M);return null!==r&&(i=this.ValueAtVariablePointer(r)),i}},{key:"GetRawVariableWithName",value:function(t,e){if(0==e||-1==e){var n=A(this._globalVariables,t,null);if(n.exists)return n.result;if(null===this._listDefsOrigin)return _("VariablesState._listDefsOrigin");var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName;if(null===n)return _("name");var i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this._globalVariables.has(n),t.isNewDeclaration){var a=g(e,M);null!==a&&(e=this.ResolveVariablePointer(a))}else for(var o=null;null!=(o=g(this.GetRawVariableWithName(n,i),M))&&(n=o.variableName,r=0==(i=o.contextIndex)),null!=o;);r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=new Map(this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=S(t,B),i=S(e,B);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n=A(this._globalVariables,t,null);if(n.exists&&B.RetainListOriginsForAssignment(n.result,e),null===t)return _("variableName");if(this._globalVariables.set(t,e),null!=this.variableChangedEvent&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariables)return _("this._changedVariables");this._changedVariables.add(t)}else this.variableChangedEvent(t,e)}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=g(this.GetRawVariableWithName(t.variableName,e),M);return null!=n?n:new M(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this._globalVariables.get(t)?0:this._callStack.currentElementIndex}},{key:"ObserveVariableChange",value:function(t){this.variableChangedEventCallbacks.push(t)}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){if(this._batchObservingVariableChanges=t)this._changedVariables=new Set;else if(null!=this._changedVariables){var e=!0,n=!1,i=void 0;try{for(var r,a=this._changedVariables[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=r.value,u=this._globalVariables.get(o);u?this.variableChangedEvent(o,u):_("currentValue")}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}}}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}},{key:"jsonToken",get:function(){return lt.DictionaryRuntimeObjsToJObject(this._globalVariables)},set:function(t){this._globalVariables=lt.JObjectToDictionaryRuntimeObjs(t)}}]),t}(),dt=function(){function t(e){n(this,t),this.seed=e%2147483647,this.seed<=0&&(this.seed+=2147483646)}return r(t,[{key:"next",value:function(){return this.seed=16807*this.seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),yt=function(){function t(e){n(this,t),this.kInkSaveStateVersion=8,this.kMinCompatibleLoadVersion=8,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=Y.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this.story=e,this._outputStream=[],this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new ht(e),this._variablesState=new vt(this.callStack,e.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this._currentTurnIndex=-1;var i=(new Date).getTime();this.storySeed=new dt(i).next()%100,this.previousRandom=0,this._currentChoices=[],this.GoToStart()}return r(t,[{key:"ToJson",value:function(t){var e=0<arguments.length&&void 0!==t&&t;return JSON.stringify(this.jsonToken,null,e?2:0)}},{key:"toJson",value:function(t){var e=0<arguments.length&&void 0!==t&&t;return this.ToJson(e)}},{key:"LoadJson",value:function(t){this.jsonToken=JSON.parse(t)}},{key:"VisitCountAtPathString",value:function(t){var e=A(this.visitCounts,t,null);return e.exists?e.result:0}},{key:"CleanOutputWhitespace",value:function(t){for(var e=new E,n=-1,i=0,r=0;r<t.length;r++){var a=t.charAt(r),o=" "==a||"\t"==a;o&&-1==n&&(n=r),o||("\n"!=a&&0<n&&n!=i&&e.Append(" "),n=-1),"\n"==a&&(i=r+1),o||e.Append(a)}return e.toString()}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=Y.StartOf(this.story.mainContentContainer)}},{key:"Copy",value:function(){var e=new t(this.story);return e.outputStream.push.apply(e.outputStream,this._outputStream),this.OutputStreamDirty(),e._currentChoices.push.apply(e._currentChoices,this._currentChoices),this.hasError&&(e._currentErrors=[],e._currentErrors.push.apply(e._currentErrors,this.currentErrors||[])),this.hasWarning&&(e._currentWarnings=[],e._currentWarnings.push.apply(e._currentWarnings,this.currentWarnings||[])),e.callStack=new ht(this.callStack),e._variablesState=new vt(e.callStack,this.story.listDefinitions),e.variablesState.CopyFrom(this.variablesState),e.evaluationStack.push.apply(e.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(e.divertedPointer=this.divertedPointer.copy()),e.previousPointer=this.previousPointer.copy(),e._visitCounts=new Map(this.visitCounts),e._turnIndices=new Map(this.turnIndices),e._currentTurnIndex=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.didSafeExit=this.didSafeExit,e}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;this._outputStream.length=0,null!==e&&this._outputStream.push.apply(this._outputStream,e),this.OutputStreamDirty()}},{key:"PushToOutputStream",value:function(t){var e=g(t,j);if(null!==e){var n=this.TrySplittingHeadTailWhitespace(e);if(null!==n){var i=!0,r=!1,a=void 0;try{for(var o,u=n[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;this.PushToOutputStreamIndividual(s)}}catch(t){r=!0,a=t}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){var e=t.value;if(null===e)return _("single.value");for(var n=-1,i=-1,r=0;r<e.length;++r){var a=e[r];if("\n"!=a){if(" "==a||"\t"==a)continue;break}-1==n&&(n=r),i=r}for(var o=-1,u=-1,s=0;s<e.length;++s){var l=e[s];if("\n"!=l){if(" "==l||"\t"==l)continue;break}-1==o&&(o=s),u=s}if(-1==n&&-1==o)return null;var h=[],c=0,f=e.length;if(-1!=n){if(0<n){var v=new j(e.substring(0,n));h.push(v)}h.push(new j("\n")),c=i+1}if(-1!=o&&(f=u),c<f){var d=e.substring(c,f-c);h.push(new j(d))}if(-1!=o&&i<u&&(h.push(new j("\n")),o<e.length-1)){var y=e.length-o-1,p=new j(e.substring(o+1,y));h.push(p)}return h}},{key:"PushToOutputStreamIndividual",value:function(t){var e=g(t,X),n=g(t,j),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){var r=-1,a=this.callStack.currentElement;a.type==z.Function&&(r=a.functionStartInOutputStream);for(var o=-1,u=this._outputStream.length-1;0<=u;u--){var s=this._outputStream[u],l=s instanceof Q?s:null;if(null!=(s instanceof X?s:null)){o=u;break}if(null!=l&&l.commandType==Q.CommandType.BeginString){r<=u&&(r=-1);break}}if(-1!=(-1!=o&&-1!=r?Math.min(r,o):-1!=o?o:r)){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(-1<o&&this.RemoveExistingGlue(),-1<r))for(var h=this.callStack.elements,c=h.length-1;0<=c;c--){var f=h[c];if(f.type!=z.Function)break;f.functionStartInOutputStream=-1}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return _("obj");this._outputStream.push(t),this.OutputStreamDirty()}}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var t=-1,e=this._outputStream.length-1;0<=e;){var n=this._outputStream[e],i=g(n,Q),r=g(n,j);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(0<=t)for(e=t;e<this._outputStream.length;)g(this._outputStream[e],j)?this._outputStream.splice(e,1):e++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;0<=t;t--){var e=this._outputStream[t];if(e instanceof X)this._outputStream.splice(t,1);else if(e instanceof Q)break}this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(t){var e=g(t,B);if(e){var n=e.value;if(null===n)return _("rawList");if(null!=n.originNames){n.origins||(n.origins=[]);var i=!(n.origins.length=0),r=!1,a=void 0;try{for(var o,u=n.originNames[Symbol.iterator]();!(i=(o=u.next()).done);i=!0){var s=o.value;if(null===this.story.listDefinitions)return _("StoryState.story.listDefinitions");var l=this.story.listDefinitions.TryListGetDefinition(s,null);if(null===l.result)return _("StoryState def.result");n.origins.indexOf(l.result)<0&&n.origins.push(l.result)}}catch(t){r=!0,a=t}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}}}if(null===t)return _("obj");this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(void 0===t)return b(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return b(this.evaluationStack.splice(this.evaluationStack.length-t,t))}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"ForceEnd",value:function(){this.callStack.Reset(),this._currentChoices.length=0,this.currentPointer=Y.Null,this.previousPointer=Y.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){d.Assert(this.callStack.currentElement.type==z.Function);var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var e=this._outputStream.length-1;t<=e;e--){var n=this._outputStream[e],i=g(n,j),r=g(n,Q);if(null!=i){if(r)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;this.callStack.currentElement.type==z.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(e)}},{key:"SetChosenPath",value:function(t,e){this._currentChoices.length=0;var n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this._currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(z.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=Y.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!=t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(L.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==z.FunctionEvaluationFromGame&&(this.currentPointer=Y.Null,this.didSafeExit=!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=z.FunctionEvaluationFromGame)throw new P("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var n=this.PopEvaluationStack();null===e&&(e=n)}if(this.PopCallStack(z.FunctionEvaluationFromGame),e){if(e instanceof it)return null;var i=S(e,L);return i.valueType==I.DivertTarget?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"variablesState",get:function(){return this._variablesState}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:null===t.path?_("pointer.path"):t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&0<this.currentErrors.length}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&0<this.currentWarnings.length}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t=new E,e=!0,n=!1,i=void 0;try{for(var r,a=this._outputStream[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=g(r.value,j);null!==o&&t.Append(o.value)}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}this._currentText=this.CleanOutputWhitespace(t.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){if(this._outputStreamTagsDirty){var t=!0,e=!(this._currentTags=[]),n=void 0;try{for(var i,r=this._outputStream[Symbol.iterator]();!(t=(i=r.next()).done);t=!0){var a=g(i.value,at);null!==a&&this._currentTags.push(a.text)}}catch(t){e=!0,n=t}finally{try{t||null==r.return||r.return()}finally{if(e)throw n}}this._outputStreamTagsDirty=!1}return this._currentTags}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"jsonToken",get:function(){var t,e={},n=!0,i=!1,r=void 0;try{for(var a,o=this._currentChoices[Symbol.iterator]();!(n=(a=o.next()).done);n=!0){var u=a.value;if(null===u.threadAtGeneration)return _("c.threadAtGeneration");u.originalThreadIndex=u.threadAtGeneration.threadIndex,null==this.callStack.ThreadWithIndex(u.originalThreadIndex)&&(null==t&&(t=new Map),t[u.originalThreadIndex.toString()]=u.threadAtGeneration.jsonToken)}}catch(t){i=!0,r=t}finally{try{n||null==o.return||o.return()}finally{if(i)throw r}}if(null!=t&&(e.choiceThreads=t),e.callstackThreads=this.callStack.GetJsonToken(),e.variablesState=this.variablesState.jsonToken,e.evalStack=lt.ListToJArray(this.evaluationStack),e.outputStream=lt.ListToJArray(this._outputStream),e.currentChoices=lt.ListToJArray(this._currentChoices),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return _("this.divertedPointer.path");e.currentDivertTarget=this.divertedPointer.path.componentsString}return e.visitCounts=lt.IntDictionaryToJObject(this.visitCounts),e.turnIndices=lt.IntDictionaryToJObject(this.turnIndices),e.turnIdx=this.currentTurnIndex,e.storySeed=this.storySeed,e.previousRandom=this.previousRandom,e.inkSaveVersion=this.kInkSaveStateVersion,e.inkFormatVersion=this.story.inkVersionCurrent,e},set:function(t){var e=t,n=e.inkSaveVersion;if(null==n)throw new P("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new P("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(e.callstackThreads,this.story),this.variablesState.jsonToken=e.variablesState,this._evaluationStack=lt.JArrayToRuntimeObjList(e.evalStack),this._outputStream=lt.JArrayToRuntimeObjList(e.outputStream),this.OutputStreamDirty(),this._currentChoices=lt.JArrayToRuntimeObjList(e.currentChoices);var i=e.currentDivertTarget;if(null!=i){var r=new p(i.toString());this.divertedPointer=this.story.PointerAtPath(r)}this._visitCounts=lt.JObjectToIntDictionary(e.visitCounts),this._turnIndices=lt.JObjectToIntDictionary(e.turnIndices),this._currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom);var a=e.choiceThreads,o=!0,u=!1,s=void 0;try{for(var l,h=this._currentChoices[Symbol.iterator]();!(o=(l=h.next()).done);o=!0){var c=l.value,f=this.callStack.ThreadWithIndex(c.originalThreadIndex);if(null!=f)c.threadAtGeneration=f.Copy();else{var v=a[c.originalThreadIndex.toString()];c.threadAtGeneration=new ht.Thread(v,this.story)}}}catch(t){u=!0,s=t}finally{try{o||null==h.return||h.return()}finally{if(u)throw s}}}},{key:"outputStreamEndsInNewline",get:function(){if(0<this._outputStream.length)for(var t=this._outputStream.length-1;0<=t&&!(this._outputStream[t]instanceof Q);t--){var e=this._outputStream[t];if(e instanceof j){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof j)return!0;return!1}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;0<=t;t--){var e=g(this._outputStream[t],Q);if(e instanceof Q&&e.commandType==Q.CommandType.BeginString)return!0}return!1}}]),t}(),pt=function(){function t(){n(this,t),this.startTime=void 0}return r(t,[{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}},{key:"ElapsedMilliseconds",get:function(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}}]),t}();Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&-9007199254740992<t&&t<9007199254740992&&Math.floor(t)===t}),t.Story=function(){function t(){var e,i;n(this,t),(e=h(this,o(t).call(this))).inkVersionCurrent=19,e.inkVersionMinimumCompatible=18,e._prevContainers=[],e.allowExternalFunctionFallbacks=!1,e._listDefinitions=null,e._variableObservers=null,e._hasValidatedExternals=!1,e._temporaryEvaluationContainer=null,e._asyncContinueActive=!1,e._stateAtLastNewline=null,e._recursiveContinueCount=0;var r=e._profiler=null,a=null;if(arguments[0]instanceof K)i=arguments[0],void 0!==arguments[1]&&(r=arguments[1]),e._mainContentContainer=i;else if("string"==typeof arguments[0]){var u=arguments[0];a=JSON.parse(u)}else a=arguments[0];if(null!=r&&(e._listDefinitions=new st(r)),e._externals=new Map,null!==a){var s=a,l=s.inkVersion;if(null==l)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");var c=parseInt(l);if(c>e.inkVersionCurrent)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(c<e.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");c!=e.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var f,v=s.root;if(null==v)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(f=s.listDefs)&&(e._listDefinitions=lt.JTokenToListDefinitions(f)),e._mainContentContainer=S(lt.JTokenToRuntimeObject(v),K),e.ResetState()}return e}return a(t,x),r(t,[{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJsonString",value:function(){var t=lt.RuntimeObjectToJToken(this._mainContentContainer),e={};return e.inkVersion=this.inkVersionCurrent,e.root=t,null!=this._listDefinitions&&(e.listDefs=lt.ListDefinitionsToJToken(this._listDefinitions)),JSON.stringify(e)}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new yt(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){if(null===this._state)return _("this._state");this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return _("this._state");this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){if(this._mainContentContainer.namedContent.get("global decl")){var t=this.state.currentPointer.copy();this.ChoosePath(new p("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t}this.state.variablesState.SnapshotDefaultGlobals()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(t){var e=0<arguments.length&&void 0!==t?t:0;null!=this._profiler&&this._profiler.PreContinue();var n=0<e;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=n,!this.canContinue)throw new P("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var i=new pt;i.Start();var r=!1;do{try{r=this.ContinueSingleStep()}catch(t){if(!(t instanceof P))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(r)break;if(this._asyncContinueActive&&i.ElapsedMilliseconds>e)break}while(this.canContinue);i.Stop(),!r&&this.canContinue||(null!=this._stateAtLastNewline&&(this.RestoreStateSnapshot(this._stateAtLastNewline),this._stateAtLastNewline=null),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(z.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(z.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!=this._stateAtLastNewline){if(null===this._stateAtLastNewline.currentTags)return _("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return _("this.state.currentTags");var e=this.CalculateNewlineOutputStateChange(this._stateAtLastNewline.currentText,this.state.currentText,this._stateAtLastNewline.currentTags.length,this.state.currentTags.length);if(e==t.OutputStateChange.ExtendedBeyondNewline)return this.RestoreStateSnapshot(this._stateAtLastNewline),!0;e==t.OutputStateChange.NewlineRemoved&&(this._stateAtLastNewline=null)}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateAtLastNewline&&(this._stateAtLastNewline=this.StateSnapshot()):this._stateAtLastNewline=null)}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(e,n,i,r){if(null===e)return _("prevText");if(null===n)return _("currText");var a=n.length>=e.length&&"\n"==n.charAt(e.length-1);if(i==r&&e.length==n.length&&a)return t.OutputStateChange.NoChange;if(!a)return t.OutputStateChange.NewlineRemoved;if(i<r)return t.OutputStateChange.ExtendedBeyondNewline;for(var o=e.length;o<n.length;o++){var u=n.charAt(o);if(" "!=u&&"\t"!=u)return t.OutputStateChange.ExtendedBeyondNewline}return t.OutputStateChange.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new E;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){var e=this.mainContentContainer.namedContent.get(t);return e instanceof K?e:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return Y.Null;var e=new Y,n=t.length,i=null;return null===t.lastComponent?_("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&0<n?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}},{key:"StateSnapshot",value:function(){return this.state.Copy()}},{key:"RestoreStateSnapshot",value:function(t){this._state=t}},{key:"Step",value:function(){var t=!0,e=this.state.currentPointer.copy();if(!e.isNull){for(var n=g(e.Resolve(),K);n&&(this.VisitContainer(n,!0),0!=n.content.length);)n=g((e=Y.StartOf(n)).Resolve(),K);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);var i=e.Resolve(),r=this.PerformLogicAndFlowControl(i);if(!this.state.currentPointer.isNull){r&&(t=!1);var a=g(i,tt);if(a){var o=this.ProcessChoice(a);o&&this.state.generatedChoices.push(o),i=null,t=!1}if(i instanceof K&&(t=!1),t){var u=g(i,M);if(u&&-1==u.contextIndex){var s=this.state.callStack.ContextForVariableNamed(u.variableName);i=new M(u.variableName,s)}this.state.inExpressionEvaluation?this.state.PushEvaluationStack(i):this.state.PushToOutputStream(i)}this.NextContent();var l=g(i,Q);l&&l.commandType==Q.CommandType.StartThread&&this.state.callStack.PushThread()}}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(!e.isNull&&-1!=e.index){if(this._prevContainers.length=0,!t.isNull)for(var n=g(t.Resolve(),K)||g(t.container,K);n;)this._prevContainers.push(n),n=g(n.parent,K);var i=e.Resolve();if(null!=i)for(var r=g(i.parent,K);r&&(this._prevContainers.indexOf(r)<0||r.countingAtStartOnly);){var a=0<r.content.length&&i==r.content[0];this.VisitContainer(r,a),r=g((i=r).parent,K)}}}},{key:"ProcessChoice",value:function(t){var e=!0;if(t.hasCondition){var n=this.state.PopEvaluationStack();this.IsTruthy(n)||(e=!1)}var i="",r="";if(t.hasChoiceOnlyContent&&(r=S(this.state.PopEvaluationStack(),j).value||""),t.hasStartContent&&(i=S(this.state.PopEvaluationStack(),j).value||""),t.onceOnly&&0<this.VisitCountForContainer(t.choiceTarget)&&(e=!1),!e)return null;var a=new ot;return a.targetPath=t.pathOnChoice,a.sourcePath=t.path.toString(),a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.ForkThread(),a.text=(i+r).replace(/^[ \t]+|[ \t]+$/g,""),a}},{key:"IsTruthy",value:function(t){if(t instanceof L){var e=t;if(e instanceof G){var n=e;return this.Error("Shouldn't use a divert target (to "+n.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1}return e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof Z){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i=e.variableDivertName,r=this.state.variablesState.GetVariableWithName(i);if(null==r)this.Error("Tried to divert using a target from a variable that could not be found ("+i+")");else if(!(r instanceof G)){var a=g(r,R),o="Tried to divert to a target from a variable, but the variable ("+i+") didn't contain a divert target, it ";a instanceof R&&0==a.value?o+="was empty/null (the value 0).":o+="contained '"+r+"'.",this.Error(o)}var u=S(r,G);this.state.divertedPointer=this.PointerAtPath(u.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof Q){var s=t;switch(s.commandType){case Q.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case Q.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case Q.CommandType.EvalOutput:if(0<this.state.evaluationStack.length){var l=this.state.PopEvaluationStack();if(!(l instanceof it)){var h=new j(l.toString());this.state.PushToOutputStream(h)}}break;case Q.CommandType.NoOp:break;case Q.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case Q.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case Q.CommandType.PopFunction:case Q.CommandType.PopTunnel:var c=s.commandType==Q.CommandType.PopFunction?z.Function:z.Tunnel,f=null;if(c==z.Tunnel){var v=this.state.PopEvaluationStack();null===(f=g(v,G))&&this.Assert(v instanceof it,"Expected void if ->-> doesn't override target")}if(this.state.TryExitFunctionEvaluationFromGame())break;if(this.state.callStack.currentElement.type==c&&this.state.callStack.canPop)this.state.PopCallStack(),f&&(this.state.divertedPointer=this.PointerAtPath(f.targetPath));else{var d=new Map;d.set(z.Function,"function return statement (~ return)"),d.set(z.Tunnel,"tunnel onwards statement (->->)");var y=d.get(this.state.callStack.currentElement.type);this.state.callStack.canPop||(y="end of flow (-> END or choice)");var p="Found "+d.get(c)+", when expected "+y;this.Error(p)}break;case Q.CommandType.BeginString:this.state.PushToOutputStream(s),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case Q.CommandType.EndString:for(var m=[],k=0,C=this.state.outputStream.length-1;0<=C;--C){var b=this.state.outputStream[C];k++;var w=g(b,Q);if(w&&w.commandType==Q.CommandType.BeginString)break;b instanceof j&&m.push(b)}this.state.PopFromOutputStream(k),m=m.reverse();var T=new E,x=!0,A=!1,I=void 0;try{for(var F,V=m[Symbol.iterator]();!(x=(F=V.next()).done);x=!0){var D=F.value;T.Append(D.toString())}}catch(t){A=!0,I=t}finally{try{x||null==V.return||V.return()}finally{if(A)throw I}}this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new j(T.toString()));break;case Q.CommandType.ChoiceCount:var M=this.state.generatedChoices.length;this.state.PushEvaluationStack(new R(M));break;case Q.CommandType.Turns:this.state.PushEvaluationStack(new R(this.state.currentTurnIndex+1));break;case Q.CommandType.TurnsSince:case Q.CommandType.ReadCount:var W=this.state.PopEvaluationStack();if(!(W instanceof G)){var J="";W instanceof R&&(J=". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?"),this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+W+J);break}var q,U=S(W,G),$=g(this.ContentAtPath(U.targetPath).correctObj,K);null!=$?q=s.commandType==Q.CommandType.TurnsSince?this.TurnsSinceForContainer($):this.VisitCountForContainer($):(q=s.commandType==Q.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+s.toString()+" lookup at "+U.targetPath.toString())),this.state.PushEvaluationStack(new R(q));break;case Q.CommandType.Random:var H=g(this.state.PopEvaluationStack(),R),X=g(this.state.PopEvaluationStack(),R);if(null==X||X instanceof R==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==H||X instanceof R==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===H.value)return _("maxInt.value");if(null===X.value)return _("minInt.value");var tt=H.value-X.value+1;tt<=0&&this.Error("RANDOM was called with minimum as "+X.value+" and maximum as "+H.value+". The maximum must be larger");var at=this.state.storySeed+this.state.previousRandom,ot=new dt(at).next(),ut=ot%tt+X.value;this.state.PushEvaluationStack(new R(ut)),this.state.previousRandom=ot;break;case Q.CommandType.SeedRandom:var st=g(this.state.PopEvaluationStack(),R);if(null==st||st instanceof R==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===st.value)return _("minInt.value");this.state.storySeed=st.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new it);break;case Q.CommandType.VisitIndex:var lt=this.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new R(lt));break;case Q.CommandType.SequenceShuffleIndex:var ht=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new R(ht));break;case Q.CommandType.StartThread:break;case Q.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=Y.Null);break;case Q.CommandType.End:this.state.ForceEnd();break;case Q.CommandType.ListFromInt:var ct=g(this.state.PopEvaluationStack(),R),ft=S(this.state.PopEvaluationStack(),j);if(null===ct)throw new P("Passed non-integer when creating a list element from a numerical value.");var vt=null;if(null===this.listDefinitions)return _("this.listDefinitions");var yt=this.listDefinitions.TryListGetDefinition(ft.value,null);if(!yt.exists)throw new P("Failed to find LIST called "+ft.value);if(null===ct.value)return _("minInt.value");var pt=yt.result.TryGetItemWithValue(ct.value,O.Null);pt.exists&&(vt=new B(pt.result,ct.value)),null==vt&&(vt=new B),this.state.PushEvaluationStack(vt);break;case Q.CommandType.ListRange:var mt=g(this.state.PopEvaluationStack(),L),gt=g(this.state.PopEvaluationStack(),L),St=g(this.state.PopEvaluationStack(),B);if(null===St||null===gt||null===mt)throw new P("Expected list, minimum and maximum for LIST_RANGE");if(null===St.value)return _("targetList.value");var kt=St.value.ListWithSubRange(gt.valueObject,mt.valueObject);this.state.PushEvaluationStack(new B(kt));break;case Q.CommandType.ListRandom:var Ct=this.state.PopEvaluationStack();if(null===Ct)throw new P("Expected list for LIST_RANDOM");var bt=Ct.value,wt=null;if(null===bt)throw _("list");if(0==bt.Count)wt=new N;else{for(var Tt=this.state.storySeed+this.state.previousRandom,_t=new dt(Tt).next(),xt=_t%bt.Count,Et=bt.entries(),Ot=0;Ot<=xt-1;Ot++)Et.next();var Nt=Et.next().value,Pt={Key:O.fromSerializedKey(Nt[0]),Value:Nt[1]};if(null===Pt.Key.originName)return _("randomItem.Key.originName");(wt=new N(Pt.Key.originName,this)).Add(Pt.Key,Pt.Value),this.state.previousRandom=_t}this.state.PushEvaluationStack(new B(wt));break;default:this.Error("unhandled ControlCommand: "+s)}return!0}if(t instanceof nt){var At=t,It=this.state.PopEvaluationStack();return this.state.variablesState.Assign(At,It),!0}if(t instanceof et){var Ft=t,Vt=null;if(null!=Ft.pathForCount){var Lt=Ft.containerForCount,Rt=this.VisitCountForContainer(Lt);Vt=new R(Rt)}else if(null==(Vt=this.state.variablesState.GetVariableWithName(Ft.name))){var Dt=this.state.variablesState.TryGetDefaultVariableValue(Ft.name);null!=Dt?(this.Warning("Variable not found in save state: '"+Ft.name+"', but seems to have been newly created. Assigning value from latest ink's declaration: "+Dt),Vt=Dt,this.state.variablesState.SetGlobal(Ft.name,Vt)):(this.Warning("Variable not found: '"+Ft.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit."),Vt=new R(0))}return this.state.PushEvaluationStack(Vt),!0}if(t instanceof rt){var jt=t,Gt=this.state.PopEvaluationStack(jt.numberOfParameters),Mt=jt.Call(Gt);return this.state.PushEvaluationStack(Mt),!0}return!1}},{key:"ChoosePathString",value:function(t,e,n){var i=!(1<arguments.length&&void 0!==e)||e,r=2<arguments.length&&void 0!==n?n:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),i)this.ResetCallstack();else if(this.state.callStack.currentElement.type==z.Function){var a="",o=this.state.callStack.currentElement.currentPointer.container;throw null!=o&&(a="("+o.path.toString()+") "),new Error("Story was running a function "+a+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(r),this.ChoosePath(new p(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}},{key:"ChoosePath",value:function(t,e){var n=!(1<arguments.length&&void 0!==e)||e;this.state.SetChosenPath(t,n),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;this.Assert(0<=t&&t<e.length,"choice out of range");var n=e[t];return null===n.threadAtGeneration?_("choiceToChoose.threadAtGeneration"):null===n.targetPath?_("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t,e,n){var i=1<arguments.length&&void 0!==e?e:[],r=2<arguments.length&&void 0!==n&&n;if(this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");var a=this.KnotContainerWithName(t);if(null==a)throw new Error("Function doesn't exist: '"+t+"'");var o=[];o.push.apply(o,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(a,i);for(var u=new E;this.canContinue;)u.Append(this.Continue());var s=u.toString();this._state.ResetOutput(o);var l=this.state.CompleteFunctionEvaluationFromGame();return r?{returned:l,output:s}:l}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(z.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),n<this.state.evaluationStack.length?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,n){if(null===t)return _("funcName");var i=this._externals.get(t),r=null;if(void 0===i){if(this.allowExternalFunctionFallbacks)return r=this.KnotContainerWithName(t),this.Assert(null!==r,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(z.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=Y.StartOf(r));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var a=[],o=0;o<n;++o){var u=S(this.state.PopEvaluationStack(),L).valueObject;a.push(u)}a.reverse();var s=i(a),l=null;null!=s?(l=L.Create(s),this.Assert(null!==l,"Could not create ink value from returned object of type "+e(s))):l=new it,this.state.PushEvaluationStack(l)}},{key:"BindExternalFunctionGeneral",value:function(t,e){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,e)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunction",value:function(t,e){var n=this;this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,function(t){n.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");for(var i=[],r=0,a=t.length;r<a;r++)i[r]=n.TryCoerce(t[r]);return e.apply(null,i)})}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}},{key:"ValidateExternalBindings",value:function(t,e){var n=null,i=null,r=e||new Set;if(t instanceof K&&(n=t),t instanceof x&&(i=t),null===n&&null===i)if(this.ValidateExternalBindings(this._mainContentContainer,r),this._hasValidatedExternals=!0,0==r.size)this._hasValidatedExternals=!0;else{var a="Error: Missing function binding for external";a+=1<r.size?"s":"",a+=": '",a+=Array.from(r).join("', '"),a+="' ",a+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(a)}else if(null!=n){var o=!0,u=!1,s=void 0;try{for(var l,h=n.content[Symbol.iterator]();!(o=(l=h.next()).done);o=!0){var f=l.value;null!=f&&f.hasValidName||this.ValidateExternalBindings(f,r)}}catch(t){u=!0,s=t}finally{try{o||null==h.return||h.return()}finally{if(u)throw s}}var v=!0,d=!1,y=void 0;try{for(var p,m=n.namedContent[Symbol.iterator]();!(v=(p=m.next()).done);v=!0){var S=c(p.value,2),k=(S[0],S[1]);this.ValidateExternalBindings(g(k,x),r)}}catch(t){d=!0,y=t}finally{try{v||null==m.return||m.return()}finally{if(d)throw y}}}else if(null!=i){var C=g(i,Z);if(C&&C.isExternal){var b=C.targetPathString;if(null===b)return _("name");this._externals.has(b)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(b)||r.add(b)}}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new P("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(void 0!==e){if(this._variableObservers.has(e)){var n=this._variableObservers.get(e);n.splice(n.indexOf(t),1)}}else{var i=this._variableObservers.keys(),r=!0,a=!1,o=void 0;try{for(var u,s=i[Symbol.iterator]();!(r=(u=s.next()).done);r=!0){var l=u.value,h=this._variableObservers.get(l);h.splice(h.indexOf(t),1)}}catch(t){a=!0,o=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}}}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!==this._variableObservers){var n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof L))throw new Error("Tried to get the value of a variable that isn't a standard type");var i=S(e,L),r=!0,a=!1,o=void 0;try{for(var u,s=n[Symbol.iterator]();!(r=(u=s.next()).done);r=!0)(0,u.value)(t,i.valueObject)}catch(t){a=!0,o=t}finally{try{r||null==s.return||s.return()}finally{if(a)throw o}}}}}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){var e=new p(t),n=this.ContentAtPath(e).container;if(null===n)return _("flowContainer");for(;;){var i=n.content[0];if(!(i instanceof K))break;n=i}var r=null,a=!0,o=!1,u=void 0;try{for(var s,l=n.content[Symbol.iterator]();!(a=(s=l.next()).done);a=!0){var h=g(s.value,at);if(!h)break;null==r&&(r=[]),r.push(h.text)}}catch(t){o=!0,u=t}finally{try{a||null==l.return||l.return()}finally{if(o)throw u}}return r}},{key:"BuildStringOfHierarchy",value:function(){var t=new E;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new E;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){if(this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=Y.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&!this.IncrementContentPointer()){var t=!1;this.state.callStack.CanPop(z.Function)?(this.state.PopCallStack(z.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new it),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()}}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return _("pointer.container");for(;e.index>=e.container.content.length;){t=!1;var n=g(e.container.parent,K);if(n instanceof K==0)break;var i=n.content.indexOf(e.container);if(-1==i)break;if((e=new Y(n,i)).index++,t=!0,null===e.container)return _("pointer.container")}return t||(e=Y.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter(function(t){return t.isInvisibleDefault});if(0==e.length||t.length>e.length)return!1;var n=e[0];return null===n.targetPath?_("choice.targetPath"):null===n.threadAtGeneration?_("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath,!1),!0)}},{key:"VisitCountForContainer",value:function(t){if(null===t)return _("container");if(!t.visitsShouldBeCounted)return console.warn("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;var e=0,n=t.path.toString();return e=this.state.visitCounts.get(n)||e}},{key:"IncrementVisitCountForContainer",value:function(t){var e=0,n=t.path.toString();this.state.visitCounts.has(n)&&(e=this.state.visitCounts.get(n)),e++,this.state.visitCounts.set(n,e)}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e=t.path.toString();this.state.turnIndices.set(e,this.state.currentTurnIndex)}},{key:"TurnsSinceForContainer",value:function(t){t.turnIndexShouldBeCounted||this.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c).");var e=t.path.toString(),n=this.state.turnIndices.get(e);return void 0!==n?this.state.currentTurnIndex-n:-1}},{key:"NextSequenceShuffleIndex",value:function(){var t=g(this.state.PopEvaluationStack(),R);if(!(t instanceof R))return this.Error("expected number of elements in sequence for shuffle index"),0;var e=this.state.currentPointer.container;if(null===e)return _("seqContainer");if(null===t.value)return _("numElementsIntVal.value");var n=t.value,i=S(this.state.PopEvaluationStack(),R).value;if(null===i)return _("seqCount");for(var r=i/n,a=i%n,o=e.path.toString(),u=0,s=0,l=o.length;s<l;s++)u+=o.charCodeAt(s)||0;for(var h=u+r+this.state.storySeed,c=new dt(Math.floor(h)),f=[],v=0;v<n;++v)f.push(v);for(var d=0;d<=a;++d){var y=c.next()%f.length,p=f[y];if(f.splice(y,1),d==a)return p}throw new Error("Should never reach here")}},{key:"Error",value:function(t,e){var n=1<arguments.length&&void 0!==e&&e,i=new P(t);throw i.useEndLineNumber=n,i}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t,e,n){var i=1<arguments.length&&void 0!==e&&e,r=2<arguments.length&&void 0!==n&&n,a=this.currentDebugMetadata,o=i?"WARNING":"ERROR";if(null!=a){var u=r?a.endLineNumber:a.startLineNumber;t="RUNTIME "+o+": '"+a.fileName+"' line "+u+": "+t}else t=this.state.currentPointer.isNull?"RUNTIME "+o+": "+t:"RUNTIME "+o+": ("+this.state.currentPointer+"): "+t;this.state.AddError(t,i),i||this.state.ForceEnd()}},{key:"Assert",value:function(t,e){var n=1<arguments.length&&void 0!==e?e:null;if(0==t)throw null==n&&(n="Story assert"),new Error(n+" "+this.currentDebugMetadata)}},{key:"currentChoices",get:function(){var t=[];if(null===this._state)return _("this._state");var e=!0,n=!1,i=void 0;try{for(var r,a=this._state.currentChoices[Symbol.iterator]();!(e=(r=a.next()).done);e=!0){var o=r.value;o.isInvisibleDefault||(o.index=t.length,t.push(o))}}catch(t){n=!0,i=t}finally{try{e||null==a.return||a.return()}finally{if(n)throw i}}return t}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}},{key:"currentDebugMetadata",get:function(){var t,e=this.state.currentPointer;if(!e.isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var n=this.state.callStack.elements.length-1;0<=n;--n)if(!(e=this.state.callStack.elements[n].currentPointer).isNull&&null!==e.Resolve()&&null!==(t=e.Resolve().debugMetadata))return t;for(var i=this.state.outputStream.length-1;0<=i;--i)if(null!==(t=this.state.outputStream[i].debugMetadata))return t;return null}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}]),t}(),ct=t.Story||(t.Story={}),(ft=ct.OutputStateChange||(ct.OutputStateChange={}))[ft.NoChange=0]="NoChange",ft[ft.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",ft[ft.NewlineRemoved=2]="NewlineRemoved",t.InkList=N,Object.defineProperty(t,"__esModule",{value:!0})}(e)},function(t,e,n){t.exports=n(2)},function(t,e,n){"use strict";n.r(e);var i=n(0);function r(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],i=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done)&&(n.push(o.value),!e||n.length!==e);i=!0);}catch(t){r=!0,a=t}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function a(t){var e={};return t.forEach(function(t){var n=t.match(/\s*(\w+)\s*:\s*(.+?)\s*$/);if(Array.isArray(n)){var i=r(n,3),a=i[1],o=i[2],u=o.substr(0,1);n="{"===u||"["===u?JSON.parse(o):o,e[a]=n}else e[t]=!0}),e}var o=function(t,e){for(var n=t.$ink,i={type:"text",content:[],text:[],tags:{},choices:[]};n.canContinue;){n.Continue();var r=n.currentText;if(0===r.indexOf(">>>")){var o=e.run(r,t);o&&i.text.push(o)}else i.text.push(r);var u=a(n.currentTags);u.scene&&(i.type=u.scene),i.tags=Object.assign({},i.tags,u),i.content.push({text:r,tags:u})}return n.currentChoices.forEach(function(t,e){i.choices.push({id:e,choice:t.text})}),i};function u(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var s=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.$ink=new i.Story(e),this.$episode=[],this.$sceneId=-1}var e,n,r;return e=t,(n=[{key:"clearEpisode",value:function(){this.$episode.splice(0),this.$sceneId=-1}},{key:"getCurrentEpisode",value:function(){return this.$episode}},{key:"getCurrentScene",value:function(){return this.$episode[this.$episode.length-1]}},{key:"renderScene",value:function(t){var e=o(this,t);return this.updateEpisode(e)}},{key:"makeChoice",value:function(t){return this.$ink.ChooseChoiceIndex(t)}},{key:"updateEpisode",value:function(t){return this.$sceneId>=0&&(this.$episode[this.$sceneId].isActive=!1),this.$sceneId+=1,t.isActive=!0,t.id=this.$sceneId,this.$episode.push(t),t}},{key:"getState",value:function(){return{episode:this.$episode,story:JSON.parse(this.$ink.state.toJson())}}},{key:"restoreState",value:function(t){this.$episode=t.episode,this.$ink.state.LoadJson(JSON.stringify(t.story))}},{key:"getVar",value:function(t){return this.$ink.variablesState[t]}},{key:"getVars",value:function(){var t=this.$ink.variablesState,e={};return t._globalVariables.forEach(function(n,i){e[i]=t[i]}),e}},{key:"setVar",value:function(t,e){this.$ink.variablesState[t]=e}},{key:"setVars",value:function(t){var e=this;Object.keys(t).forEach(function(n){e.$ink.variablesState[n]=t[n]})}},{key:"getVisitCount",value:function(t){this.$ink.state.VisitCountAtPathString(t)}},{key:"evaluateFunction",value:function(){var t;return(t=this.$ink).EvaluateFunction.apply(t,arguments)}}])&&u(e.prototype,n),r&&u(e,r),t}();function l(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var h=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.commands={}}var e,n,i;return e=t,(n=[{key:"register",value:function(t,e){this.commands[t]=e}},{key:"run",value:function(t,e){var n=t.replace(/(\r\n\t|\n|\r\t)/gm,"").split(" "),i=n[1],r=n.slice(2);return i in this.commands?this.commands[i](r,e,i):t}}])&&l(e.prototype,n),i&&l(e,i),t}();function c(t){return function(t){if(Array.isArray(t)){for(var e=0,n=new Array(t.length);e<t.length;e++)n[e]=t[e];return n}}(t)||function(t){if(Symbol.iterator in Object(t)||"[object Arguments]"===Object.prototype.toString.call(t))return Array.from(t)}(t)||function(){throw new TypeError("Invalid attempt to spread non-iterable instance")}()}function f(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}var v=function(){function t(){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.handlers={}}var e,n,i;return e=t,(n=[{key:"subscribeAll",value:function(t){var e=this;Object.entries(t).forEach(function(t){return e.subscribe.apply(e,c(t))})}},{key:"subscribe",value:function(t,e){this.handlers[t]=e}},{key:"apply",value:function(t){Object.entries(this.handlers).forEach(t)}},{key:"publish",value:function(t,e){return this.handlers[t]?this.handlers[t](e):null}}])&&f(e.prototype,n),i&&f(e,i),t}();function d(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){var n=[],i=!0,r=!1,a=void 0;try{for(var o,u=t[Symbol.iterator]();!(i=(o=u.next()).done)&&(n.push(o.value),!e||n.length!==e);i=!0);}catch(t){r=!0,a=t}finally{try{i||null==u.return||u.return()}finally{if(r)throw a}}return n}(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance")}()}function y(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function p(t){return new Promise(function(){throw new Error("".concat(t," is not implemented"))})}var m=function(){function t(e){!function(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}(this,t),this.game=e,this.event=new v,this.event.subscribeAll({loadStory:function(){return p("loadStory")},loadGame:function(){return p("loadGame")},saveGame:function(){return p("saveGame")},error:function(){return p("error")}}),this.inkObservers=new v,this.inkFunctions=new v,this.inkCommands=new h,this.story={},this.transcript=[]}var e,n,i;return e=t,(n=[{key:"startGame",value:function(){var t=this;return this.loadStoryFile().then(function(){t.story.clearEpisode()})}},{key:"loadGame",value:function(t){var e=this,n={};return this.event.publish("loadGame",t).then(function(t){return n=JSON.parse(t),e.loadStoryFile()}).then(function(){e.story.restoreState(n.data)})}},{key:"saveGame",value:function(t){return this.event.publish("saveGame",{id:t,data:this.story.getState()})}},{key:"renderScene",value:function(){var t=this.story.renderScene(this.inkCommands);return this.game.transcript&&this.transcript.push(t),t}},{key:"getTranscript",value:function(){return this.transcript}},{key:"makeChoice",value:function(t){var e=this;return new Promise(function(n){e.game.transcript&&(e.transcript[e.transcript.length-1].chosen=t),e.story.$ink.ChooseChoiceIndex(t),n()}).catch(function(t){e.event.publish("error",t)})}},{key:"loadStoryFile",value:function(){var t=this;return this.event.publish("loadStory",this.game.storyFile).then(function(e){var n=e;if("string"==typeof e){var i=e.replace("\ufeff","");n=JSON.parse(i)}t.initEpisode(n)})}},{key:"initEpisode",value:function(t){var e=new s(t);this.inkObservers.apply(function(t){var n=d(t,2),i=n[0],r=n[1];e.$ink.ObserveVariable(i,r)}),this.inkFunctions.apply(function(t){var n=d(t,2),i=n[0],r=n[1];e.$ink.BindExternalFunction(i,r)}),this.story=e}},{key:"registerFunctions",value:function(t){this.inkFunctions.subscribeAll(t)}},{key:"registerObservers",value:function(t){this.inkObservers.subscribeAll(t)}},{key:"registerCommand",value:function(t,e){this.inkCommands.register(t,e)}},{key:"on",value:function(t,e){this.event.subscribe(t,e)}},{key:"debug",value:function(){return this.story.$ink.state}}])&&y(e.prototype,n),i&&y(e,i),t}();e.default=m}])});
//# sourceMappingURL=atrament.js.map