!function(t,e){"object"==typeof exports&&"object"==typeof module?module.exports=e():"function"==typeof define&&define.amd?define([],e):"object"==typeof exports?exports.Atrament=e():t.Atrament=e()}("undefined"!=typeof self?self:this,(function(){return(()=>{var t={914:(t,e,n)=>{"use strict";n.r(e),n.d(e,{default:()=>c});var i=n(117);function r(){return Math.random().toString(36).substring(2,15)+Math.random().toString(36).substring(2,15)}function a(t){const e={};return t.forEach((t=>{let n=t.match(/\s*(\w+)\s*:\s*(.+?)\s*$/);if(Array.isArray(n)){const[,t,i]=n,r=i.substr(0,1);n="{"===r||"["===r?JSON.parse(i):i,e[t]=n}else e[t]=!0})),e}const s=function(t,e){const n=t.$ink,i={type:"text",content:[],text:[],tags:{},choices:[]};for(;n.canContinue;){n.Continue();const{currentText:s}=n;if(0===s.indexOf(">>>")){const n=e.run(s,t);n&&i.text.push(n)}else i.text.push(s);const o=a(n.currentTags);o.scene&&(i.type=o.scene),i.tags={...i.tags,...o},i.uuid=r(),i.content.push({text:s,tags:o})}return n.currentChoices.forEach(((t,e)=>{i.choices.push({id:e,choice:t.text,uuid:"".concat(i.uuid,":").concat(r())})})),i};const o=class{constructor(t){this.$ink=new i.Story(t),this.$episode=[],this.$sceneId=-1,this.$extState={}}clearEpisode(){this.$episode.splice(0),this.$sceneId=-1}getCurrentEpisode(){return this.$episode}getCurrentScene(){return this.$episode[this.$episode.length-1]}renderScene(t){const e=s(this,t);return this.updateEpisode(e)}updateEpisode(t){return this.$sceneId>=0&&(this.$episode[this.$sceneId].isActive=!1),this.$sceneId+=1,t.isActive=!0,t.id=this.$sceneId,this.$episode.push(t),t}getState(){return{episode:this.$episode,state:this.$extState,story:JSON.parse(this.$ink.state.toJson())}}restoreState(t){this.$episode=t.episode,this.$extState=t.state,this.$ink.state.LoadJson(JSON.stringify(t.story))}getVar(t){return this.$ink.variablesState[t]}getVars(){const t=this.$ink.variablesState,e={};return t._globalVariables.forEach(((n,i)=>{e[i]=t[i]})),e}setVar(t,e){this.$ink.variablesState[t]=e}setVars(t){Object.keys(t).forEach((e=>{this.$ink.variablesState[e]=t[e]}))}getVisitCount(t){this.$ink.state.VisitCountAtPathString(t)}evaluateFunction(...t){return this.$ink.EvaluateFunction(...t)}updateExtStateWith(t){const e=t(this.$extState,this);e&&(this.$extState={...this.$extState,...e})}};const u=class{constructor(){this.commands={}}register(t,e){this.commands[t]=e}run(t,e){const n=t.replace(/(\r\n\t|\n|\r\t)/gm,"").split(" "),i=n[1],r=n.slice(2);return i in this.commands?this.commands[i](r,e,i):t}};const l=class{constructor(){this.handlers={}}subscribeAll(t){Object.entries(t).forEach((t=>this.subscribe(...t)))}subscribe(t,e){this.handlers[t]=e}apply(t){Object.entries(this.handlers).forEach(t)}publish(t,e){return this.handlers[t]?this.handlers[t](e):null}};function h(t){return new Promise((()=>{throw new Error("".concat(t," is not implemented"))}))}const c=class{constructor(t){this.game=t,this.event=new l,this.event.subscribeAll({loadStory:()=>h("loadStory"),loadGame:()=>h("loadGame"),saveGame:()=>h("saveGame"),error:()=>h("error")}),this.inkObservers=new l,this.inkFunctions=new l,this.inkCommands=new u,this.story={},this.transcript=[]}startGame(){return this.loadStoryFile().then((()=>{this.story.clearEpisode()}))}loadGame(t){let e={};return this.event.publish("loadGame",t).then((t=>(e=JSON.parse(t),this.loadStoryFile()))).then((()=>{this.story.restoreState(e.data)}))}saveGame(t){return this.event.publish("saveGame",{id:t,data:this.story.getState()})}renderScene(){const t=this.story.renderScene(this.inkCommands);return this.game.transcript&&this.transcript.push(t),t}getTranscript(){return this.transcript}makeChoice(t){this.game.transcript&&(this.transcript[this.transcript.length-1].chosen=t);try{this.story.$ink.ChooseChoiceIndex(t)}catch(t){this.event.publish("error",t)}}goto(t){this.story.$ink.ChoosePathString(t)}loadStoryFile(){return this.event.publish("loadStory",this.game.storyFile).then((t=>{let e=t;if("string"==typeof t){const n=t.replace("\ufeff","");e=JSON.parse(n)}this.initEpisode(e)}))}initEpisode(t){const e=new o(t);this.inkObservers.apply((([t,n])=>{e.$ink.ObserveVariable(t,n)})),this.inkFunctions.apply((([t,n])=>{e.$ink.BindExternalFunction(t,n)})),this.story=e}registerFunctions(t){this.inkFunctions.subscribeAll(t)}registerObservers(t){this.inkObservers.subscribeAll(t)}registerCommand(t,e){this.inkCommands.register(t,e)}on(t,e){this.event.subscribe(t,e)}onPhase(t,e){this.event.subscribe("phase:".concat(t),(()=>this.story.updateExtStateWith(e)))}runPhase(t){this.event.publish("phase:".concat(t))}debug(){return this.story.$ink.state}}},117:function(t,e){!function(t){"use strict";function e(t){return(e="function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?function(t){return typeof t}:function(t){return t&&"function"==typeof Symbol&&t.constructor===Symbol&&t!==Symbol.prototype?"symbol":typeof t})(t)}function n(t,e){if(!(t instanceof e))throw new TypeError("Cannot call a class as a function")}function i(t,e){for(var n=0;n<e.length;n++){var i=e[n];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(t,i.key,i)}}function r(t,e,n){return e&&i(t.prototype,e),n&&i(t,n),t}function a(t,e){if("function"!=typeof e&&null!==e)throw new TypeError("Super expression must either be null or a function");t.prototype=Object.create(e&&e.prototype,{constructor:{value:t,writable:!0,configurable:!0}}),e&&o(t,e)}function s(t){return(s=Object.setPrototypeOf?Object.getPrototypeOf:function(t){return t.__proto__||Object.getPrototypeOf(t)})(t)}function o(t,e){return(o=Object.setPrototypeOf||function(t,e){return t.__proto__=e,t})(t,e)}function u(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Date.prototype.toString.call(Reflect.construct(Date,[],(function(){}))),!0}catch(t){return!1}}function l(t,e,n){return(l=u()?Reflect.construct:function(t,e,n){var i=[null];i.push.apply(i,e);var r=new(Function.bind.apply(t,i));return n&&o(r,n.prototype),r}).apply(null,arguments)}function h(t){var e="function"==typeof Map?new Map:void 0;return(h=function(t){if(null===t||(n=t,-1===Function.toString.call(n).indexOf("[native code]")))return t;var n;if("function"!=typeof t)throw new TypeError("Super expression must either be null or a function");if(void 0!==e){if(e.has(t))return e.get(t);e.set(t,i)}function i(){return l(t,arguments,s(this).constructor)}return i.prototype=Object.create(t.prototype,{constructor:{value:i,enumerable:!1,writable:!0,configurable:!0}}),o(i,t)})(t)}function c(t,e){return!e||"object"!=typeof e&&"function"!=typeof e?function(t){if(void 0===t)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return t}(t):e}function f(t){var e=u();return function(){var n,i=s(t);return c(this,e?(n=s(this).constructor,Reflect.construct(i,arguments,n)):i.apply(this,arguments))}}function v(t,e){return function(t){if(Array.isArray(t))return t}(t)||function(t,e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(t)){var n=[],i=!0,r=!1,a=void 0;try{for(var s,o=t[Symbol.iterator]();!(i=(s=o.next()).done)&&(n.push(s.value),!e||n.length!==e);i=!0);}catch(t){r=!0,a=t}finally{try{i||null==o.return||o.return()}finally{if(r)throw a}}return n}}(t,e)||d(t,e)||function(){throw new TypeError("Invalid attempt to destructure non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}()}function d(t,e){if(t){if("string"==typeof t)return p(t,e);var n=Object.prototype.toString.call(t).slice(8,-1);return"Object"===n&&t.constructor&&(n=t.constructor.name),"Map"===n||"Set"===n?Array.from(t):"Arguments"===n||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(n)?p(t,e):void 0}}function p(t,e){(null==e||e>t.length)&&(e=t.length);for(var n=0,i=new Array(e);n<e;n++)i[n]=t[n];return i}function y(t,e){var n;if("undefined"==typeof Symbol||null==t[Symbol.iterator]){if(Array.isArray(t)||(n=d(t))||e&&t&&"number"==typeof t.length){n&&(t=n);var i=0,r=function(){};return{s:r,n:function(){return i>=t.length?{done:!0}:{done:!1,value:t[i++]}},e:function(t){throw t},f:r}}throw new TypeError("Invalid attempt to iterate non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}var a,s=!0,o=!1;return{s:function(){n=t[Symbol.iterator]()},n:function(){var t=n.next();return s=t.done,t},e:function(t){o=!0,a=t},f:function(){try{s||null==n.return||n.return()}finally{if(o)throw a}}}}var m,g,S,k,C=function(){function t(){var e,i,r,a,s;n(this,t),this._components=[],this._componentsString=null,this._isRelative=!1,"string"==typeof arguments[0]?(e=arguments[0],this.componentsString=e):arguments[0]instanceof t.Component&&arguments[1]instanceof t?(i=arguments[0],r=arguments[1],this._components.push(i),this._components=this._components.concat(r._components)):arguments[0]instanceof Array&&(a=arguments[0],s=!!arguments[1],this._components=this._components.concat(a),this._isRelative=s)}return r(t,[{key:"GetComponent",value:function(t){return this._components[t]}},{key:"PathByAppendingPath",value:function(e){for(var n=new t,i=0,r=0;r<e._components.length&&e._components[r].isParent;++r)i++;for(var a=0;a<this._components.length-i;++a)n._components.push(this._components[a]);for(var s=i;s<e._components.length;++s)n._components.push(e._components[s]);return n}},{key:"toString",value:function(){return this.componentsString}},{key:"Equals",value:function(t){if(null==t)return!1;if(t._components.length!=this._components.length)return!1;if(t.isRelative!=this.isRelative)return!1;for(var e=0,n=t._components.length;e<n;e++)if(!t._components[e].Equals(this._components[e]))return!1;return!0}},{key:"PathByAppendingComponent",value:function(e){var n=new t;return n._components.push.apply(n._components,this._components),n._components.push(e),n}},{key:"isRelative",get:function(){return this._isRelative}},{key:"componentCount",get:function(){return this._components.length}},{key:"head",get:function(){return 0<this._components.length?this._components[0]:null}},{key:"tail",get:function(){return 2<=this._components.length?new t(this._components.slice(1,this._components.length)):t.self}},{key:"length",get:function(){return this._components.length}},{key:"lastComponent",get:function(){var t=this._components.length-1;return 0<=t?this._components[t]:null}},{key:"containsNamedComponent",get:function(){for(var t=0,e=this._components.length;t<e;t++)if(!this._components[t].isIndex)return!0;return!1}},{key:"componentsString",get:function(){return null==this._componentsString&&(this._componentsString=this._components.join("."),this.isRelative&&(this._componentsString="."+this._componentsString)),this._componentsString},set:function(e){if(this._components.length=0,this._componentsString=e,null!=this._componentsString&&""!=this._componentsString){"."==this._componentsString[0]&&(this._isRelative=!0,this._componentsString=this._componentsString.substring(1));var n,i=y(this._componentsString.split("."));try{for(i.s();!(n=i.n()).done;){var r=n.value;/^(\-|\+)?([0-9]+|Infinity)$/.test(r)?this._components.push(new t.Component(parseInt(r))):this._components.push(new t.Component(r))}}catch(e){i.e(e)}finally{i.f()}}}}],[{key:"self",get:function(){var e=new t;return e._isRelative=!0,e}}]),t}();function b(t,e){if(!t)throw void 0!==e&&console.warn(e),console.trace&&console.trace(),new Error("")}function _(t,e){return t instanceof e?t:null}function T(t,e){if(t instanceof e)return t;throw new Error("".concat(t," is not of type ").concat(e))}function w(t){return t.hasValidName&&t.name?t:null}function P(t){return void 0===t?null:t}function O(t){return"object"===e(t)&&"function"==typeof t.Equals}C.parentId="^",m=C=C||{},g=function(){function t(e){n(this,t),this.index=-1,this.name=null,"string"==typeof e?this.name=e:this.index=e}return r(t,[{key:"toString",value:function(){return this.isIndex?this.index.toString():this.name}},{key:"Equals",value:function(t){return null!=t&&t.isIndex==this.isIndex&&(this.isIndex?this.index==t.index:this.name==t.name)}},{key:"isIndex",get:function(){return 0<=this.index}},{key:"isParent",get:function(){return this.name==m.parentId}}],[{key:"ToParent",value:function(){return new t(m.parentId)}}]),t}(),m.Component=g,(k=S=S||{}).AssertType=function(t,e,n){b(t instanceof e,n)},k.Assert=b;var E=function(){a(e,h(Error));var t=f(e);function e(){return n(this,e),t.apply(this,arguments)}return e}();function N(t){throw new E("".concat(t," is null or undefined"))}var A=function(){function t(){n(this,t),this.parent=null,this._debugMetadata=null,this._path=null}return r(t,[{key:"DebugLineNumberOfPath",value:function(t){if(null===t)return null;var e=this.rootContentContainer;if(e){var n=e.ContentAtPath(t).obj;if(n){var i=n.debugMetadata;if(null!==i)return i.startLineNumber}}return null}},{key:"ResolvePath",value:function(t){if(null===t)return N("path");if(t.isRelative){var e=_(this,H);return null===e&&(S.Assert(null!==this.parent,"Can't resolve relative path because we don't have a parent"),e=_(this.parent,H),S.Assert(null!==e,"Expected parent to be a container"),S.Assert(t.GetComponent(0).isParent),t=t.tail),null===e?N("nearestContainer"):e.ContentAtPath(t)}var n=this.rootContentContainer;return null===n?N("contentContainer"):n.ContentAtPath(t)}},{key:"ConvertPathToRelative",value:function(t){for(var e=this.path,n=Math.min(t.length,e.length),i=-1,r=0;r<n;++r){var a=e.GetComponent(r),s=t.GetComponent(r);if(!a.Equals(s))break;i=r}if(-1==i)return t;for(var o=e.componentCount-1-i,u=[],l=0;l<o;++l)u.push(C.Component.ToParent());for(var h=i+1;h<t.componentCount;++h)u.push(t.GetComponent(h));return new C(u,!0)}},{key:"CompactPathString",value:function(t){var e=null,n=null;return e=t.isRelative?(n=t.componentsString,this.path.PathByAppendingPath(t).componentsString):(n=this.ConvertPathToRelative(t).componentsString,t.componentsString),n.length<e.length?n:e}},{key:"Copy",value:function(){throw Error("Not Implemented: Doesn't support copying")}},{key:"SetChild",value:function(t,e,n){t[e]&&(t[e]=null),t[e]=n,t[e]&&(t[e].parent=this)}},{key:"debugMetadata",get:function(){return null===this._debugMetadata&&this.parent?this.parent.debugMetadata:this._debugMetadata},set:function(t){this._debugMetadata=t}},{key:"ownDebugMetadata",get:function(){return this._debugMetadata}},{key:"path",get:function(){if(null==this._path)if(null==this.parent)this._path=new C;else{for(var t=[],e=this,n=_(e.parent,H);null!==n;){var i=w(e);null!=i&&i.hasValidName?t.unshift(new C.Component(i.name)):t.unshift(new C.Component(n.content.indexOf(e))),n=_((e=n).parent,H)}this._path=new C(t)}return this._path}},{key:"rootContentContainer",get:function(){for(var t=this;t.parent;)t=t.parent;return _(t,H)}}]),t}(),x=function(){function t(e){n(this,t),e=void 0!==e?e.toString():"",this.string=e}return r(t,[{key:"Append",value:function(t){null!==t&&(this.string+=t)}},{key:"AppendLine",value:function(t){void 0!==t&&this.Append(t),this.string+="\n"}},{key:"AppendFormat",value:function(t){for(var e=arguments.length,n=new Array(1<e?e-1:0),i=1;i<e;i++)n[i-1]=arguments[i];this.string+=t.replace(/{(\d+)}/g,(function(t,e){return void 0!==n[e]?n[e]:t}))}},{key:"toString",value:function(){return this.string}},{key:"Length",get:function(){return this.string.length}}]),t}(),I=function(){function t(){var e,i,r;n(this,t),this.originName=null,this.itemName=null,void 0!==arguments[1]?(e=arguments[0],i=arguments[1],this.originName=e,this.itemName=i):arguments[0]&&(r=arguments[0].toString().split("."),this.originName=r[0],this.itemName=r[1])}return r(t,[{key:"toString",value:function(){return this.fullName}},{key:"Equals",value:function(e){return e instanceof t&&e.itemName==this.itemName&&e.originName==this.originName}},{key:"copy",value:function(){return new t(this.originName,this.itemName)}},{key:"serialized",value:function(){return JSON.stringify({originName:this.originName,itemName:this.itemName})}},{key:"isNull",get:function(){return null==this.originName&&null==this.itemName}},{key:"fullName",get:function(){return(null!==this.originName?this.originName:"?")+"."+this.itemName}}],[{key:"fromSerializedKey",value:function(e){var n=JSON.parse(e);return t.isLikeInkListItem(n)?new t(n.originName,n.itemName):t.Null}},{key:"isLikeInkListItem",value:function(t){return!("object"!==e(t)||!t.hasOwnProperty("originName")||!t.hasOwnProperty("itemName")||"string"!=typeof t.originName&&null!==typeof t.originName||"string"!=typeof t.itemName&&null!==typeof t.itemName)}},{key:"Null",get:function(){return new t(null,null)}}]),t}(),W=function(){a(i,h(Map));var t=f(i);function i(){var r,a,s=arguments;if(n(this,i),(r=t.call(this,s[0]instanceof i?s[0]:[])).origins=null,r._originNames=[],arguments[0]instanceof i){var o=arguments[0];o._originNames&&(r._originNames=o._originNames.slice())}else if("string"==typeof arguments[0]){var u=arguments[0],l=arguments[1];r.SetInitialOriginName(u);var h=l.listDefinitions.TryListGetDefinition(u,null);if(!h.exists)throw new Error("InkList origin could not be found in story when constructing new list: "+u);r.origins=[h.result]}else"object"===e(arguments[0])&&arguments[0].hasOwnProperty("Key")&&arguments[0].hasOwnProperty("Value")&&(a=arguments[0],r.Add(a.Key,a.Value));return r}return r(i,[{key:"AddItem",value:function(t){if(t instanceof I){var e=t;if(null==e.originName)return void this.AddItem(e.itemName);if(null===this.origins)return N("this.origins");var n,i=y(this.origins);try{for(i.s();!(n=i.n()).done;){var r=n.value;if(r.name==e.originName){var a=r.TryGetValueForItem(e,0);if(a.exists)return void this.Add(e,a.result);throw new Error("Could not add the item "+e+" to this list because it doesn't exist in the original list definition in ink.")}}}catch(t){i.e(t)}finally{i.f()}throw new Error("Failed to add item to list because the item was from a new list definition that wasn't previously known to this list. Only items from previously known lists can be used, so that the int value can be found.")}var s=t,o=null;if(null===this.origins)return N("this.origins");var u,l=y(this.origins);try{for(l.s();!(u=l.n()).done;){var h=u.value;if(null===s)return N("itemName");if(h.ContainsItemWithName(s)){if(null!=o)throw new Error("Could not add the item "+s+" to this list because it could come from either "+h.name+" or "+o.name);o=h}}}catch(t){l.e(t)}finally{l.f()}if(null==o)throw new Error("Could not add the item "+s+" to this list because it isn't known to any list definitions previously associated with this list.");var c=new I(o.name,s),f=o.ValueForItem(c);this.Add(c,f)}},{key:"ContainsItemNamed",value:function(t){var e,n=y(this);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,1)[0];if(I.fromSerializedKey(i).itemName==t)return!0}}catch(t){n.e(t)}finally{n.f()}return!1}},{key:"ContainsKey",value:function(t){return this.has(t.serialized())}},{key:"Add",value:function(t,e){var n=t.serialized();if(this.has(n))throw new Error("The Map already contains an entry for ".concat(t));this.set(n,e)}},{key:"Remove",value:function(t){return this.delete(t.serialized())}},{key:"SetInitialOriginName",value:function(t){this._originNames=[t]}},{key:"SetInitialOriginNames",value:function(t){this._originNames=null==t?null:t.slice()}},{key:"Union",value:function(t){var e,n=new i(this),r=y(t);try{for(r.s();!(e=r.n()).done;){var a=v(e.value,2),s=a[0],o=a[1];n.set(s,o)}}catch(t){r.e(t)}finally{r.f()}return n}},{key:"Intersect",value:function(t){var e,n=new i,r=y(this);try{for(r.s();!(e=r.n()).done;){var a=v(e.value,2),s=a[0],o=a[1];t.has(s)&&n.set(s,o)}}catch(t){r.e(t)}finally{r.f()}return n}},{key:"Without",value:function(t){var e,n=new i(this),r=y(t);try{for(r.s();!(e=r.n()).done;){var a=v(e.value,1)[0];n.delete(a)}}catch(t){r.e(t)}finally{r.f()}return n}},{key:"Contains",value:function(t){var e,n=y(t);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,1)[0];if(!this.has(i))return!1}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"GreaterThan",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>t.maxItem.Value)}},{key:"GreaterThanOrEquals",value:function(t){return 0!=this.Count&&(0==t.Count||this.minItem.Value>=t.minItem.Value&&this.maxItem.Value>=t.maxItem.Value)}},{key:"LessThan",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<t.minItem.Value)}},{key:"LessThanOrEquals",value:function(t){return 0!=t.Count&&(0==this.Count||this.maxItem.Value<=t.maxItem.Value&&this.minItem.Value<=t.minItem.Value)}},{key:"MaxAsList",value:function(){return 0<this.Count?new i(this.maxItem):new i}},{key:"MinAsList",value:function(){return 0<this.Count?new i(this.minItem):new i}},{key:"ListWithSubRange",value:function(t,e){if(0==this.Count)return new i;var n=this.orderedItems,r=0,a=Number.MAX_SAFE_INTEGER;Number.isInteger(t)?r=t:t instanceof i&&0<t.Count&&(r=t.minItem.Value),Number.isInteger(e)?a=e:t instanceof i&&0<t.Count&&(a=e.maxItem.Value);var s=new i;s.SetInitialOriginNames(this.originNames);var o,u=y(n);try{for(u.s();!(o=u.n()).done;){var l=o.value;l.Value>=r&&l.Value<=a&&s.Add(l.Key,l.Value)}}catch(t){u.e(t)}finally{u.f()}return s}},{key:"Equals",value:function(t){if(t instanceof i==0)return!1;if(t.Count!=this.Count)return!1;var e,n=y(this);try{for(n.s();!(e=n.n()).done;){var r=v(e.value,1)[0];if(!t.has(r))return!1}}catch(t){n.e(t)}finally{n.f()}return!0}},{key:"toString",value:function(){for(var t=this.orderedItems,e=new x,n=0;n<t.length;n++){0<n&&e.Append(", ");var i=t[n].Key;if(null===i.itemName)return N("item.itemName");e.Append(i.itemName)}return e.toString()}},{key:"valueOf",value:function(){return NaN}},{key:"Count",get:function(){return this.size}},{key:"originOfMaxItem",get:function(){if(null==this.origins)return null;var t=this.maxItem.Key.originName,e=null;return this.origins.every((function(n){return n.name!=t||(e=n,!1)})),e}},{key:"originNames",get:function(){if(0<this.Count){null==this._originNames&&0<this.Count?this._originNames=[]:(this._originNames||(this._originNames=[]),this._originNames.length=0);var t,e=y(this);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,1)[0],i=I.fromSerializedKey(n);if(null===i.originName)return N("item.originName");this._originNames.push(i.originName)}}catch(t){e.e(t)}finally{e.f()}}return this._originNames}},{key:"maxItem",get:function(){var t,e={Key:I.Null,Value:0},n=y(this);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=i[1],s=I.fromSerializedKey(r);(e.Key.isNull||a>e.Value)&&(e={Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"minItem",get:function(){var t,e={Key:I.Null,Value:0},n=y(this);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=i[1],s=I.fromSerializedKey(r);(e.Key.isNull||a<e.Value)&&(e={Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e}},{key:"inverse",get:function(){var t=new i;if(null!=this.origins){var e,n=y(this.origins);try{for(n.s();!(e=n.n()).done;){var r,a=y(e.value.items);try{for(a.s();!(r=a.n()).done;){var s=v(r.value,2),o=s[0],u=s[1],l=I.fromSerializedKey(o);this.ContainsKey(l)||t.Add(l,u)}}catch(t){a.e(t)}finally{a.f()}}}catch(t){n.e(t)}finally{n.f()}}return t}},{key:"all",get:function(){var t=new i;if(null!=this.origins){var e,n=y(this.origins);try{for(n.s();!(e=n.n()).done;){var r,a=y(e.value.items);try{for(a.s();!(r=a.n()).done;){var s=v(r.value,2),o=s[0],u=s[1],l=I.fromSerializedKey(o);t.set(l.serialized(),u)}}catch(t){a.e(t)}finally{a.f()}}}catch(t){n.e(t)}finally{n.f()}}return t}},{key:"orderedItems",get:function(){var t,e=new Array,n=y(this);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=i[1],s=I.fromSerializedKey(r);e.push({Key:s,Value:a})}}catch(t){n.e(t)}finally{n.f()}return e.sort((function(t,e){return null===t.Key.originName?N("x.Key.originName"):null===e.Key.originName?N("y.Key.originName"):t.Value==e.Value?t.Key.originName.localeCompare(e.Key.originName):t.Value<e.Value?-1:t.Value>e.Value?1:0})),e}}]),i}(),F=function(){a(e,h(Error));var t=f(e);function e(i){var r;return n(this,e),(r=t.call(this,i)).useEndLineNumber=!1,r.message=i,r.name="StoryException",r}return e}();function V(t,e,n){if(null===t)return{result:n,exists:!1};var i=t.get(e);return void 0===i?{result:n,exists:!1}:{result:i,exists:!0}}var R,j,L=function(){a(e,A);var t=f(e);function e(){return n(this,e),t.apply(this,arguments)}return r(e,[{key:"Copy",value:function(){return T(e.Create(this),A)}},{key:"BadCastException",value:function(t){return new F("Can't cast "+this.valueObject+" from "+this.valueType+" to "+t)}}],[{key:"Create",value:function(t,e){if(e){if(e===R.Int&&Number.isInteger(Number(t)))return new G(Number(t));if(e===R.Float&&!isNaN(t))return new B(Number(t))}return"boolean"==typeof t&&(t=t?1:0),"string"==typeof t?new M(String(t)):Number.isInteger(Number(t))?new G(Number(t)):isNaN(t)?t instanceof C?new J(T(t,C)):t instanceof W?new K(T(t,W)):null:new B(Number(t))}}]),e}(),D=function(){a(e,L);var t=f(e);function e(i){var r;return n(this,e),(r=t.call(this)).value=i,r}return r(e,[{key:"toString",value:function(){return null===this.value?N("Value.value"):this.value.toString()}},{key:"valueObject",get:function(){return this.value}}]),e}(),G=function(){a(e,D);var t=f(e);function e(i){return n(this,e),t.call(this,i||0)}return r(e,[{key:"Cast",value:function(t){if(null===this.value)return N("Value.value");if(t==this.valueType)return this;if(t==R.Float)return new B(this.value);if(t==R.String)return new M(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return R.Int}}]),e}(),B=function(){a(e,D);var t=f(e);function e(i){return n(this,e),t.call(this,i||0)}return r(e,[{key:"Cast",value:function(t){if(null===this.value)return N("Value.value");if(t==this.valueType)return this;if(t==R.Int)return new G(this.value);if(t==R.String)return new M(""+this.value);throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return 0!=this.value}},{key:"valueType",get:function(){return R.Float}}]),e}(),M=function(){a(e,D);var t=f(e);function e(i){var r;return n(this,e),(r=t.call(this,i||""))._isNewline="\n"==r.value,r._isInlineWhitespace=!0,null===r.value?c(r,N("Value.value")):(0<r.value.length&&r.value.split("").every((function(t){return" "==t||"\t"==t||(r._isInlineWhitespace=!1)})),r)}return r(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;if(t==R.Int){var e=function(t,e){var n=1<arguments.length&&void 0!==e?e:0,i=parseInt(t);return Number.isNaN(i)?{result:n,exists:!1}:{result:i,exists:!0}}(this.value);if(e.exists)return new G(e.result);throw this.BadCastException(t)}if(t!=R.Float)throw this.BadCastException(t);var n=function(t,e){var n=1<arguments.length&&void 0!==e?e:0,i=parseFloat(t);return Number.isNaN(i)?{result:n,exists:!1}:{result:i,exists:!0}}(this.value);if(n.exists)return new B(n.result);throw this.BadCastException(t)}},{key:"valueType",get:function(){return R.String}},{key:"isTruthy",get:function(){return null===this.value?N("Value.value"):0<this.value.length}},{key:"isNewline",get:function(){return this._isNewline}},{key:"isInlineWhitespace",get:function(){return this._isInlineWhitespace}},{key:"isNonWhitespace",get:function(){return!this.isNewline&&!this.isInlineWhitespace}}]),e}(),J=function(){a(e,D);var t=f(e);function e(i){return n(this,e),t.call(this,i)}return r(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"DivertTargetValue("+this.targetPath+")"}},{key:"valueType",get:function(){return R.DivertTarget}},{key:"targetPath",get:function(){return null===this.value?N("Value.value"):this.value},set:function(t){this.value=t}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a divert target")}}]),e}(),q=function(){a(e,D);var t=f(e);function e(i){var r,a=1<arguments.length&&void 0!==arguments[1]?arguments[1]:-1;return n(this,e),(r=t.call(this,i))._contextIndex=a,r}return r(e,[{key:"Cast",value:function(t){if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"toString",value:function(){return"VariablePointerValue("+this.variableName+")"}},{key:"Copy",value:function(){return new e(this.variableName,this.contextIndex)}},{key:"contextIndex",get:function(){return this._contextIndex},set:function(t){this._contextIndex=t}},{key:"variableName",get:function(){return null===this.value?N("Value.value"):this.value},set:function(t){this.value=t}},{key:"valueType",get:function(){return R.VariablePointer}},{key:"isTruthy",get:function(){throw new Error("Shouldn't be checking the truthiness of a variable pointer")}}]),e}(),K=function(){a(e,D);var t=f(e);function e(i,r){var a;return n(this,e),a=t.call(this,null),i||r?i instanceof W?a.value=new W(i):i instanceof I&&"number"==typeof r&&(a.value=new W({Key:i,Value:r})):a.value=new W,a}return r(e,[{key:"Cast",value:function(t){if(null===this.value)return N("Value.value");if(t==R.Int){var e=this.value.maxItem;return e.Key.isNull?new G(0):new G(e.Value)}if(t==R.Float){var n=this.value.maxItem;return n.Key.isNull?new B(0):new B(n.Value)}if(t==R.String){var i=this.value.maxItem;return i.Key.isNull?new M(""):new M(i.Key.toString())}if(t==this.valueType)return this;throw this.BadCastException(t)}},{key:"isTruthy",get:function(){return null===this.value?N("this.value"):0<this.value.Count}},{key:"valueType",get:function(){return R.List}}]),r(e,null,[{key:"RetainListOriginsForAssignment",value:function(t,n){var i=_(t,e),r=_(n,e);return r&&null===r.value?N("newList.value"):i&&null===i.value?N("oldList.value"):void(i&&r&&0==r.value.Count&&r.value.SetInitialOriginNames(i.value.originNames))}}]),e}();(j=R=R||{})[j.Int=0]="Int",j[j.Float=1]="Float",j[j.List=2]="List",j[j.String=3]="String",j[j.DivertTarget=4]="DivertTarget",j[j.VariablePointer=5]="VariablePointer";var U,$,z=function(){function t(){n(this,t),this.obj=null,this.approximate=!1}return r(t,[{key:"copy",value:function(){var e=new t;return e.obj=this.obj,e.approximate=this.approximate,e}},{key:"correctObj",get:function(){return this.approximate?null:this.obj}},{key:"container",get:function(){return this.obj instanceof H?this.obj:null}}]),t}(),H=function(){a(e,A);var t=f(e);function e(){var i;return n(this,e),(i=t.apply(this,arguments)).name="",i._content=[],i.namedContent=new Map,i.visitsShouldBeCounted=!1,i.turnIndexShouldBeCounted=!1,i.countingAtStartOnly=!1,i._pathToFirstLeafContent=null,i}return r(e,[{key:"AddContent",value:function(t){if(t instanceof Array){var e,n=y(t);try{for(n.s();!(e=n.n()).done;){var i=e.value;this.AddContent(i)}}catch(t){n.e(t)}finally{n.f()}}else{var r=t;if(this._content.push(r),r.parent)throw new Error("content is already in "+r.parent);(r.parent=this).TryAddNamedContent(r)}}},{key:"TryAddNamedContent",value:function(t){var e=w(t);null!=e&&e.hasValidName&&this.AddToNamedContentOnly(e)}},{key:"AddToNamedContentOnly",value:function(t){S.AssertType(t,A,"Can only add Runtime.Objects to a Runtime.Container"),(T(t,A).parent=this).namedContent.set(t.name,t)}},{key:"ContentAtPath",value:function(t,n,i){var r=1<arguments.length&&void 0!==n?n:0,a=2<arguments.length&&void 0!==i?i:-1;-1==a&&(a=t.length);var s=new z;s.approximate=!1;for(var o=this,u=this,l=r;l<a;++l){var h=t.GetComponent(l);if(null==o){s.approximate=!0;break}var c=o.ContentWithPathComponent(h);if(null==c){s.approximate=!0;break}o=_(u=c,e)}return s.obj=u,s}},{key:"InsertContent",value:function(t,e){if((this.content[e]=t).parent)throw new Error("content is already in "+t.parent);(t.parent=this).TryAddNamedContent(t)}},{key:"AddContentsOfContainer",value:function(t){this.content=this.content.concat(t.content);var e,n=y(t.content);try{for(n.s();!(e=n.n()).done;){var i=e.value;(i.parent=this).TryAddNamedContent(i)}}catch(t){n.e(t)}finally{n.f()}}},{key:"ContentWithPathComponent",value:function(t){if(t.isIndex)return 0<=t.index&&t.index<this.content.length?this.content[t.index]:null;if(t.isParent)return this.parent;if(null===t.name)return N("component.name");var e=V(this.namedContent,t.name,null);return e.exists?T(e.result,A):null}},{key:"BuildStringOfHierarchy",value:function(t,n,i){var r;if(0==arguments.length)return r=new x,this.BuildStringOfHierarchy(r,0,null),r.toString();r=t;var a=n,s=i;function o(){for(var t=0;t<4*a;++t)r.Append(" ")}o(),r.Append("["),this.hasValidName&&r.AppendFormat(" ({0})",this.name),this==s&&r.Append("  <---"),r.AppendLine(),a++;for(var u=0;u<this.content.length;++u){var l=this.content[u];l instanceof e?l.BuildStringOfHierarchy(r,a,s):(o(),l instanceof M?(r.Append('"'),r.Append(l.toString().replace("\n","\\n")),r.Append('"')):r.Append(l.toString())),u!=this.content.length-1&&r.Append(","),l instanceof e||l!=s||r.Append("  <---"),r.AppendLine()}var h,c=new Map,f=y(this.namedContent);try{for(f.s();!(h=f.n()).done;){var d=v(h.value,2),p=d[0],m=d[1];0<=this.content.indexOf(T(m,A))||c.set(p,m)}}catch(t){f.e(t)}finally{f.f()}if(0<c.size){o(),r.AppendLine("-- named: --");var g,k=y(c);try{for(k.s();!(g=k.n()).done;){var C=v(g.value,2)[1];S.AssertType(C,e,"Can only print out named Containers"),C.BuildStringOfHierarchy(r,a,s),r.AppendLine()}}catch(t){k.e(t)}finally{k.f()}}a--,o(),r.Append("]")}},{key:"hasValidName",get:function(){return null!=this.name&&0<this.name.length}},{key:"content",get:function(){return this._content},set:function(t){this.AddContent(t)}},{key:"namedOnlyContent",get:function(){var t,e=new Map,n=y(this.namedContent);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2),r=i[0],a=T(i[1],A);e.set(r,a)}}catch(t){n.e(t)}finally{n.f()}var s,o=y(this.content);try{for(o.s();!(s=o.n()).done;){var u=w(s.value);null!=u&&u.hasValidName&&e.delete(u.name)}}catch(t){o.e(t)}finally{o.f()}return 0==e.size&&(e=null),e},set:function(t){var e=this.namedOnlyContent;if(null!=e){var n,i=y(e);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,1)[0];this.namedContent.delete(r)}}catch(t){i.e(t)}finally{i.f()}}if(null!=t){var a,s=y(t);try{for(s.s();!(a=s.n()).done;){var o=w(v(a.value,2)[1]);null!=o&&this.AddToNamedContentOnly(o)}}catch(t){s.e(t)}finally{s.f()}}}},{key:"countFlags",get:function(){var t=0;return this.visitsShouldBeCounted&&(t|=e.CountFlags.Visits),this.turnIndexShouldBeCounted&&(t|=e.CountFlags.Turns),this.countingAtStartOnly&&(t|=e.CountFlags.CountStartOnly),t==e.CountFlags.CountStartOnly&&(t=0),t},set:function(t){var n=t;0<(n&e.CountFlags.Visits)&&(this.visitsShouldBeCounted=!0),0<(n&e.CountFlags.Turns)&&(this.turnIndexShouldBeCounted=!0),0<(n&e.CountFlags.CountStartOnly)&&(this.countingAtStartOnly=!0)}},{key:"pathToFirstLeafContent",get:function(){return null==this._pathToFirstLeafContent&&(this._pathToFirstLeafContent=this.path.PathByAppendingPath(this.internalPathToFirstLeafContent)),this._pathToFirstLeafContent}},{key:"internalPathToFirstLeafContent",get:function(){for(var t=[],n=this;n instanceof e;)0<n.content.length&&(t.push(new C.Component(0)),n=n.content[0]);return new C(t)}}]),e}();U=H=H||{},($=U.CountFlags||(U.CountFlags={}))[$.Visits=1]="Visits",$[$.Turns=2]="Turns",$[$.CountStartOnly=4]="CountStartOnly";var X,Y,Q,Z,tt=function(){a(e,A);var t=f(e);function e(){return n(this,e),t.apply(this,arguments)}return r(e,[{key:"toString",value:function(){return"Glue"}}]),e}(),et=function(){a(e,A);var t=f(e);function e(){var i,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:e.CommandType.NotSet;return n(this,e),(i=t.call(this))._commandType=r,i}return r(e,[{key:"Copy",value:function(){return new e(this.commandType)}},{key:"toString",value:function(){return this.commandType.toString()}},{key:"commandType",get:function(){return this._commandType}}],[{key:"EvalStart",value:function(){return new e(e.CommandType.EvalStart)}},{key:"EvalOutput",value:function(){return new e(e.CommandType.EvalOutput)}},{key:"EvalEnd",value:function(){return new e(e.CommandType.EvalEnd)}},{key:"Duplicate",value:function(){return new e(e.CommandType.Duplicate)}},{key:"PopEvaluatedValue",value:function(){return new e(e.CommandType.PopEvaluatedValue)}},{key:"PopFunction",value:function(){return new e(e.CommandType.PopFunction)}},{key:"PopTunnel",value:function(){return new e(e.CommandType.PopTunnel)}},{key:"BeginString",value:function(){return new e(e.CommandType.BeginString)}},{key:"EndString",value:function(){return new e(e.CommandType.EndString)}},{key:"NoOp",value:function(){return new e(e.CommandType.NoOp)}},{key:"ChoiceCount",value:function(){return new e(e.CommandType.ChoiceCount)}},{key:"Turns",value:function(){return new e(e.CommandType.Turns)}},{key:"TurnsSince",value:function(){return new e(e.CommandType.TurnsSince)}},{key:"ReadCount",value:function(){return new e(e.CommandType.ReadCount)}},{key:"Random",value:function(){return new e(e.CommandType.Random)}},{key:"SeedRandom",value:function(){return new e(e.CommandType.SeedRandom)}},{key:"VisitIndex",value:function(){return new e(e.CommandType.VisitIndex)}},{key:"SequenceShuffleIndex",value:function(){return new e(e.CommandType.SequenceShuffleIndex)}},{key:"StartThread",value:function(){return new e(e.CommandType.StartThread)}},{key:"Done",value:function(){return new e(e.CommandType.Done)}},{key:"End",value:function(){return new e(e.CommandType.End)}},{key:"ListFromInt",value:function(){return new e(e.CommandType.ListFromInt)}},{key:"ListRange",value:function(){return new e(e.CommandType.ListRange)}},{key:"ListRandom",value:function(){return new e(e.CommandType.ListRandom)}}]),e}();X=et=et||{},(Y=X.CommandType||(X.CommandType={}))[Y.NotSet=-1]="NotSet",Y[Y.EvalStart=0]="EvalStart",Y[Y.EvalOutput=1]="EvalOutput",Y[Y.EvalEnd=2]="EvalEnd",Y[Y.Duplicate=3]="Duplicate",Y[Y.PopEvaluatedValue=4]="PopEvaluatedValue",Y[Y.PopFunction=5]="PopFunction",Y[Y.PopTunnel=6]="PopTunnel",Y[Y.BeginString=7]="BeginString",Y[Y.EndString=8]="EndString",Y[Y.NoOp=9]="NoOp",Y[Y.ChoiceCount=10]="ChoiceCount",Y[Y.Turns=11]="Turns",Y[Y.TurnsSince=12]="TurnsSince",Y[Y.Random=13]="Random",Y[Y.SeedRandom=14]="SeedRandom",Y[Y.VisitIndex=15]="VisitIndex",Y[Y.SequenceShuffleIndex=16]="SequenceShuffleIndex",Y[Y.StartThread=17]="StartThread",Y[Y.Done=18]="Done",Y[Y.End=19]="End",Y[Y.ListFromInt=20]="ListFromInt",Y[Y.ListRange=21]="ListRange",Y[Y.ListRandom=22]="ListRandom",Y[Y.ReadCount=23]="ReadCount",Y[Y.TOTAL_VALUES=24]="TOTAL_VALUES",(Z=Q=Q||{})[Z.Tunnel=0]="Tunnel",Z[Z.Function=1]="Function",Z[Z.FunctionEvaluationFromGame=2]="FunctionEvaluationFromGame";var nt=function(){function t(){n(this,t),this.container=null,this.index=-1,2===arguments.length&&(this.container=arguments[0],this.index=arguments[1])}return r(t,[{key:"Resolve",value:function(){return this.index<0?this.container:null==this.container?null:0==this.container.content.length?this.container:this.index>=this.container.content.length?null:this.container.content[this.index]}},{key:"toString",value:function(){return this.container?"Ink Pointer -> "+this.container.path.toString()+" -- index "+this.index:"Ink Pointer (null)"}},{key:"copy",value:function(){return new t(this.container,this.index)}},{key:"isNull",get:function(){return null==this.container}},{key:"path",get:function(){return this.isNull?null:0<=this.index?this.container.path.PathByAppendingComponent(new C.Component(this.index)):this.container.path}}],[{key:"StartOf",value:function(e){return new t(e,0)}},{key:"Null",get:function(){return new t(null,-1)}}]),t}(),it=function(){a(e,A);var t=f(e);function e(i){var r;return n(this,e),(r=t.call(this))._targetPath=null,r._targetPointer=nt.Null,r.variableDivertName=null,r.pushesToStack=!1,r.stackPushType=0,r.isExternal=!1,r.externalArgs=0,r.isConditional=!1,r.pushesToStack=!1,void 0!==i&&(r.pushesToStack=!0,r.stackPushType=i),r}return r(e,[{key:"Equals",value:function(t){var n=t;return n instanceof e&&this.hasVariableTarget==n.hasVariableTarget&&(this.hasVariableTarget?this.variableDivertName==n.variableDivertName:null===this.targetPath?N("this.targetPath"):this.targetPath.Equals(n.targetPath))}},{key:"toString",value:function(){if(this.hasVariableTarget)return"Divert(variable: "+this.variableDivertName+")";if(null==this.targetPath)return"Divert(null)";var t=new x,e=this.targetPath.toString();return t.Append("Divert"),this.isConditional&&t.Append("?"),this.pushesToStack&&(this.stackPushType==Q.Function?t.Append(" function"):t.Append(" tunnel")),t.Append(" -> "),t.Append(this.targetPathString),t.Append(" ("),t.Append(e),t.Append(")"),t.toString()}},{key:"targetPath",get:function(){var t;return null==this._targetPath||!this._targetPath.isRelative||(t=this.targetPointer.Resolve())&&(this._targetPath=t.path),this._targetPath},set:function(t){this._targetPath=t,this._targetPointer=nt.Null}},{key:"targetPointer",get:function(){if(this._targetPointer.isNull){var t=this.ResolvePath(this._targetPath).obj;if(null===this._targetPath)return N("this._targetPath");if(null===this._targetPath.lastComponent)return N("this._targetPath.lastComponent");if(this._targetPath.lastComponent.isIndex){if(null===t)return N("targetObj");this._targetPointer.container=t.parent instanceof H?t.parent:null,this._targetPointer.index=this._targetPath.lastComponent.index}else this._targetPointer=nt.StartOf(t instanceof H?t:null)}return this._targetPointer.copy()}},{key:"targetPathString",get:function(){return null==this.targetPath?null:this.CompactPathString(this.targetPath)},set:function(t){this.targetPath=null==t?null:new C(t)}},{key:"hasVariableTarget",get:function(){return null!=this.variableDivertName}}]),e}(),rt=function(){a(e,A);var t=f(e);function e(){var i,r=!(0<arguments.length&&void 0!==arguments[0])||arguments[0];return n(this,e),(i=t.call(this))._pathOnChoice=null,i.hasCondition=!1,i.hasStartContent=!1,i.hasChoiceOnlyContent=!1,i.isInvisibleDefault=!1,i.onceOnly=!0,i.onceOnly=r,i}return r(e,[{key:"toString",value:function(){return null===this.pathOnChoice?N("ChoicePoint.pathOnChoice"):"Choice: -> "+this.pathOnChoice.toString()}},{key:"pathOnChoice",get:function(){var t;return null==this._pathOnChoice||!this._pathOnChoice.isRelative||(t=this.choiceTarget)&&(this._pathOnChoice=t.path),this._pathOnChoice},set:function(t){this._pathOnChoice=t}},{key:"choiceTarget",get:function(){return null===this._pathOnChoice?N("ChoicePoint._pathOnChoice"):this.ResolvePath(this._pathOnChoice).container}},{key:"pathStringOnChoice",get:function(){return null===this.pathOnChoice?N("ChoicePoint.pathOnChoice"):this.CompactPathString(this.pathOnChoice)},set:function(t){this.pathOnChoice=new C(t)}},{key:"flags",get:function(){var t=0;return this.hasCondition&&(t|=1),this.hasStartContent&&(t|=2),this.hasChoiceOnlyContent&&(t|=4),this.isInvisibleDefault&&(t|=8),this.onceOnly&&(t|=16),t},set:function(t){this.hasCondition=0<(1&t),this.hasStartContent=0<(2&t),this.hasChoiceOnlyContent=0<(4&t),this.isInvisibleDefault=0<(8&t),this.onceOnly=0<(16&t)}}]),e}(),at=function(){a(e,A);var t=f(e);function e(){var i,r=0<arguments.length&&void 0!==arguments[0]?arguments[0]:null;return n(this,e),(i=t.call(this)).pathForCount=null,i.name=r,i}return r(e,[{key:"toString",value:function(){return null!=this.name?"var("+this.name+")":"read_count("+this.pathStringForCount+")"}},{key:"containerForCount",get:function(){return null===this.pathForCount?null:this.ResolvePath(this.pathForCount).container}},{key:"pathStringForCount",get:function(){return null===this.pathForCount?null:this.CompactPathString(this.pathForCount)},set:function(t){this.pathForCount=null===t?null:new C(t)}}]),e}(),st=function(){a(e,A);var t=f(e);function e(i,r){var a;return n(this,e),(a=t.call(this)).variableName=i||null,a.isNewDeclaration=!!r,a.isGlobal=!1,a}return r(e,[{key:"toString",value:function(){return"VarAssign to "+this.variableName}}]),e}(),ot=function(){a(e,A);var t=f(e);function e(){return n(this,e),t.apply(this,arguments)}return e}(),ut=function(){a(e,A);var t=f(e);function e(){var i,r,a,s;return n(this,e),(i=t.call(this))._name=null,i._numberOfParameters=0,i._prototype=null,i._isPrototype=!1,i._operationFuncs=null,0===arguments.length?e.GenerateNativeFunctionsIfNecessary():1===arguments.length?(r=arguments[0],e.GenerateNativeFunctionsIfNecessary(),i.name=r):2===arguments.length&&(a=arguments[0],s=arguments[1],i._isPrototype=!0,i.name=a,i.numberOfParameters=s),i}return r(e,[{key:"Call",value:function(t){if(this._prototype)return this._prototype.Call(t);if(this.numberOfParameters!=t.length)throw new Error("Unexpected number of parameters");var e,n=!1,i=y(t);try{for(i.s();!(e=i.n()).done;){var r=e.value;if(r instanceof ot)throw new F('Attempting to perform operation on a void value. Did you forget to "return" a value from a function you called here?');r instanceof K&&(n=!0)}}catch(t){i.e(t)}finally{i.f()}if(2==t.length&&n)return this.CallBinaryListOperation(t);var a=this.CoerceValuesToSingleType(t),s=a[0].valueType;return s==R.Int||s==R.Float||s==R.String||s==R.DivertTarget||s==R.List?this.CallType(a):null}},{key:"CallType",value:function(t){var n=T(t[0],D),i=n.valueType,r=n,a=t.length;if(2!=a&&1!=a)throw new Error("Unexpected number of parameters to NativeFunctionCall: "+t.length);if(null===this._operationFuncs)return N("NativeFunctionCall._operationFuncs");var s=this._operationFuncs.get(i);if(!s){var o=R[i];throw new F("Cannot perform operation "+this.name+" on "+o)}if(2==a){var u=T(t[1],D),l=s;if(null===r.value||null===u.value)return N("NativeFunctionCall.Call BinaryOp values");var h=l(r.value,u.value);return D.Create(h)}var c=s;if(null===r.value)return N("NativeFunctionCall.Call UnaryOp value");var f=c(r.value);return this.name===e.Int?D.Create(f,R.Int):this.name===e.Float?D.Create(f,R.Float):D.Create(f,n.valueType)}},{key:"CallBinaryListOperation",value:function(t){if(("+"==this.name||"-"==this.name)&&t[0]instanceof K&&t[1]instanceof G)return this.CallListIncrementOperation(t);var e=T(t[0],D),n=T(t[1],D);if(!("&&"!=this.name&&"||"!=this.name||e.valueType==R.List&&n.valueType==R.List)){if(null===this._operationFuncs)return N("NativeFunctionCall._operationFuncs");var i=this._operationFuncs.get(R.Int);if(null===i)return N("NativeFunctionCall.CallBinaryListOperation op");var r=i(e.isTruthy?1:0,n.isTruthy?1:0);return new G(r)}if(e.valueType==R.List&&n.valueType==R.List)return this.CallType([e,n]);throw new F("Can not call use "+this.name+" operation on "+R[e.valueType]+" and "+R[n.valueType])}},{key:"CallListIncrementOperation",value:function(t){var e=T(t[0],K),n=T(t[1],G),i=new W;if(null===e.value)return N("NativeFunctionCall.CallListIncrementOperation listVal.value");var r,a=y(e.value);try{for(a.s();!(r=a.n()).done;){var s=v(r.value,2),o=s[0],u=s[1],l=I.fromSerializedKey(o);if(null===this._operationFuncs)return N("NativeFunctionCall._operationFuncs");var h=this._operationFuncs.get(R.Int);if(null===n.value)return N("NativeFunctionCall.CallListIncrementOperation intVal.value");var c=h(u,n.value),f=null;if(null===e.value.origins)return N("NativeFunctionCall.CallListIncrementOperation listVal.value.origins");var d,p,m=y(e.value.origins);try{for(m.s();!(d=m.n()).done;){var g=d.value;if(g.name==l.originName){f=g;break}}}catch(t){m.e(t)}finally{m.f()}null==f||(p=f.TryGetItemWithValue(c,I.Null)).exists&&i.Add(p.result,c)}}catch(t){a.e(t)}finally{a.f()}return new K(i)}},{key:"CoerceValuesToSingleType",value:function(t){var e,n=R.Int,i=null,r=y(t);try{for(r.s();!(e=r.n()).done;){var a=T(e.value,D);a.valueType>n&&(n=a.valueType),a.valueType==R.List&&(i=_(a,K))}}catch(t){r.e(t)}finally{r.f()}var s=[];if(R[n]==R[R.List]){var o,u=y(t);try{for(u.s();!(o=u.n()).done;){var l=T(o.value,D);if(l.valueType==R.List)s.push(l);else{if(l.valueType!=R.Int){var h=R[l.valueType];throw new F("Cannot mix Lists and "+h+" values in this operation")}var c=parseInt(l.valueObject);if(null===(i=T(i,K)).value)return N("NativeFunctionCall.CoerceValuesToSingleType specialCaseList.value");var f=i.value.originOfMaxItem;if(null===f)return N("NativeFunctionCall.CoerceValuesToSingleType list");var v=f.TryGetItemWithValue(c,I.Null);if(!v.exists)throw new F("Could not find List item with the value "+c+" in "+f.name);var d=new K(v.result,c);s.push(d)}}}catch(t){u.e(t)}finally{u.f()}}else{var p,m=y(t);try{for(m.s();!(p=m.n()).done;){var g=T(p.value,D).Cast(n);s.push(g)}}catch(t){m.e(t)}finally{m.f()}}return s}},{key:"AddOpFuncForType",value:function(t,e){null==this._operationFuncs&&(this._operationFuncs=new Map),this._operationFuncs.set(t,e)}},{key:"toString",value:function(){return'Native "'+this.name+'"'}},{key:"name",get:function(){return null===this._name?N("NativeFunctionCall._name"):this._name},set:function(t){this._name=t,this._isPrototype||(null===e._nativeFunctions?N("NativeFunctionCall._nativeFunctions"):this._prototype=e._nativeFunctions.get(this._name)||null)}},{key:"numberOfParameters",get:function(){return this._prototype?this._prototype.numberOfParameters:this._numberOfParameters},set:function(t){this._numberOfParameters=t}}],[{key:"CallWithName",value:function(t){return new e(t)}},{key:"CallExistsWithName",value:function(t){return this.GenerateNativeFunctionsIfNecessary(),this._nativeFunctions.get(t)}},{key:"Identity",value:function(t){return t}},{key:"GenerateNativeFunctionsIfNecessary",value:function(){null==this._nativeFunctions&&(this._nativeFunctions=new Map,this.AddIntBinaryOp(this.Add,(function(t,e){return t+e})),this.AddIntBinaryOp(this.Subtract,(function(t,e){return t-e})),this.AddIntBinaryOp(this.Multiply,(function(t,e){return t*e})),this.AddIntBinaryOp(this.Divide,(function(t,e){return Math.floor(t/e)})),this.AddIntBinaryOp(this.Mod,(function(t,e){return t%e})),this.AddIntUnaryOp(this.Negate,(function(t){return-t})),this.AddIntBinaryOp(this.Equal,(function(t,e){return t==e?1:0})),this.AddIntBinaryOp(this.Greater,(function(t,e){return e<t?1:0})),this.AddIntBinaryOp(this.Less,(function(t,e){return t<e?1:0})),this.AddIntBinaryOp(this.GreaterThanOrEquals,(function(t,e){return e<=t?1:0})),this.AddIntBinaryOp(this.LessThanOrEquals,(function(t,e){return t<=e?1:0})),this.AddIntBinaryOp(this.NotEquals,(function(t,e){return t!=e?1:0})),this.AddIntUnaryOp(this.Not,(function(t){return 0==t?1:0})),this.AddIntBinaryOp(this.And,(function(t,e){return 0!=t&&0!=e?1:0})),this.AddIntBinaryOp(this.Or,(function(t,e){return 0!=t||0!=e?1:0})),this.AddIntBinaryOp(this.Max,(function(t,e){return Math.max(t,e)})),this.AddIntBinaryOp(this.Min,(function(t,e){return Math.min(t,e)})),this.AddIntBinaryOp(this.Pow,(function(t,e){return Math.pow(t,e)})),this.AddIntUnaryOp(this.Floor,e.Identity),this.AddIntUnaryOp(this.Ceiling,e.Identity),this.AddIntUnaryOp(this.Int,e.Identity),this.AddIntUnaryOp(this.Float,(function(t){return t})),this.AddFloatBinaryOp(this.Add,(function(t,e){return t+e})),this.AddFloatBinaryOp(this.Subtract,(function(t,e){return t-e})),this.AddFloatBinaryOp(this.Multiply,(function(t,e){return t*e})),this.AddFloatBinaryOp(this.Divide,(function(t,e){return t/e})),this.AddFloatBinaryOp(this.Mod,(function(t,e){return t%e})),this.AddFloatUnaryOp(this.Negate,(function(t){return-t})),this.AddFloatBinaryOp(this.Equal,(function(t,e){return t==e?1:0})),this.AddFloatBinaryOp(this.Greater,(function(t,e){return e<t?1:0})),this.AddFloatBinaryOp(this.Less,(function(t,e){return t<e?1:0})),this.AddFloatBinaryOp(this.GreaterThanOrEquals,(function(t,e){return e<=t?1:0})),this.AddFloatBinaryOp(this.LessThanOrEquals,(function(t,e){return t<=e?1:0})),this.AddFloatBinaryOp(this.NotEquals,(function(t,e){return t!=e?1:0})),this.AddFloatUnaryOp(this.Not,(function(t){return 0==t?1:0})),this.AddFloatBinaryOp(this.And,(function(t,e){return 0!=t&&0!=e?1:0})),this.AddFloatBinaryOp(this.Or,(function(t,e){return 0!=t||0!=e?1:0})),this.AddFloatBinaryOp(this.Max,(function(t,e){return Math.max(t,e)})),this.AddFloatBinaryOp(this.Min,(function(t,e){return Math.min(t,e)})),this.AddFloatBinaryOp(this.Pow,(function(t,e){return Math.pow(t,e)})),this.AddFloatUnaryOp(this.Floor,(function(t){return Math.floor(t)})),this.AddFloatUnaryOp(this.Ceiling,(function(t){return Math.ceil(t)})),this.AddFloatUnaryOp(this.Int,(function(t){return Math.floor(t)})),this.AddFloatUnaryOp(this.Float,e.Identity),this.AddStringBinaryOp(this.Add,(function(t,e){return t+e})),this.AddStringBinaryOp(this.Equal,(function(t,e){return t===e?1:0})),this.AddStringBinaryOp(this.NotEquals,(function(t,e){return t!==e?1:0})),this.AddStringBinaryOp(this.Has,(function(t,e){return t.includes(e)?1:0})),this.AddStringBinaryOp(this.Hasnt,(function(t,e){return t.includes(e)?0:1})),this.AddListBinaryOp(this.Add,(function(t,e){return t.Union(e)})),this.AddListBinaryOp(this.Subtract,(function(t,e){return t.Without(e)})),this.AddListBinaryOp(this.Has,(function(t,e){return t.Contains(e)?1:0})),this.AddListBinaryOp(this.Hasnt,(function(t,e){return t.Contains(e)?0:1})),this.AddListBinaryOp(this.Intersect,(function(t,e){return t.Intersect(e)})),this.AddListBinaryOp(this.Equal,(function(t,e){return t.Equals(e)?1:0})),this.AddListBinaryOp(this.Greater,(function(t,e){return t.GreaterThan(e)?1:0})),this.AddListBinaryOp(this.Less,(function(t,e){return t.LessThan(e)?1:0})),this.AddListBinaryOp(this.GreaterThanOrEquals,(function(t,e){return t.GreaterThanOrEquals(e)?1:0})),this.AddListBinaryOp(this.LessThanOrEquals,(function(t,e){return t.LessThanOrEquals(e)?1:0})),this.AddListBinaryOp(this.NotEquals,(function(t,e){return t.Equals(e)?0:1})),this.AddListBinaryOp(this.And,(function(t,e){return 0<t.Count&&0<e.Count?1:0})),this.AddListBinaryOp(this.Or,(function(t,e){return 0<t.Count||0<e.Count?1:0})),this.AddListUnaryOp(this.Not,(function(t){return 0==t.Count?1:0})),this.AddListUnaryOp(this.Invert,(function(t){return t.inverse})),this.AddListUnaryOp(this.All,(function(t){return t.all})),this.AddListUnaryOp(this.ListMin,(function(t){return t.MinAsList()})),this.AddListUnaryOp(this.ListMax,(function(t){return t.MaxAsList()})),this.AddListUnaryOp(this.Count,(function(t){return t.Count})),this.AddListUnaryOp(this.ValueOfList,(function(t){return t.maxItem.Value})),this.AddOpToNativeFunc(this.Equal,2,R.DivertTarget,(function(t,e){return t.Equals(e)?1:0})),this.AddOpToNativeFunc(this.NotEquals,2,R.DivertTarget,(function(t,e){return t.Equals(e)?0:1})))}},{key:"AddOpToNativeFunc",value:function(t,n,i,r){if(null===this._nativeFunctions)return N("NativeFunctionCall._nativeFunctions");var a=this._nativeFunctions.get(t);a||(a=new e(t,n),this._nativeFunctions.set(t,a)),a.AddOpFuncForType(i,r)}},{key:"AddIntBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,R.Int,e)}},{key:"AddIntUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,R.Int,e)}},{key:"AddFloatBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,R.Float,e)}},{key:"AddFloatUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,R.Float,e)}},{key:"AddStringBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,R.String,e)}},{key:"AddListBinaryOp",value:function(t,e){this.AddOpToNativeFunc(t,2,R.List,e)}},{key:"AddListUnaryOp",value:function(t,e){this.AddOpToNativeFunc(t,1,R.List,e)}}]),e}();ut.Add="+",ut.Subtract="-",ut.Divide="/",ut.Multiply="*",ut.Mod="%",ut.Negate="_",ut.Equal="==",ut.Greater=">",ut.Less="<",ut.GreaterThanOrEquals=">=",ut.LessThanOrEquals="<=",ut.NotEquals="!=",ut.Not="!",ut.And="&&",ut.Or="||",ut.Min="MIN",ut.Max="MAX",ut.Pow="POW",ut.Floor="FLOOR",ut.Ceiling="CEILING",ut.Int="INT",ut.Float="FLOAT",ut.Has="?",ut.Hasnt="!?",ut.Intersect="^",ut.ListMin="LIST_MIN",ut.ListMax="LIST_MAX",ut.All="LIST_ALL",ut.Count="LIST_COUNT",ut.ValueOfList="LIST_VALUE",ut.Invert="LIST_INVERT",ut._nativeFunctions=null;var lt=function(){a(e,A);var t=f(e);function e(i){var r;return n(this,e),(r=t.call(this)).text=i.toString()||"",r}return r(e,[{key:"toString",value:function(){return"# "+this.text}}]),e}(),ht=function(){a(e,A);var t=f(e);function e(){var i;return n(this,e),(i=t.apply(this,arguments)).text="",i.index=0,i.threadAtGeneration=null,i.sourcePath="",i.targetPath=null,i.isInvisibleDefault=!1,i.originalThreadIndex=0,i}return r(e,[{key:"pathStringOnChoice",get:function(){return null===this.targetPath?N("Choice.targetPath"):this.targetPath.toString()},set:function(t){this.targetPath=new C(t)}}]),e}(),ct=function(){function t(e,i){n(this,t),this._name=e||"",this._items=null,this._itemNameToValues=i||new Map}return r(t,[{key:"ValueForItem",value:function(t){if(!t.itemName)return 0;var e=this._itemNameToValues.get(t.itemName);return void 0!==e?e:0}},{key:"ContainsItem",value:function(t){return!!t.itemName&&t.originName==this.name&&this._itemNameToValues.has(t.itemName)}},{key:"ContainsItemWithName",value:function(t){return this._itemNameToValues.has(t)}},{key:"TryGetItemWithValue",value:function(t){var e,n=y(this._itemNameToValues);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,2),r=i[0];if(i[1]==t)return{result:new I(this.name,r),exists:!0}}}catch(t){n.e(t)}finally{n.f()}return{result:I.Null,exists:!1}}},{key:"TryGetValueForItem",value:function(t){if(!t.itemName)return{result:0,exists:!1};var e=this._itemNameToValues.get(t.itemName);return e?{result:e,exists:!0}:{result:0,exists:!1}}},{key:"name",get:function(){return this._name}},{key:"items",get:function(){if(null==this._items){this._items=new Map;var t,e=y(this._itemNameToValues);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,2),i=n[0],r=n[1],a=new I(this.name,i);this._items.set(a.serialized(),r)}}catch(t){e.e(t)}finally{e.f()}}return this._items}}]),t}(),ft=function(){function t(e){n(this,t),this._lists=new Map,this._allUnambiguousListValueCache=new Map;var i,r=y(e);try{for(r.s();!(i=r.n()).done;){var a=i.value;this._lists.set(a.name,a);var s,o=y(a.items);try{for(o.s();!(s=o.n()).done;){var u=v(s.value,2),l=u[0],h=u[1],c=I.fromSerializedKey(l),f=new K(c,h);if(!c.itemName)throw new Error("item.itemName is null or undefined.");this._allUnambiguousListValueCache.set(c.itemName,f),this._allUnambiguousListValueCache.set(c.fullName,f)}}catch(e){o.e(e)}finally{o.f()}}}catch(e){r.e(e)}finally{r.f()}}return r(t,[{key:"TryListGetDefinition",value:function(t,e){if(null===t)return{result:e,exists:!1};var n=this._lists.get(t);return n?{result:n,exists:!0}:{result:e,exists:!1}}},{key:"FindSingleItemListWithName",value:function(t){if(null===t)return N("name");var e=this._allUnambiguousListValueCache.get(t);return void 0!==e?e:null}},{key:"lists",get:function(){var t,e=[],n=y(this._lists);try{for(n.s();!(t=n.n()).done;){var i=v(t.value,2)[1];e.push(i)}}catch(t){n.e(t)}finally{n.f()}return e}}]),t}(),vt=function(){function t(){n(this,t)}return r(t,null,[{key:"JArrayToRuntimeObjList",value:function(t,e){var n=1<arguments.length&&void 0!==e&&e,i=t.length;n&&i--;for(var r=[],a=0;a<i;a++){var s=t[a],o=this.JTokenToRuntimeObject(s);if(null===o)return N("runtimeObj");r.push(o)}return r}},{key:"WriteDictionaryRuntimeObjs",value:function(t,e){t.WriteObjectStart();var n,i=y(e);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,2),a=r[0],s=r[1];t.WritePropertyStart(a),this.WriteRuntimeObject(t,s),t.WritePropertyEnd()}}catch(t){i.e(t)}finally{i.f()}t.WriteObjectEnd()}},{key:"WriteListRuntimeObjs",value:function(t,e){t.WriteArrayStart();var n,i=y(e);try{for(i.s();!(n=i.n()).done;){var r=n.value;this.WriteRuntimeObject(t,r)}}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()}},{key:"WriteIntDictionary",value:function(t,e){t.WriteObjectStart();var n,i=y(e);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,2),a=r[0],s=r[1];t.WriteIntProperty(a,s)}}catch(t){i.e(t)}finally{i.f()}t.WriteObjectEnd()}},{key:"WriteRuntimeObject",value:function(e,n){var i=_(n,H);if(i)this.WriteRuntimeContainer(e,i);else{var r=_(n,it);if(r){var a,s="->";return r.isExternal?s="x()":r.pushesToStack&&(r.stackPushType==Q.Function?s="f()":r.stackPushType==Q.Tunnel&&(s="->t->")),a=r.hasVariableTarget?r.variableDivertName:r.targetPathString,e.WriteObjectStart(),e.WriteProperty(s,a),r.hasVariableTarget&&e.WriteProperty("var",!0),r.isConditional&&e.WriteProperty("c",!0),0<r.externalArgs&&e.WriteIntProperty("exArgs",r.externalArgs),void e.WriteObjectEnd()}var o=_(n,rt);if(o)return e.WriteObjectStart(),e.WriteProperty("*",o.pathStringOnChoice),e.WriteIntProperty("flg",o.flags),void e.WriteObjectEnd();var u=_(n,G);if(u)e.WriteInt(u.value);else{var l=_(n,B);if(l)e.WriteFloat(l.value);else{var h=_(n,M);if(h)h.isNewline?e.Write("\n",!1):(e.WriteStringStart(),e.WriteStringInner("^"),e.WriteStringInner(h.value),e.WriteStringEnd());else{var c=_(n,K);if(c)this.WriteInkList(e,c);else{var f=_(n,J);if(f)return e.WriteObjectStart(),null===f.value?N("divTargetVal.value"):(e.WriteProperty("^->",f.value.componentsString),void e.WriteObjectEnd());var v=_(n,q);if(v)return e.WriteObjectStart(),e.WriteProperty("^var",v.value),e.WriteIntProperty("ci",v.contextIndex),void e.WriteObjectEnd();if(_(n,tt))e.Write("<>");else{var d=_(n,et);if(d)e.Write(t._controlCommandNames[d.commandType]);else{var p=_(n,ut);if(p){var y=p.name;return"^"==y&&(y="L^"),void e.Write(y)}var m=_(n,at);if(m){e.WriteObjectStart();var g=m.pathStringForCount;return null!=g?e.WriteProperty("CNT?",g):e.WriteProperty("VAR?",m.name),void e.WriteObjectEnd()}var S=_(n,st);if(S){e.WriteObjectStart();var k=S.isGlobal?"VAR=":"temp=";return e.WriteProperty(k,S.variableName),S.isNewDeclaration||e.WriteProperty("re",!0),void e.WriteObjectEnd()}if(_(n,ot))e.Write("void");else{var C=_(n,lt);if(C)return e.WriteObjectStart(),e.WriteProperty("#",C.text),void e.WriteObjectEnd();var b=_(n,ht);if(!b)throw new Error("Failed to convert runtime object to Json token: "+n);this.WriteChoice(e,b)}}}}}}}}}},{key:"JObjectToDictionaryRuntimeObjs",value:function(t){var e=new Map;for(var n in t)if(t.hasOwnProperty(n)){var i=this.JTokenToRuntimeObject(t[n]);if(null===i)return N("inkObject");e.set(n,i)}return e}},{key:"JObjectToIntDictionary",value:function(t){var e=new Map;for(var n in t)t.hasOwnProperty(n)&&e.set(n,parseInt(t[n]));return e}},{key:"JTokenToRuntimeObject",value:function(n){if("number"==typeof n&&!isNaN(n))return D.Create(n);if("string"==typeof n){var i=n.toString(),r=i[0];if("^"==r)return new M(i.substring(1));if("\n"==r&&1==i.length)return new M("\n");if("<>"==i)return new tt;for(var a=0;a<t._controlCommandNames.length;++a)if(i==t._controlCommandNames[a])return new et(a);if("L^"==i&&(i="^"),ut.CallExistsWithName(i))return ut.CallWithName(i);if("->->"==i)return et.PopTunnel();if("~ret"==i)return et.PopFunction();if("void"==i)return new ot}if("object"===e(n)&&!Array.isArray(n)){var s,o=n;if(o["^->"])return s=o["^->"],new J(new C(s.toString()));if(o["^var"]){s=o["^var"];var u=new q(s.toString());return"ci"in o&&(s=o.ci,u.contextIndex=parseInt(s)),u}var l=!1,h=!1,c=Q.Function,f=!1;if((s=o["->"])?l=!0:(s=o["f()"])?(h=l=!0,c=Q.Function):(s=o["->t->"])?(h=l=!0,c=Q.Tunnel):(s=o["x()"])&&(h=!(f=l=!0),c=Q.Function),l){var v=new it;v.pushesToStack=h,v.stackPushType=c,v.isExternal=f;var d=s.toString();return(s=o.var)?v.variableDivertName=d:v.targetPathString=d,v.isConditional=!!o.c,f&&(s=o.exArgs)&&(v.externalArgs=parseInt(s)),v}if(s=o["*"]){var p=new rt;return p.pathStringOnChoice=s.toString(),(s=o.flg)&&(p.flags=parseInt(s)),p}if(s=o["VAR?"])return new at(s.toString());if(s=o["CNT?"]){var y=new at;return y.pathStringForCount=s.toString(),y}var m=!1,g=!1;if((s=o["VAR="])?g=m=!0:(s=o["temp="])&&(g=!(m=!0)),m){var S=s.toString(),k=!o.re,b=new st(S,k);return b.isGlobal=g,b}if(void 0!==o["#"])return s=o["#"],new lt(s.toString());if(s=o.list){var _,T,w,P=s,O=new W;for(var E in(s=o.origins)&&O.SetInitialOriginNames(s),P)P.hasOwnProperty(E)&&(_=P[E],T=new I(E),w=parseInt(_),O.Add(T,w));return new K(O)}if(null!=o.originalChoicePath)return this.JObjectToChoice(o)}if(Array.isArray(n))return this.JArrayToContainer(n);if(null==n)return null;throw new Error("Failed to convert token to runtime object: "+JSON.stringify(n))}},{key:"WriteRuntimeContainer",value:function(t,e,n){var i=2<arguments.length&&void 0!==n&&n;if(t.WriteArrayStart(),null===e)return N("container");var r,a=y(e.content);try{for(a.s();!(r=a.n()).done;){var s=r.value;this.WriteRuntimeObject(t,s)}}catch(t){a.e(t)}finally{a.f()}var o=e.namedOnlyContent,u=e.countFlags,l=null!=e.name&&!i,h=null!=o||0<u||l;if(h&&t.WriteObjectStart(),null!=o){var c,f=y(o);try{for(f.s();!(c=f.n()).done;){var d=v(c.value,2),p=d[0],m=_(d[1],H);t.WritePropertyStart(p),this.WriteRuntimeContainer(t,m,!0),t.WritePropertyEnd()}}catch(t){f.e(t)}finally{f.f()}}l&&t.WriteProperty("#n",e.name),h?t.WriteObjectEnd():t.WriteNull(),t.WriteArrayEnd()}},{key:"JArrayToContainer",value:function(t){var e=new H;e.content=this.JArrayToRuntimeObjList(t,!0);var n=t[t.length-1];if(null!=n){var i,r,a=new Map;for(var s in n)"#f"==s?e.countFlags=parseInt(n[s]):"#n"==s?e.name=n[s].toString():((r=_(i=this.JTokenToRuntimeObject(n[s]),H))&&(r.name=s),a.set(s,i));e.namedOnlyContent=a}return e}},{key:"JObjectToChoice",value:function(t){var e=new ht;return e.text=t.text.toString(),e.index=parseInt(t.index),e.sourcePath=t.originalChoicePath.toString(),e.originalThreadIndex=parseInt(t.originalThreadIndex),e.pathStringOnChoice=t.targetPath.toString(),e}},{key:"WriteChoice",value:function(t,e){t.WriteObjectStart(),t.WriteProperty("text",e.text),t.WriteIntProperty("index",e.index),t.WriteProperty("originalChoicePath",e.sourcePath),t.WriteIntProperty("originalThreadIndex",e.originalThreadIndex),t.WriteProperty("targetPath",e.pathStringOnChoice),t.WriteObjectEnd()}},{key:"WriteInkList",value:function(t,e){var n=e.value;if(null===n)return N("rawList");t.WriteObjectStart(),t.WritePropertyStart("list"),t.WriteObjectStart();var i,r=y(n);try{for(r.s();!(i=r.n()).done;){var a=v(i.value,2),s=a[0],o=a[1],u=I.fromSerializedKey(s),l=o;if(null===u.itemName)return N("item.itemName");t.WritePropertyNameStart(),t.WritePropertyNameInner(u.originName?u.originName:"?"),t.WritePropertyNameInner("."),t.WritePropertyNameInner(u.itemName),t.WritePropertyNameEnd(),t.Write(l),t.WritePropertyEnd()}}catch(t){r.e(t)}finally{r.f()}if(t.WriteObjectEnd(),t.WritePropertyEnd(),0==n.Count&&null!=n.originNames&&0<n.originNames.length){t.WritePropertyStart("origins"),t.WriteArrayStart();var h,c=y(n.originNames);try{for(c.s();!(h=c.n()).done;){var f=h.value;t.Write(f)}}catch(t){c.e(t)}finally{c.f()}t.WriteArrayEnd(),t.WritePropertyEnd()}t.WriteObjectEnd()}},{key:"ListDefinitionsToJToken",value:function(t){var e,n={},i=y(t.lists);try{for(i.s();!(e=i.n()).done;){var r,a=e.value,s={},o=y(a.items);try{for(o.s();!(r=o.n()).done;){var u=v(r.value,2),l=u[0],h=u[1],c=I.fromSerializedKey(l);if(null===c.itemName)return N("item.itemName");s[c.itemName]=h}}catch(t){o.e(t)}finally{o.f()}n[a.name]=s}}catch(t){i.e(t)}finally{i.f()}return n}},{key:"JTokenToListDefinitions",value:function(t){var e=t,n=[];for(var i in e)if(e.hasOwnProperty(i)){var r,a=i.toString(),s=e[i],o=new Map;for(var u in s)e.hasOwnProperty(i)&&(r=s[u],o.set(u,parseInt(r)));var l=new ct(a,o);n.push(l)}return new ft(n)}}]),t}();vt._controlCommandNames=function(){var t=[];t[et.CommandType.EvalStart]="ev",t[et.CommandType.EvalOutput]="out",t[et.CommandType.EvalEnd]="/ev",t[et.CommandType.Duplicate]="du",t[et.CommandType.PopEvaluatedValue]="pop",t[et.CommandType.PopFunction]="~ret",t[et.CommandType.PopTunnel]="->->",t[et.CommandType.BeginString]="str",t[et.CommandType.EndString]="/str",t[et.CommandType.NoOp]="nop",t[et.CommandType.ChoiceCount]="choiceCnt",t[et.CommandType.Turns]="turn",t[et.CommandType.TurnsSince]="turns",t[et.CommandType.ReadCount]="readc",t[et.CommandType.Random]="rnd",t[et.CommandType.SeedRandom]="srnd",t[et.CommandType.VisitIndex]="visit",t[et.CommandType.SequenceShuffleIndex]="seq",t[et.CommandType.StartThread]="thread",t[et.CommandType.Done]="done",t[et.CommandType.End]="end",t[et.CommandType.ListFromInt]="listInt",t[et.CommandType.ListRange]="range",t[et.CommandType.ListRandom]="lrnd";for(var e=0;e<et.CommandType.TOTAL_VALUES;++e)if(null==t[e])throw new Error("Control command not accounted for in serialisation");return t}();var dt=function(){function e(){if(n(this,e),this._threadCounter=0,this._startOfRoot=nt.Null,arguments[0]instanceof t.Story){var i=arguments[0];this._startOfRoot=nt.StartOf(i.rootContentContainer),this.Reset()}else{var r=arguments[0];this._threads=[];var a,s=y(r._threads);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._threads.push(o.Copy())}}catch(i){s.e(i)}finally{s.f()}this._threadCounter=r._threadCounter,this._startOfRoot=r._startOfRoot}}return r(e,[{key:"Reset",value:function(){this._threads=[],this._threads.push(new e.Thread),this._threads[0].callstack.push(new e.Element(Q.Tunnel,this._startOfRoot))}},{key:"SetJsonToken",value:function(t,n){this._threads.length=0;var i,r=y(t.threads);try{for(r.s();!(i=r.n()).done;){var a=i.value,s=new e.Thread(a,n);this._threads.push(s)}}catch(t){r.e(t)}finally{r.f()}this._threadCounter=parseInt(t.threadCounter),this._startOfRoot=nt.StartOf(n.rootContentContainer)}},{key:"WriteJson",value:function(t){var e=this;t.WriteObject((function(t){t.WritePropertyStart("threads"),t.WriteArrayStart();var n,i=y(e._threads);try{for(i.s();!(n=i.n()).done;)n.value.WriteJson(t)}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd(),t.WritePropertyEnd(),t.WritePropertyStart("threadCounter"),t.WriteInt(e._threadCounter),t.WritePropertyEnd()}))}},{key:"PushThread",value:function(){var t=this.currentThread.Copy();this._threadCounter++,t.threadIndex=this._threadCounter,this._threads.push(t)}},{key:"ForkThread",value:function(){var t=this.currentThread.Copy();return this._threadCounter++,t.threadIndex=this._threadCounter,t}},{key:"PopThread",value:function(){if(!this.canPopThread)throw new Error("Can't pop thread");this._threads.splice(this._threads.indexOf(this.currentThread),1)}},{key:"Push",value:function(t,n,i){var r=1<arguments.length&&void 0!==n?n:0,a=2<arguments.length&&void 0!==i?i:0,s=new e.Element(t,this.currentElement.currentPointer,!1);s.evaluationStackHeightWhenPushed=r,s.functionStartInOutputStream=a,this.callStack.push(s)}},{key:"CanPop",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;return!!this.canPop&&(null==e||this.currentElement.type==e)}},{key:"Pop",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;if(!this.CanPop(e))throw new Error("Mismatched push/pop in Callstack");this.callStack.pop()}},{key:"GetTemporaryVariableWithName",value:function(t,e){var n=1<arguments.length&&void 0!==e?e:-1;-1==n&&(n=this.currentElementIndex+1);var i=V(this.callStack[n-1].temporaryVariables,t,null);return i.exists?i.result:null}},{key:"SetTemporaryVariable",value:function(t,e,n,i){var r=3<arguments.length&&void 0!==i?i:-1;-1==r&&(r=this.currentElementIndex+1);var a=this.callStack[r-1];if(!n&&!a.temporaryVariables.get(t))throw new F("Could not find temporary variable to set: "+t);var s=V(a.temporaryVariables,t,null);s.exists&&K.RetainListOriginsForAssignment(s.result,e),a.temporaryVariables.set(t,e)}},{key:"ContextForVariableNamed",value:function(t){return this.currentElement.temporaryVariables.get(t)?this.currentElementIndex+1:0}},{key:"ThreadWithIndex",value:function(t){var e=this._threads.filter((function(e){if(e.threadIndex==t)return e}));return 0<e.length?e[0]:null}},{key:"elements",get:function(){return this.callStack}},{key:"depth",get:function(){return this.elements.length}},{key:"currentElement",get:function(){var t=this._threads[this._threads.length-1].callstack;return t[t.length-1]}},{key:"currentElementIndex",get:function(){return this.callStack.length-1}},{key:"currentThread",get:function(){return this._threads[this._threads.length-1]},set:function(t){S.Assert(1==this._threads.length,"Shouldn't be directly setting the current thread when we have a stack of them"),this._threads.length=0,this._threads.push(t)}},{key:"canPop",get:function(){return 1<this.callStack.length}},{key:"canPopThread",get:function(){return 1<this._threads.length&&!this.elementIsEvaluateFromGame}},{key:"elementIsEvaluateFromGame",get:function(){return this.currentElement.type==Q.FunctionEvaluationFromGame}},{key:"callStack",get:function(){return this.currentThread.callstack}},{key:"callStackTrace",get:function(){for(var t=new x,e=0;e<this._threads.length;e++){var n=this._threads[e],i=e==this._threads.length-1;t.AppendFormat("=== THREAD {0}/{1} {2}===\n",e+1,this._threads.length,i?"(current) ":"");for(var r=0;r<n.callstack.length;r++){n.callstack[r].type==Q.Function?t.Append("  [FUNCTION] "):t.Append("  [TUNNEL] ");var a=n.callstack[r].currentPointer;if(!a.isNull){if(t.Append("<SOMEWHERE IN "),null===a.container)return N("pointer.container");t.Append(a.container.path.toString()),t.AppendLine(">")}}}return t.toString()}}]),e}();!function(t){var e=function(){function t(e,i){var r=2<arguments.length&&void 0!==arguments[2]&&arguments[2];n(this,t),this.evaluationStackHeightWhenPushed=0,this.functionStartInOutputStream=0,this.currentPointer=i.copy(),this.inExpressionEvaluation=r,this.temporaryVariables=new Map,this.type=e}return r(t,[{key:"Copy",value:function(){var e=new t(this.type,this.currentPointer,this.inExpressionEvaluation);return e.temporaryVariables=new Map(this.temporaryVariables),e.evaluationStackHeightWhenPushed=this.evaluationStackHeightWhenPushed,e.functionStartInOutputStream=this.functionStartInOutputStream,e}}]),t}();t.Element=e;var i=function(){function t(){if(n(this,t),this.threadIndex=0,this.previousPointer=nt.Null,this.callstack=[],arguments[0]&&arguments[1]){var i=arguments[0],r=arguments[1];this.threadIndex=parseInt(i.threadIndex);var a,s=y(i.callstack);try{for(s.s();!(a=s.n()).done;){var o=a.value,u=parseInt(o.type),l=nt.Null,h=void 0,c=o.cPath;if(void 0!==c){h=c.toString();var f=r.ContentAtPath(new C(h));if(l.container=f.container,l.index=parseInt(o.idx),null==f.obj)throw new Error("When loading state, internal story location couldn't be found: "+h+". Has the story changed since this save data was created?");if(f.approximate){if(null===l.container)return N("pointer.container");r.Warning("When loading state, exact internal story location couldn't be found: '"+h+"', so it was approximated to '"+l.container.path.toString()+"' to recover. Has the story changed since this save data was created?")}}var v=!!o.exp,d=new e(u,l,v),p=o.temp;void 0!==p?d.temporaryVariables=vt.JObjectToDictionaryRuntimeObjs(p):d.temporaryVariables.clear(),this.callstack.push(d)}}catch(i){s.e(i)}finally{s.f()}var m,g=i.previousContentObject;void 0!==g&&(m=new C(g.toString()),this.previousPointer=r.PointerAtPath(m))}}return r(t,[{key:"Copy",value:function(){var e=new t;e.threadIndex=this.threadIndex;var n,i=y(this.callstack);try{for(i.s();!(n=i.n()).done;){var r=n.value;e.callstack.push(r.Copy())}}catch(e){i.e(e)}finally{i.f()}return e.previousPointer=this.previousPointer.copy(),e}},{key:"WriteJson",value:function(t){t.WriteObjectStart(),t.WritePropertyStart("callstack"),t.WriteArrayStart();var e,n=y(this.callstack);try{for(n.s();!(e=n.n()).done;){var i=e.value;if(t.WriteObjectStart(),!i.currentPointer.isNull){if(null===i.currentPointer.container)return N("el.currentPointer.container");t.WriteProperty("cPath",i.currentPointer.container.path.componentsString),t.WriteIntProperty("idx",i.currentPointer.index)}t.WriteProperty("exp",i.inExpressionEvaluation),t.WriteIntProperty("type",i.type),0<i.temporaryVariables.size&&(t.WritePropertyStart("temp"),vt.WriteDictionaryRuntimeObjs(t,i.temporaryVariables),t.WritePropertyEnd()),t.WriteObjectEnd()}}catch(t){n.e(t)}finally{n.f()}if(t.WriteArrayEnd(),t.WritePropertyEnd(),t.WriteIntProperty("threadIndex",this.threadIndex),!this.previousPointer.isNull){var r=this.previousPointer.Resolve();if(null===r)return N("this.previousPointer.Resolve()");t.WriteProperty("previousContentObject",r.path.toString())}t.WriteObjectEnd()}}]),t}();t.Thread=i}(dt=dt||{});var pt=function(){function t(e,i){n(this,t),this.variableChangedEventCallbacks=[],this.patch=null,this._batchObservingVariableChanges=!1,this._defaultGlobalVariables=new Map,this._changedVariablesForBatchObs=new Set,this._globalVariables=new Map,this._callStack=e,this._listDefsOrigin=i;try{return new Proxy(this,{get:function(t,e){return e in t?t[e]:t.$(e)},set:function(t,e,n){return e in t?t[e]=n:t.$(e,n),!0}})}catch(e){}}return r(t,[{key:"variableChangedEvent",value:function(t,e){var n,i=y(this.variableChangedEventCallbacks);try{for(i.s();!(n=i.n()).done;)(0,n.value)(t,e)}catch(t){i.e(t)}finally{i.f()}}},{key:"$",value:function(t,e){if(void 0===e){var n=null;return null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists?n.result.valueObject:(void 0===(n=this._globalVariables.get(t))&&(n=this._defaultGlobalVariables.get(t)),void 0!==n?n.valueObject:null)}if(void 0===this._defaultGlobalVariables.get(t))throw new F("Cannot assign to a variable ("+t+") that hasn't been declared in the story");var i=D.Create(e);if(null==i)throw new F(null==e?"Cannot pass null to VariableState":"Invalid value passed to VariableState: "+e.toString());this.SetGlobal(t,i)}},{key:"ApplyPatch",value:function(){if(null===this.patch)return N("this.patch");var t,e=y(this.patch.globals);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,2),i=n[0],r=n[1];this._globalVariables.set(i,r)}}catch(t){e.e(t)}finally{e.f()}if(null!==this._changedVariablesForBatchObs){var a,s=y(this.patch.changedVariables);try{for(s.s();!(a=s.n()).done;){var o=a.value;this._changedVariablesForBatchObs.add(o)}}catch(t){s.e(t)}finally{s.f()}}this.patch=null}},{key:"SetJsonToken",value:function(t){this._globalVariables.clear();var e,n=y(this._defaultGlobalVariables);try{for(n.s();!(e=n.n()).done;){var i=v(e.value,2),r=i[0],a=i[1],s=t[r];if(void 0!==s){var o=vt.JTokenToRuntimeObject(s);if(null===o)return N("tokenInkObject");this._globalVariables.set(r,o)}else this._globalVariables.set(r,a)}}catch(t){n.e(t)}finally{n.f()}}},{key:"WriteJson",value:function(e){e.WriteObjectStart();var n,i=y(this._globalVariables);try{for(i.s();!(n=i.n()).done;){var r=v(n.value,2),a=r[0],s=r[1],o=a,u=s;if(t.dontSaveDefaultValues&&this._defaultGlobalVariables.has(o)){var l=this._defaultGlobalVariables.get(o);if(this.RuntimeObjectsEqual(u,l))continue}e.WritePropertyStart(o),vt.WriteRuntimeObject(e,u),e.WritePropertyEnd()}}catch(e){i.e(e)}finally{i.f()}e.WriteObjectEnd()}},{key:"RuntimeObjectsEqual",value:function(t,e){if(null===t)return N("obj1");if(null===e)return N("obj2");if(t.constructor!==e.constructor)return!1;var n=_(t,G);if(null!==n)return n.value===T(e,G).value;var i=_(t,B);if(null!==i)return i.value===T(e,B).value;var r=_(t,D),a=_(e,D);if(null!==r&&null!==a)return O(r.valueObject)&&O(a.valueObject)?r.valueObject.Equals(a.valueObject):r.valueObject===a.valueObject;throw new Error("FastRoughDefinitelyEquals: Unsupported runtime object type: "+t.constructor.name)}},{key:"GetVariableWithName",value:function(t,e){var n=1<arguments.length&&void 0!==e?e:-1,i=this.GetRawVariableWithName(t,n),r=_(i,q);return null!==r&&(i=this.ValueAtVariablePointer(r)),i}},{key:"TryGetDefaultVariableValue",value:function(t){var e=V(this._defaultGlobalVariables,t,null);return e.exists?e.result:null}},{key:"GlobalVariableExistsWithName",value:function(t){return this._globalVariables.has(t)||null!==this._defaultGlobalVariables&&this._defaultGlobalVariables.has(t)}},{key:"GetRawVariableWithName",value:function(t,e){if(0==e||-1==e){var n=null;if(null!==this.patch&&(n=this.patch.TryGetGlobal(t,null)).exists)return n.result;if((n=V(this._globalVariables,t,null)).exists)return n.result;if(null!==this._defaultGlobalVariables&&(n=V(this._defaultGlobalVariables,t,null)).exists)return n.result;if(null===this._listDefsOrigin)return N("VariablesState._listDefsOrigin");var i=this._listDefsOrigin.FindSingleItemListWithName(t);if(i)return i}return this._callStack.GetTemporaryVariableWithName(t,e)}},{key:"ValueAtVariablePointer",value:function(t){return this.GetVariableWithName(t.variableName,t.contextIndex)}},{key:"Assign",value:function(t,e){var n=t.variableName;if(null===n)return N("name");var i=-1,r=!1;if(r=t.isNewDeclaration?t.isGlobal:this.GlobalVariableExistsWithName(n),t.isNewDeclaration){var a=_(e,q);null!==a&&(e=this.ResolveVariablePointer(a))}else for(var s=null;null!=(s=_(this.GetRawVariableWithName(n,i),q))&&(n=s.variableName,r=0==(i=s.contextIndex)),null!=s;);r?this.SetGlobal(n,e):this._callStack.SetTemporaryVariable(n,e,t.isNewDeclaration,i)}},{key:"SnapshotDefaultGlobals",value:function(){this._defaultGlobalVariables=new Map(this._globalVariables)}},{key:"RetainListOriginsForAssignment",value:function(t,e){var n=T(t,K),i=T(e,K);n.value&&i.value&&0==i.value.Count&&i.value.SetInitialOriginNames(n.value.originNames)}},{key:"SetGlobal",value:function(t,e){var n=null;if(null===this.patch&&(n=V(this._globalVariables,t,null)),null!==this.patch&&((n=this.patch.TryGetGlobal(t,null)).exists||(n=V(this._globalVariables,t,null))),K.RetainListOriginsForAssignment(n.result,e),null===t)return N("variableName");if(null!==this.patch?this.patch.SetGlobal(t,e):this._globalVariables.set(t,e),null!==this.variableChangedEvent&&null!==n&&e!==n.result)if(this.batchObservingVariableChanges){if(null===this._changedVariablesForBatchObs)return N("this._changedVariablesForBatchObs");null!==this.patch?this.patch.AddChangedVariable(t):null!==this._changedVariablesForBatchObs&&this._changedVariablesForBatchObs.add(t)}else this.variableChangedEvent(t,e)}},{key:"ResolveVariablePointer",value:function(t){var e=t.contextIndex;-1==e&&(e=this.GetContextIndexOfVariableNamed(t.variableName));var n=_(this.GetRawVariableWithName(t.variableName,e),q);return null!=n?n:new q(t.variableName,e)}},{key:"GetContextIndexOfVariableNamed",value:function(t){return this.GlobalVariableExistsWithName(t)?0:this._callStack.currentElementIndex}},{key:"ObserveVariableChange",value:function(t){this.variableChangedEventCallbacks.push(t)}},{key:"batchObservingVariableChanges",get:function(){return this._batchObservingVariableChanges},set:function(t){if(this._batchObservingVariableChanges=t)this._changedVariablesForBatchObs=new Set;else if(null!=this._changedVariablesForBatchObs){var e,n=y(this._changedVariablesForBatchObs);try{for(n.s();!(e=n.n()).done;){var i=e.value,r=this._globalVariables.get(i);r?this.variableChangedEvent(i,r):N("currentValue")}}catch(t){n.e(t)}finally{n.f()}this._changedVariablesForBatchObs=null}}},{key:"callStack",get:function(){return this._callStack},set:function(t){this._callStack=t}}]),t}();pt.dontSaveDefaultValues=!0;var yt=function(){function t(e){n(this,t),this.seed=e%2147483647,this.seed<=0&&(this.seed+=2147483646)}return r(t,[{key:"next",value:function(){return this.seed=16807*this.seed%2147483647}},{key:"nextFloat",value:function(){return(this.next()-1)/2147483646}}]),t}(),mt=function(){function t(){var e;n(this,t),this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map,1===arguments.length&&null!==arguments[0]?(e=arguments[0],this._globals=new Map(e._globals),this._changedVariables=new Set(e._changedVariables),this._visitCounts=new Map(e._visitCounts),this._turnIndices=new Map(e._turnIndices)):(this._globals=new Map,this._changedVariables=new Set,this._visitCounts=new Map,this._turnIndices=new Map)}return r(t,[{key:"TryGetGlobal",value:function(t,e){return null!==t&&this._globals.has(t)?{result:this._globals.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetGlobal",value:function(t,e){this._globals.set(t,e)}},{key:"AddChangedVariable",value:function(t){return this._changedVariables.add(t)}},{key:"TryGetVisitCount",value:function(t,e){return this._visitCounts.has(t)?{result:this._visitCounts.get(t),exists:!0}:{result:e,exists:!1}}},{key:"SetVisitCount",value:function(t,e){this._visitCounts.set(t,e)}},{key:"SetTurnIndex",value:function(t,e){this._turnIndices.set(t,e)}},{key:"TryGetTurnIndex",value:function(t,e){return this._turnIndices.has(t)?{result:this._turnIndices.get(t),exists:!0}:{result:e,exists:!1}}},{key:"globals",get:function(){return this._globals}},{key:"changedVariables",get:function(){return this._changedVariables}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}}]),t}(),gt=function(){function t(){n(this,t)}return r(t,null,[{key:"TextToDictionary",value:function(e){return new t.Reader(e).ToDictionary()}},{key:"TextToArray",value:function(e){return new t.Reader(e).ToArray()}}]),t}();!function(t){var e=function(){function t(e){n(this,t),this._rootObject=JSON.parse(e)}return r(t,[{key:"ToDictionary",value:function(){return this._rootObject}},{key:"ToArray",value:function(){return this._rootObject}}]),t}();t.Reader=e;var i=function(){function e(){n(this,e),this._currentPropertyName=null,this._currentString=null,this._stateStack=[],this._collectionStack=[],this._propertyNameStack=[],this._jsonObject=null}return r(e,[{key:"WriteObject",value:function(t){this.WriteObjectStart(),t(this),this.WriteObjectEnd()}},{key:"WriteObjectStart",value:function(){this.StartNewObject(!0);var e,n={};this.state===t.Writer.State.Property?(this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName),e=this._propertyNameStack.pop(),this.currentCollection[e]=n):this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(n)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=n),this._collectionStack.push(n),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Object))}},{key:"WriteObjectEnd",value:function(){this.Assert(this.state===t.Writer.State.Object),this._collectionStack.pop(),this._stateStack.pop()}},{key:"WriteProperty",value:function(t,e){this.WritePropertyStart(t),e instanceof Function?e(this):this.Write(e),this.WritePropertyEnd()}},{key:"WriteIntProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteInt(e),this.WritePropertyEnd()}},{key:"WriteFloatProperty",value:function(t,e){this.WritePropertyStart(t),this.WriteFloat(e),this.WritePropertyEnd()}},{key:"WritePropertyStart",value:function(e){this.Assert(this.state===t.Writer.State.Object),this._propertyNameStack.push(e),this.IncrementChildCount(),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property))}},{key:"WritePropertyEnd",value:function(){this.Assert(this.state===t.Writer.State.Property),this.Assert(1===this.childCount),this._stateStack.pop()}},{key:"WritePropertyNameStart",value:function(){this.Assert(this.state===t.Writer.State.Object),this.IncrementChildCount(),this._currentPropertyName="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Property)),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.PropertyName))}},{key:"WritePropertyNameEnd",value:function(){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._propertyNameStack.push(this._currentPropertyName),this._currentPropertyName=null,this._stateStack.pop()}},{key:"WritePropertyNameInner",value:function(e){this.Assert(this.state===t.Writer.State.PropertyName),this.Assert(null!==this._currentPropertyName),this._currentPropertyName+=e}},{key:"WriteArrayStart",value:function(){this.StartNewObject(!0);var e,n=[];this.state===t.Writer.State.Property?(this.Assert(null!==this.currentCollection),this.Assert(null!==this.currentPropertyName),e=this._propertyNameStack.pop(),this.currentCollection[e]=n):this.state===t.Writer.State.Array?(this.Assert(null!==this.currentCollection),this.currentCollection.push(n)):(this.Assert(this.state===t.Writer.State.None),this._jsonObject=n),this._collectionStack.push(n),this._stateStack.push(new t.Writer.StateElement(t.Writer.State.Array))}},{key:"WriteArrayEnd",value:function(){this.Assert(this.state===t.Writer.State.Array),this._collectionStack.pop(),this._stateStack.pop()}},{key:"Write",value:function(t){null!==t?(this.StartNewObject(!1),this._addToCurrentObject(t)):console.error("Warning: trying to write a null string")}},{key:"WriteInt",value:function(t){null!==t&&(this.StartNewObject(!1),this._addToCurrentObject(Math.floor(t)))}},{key:"WriteFloat",value:function(t){null!==t&&(this.StartNewObject(!1),t==Number.POSITIVE_INFINITY?this._addToCurrentObject(34e37):t==Number.NEGATIVE_INFINITY?this._addToCurrentObject(-34e37):isNaN(t)?this._addToCurrentObject(0):this._addToCurrentObject(t))}},{key:"WriteNull",value:function(){this.StartNewObject(!1),this._addToCurrentObject(null)}},{key:"WriteStringStart",value:function(){this.StartNewObject(!1),this._currentString="",this._stateStack.push(new t.Writer.StateElement(t.Writer.State.String))}},{key:"WriteStringEnd",value:function(){this.Assert(this.state==t.Writer.State.String),this._stateStack.pop(),this._addToCurrentObject(this._currentString),this._currentString=null}},{key:"WriteStringInner",value:function(e){this.Assert(this.state===t.Writer.State.String),null!==e?this._currentString+=e:console.error("Warning: trying to write a null string")}},{key:"ToString",value:function(){return null===this._jsonObject?"":JSON.stringify(this._jsonObject)}},{key:"StartNewObject",value:function(e){e?this.Assert(this.state===t.Writer.State.None||this.state===t.Writer.State.Property||this.state===t.Writer.State.Array):this.Assert(this.state===t.Writer.State.Property||this.state===t.Writer.State.Array),this.state===t.Writer.State.Property&&this.Assert(0===this.childCount),this.state!==t.Writer.State.Array&&this.state!==t.Writer.State.Property||this.IncrementChildCount()}},{key:"IncrementChildCount",value:function(){this.Assert(0<this._stateStack.length);var t=this._stateStack.pop();t.childCount++,this._stateStack.push(t)}},{key:"Assert",value:function(t){if(!t)throw Error("Assert failed while writing JSON")}},{key:"_addToCurrentObject",value:function(e){this.Assert(null!==this.currentCollection),this.state===t.Writer.State.Array?(this.Assert(Array.isArray(this.currentCollection)),this.currentCollection.push(e)):this.state===t.Writer.State.Property&&(this.Assert(!Array.isArray(this.currentCollection)),this.Assert(null!==this.currentPropertyName),this.currentCollection[this.currentPropertyName]=e,this._propertyNameStack.pop())}},{key:"state",get:function(){return 0<this._stateStack.length?this._stateStack[this._stateStack.length-1].type:t.Writer.State.None}},{key:"childCount",get:function(){return 0<this._stateStack.length?this._stateStack[this._stateStack.length-1].childCount:0}},{key:"currentCollection",get:function(){return 0<this._collectionStack.length?this._collectionStack[this._collectionStack.length-1]:null}},{key:"currentPropertyName",get:function(){return 0<this._propertyNameStack.length?this._propertyNameStack[this._propertyNameStack.length-1]:null}}]),e}();t.Writer=i,function(e){var i;(i=e.State||(e.State={}))[i.None=0]="None",i[i.Object=1]="Object",i[i.Array=2]="Array",i[i.Property=3]="Property",i[i.PropertyName=4]="PropertyName",i[i.String=5]="String",e.StateElement=function e(i){n(this,e),this.type=t.Writer.State.None,this.childCount=0,this.type=i}}(i=t.Writer||(t.Writer={}))}(gt=gt||{});var St,kt,Ct=function(){function e(t){n(this,e),this.kInkSaveStateVersion=8,this.kMinCompatibleLoadVersion=8,this._currentErrors=null,this._currentWarnings=null,this.divertedPointer=nt.Null,this._currentTurnIndex=0,this.storySeed=0,this.previousRandom=0,this.didSafeExit=!1,this._currentText=null,this._currentTags=null,this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0,this._patch=null,this.story=t,this._outputStream=[],this.OutputStreamDirty(),this._evaluationStack=[],this.callStack=new dt(t),this._variablesState=new pt(this.callStack,t.listDefinitions),this._visitCounts=new Map,this._turnIndices=new Map,this.currentTurnIndex=-1;var i=(new Date).getTime();this.storySeed=new yt(i).next()%100,this.previousRandom=0,this._currentChoices=[],this.GoToStart()}return r(e,[{key:"ToJson",value:function(){var t=new gt.Writer;return this.WriteJson(t),t.ToString()}},{key:"toJson",value:function(t){var e=0<arguments.length&&void 0!==t&&t;return this.ToJson(e)}},{key:"LoadJson",value:function(t){var e=gt.TextToDictionary(t);this.LoadJsonObj(e)}},{key:"VisitCountAtPathString",value:function(t){var e;if(null!==this._patch){var n=this.story.ContentAtPath(new C(t)).container;if(null===n)throw new Error("Content at path not found: "+t);if((e=this._patch.TryGetVisitCount(n,0)).exists)return e.result}return(e=V(this._visitCounts,t,null)).exists?e.result:0}},{key:"VisitCountForContainer",value:function(t){if(null===t)return N("container");if(!t.visitsShouldBeCounted)return this.story.Error("Read count for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),0;if(null!==this._patch){var e=this._patch.TryGetVisitCount(t,0);if(e.exists)return e.result}var n=t.path.toString(),i=V(this._visitCounts,n,null);return i.exists?i.result:0}},{key:"IncrementVisitCountForContainer",value:function(t){if(null!==this._patch){var e=this.VisitCountForContainer(t);return e++,void this._patch.SetVisitCount(t,e)}var n=t.path.toString(),i=V(this._visitCounts,n,null);i.exists?this._visitCounts.set(n,i.result+1):this._visitCounts.set(n,1)}},{key:"RecordTurnIndexVisitToContainer",value:function(t){var e;null===this._patch?(e=t.path.toString(),this._turnIndices.set(e,this.currentTurnIndex)):this._patch.SetTurnIndex(t,this.currentTurnIndex)}},{key:"TurnsSinceForContainer",value:function(t){if(t.turnIndexShouldBeCounted||this.story.Error("TURNS_SINCE() for target ("+t.name+" - on "+t.debugMetadata+") unknown. The story may need to be compiled with countAllVisits flag (-c)."),null!==this._patch){var e=this._patch.TryGetTurnIndex(t,0);if(e.exists)return this.currentTurnIndex-e.result}var n=t.path.toString(),i=V(this._turnIndices,n,0);return i.exists?this.currentTurnIndex-i.result:-1}},{key:"CleanOutputWhitespace",value:function(t){for(var e=new x,n=-1,i=0,r=0;r<t.length;r++){var a=t.charAt(r),s=" "==a||"\t"==a;s&&-1==n&&(n=r),s||("\n"!=a&&0<n&&n!=i&&e.Append(" "),n=-1),"\n"==a&&(i=r+1),s||e.Append(a)}return e.toString()}},{key:"GoToStart",value:function(){this.callStack.currentElement.currentPointer=nt.StartOf(this.story.mainContentContainer)}},{key:"CopyAndStartPatching",value:function(){var t=new e(this.story);return t._patch=new mt(this._patch),t.outputStream.push.apply(t.outputStream,this._outputStream),t.OutputStreamDirty(),t._currentChoices.push.apply(t._currentChoices,this._currentChoices),this.hasError&&(t._currentErrors=[],t._currentErrors.push.apply(t._currentErrors,this.currentErrors||[])),this.hasWarning&&(t._currentWarnings=[],t._currentWarnings.push.apply(t._currentWarnings,this.currentWarnings||[])),t.callStack=new dt(this.callStack),t.variablesState=this.variablesState,t.variablesState.callStack=t.callStack,t.variablesState.patch=t._patch,t.evaluationStack.push.apply(t.evaluationStack,this.evaluationStack),this.divertedPointer.isNull||(t.divertedPointer=this.divertedPointer.copy()),t.previousPointer=this.previousPointer.copy(),t._visitCounts=this._visitCounts,t._turnIndices=this._turnIndices,t.currentTurnIndex=this.currentTurnIndex,t.storySeed=this.storySeed,t.previousRandom=this.previousRandom,t.didSafeExit=this.didSafeExit,t}},{key:"RestoreAfterPatch",value:function(){this.variablesState.callStack=this.callStack,this.variablesState.patch=this._patch}},{key:"ApplyAnyPatch",value:function(){if(null!==this._patch){this.variablesState.ApplyPatch();var t,e=y(this._patch.visitCounts);try{for(e.s();!(t=e.n()).done;){var n=v(t.value,2),i=n[0],r=n[1];this.ApplyCountChanges(i,r,!0)}}catch(t){e.e(t)}finally{e.f()}var a,s=y(this._patch.turnIndices);try{for(s.s();!(a=s.n()).done;){var o=v(a.value,2),u=o[0],l=o[1];this.ApplyCountChanges(u,l,!1)}}catch(t){s.e(t)}finally{s.f()}this._patch=null}}},{key:"ApplyCountChanges",value:function(t,e,n){(n?this._visitCounts:this._turnIndices).set(t.path.toString(),e)}},{key:"WriteJson",value:function(e){var n=this;e.WriteObjectStart();var i,r=!1,a=y(this._currentChoices);try{for(a.s();!(i=a.n()).done;){var s=i.value;if(null===s.threadAtGeneration)return N("c.threadAtGeneration");s.originalThreadIndex=s.threadAtGeneration.threadIndex,null===this.callStack.ThreadWithIndex(s.originalThreadIndex)&&(r||(r=!0,e.WritePropertyStart("choiceThreads"),e.WriteObjectStart()),e.WritePropertyStart(s.originalThreadIndex),s.threadAtGeneration.WriteJson(e),e.WritePropertyEnd())}}catch(e){a.e(e)}finally{a.f()}if(r&&(e.WriteObjectEnd(),e.WritePropertyEnd()),e.WriteProperty("callstackThreads",(function(t){return n.callStack.WriteJson(t)})),e.WriteProperty("variablesState",(function(t){return n.variablesState.WriteJson(t)})),e.WriteProperty("evalStack",(function(t){return vt.WriteListRuntimeObjs(t,n.evaluationStack)})),e.WriteProperty("outputStream",(function(t){return vt.WriteListRuntimeObjs(t,n._outputStream)})),e.WriteProperty("currentChoices",(function(t){t.WriteArrayStart();var e,i=y(n._currentChoices);try{for(i.s();!(e=i.n()).done;){var r=e.value;vt.WriteChoice(t,r)}}catch(t){i.e(t)}finally{i.f()}t.WriteArrayEnd()})),!this.divertedPointer.isNull){if(null===this.divertedPointer.path)return N("divertedPointer");e.WriteProperty("currentDivertTarget",this.divertedPointer.path.componentsString)}e.WriteProperty("visitCounts",(function(t){return vt.WriteIntDictionary(t,n._visitCounts)})),e.WriteProperty("turnIndices",(function(t){return vt.WriteIntDictionary(t,n._turnIndices)})),e.WriteIntProperty("turnIdx",this.currentTurnIndex),e.WriteIntProperty("storySeed",this.storySeed),e.WriteIntProperty("previousRandom",this.previousRandom),e.WriteIntProperty("inkSaveVersion",this.kInkSaveStateVersion),e.WriteIntProperty("inkFormatVersion",t.Story.inkVersionCurrent),e.WriteObjectEnd()}},{key:"LoadJsonObj",value:function(t){var e=t,n=e.inkSaveVersion;if(null==n)throw new F("ink save format incorrect, can't load.");if(parseInt(n)<this.kMinCompatibleLoadVersion)throw new F("Ink save format isn't compatible with the current version (saw '"+n+"', but minimum is "+this.kMinCompatibleLoadVersion+"), so can't load.");this.callStack.SetJsonToken(e.callstackThreads,this.story),this.variablesState.SetJsonToken(e.variablesState),this._evaluationStack=vt.JArrayToRuntimeObjList(e.evalStack),this._outputStream=vt.JArrayToRuntimeObjList(e.outputStream),this.OutputStreamDirty(),this._currentChoices=vt.JArrayToRuntimeObjList(e.currentChoices);var i,r=e.currentDivertTarget;null!=r&&(i=new C(r.toString()),this.divertedPointer=this.story.PointerAtPath(i)),this._visitCounts=vt.JObjectToIntDictionary(e.visitCounts),this._turnIndices=vt.JObjectToIntDictionary(e.turnIndices),this.currentTurnIndex=parseInt(e.turnIdx),this.storySeed=parseInt(e.storySeed),this.previousRandom=parseInt(e.previousRandom);var a,s=e.choiceThreads,o=y(this._currentChoices);try{for(o.s();!(a=o.n()).done;){var u,l=a.value,h=this.callStack.ThreadWithIndex(l.originalThreadIndex);null!=h?l.threadAtGeneration=h.Copy():(u=s[l.originalThreadIndex.toString()],l.threadAtGeneration=new dt.Thread(u,this.story))}}catch(t){o.e(t)}finally{o.f()}}},{key:"ResetErrors",value:function(){this._currentErrors=null,this._currentWarnings=null}},{key:"ResetOutput",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;this._outputStream.length=0,null!==e&&this._outputStream.push.apply(this._outputStream,e),this.OutputStreamDirty()}},{key:"PushToOutputStream",value:function(t){var e=_(t,M);if(null!==e){var n=this.TrySplittingHeadTailWhitespace(e);if(null!==n){var i,r=y(n);try{for(r.s();!(i=r.n()).done;){var a=i.value;this.PushToOutputStreamIndividual(a)}}catch(t){r.e(t)}finally{r.f()}return void this.OutputStreamDirty()}}this.PushToOutputStreamIndividual(t),this.OutputStreamDirty()}},{key:"PopFromOutputStream",value:function(t){this.outputStream.splice(this.outputStream.length-t,t),this.OutputStreamDirty()}},{key:"TrySplittingHeadTailWhitespace",value:function(t){var e=t.value;if(null===e)return N("single.value");for(var n=-1,i=-1,r=0;r<e.length;++r){var a=e[r];if("\n"!=a){if(" "==a||"\t"==a)continue;break}-1==n&&(n=r),i=r}for(var s=-1,o=-1,u=0;u<e.length;++u){var l=e[u];if("\n"!=l){if(" "==l||"\t"==l)continue;break}-1==s&&(s=u),o=u}if(-1==n&&-1==s)return null;var h,c,f,v,d=[],p=0,y=e.length;return-1!=n&&(0<n&&(h=new M(e.substring(0,n)),d.push(h)),d.push(new M("\n")),p=i+1),-1!=s&&(y=o),p<y&&(c=e.substring(p,y-p),d.push(new M(c))),-1!=s&&i<o&&(d.push(new M("\n")),s<e.length-1&&(f=e.length-s-1,v=new M(e.substring(s+1,f)),d.push(v))),d}},{key:"PushToOutputStreamIndividual",value:function(t){var e=_(t,tt),n=_(t,M),i=!0;if(e)this.TrimNewlinesFromOutputStream(),i=!0;else if(n){var r=-1,a=this.callStack.currentElement;a.type==Q.Function&&(r=a.functionStartInOutputStream);for(var s=-1,o=this._outputStream.length-1;0<=o;o--){var u=this._outputStream[o],l=u instanceof et?u:null;if(null!=(u instanceof tt?u:null)){s=o;break}if(null!=l&&l.commandType==et.CommandType.BeginString){r<=o&&(r=-1);break}}if(-1!=(-1!=s&&-1!=r?Math.min(r,s):-1!=s?s:r)){if(n.isNewline)i=!1;else if(n.isNonWhitespace&&(-1<s&&this.RemoveExistingGlue(),-1<r))for(var h=this.callStack.elements,c=h.length-1;0<=c;c--){var f=h[c];if(f.type!=Q.Function)break;f.functionStartInOutputStream=-1}}else n.isNewline&&(!this.outputStreamEndsInNewline&&this.outputStreamContainsContent||(i=!1))}if(i){if(null===t)return N("obj");this._outputStream.push(t),this.OutputStreamDirty()}}},{key:"TrimNewlinesFromOutputStream",value:function(){for(var t=-1,e=this._outputStream.length-1;0<=e;){var n=this._outputStream[e],i=_(n,et),r=_(n,M);if(null!=i||null!=r&&r.isNonWhitespace)break;null!=r&&r.isNewline&&(t=e),e--}if(0<=t)for(e=t;e<this._outputStream.length;)_(this._outputStream[e],M)?this._outputStream.splice(e,1):e++;this.OutputStreamDirty()}},{key:"RemoveExistingGlue",value:function(){for(var t=this._outputStream.length-1;0<=t;t--){var e=this._outputStream[t];if(e instanceof tt)this._outputStream.splice(t,1);else if(e instanceof et)break}this.OutputStreamDirty()}},{key:"PushEvaluationStack",value:function(t){var e=_(t,K);if(e){var n=e.value;if(null===n)return N("rawList");if(null!=n.originNames){n.origins||(n.origins=[]),n.origins.length=0;var i,r=y(n.originNames);try{for(r.s();!(i=r.n()).done;){var a=i.value;if(null===this.story.listDefinitions)return N("StoryState.story.listDefinitions");var s=this.story.listDefinitions.TryListGetDefinition(a,null);if(null===s.result)return N("StoryState def.result");n.origins.indexOf(s.result)<0&&n.origins.push(s.result)}}catch(t){r.e(t)}finally{r.f()}}}if(null===t)return N("obj");this.evaluationStack.push(t)}},{key:"PopEvaluationStack",value:function(t){if(void 0===t)return P(this.evaluationStack.pop());if(t>this.evaluationStack.length)throw new Error("trying to pop too many objects");return P(this.evaluationStack.splice(this.evaluationStack.length-t,t))}},{key:"PeekEvaluationStack",value:function(){return this.evaluationStack[this.evaluationStack.length-1]}},{key:"ForceEnd",value:function(){this.callStack.Reset(),this._currentChoices.length=0,this.currentPointer=nt.Null,this.previousPointer=nt.Null,this.didSafeExit=!0}},{key:"TrimWhitespaceFromFunctionEnd",value:function(){S.Assert(this.callStack.currentElement.type==Q.Function);var t=this.callStack.currentElement.functionStartInOutputStream;-1==t&&(t=0);for(var e=this._outputStream.length-1;t<=e;e--){var n=this._outputStream[e],i=_(n,M),r=_(n,et);if(null!=i){if(r)break;if(!i.isNewline&&!i.isInlineWhitespace)break;this._outputStream.splice(e,1),this.OutputStreamDirty()}}}},{key:"PopCallStack",value:function(t){var e=0<arguments.length&&void 0!==t?t:null;this.callStack.currentElement.type==Q.Function&&this.TrimWhitespaceFromFunctionEnd(),this.callStack.Pop(e)}},{key:"SetChosenPath",value:function(t,e){this._currentChoices.length=0;var n=this.story.PointerAtPath(t);n.isNull||-1!=n.index||(n.index=0),this.currentPointer=n,e&&this.currentTurnIndex++}},{key:"StartFunctionEvaluationFromGame",value:function(t,e){this.callStack.Push(Q.FunctionEvaluationFromGame,this.evaluationStack.length),this.callStack.currentElement.currentPointer=nt.StartOf(t),this.PassArgumentsToEvaluationStack(e)}},{key:"PassArgumentsToEvaluationStack",value:function(t){if(null!=t)for(var e=0;e<t.length;e++){if("number"!=typeof t[e]&&"string"!=typeof t[e])throw new Error("ink arguments when calling EvaluateFunction / ChoosePathStringWithParameters  must be int, float or string");this.PushEvaluationStack(D.Create(t[e]))}}},{key:"TryExitFunctionEvaluationFromGame",value:function(){return this.callStack.currentElement.type==Q.FunctionEvaluationFromGame&&(this.currentPointer=nt.Null,this.didSafeExit=!0)}},{key:"CompleteFunctionEvaluationFromGame",value:function(){if(this.callStack.currentElement.type!=Q.FunctionEvaluationFromGame)throw new F("Expected external function evaluation to be complete. Stack trace: "+this.callStack.callStackTrace);for(var t=this.callStack.currentElement.evaluationStackHeightWhenPushed,e=null;this.evaluationStack.length>t;){var n=this.PopEvaluationStack();null===e&&(e=n)}if(this.PopCallStack(Q.FunctionEvaluationFromGame),e){if(e instanceof ot)return null;var i=T(e,D);return i.valueType==R.DivertTarget?i.valueObject.toString():i.valueObject}return null}},{key:"AddError",value:function(t,e){e?(null==this._currentWarnings&&(this._currentWarnings=[]),this._currentWarnings.push(t)):(null==this._currentErrors&&(this._currentErrors=[]),this._currentErrors.push(t))}},{key:"OutputStreamDirty",value:function(){this._outputStreamTextDirty=!0,this._outputStreamTagsDirty=!0}},{key:"callstackDepth",get:function(){return this.callStack.depth}},{key:"outputStream",get:function(){return this._outputStream}},{key:"currentChoices",get:function(){return this.canContinue?[]:this._currentChoices}},{key:"generatedChoices",get:function(){return this._currentChoices}},{key:"currentErrors",get:function(){return this._currentErrors}},{key:"currentWarnings",get:function(){return this._currentWarnings}},{key:"variablesState",get:function(){return this._variablesState},set:function(t){this._variablesState=t}},{key:"evaluationStack",get:function(){return this._evaluationStack}},{key:"visitCounts",get:function(){return this._visitCounts}},{key:"turnIndices",get:function(){return this._turnIndices}},{key:"currentTurnIndex",get:function(){return this._currentTurnIndex},set:function(t){this._currentTurnIndex=t}},{key:"currentPathString",get:function(){var t=this.currentPointer;return t.isNull?null:null===t.path?N("pointer.path"):t.path.toString()}},{key:"currentPointer",get:function(){return this.callStack.currentElement.currentPointer.copy()},set:function(t){this.callStack.currentElement.currentPointer=t.copy()}},{key:"previousPointer",get:function(){return this.callStack.currentThread.previousPointer.copy()},set:function(t){this.callStack.currentThread.previousPointer=t.copy()}},{key:"canContinue",get:function(){return!this.currentPointer.isNull&&!this.hasError}},{key:"hasError",get:function(){return null!=this.currentErrors&&0<this.currentErrors.length}},{key:"hasWarning",get:function(){return null!=this.currentWarnings&&0<this.currentWarnings.length}},{key:"currentText",get:function(){if(this._outputStreamTextDirty){var t,e=new x,n=y(this._outputStream);try{for(n.s();!(t=n.n()).done;){var i=_(t.value,M);null!==i&&e.Append(i.value)}}catch(t){n.e(t)}finally{n.f()}this._currentText=this.CleanOutputWhitespace(e.toString()),this._outputStreamTextDirty=!1}return this._currentText}},{key:"currentTags",get:function(){if(this._outputStreamTagsDirty){this._currentTags=[];var t,e=y(this._outputStream);try{for(e.s();!(t=e.n()).done;){var n=_(t.value,lt);null!==n&&this._currentTags.push(n.text)}}catch(t){e.e(t)}finally{e.f()}this._outputStreamTagsDirty=!1}return this._currentTags}},{key:"inExpressionEvaluation",get:function(){return this.callStack.currentElement.inExpressionEvaluation},set:function(t){this.callStack.currentElement.inExpressionEvaluation=t}},{key:"outputStreamEndsInNewline",get:function(){if(0<this._outputStream.length)for(var t=this._outputStream.length-1;0<=t&&!(this._outputStream[t]instanceof et);t--){var e=this._outputStream[t];if(e instanceof M){if(e.isNewline)return!0;if(e.isNonWhitespace)break}}return!1}},{key:"outputStreamContainsContent",get:function(){for(var t=0;t<this._outputStream.length;t++)if(this._outputStream[t]instanceof M)return!0;return!1}},{key:"inStringEvaluation",get:function(){for(var t=this._outputStream.length-1;0<=t;t--){var e=_(this._outputStream[t],et);if(e instanceof et&&e.commandType==et.CommandType.BeginString)return!0}return!1}}]),e}(),bt=function(){function t(){n(this,t),this.startTime=void 0}return r(t,[{key:"Start",value:function(){this.startTime=(new Date).getTime()}},{key:"Stop",value:function(){this.startTime=void 0}},{key:"ElapsedMilliseconds",get:function(){return void 0===this.startTime?0:(new Date).getTime()-this.startTime}}]),t}();Number.isInteger||(Number.isInteger=function(t){return"number"==typeof t&&isFinite(t)&&-9007199254740992<t&&t<9007199254740992&&Math.floor(t)===t}),t.Story=function(){a(i,A);var t=f(i);function i(){var e,r;n(this,i),(e=t.call(this)).inkVersionMinimumCompatible=18,e._prevContainers=[],e.allowExternalFunctionFallbacks=!1,e._listDefinitions=null,e._variableObservers=null,e._hasValidatedExternals=!1,e._temporaryEvaluationContainer=null,e._asyncContinueActive=!1,e._stateSnapshotAtLastNewline=null,e._recursiveContinueCount=0,e._asyncSaving=!1;var a,s=e._profiler=null,o=null;if(arguments[0]instanceof H?(r=arguments[0],void 0!==arguments[1]&&(s=arguments[1]),e._mainContentContainer=r):o="string"==typeof arguments[0]?(a=arguments[0],gt.TextToDictionary(a)):arguments[0],null!=s&&(e._listDefinitions=new ft(s)),e._externals=new Map,null!==o){var u=o,l=u.inkVersion;if(null==l)throw new Error("ink version number not found. Are you sure it's a valid .ink.json file?");var h=parseInt(l);if(i.inkVersionCurrent<h)throw new Error("Version of ink used to build story was newer than the current version of the engine");if(h<e.inkVersionMinimumCompatible)throw new Error("Version of ink used to build story is too old to be loaded by this version of the engine");h!=i.inkVersionCurrent&&console.warn("WARNING: Version of ink used to build story doesn't match current version of engine. Non-critical, but recommend synchronising.");var c,f=u.root;if(null==f)throw new Error("Root node for ink not found. Are you sure it's a valid .ink.json file?");(c=u.listDefs)&&(e._listDefinitions=vt.JTokenToListDefinitions(c)),e._mainContentContainer=T(vt.JTokenToRuntimeObject(f),H),e.ResetState()}return e}return r(i,[{key:"StartProfiling",value:function(){}},{key:"EndProfiling",value:function(){}},{key:"ToJson",value:function(t){var e=this,n=!1;if(t||(n=!0,t=new gt.Writer),t.WriteObjectStart(),t.WriteIntProperty("inkVersion",i.inkVersionCurrent),t.WriteProperty("root",(function(t){return vt.WriteRuntimeContainer(t,e._mainContentContainer)})),null!=this._listDefinitions){t.WritePropertyStart("listDefs"),t.WriteObjectStart();var r,a=y(this._listDefinitions.lists);try{for(a.s();!(r=a.n()).done;){var s=r.value;t.WritePropertyStart(s.name),t.WriteObjectStart();var o,u=y(s.items);try{for(u.s();!(o=u.n()).done;){var l=v(o.value,2),h=l[0],c=l[1],f=I.fromSerializedKey(h);t.WriteIntProperty(f.itemName,c)}}catch(t){u.e(t)}finally{u.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}}catch(t){a.e(t)}finally{a.f()}t.WriteObjectEnd(),t.WritePropertyEnd()}if(t.WriteObjectEnd(),n)return t.ToString()}},{key:"ResetState",value:function(){this.IfAsyncWeCant("ResetState"),this._state=new Ct(this),this._state.variablesState.ObserveVariableChange(this.VariableStateDidChangeEvent.bind(this)),this.ResetGlobals()}},{key:"ResetErrors",value:function(){if(null===this._state)return N("this._state");this._state.ResetErrors()}},{key:"ResetCallstack",value:function(){if(this.IfAsyncWeCant("ResetCallstack"),null===this._state)return N("this._state");this._state.ForceEnd()}},{key:"ResetGlobals",value:function(){var t;this._mainContentContainer.namedContent.get("global decl")&&(t=this.state.currentPointer.copy(),this.ChoosePath(new C("global decl"),!1),this.ContinueInternal(),this.state.currentPointer=t),this.state.variablesState.SnapshotDefaultGlobals()}},{key:"Continue",value:function(){return this.ContinueAsync(0),this.currentText}},{key:"ContinueAsync",value:function(t){this._hasValidatedExternals||this.ValidateExternalBindings(),this.ContinueInternal(t)}},{key:"ContinueInternal",value:function(t){var e=0<arguments.length&&void 0!==t?t:0;null!=this._profiler&&this._profiler.PreContinue();var n=0<e;if(this._recursiveContinueCount++,!this._asyncContinueActive){if(this._asyncContinueActive=n,!this.canContinue)throw new F("Can't continue - should check canContinue before calling Continue");this._state.didSafeExit=!1,this._state.ResetOutput(),1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!0)}var i=new bt;i.Start();var r=!1;do{try{r=this.ContinueSingleStep()}catch(t){if(!(t instanceof F))throw t;this.AddError(t.message,void 0,t.useEndLineNumber);break}if(r)break;if(this._asyncContinueActive&&i.ElapsedMilliseconds>e)break}while(this.canContinue);i.Stop(),!r&&this.canContinue||(null!==this._stateSnapshotAtLastNewline&&this.RestoreStateSnapshot(),this.canContinue||(this.state.callStack.canPopThread&&this.AddError("Thread available to pop, threads should always be flat by the end of evaluation?"),0!=this.state.generatedChoices.length||this.state.didSafeExit||null!=this._temporaryEvaluationContainer||(this.state.callStack.CanPop(Q.Tunnel)?this.AddError("unexpectedly reached end of content. Do you need a '->->' to return from a tunnel?"):this.state.callStack.CanPop(Q.Function)?this.AddError("unexpectedly reached end of content. Do you need a '~ return'?"):this.state.callStack.canPop?this.AddError("unexpectedly reached end of content for unknown reason. Please debug compiler!"):this.AddError("ran out of content. Do you need a '-> DONE' or '-> END'?"))),this.state.didSafeExit=!1,1==this._recursiveContinueCount&&(this._state.variablesState.batchObservingVariableChanges=!1),this._asyncContinueActive=!1),this._recursiveContinueCount--,null!=this._profiler&&this._profiler.PostContinue()}},{key:"ContinueSingleStep",value:function(){if(null!=this._profiler&&this._profiler.PreStep(),this.Step(),null!=this._profiler&&this._profiler.PostStep(),this.canContinue||this.state.callStack.elementIsEvaluateFromGame||this.TryFollowDefaultInvisibleChoice(),null!=this._profiler&&this._profiler.PreSnapshot(),!this.state.inStringEvaluation){if(null!==this._stateSnapshotAtLastNewline){if(null===this._stateSnapshotAtLastNewline.currentTags)return N("this._stateAtLastNewline.currentTags");if(null===this.state.currentTags)return N("this.state.currentTags");var t=this.CalculateNewlineOutputStateChange(this._stateSnapshotAtLastNewline.currentText,this.state.currentText,this._stateSnapshotAtLastNewline.currentTags.length,this.state.currentTags.length);if(t==i.OutputStateChange.ExtendedBeyondNewline)return this.RestoreStateSnapshot(),!0;t==i.OutputStateChange.NewlineRemoved&&this.DiscardSnapshot()}this.state.outputStreamEndsInNewline&&(this.canContinue?null==this._stateSnapshotAtLastNewline&&this.StateSnapshot():this.DiscardSnapshot())}return null!=this._profiler&&this._profiler.PostSnapshot(),!1}},{key:"CalculateNewlineOutputStateChange",value:function(t,e,n,r){if(null===t)return N("prevText");if(null===e)return N("currText");var a=e.length>=t.length&&"\n"==e.charAt(t.length-1);if(n==r&&t.length==e.length&&a)return i.OutputStateChange.NoChange;if(!a)return i.OutputStateChange.NewlineRemoved;if(n<r)return i.OutputStateChange.ExtendedBeyondNewline;for(var s=t.length;s<e.length;s++){var o=e.charAt(s);if(" "!=o&&"\t"!=o)return i.OutputStateChange.ExtendedBeyondNewline}return i.OutputStateChange.NoChange}},{key:"ContinueMaximally",value:function(){this.IfAsyncWeCant("ContinueMaximally");for(var t=new x;this.canContinue;)t.Append(this.Continue());return t.toString()}},{key:"ContentAtPath",value:function(t){return this.mainContentContainer.ContentAtPath(t)}},{key:"KnotContainerWithName",value:function(t){var e=this.mainContentContainer.namedContent.get(t);return e instanceof H?e:null}},{key:"PointerAtPath",value:function(t){if(0==t.length)return nt.Null;var e=new nt,n=t.length,i=null;return null===t.lastComponent?N("path.lastComponent"):(t.lastComponent.isIndex?(n=t.length-1,i=this.mainContentContainer.ContentAtPath(t,void 0,n),e.container=i.container,e.index=t.lastComponent.index):(i=this.mainContentContainer.ContentAtPath(t),e.container=i.container,e.index=-1),null==i.obj||i.obj==this.mainContentContainer&&0<n?this.Error("Failed to find content at path '"+t+"', and no approximation of it was possible."):i.approximate&&this.Warning("Failed to find content at path '"+t+"', so it was approximated to: '"+i.obj.path+"'."),e)}},{key:"StateSnapshot",value:function(){this._stateSnapshotAtLastNewline=this._state,this._state=this._state.CopyAndStartPatching()}},{key:"RestoreStateSnapshot",value:function(){null===this._stateSnapshotAtLastNewline&&N("_stateSnapshotAtLastNewline"),this._stateSnapshotAtLastNewline.RestoreAfterPatch(),this._state=this._stateSnapshotAtLastNewline,this._stateSnapshotAtLastNewline=null,this._asyncSaving||this._state.ApplyAnyPatch()}},{key:"DiscardSnapshot",value:function(){this._asyncSaving||this._state.ApplyAnyPatch(),this._stateSnapshotAtLastNewline=null}},{key:"CopyStateForBackgroundThreadSave",value:function(){if(this.IfAsyncWeCant("start saving on a background thread"),this._asyncSaving)throw new Error("Story is already in background saving mode, can't call CopyStateForBackgroundThreadSave again!");var t=this._state;return this._state=this._state.CopyAndStartPatching(),this._asyncSaving=!0,t}},{key:"BackgroundSaveComplete",value:function(){null===this._stateSnapshotAtLastNewline&&this._state.ApplyAnyPatch(),this._asyncSaving=!1}},{key:"Step",value:function(){var t=!0,e=this.state.currentPointer.copy();if(!e.isNull){for(var n=_(e.Resolve(),H);n&&(this.VisitContainer(n,!0),0!=n.content.length);)n=_((e=nt.StartOf(n)).Resolve(),H);this.state.currentPointer=e.copy(),null!=this._profiler&&this._profiler.Step(this.state.callStack);var i,r,a,s,o,u=e.Resolve(),l=this.PerformLogicAndFlowControl(u);this.state.currentPointer.isNull||(l&&(t=!1),(i=_(u,rt))&&((r=this.ProcessChoice(i))&&this.state.generatedChoices.push(r),u=null,t=!1),u instanceof H&&(t=!1),t&&((a=_(u,q))&&-1==a.contextIndex&&(s=this.state.callStack.ContextForVariableNamed(a.variableName),u=new q(a.variableName,s)),this.state.inExpressionEvaluation?this.state.PushEvaluationStack(u):this.state.PushToOutputStream(u)),this.NextContent(),(o=_(u,et))&&o.commandType==et.CommandType.StartThread&&this.state.callStack.PushThread())}}},{key:"VisitContainer",value:function(t,e){t.countingAtStartOnly&&!e||(t.visitsShouldBeCounted&&this.state.IncrementVisitCountForContainer(t),t.turnIndexShouldBeCounted&&this.state.RecordTurnIndexVisitToContainer(t))}},{key:"VisitChangedContainersDueToDivert",value:function(){var t=this.state.previousPointer.copy(),e=this.state.currentPointer.copy();if(!e.isNull&&-1!=e.index){if(this._prevContainers.length=0,!t.isNull)for(var n=_(t.Resolve(),H)||_(t.container,H);n;)this._prevContainers.push(n),n=_(n.parent,H);var i=e.Resolve();if(null!=i)for(var r=_(i.parent,H);r&&(this._prevContainers.indexOf(r)<0||r.countingAtStartOnly);){var a=0<r.content.length&&i==r.content[0];this.VisitContainer(r,a),r=_((i=r).parent,H)}}}},{key:"ProcessChoice",value:function(t){var e,n=!0;t.hasCondition&&(e=this.state.PopEvaluationStack(),this.IsTruthy(e)||(n=!1));var i="",r="";if(t.hasChoiceOnlyContent&&(r=T(this.state.PopEvaluationStack(),M).value||""),t.hasStartContent&&(i=T(this.state.PopEvaluationStack(),M).value||""),t.onceOnly&&0<this.state.VisitCountForContainer(t.choiceTarget)&&(n=!1),!n)return null;var a=new ht;return a.targetPath=t.pathOnChoice,a.sourcePath=t.path.toString(),a.isInvisibleDefault=t.isInvisibleDefault,a.threadAtGeneration=this.state.callStack.ForkThread(),a.text=(i+r).replace(/^[ \t]+|[ \t]+$/g,""),a}},{key:"IsTruthy",value:function(t){if(t instanceof D){var e=t;return e instanceof J?(this.Error("Shouldn't use a divert target (to "+e.targetPath+") as a conditional value. Did you intend a function call 'likeThis()' or a read count check 'likeThis'? (no arrows)"),!1):e.isTruthy}return!1}},{key:"PerformLogicAndFlowControl",value:function(t){if(null==t)return!1;if(t instanceof it){var e=t;if(e.isConditional){var n=this.state.PopEvaluationStack();if(!this.IsTruthy(n))return!0}if(e.hasVariableTarget){var i,r,a=e.variableDivertName,s=this.state.variablesState.GetVariableWithName(a);null==s?this.Error("Tried to divert using a target from a variable that could not be found ("+a+")"):s instanceof J||(r="Tried to divert to a target from a variable, but the variable ("+a+") didn't contain a divert target, it ",(i=_(s,G))instanceof G&&0==i.value?r+="was empty/null (the value 0).":r+="contained '"+s+"'.",this.Error(r));var o=T(s,J);this.state.divertedPointer=this.PointerAtPath(o.targetPath)}else{if(e.isExternal)return this.CallExternalFunction(e.targetPathString,e.externalArgs),!0;this.state.divertedPointer=e.targetPointer.copy()}return e.pushesToStack&&this.state.callStack.Push(e.stackPushType,void 0,this.state.outputStream.length),this.state.divertedPointer.isNull&&!e.isExternal&&(e&&e.debugMetadata&&null!=e.debugMetadata.sourceName?this.Error("Divert target doesn't exist: "+e.debugMetadata.sourceName):this.Error("Divert resolution failed: "+e)),!0}if(t instanceof et){var u,l,h=t;switch(h.commandType){case et.CommandType.EvalStart:this.Assert(!1===this.state.inExpressionEvaluation,"Already in expression evaluation?"),this.state.inExpressionEvaluation=!0;break;case et.CommandType.EvalEnd:this.Assert(!0===this.state.inExpressionEvaluation,"Not in expression evaluation mode"),this.state.inExpressionEvaluation=!1;break;case et.CommandType.EvalOutput:0<this.state.evaluationStack.length&&((u=this.state.PopEvaluationStack())instanceof ot||(l=new M(u.toString()),this.state.PushToOutputStream(l)));break;case et.CommandType.NoOp:break;case et.CommandType.Duplicate:this.state.PushEvaluationStack(this.state.PeekEvaluationStack());break;case et.CommandType.PopEvaluatedValue:this.state.PopEvaluationStack();break;case et.CommandType.PopFunction:case et.CommandType.PopTunnel:var c,f,v,d,p=h.commandType==et.CommandType.PopFunction?Q.Function:Q.Tunnel,m=null;if(p!=Q.Tunnel||null===(m=_(c=this.state.PopEvaluationStack(),J))&&this.Assert(c instanceof ot,"Expected void if ->-> doesn't override target"),this.state.TryExitFunctionEvaluationFromGame())break;this.state.callStack.currentElement.type==p&&this.state.callStack.canPop?(this.state.PopCallStack(),m&&(this.state.divertedPointer=this.PointerAtPath(m.targetPath))):((f=new Map).set(Q.Function,"function return statement (~ return)"),f.set(Q.Tunnel,"tunnel onwards statement (->->)"),v=f.get(this.state.callStack.currentElement.type),this.state.callStack.canPop||(v="end of flow (-> END or choice)"),d="Found "+f.get(p)+", when expected "+v,this.Error(d));break;case et.CommandType.BeginString:this.state.PushToOutputStream(h),this.Assert(!0===this.state.inExpressionEvaluation,"Expected to be in an expression when evaluating a string"),this.state.inExpressionEvaluation=!1;break;case et.CommandType.EndString:for(var g=[],S=0,k=this.state.outputStream.length-1;0<=k;--k){var C=this.state.outputStream[k];S++;var b=_(C,et);if(b&&b.commandType==et.CommandType.BeginString)break;C instanceof M&&g.push(C)}this.state.PopFromOutputStream(S),g=g.reverse();var w,P=new x,O=y(g);try{for(O.s();!(w=O.n()).done;){var E=w.value;P.Append(E.toString())}}catch(t){O.e(t)}finally{O.f()}this.state.inExpressionEvaluation=!0,this.state.PushEvaluationStack(new M(P.toString()));break;case et.CommandType.ChoiceCount:var A=this.state.generatedChoices.length;this.state.PushEvaluationStack(new G(A));break;case et.CommandType.Turns:this.state.PushEvaluationStack(new G(this.state.currentTurnIndex+1));break;case et.CommandType.TurnsSince:case et.CommandType.ReadCount:var V=this.state.PopEvaluationStack();if(!(V instanceof J)){var R=V instanceof G?". Did you accidentally pass a read count ('knot_name') instead of a target ('-> knot_name')?":"";this.Error("TURNS_SINCE / READ_COUNT expected a divert target (knot, stitch, label name), but saw "+V+R);break}var j,L=T(V,J),B=_(this.ContentAtPath(L.targetPath).correctObj,H);null!=B?j=h.commandType==et.CommandType.TurnsSince?this.state.TurnsSinceForContainer(B):this.state.VisitCountForContainer(B):(j=h.commandType==et.CommandType.TurnsSince?-1:0,this.Warning("Failed to find container for "+h.toString()+" lookup at "+L.targetPath.toString())),this.state.PushEvaluationStack(new G(j));break;case et.CommandType.Random:var q=_(this.state.PopEvaluationStack(),G),U=_(this.state.PopEvaluationStack(),G);if(null==U||U instanceof G==0)return this.Error("Invalid value for minimum parameter of RANDOM(min, max)");if(null==q||U instanceof G==0)return this.Error("Invalid value for maximum parameter of RANDOM(min, max)");if(null===q.value)return N("maxInt.value");if(null===U.value)return N("minInt.value");var $=q.value-U.value+1;$<=0&&this.Error("RANDOM was called with minimum as "+U.value+" and maximum as "+q.value+". The maximum must be larger");var z=this.state.storySeed+this.state.previousRandom,X=new yt(z).next(),Y=X%$+U.value;this.state.PushEvaluationStack(new G(Y)),this.state.previousRandom=X;break;case et.CommandType.SeedRandom:var Z=_(this.state.PopEvaluationStack(),G);if(null==Z||Z instanceof G==0)return this.Error("Invalid value passed to SEED_RANDOM");if(null===Z.value)return N("minInt.value");this.state.storySeed=Z.value,this.state.previousRandom=0,this.state.PushEvaluationStack(new ot);break;case et.CommandType.VisitIndex:var tt=this.state.VisitCountForContainer(this.state.currentPointer.container)-1;this.state.PushEvaluationStack(new G(tt));break;case et.CommandType.SequenceShuffleIndex:var rt=this.NextSequenceShuffleIndex();this.state.PushEvaluationStack(new G(rt));break;case et.CommandType.StartThread:break;case et.CommandType.Done:this.state.callStack.canPopThread?this.state.callStack.PopThread():(this.state.didSafeExit=!0,this.state.currentPointer=nt.Null);break;case et.CommandType.End:this.state.ForceEnd();break;case et.CommandType.ListFromInt:var lt=_(this.state.PopEvaluationStack(),G),ht=T(this.state.PopEvaluationStack(),M);if(null===lt)throw new F("Passed non-integer when creating a list element from a numerical value.");var ct=null;if(null===this.listDefinitions)return N("this.listDefinitions");var ft=this.listDefinitions.TryListGetDefinition(ht.value,null);if(!ft.exists)throw new F("Failed to find LIST called "+ht.value);if(null===lt.value)return N("minInt.value");var vt=ft.result.TryGetItemWithValue(lt.value,I.Null);vt.exists&&(ct=new K(vt.result,lt.value)),null==ct&&(ct=new K),this.state.PushEvaluationStack(ct);break;case et.CommandType.ListRange:var dt=_(this.state.PopEvaluationStack(),D),pt=_(this.state.PopEvaluationStack(),D),mt=_(this.state.PopEvaluationStack(),K);if(null===mt||null===pt||null===dt)throw new F("Expected list, minimum and maximum for LIST_RANGE");if(null===mt.value)return N("targetList.value");var gt=mt.value.ListWithSubRange(pt.valueObject,dt.valueObject);this.state.PushEvaluationStack(new K(gt));break;case et.CommandType.ListRandom:var St=this.state.PopEvaluationStack();if(null===St)throw new F("Expected list for LIST_RANDOM");var kt=St.value,Ct=null;if(null===kt)throw N("list");if(0==kt.Count)Ct=new W;else{for(var bt=this.state.storySeed+this.state.previousRandom,_t=new yt(bt).next(),Tt=_t%kt.Count,wt=kt.entries(),Pt=0;Pt<=Tt-1;Pt++)wt.next();var Ot=wt.next().value,Et={Key:I.fromSerializedKey(Ot[0]),Value:Ot[1]};if(null===Et.Key.originName)return N("randomItem.Key.originName");(Ct=new W(Et.Key.originName,this)).Add(Et.Key,Et.Value),this.state.previousRandom=_t}this.state.PushEvaluationStack(new K(Ct));break;default:this.Error("unhandled ControlCommand: "+h)}return!0}if(t instanceof st){var Nt=t,At=this.state.PopEvaluationStack();return this.state.variablesState.Assign(Nt,At),!0}if(t instanceof at){var xt,It,Wt=t,Ft=null;return null!=Wt.pathForCount?(xt=Wt.containerForCount,It=this.state.VisitCountForContainer(xt),Ft=new G(It)):null==(Ft=this.state.variablesState.GetVariableWithName(Wt.name))&&(this.Warning("Variable not found: '"+Wt.name+"'. Using default value of 0 (false). This can happen with temporary variables if the declaration hasn't yet been hit. Globals are always given a default value on load if a value doesn't exist in the save state."),Ft=new G(0)),this.state.PushEvaluationStack(Ft),!0}if(t instanceof ut){var Vt=t,Rt=this.state.PopEvaluationStack(Vt.numberOfParameters),jt=Vt.Call(Rt);return this.state.PushEvaluationStack(jt),!0}return!1}},{key:"ChoosePathString",value:function(t,e,n){var i=!(1<arguments.length&&void 0!==e)||e,r=2<arguments.length&&void 0!==n?n:[];if(this.IfAsyncWeCant("call ChoosePathString right now"),i)this.ResetCallstack();else if(this.state.callStack.currentElement.type==Q.Function){var a="",s=this.state.callStack.currentElement.currentPointer.container;throw null!=s&&(a="("+s.path.toString()+") "),new Error("Story was running a function "+a+"when you called ChoosePathString("+t+") - this is almost certainly not not what you want! Full stack trace: \n"+this.state.callStack.callStackTrace)}this.state.PassArgumentsToEvaluationStack(r),this.ChoosePath(new C(t))}},{key:"IfAsyncWeCant",value:function(t){if(this._asyncContinueActive)throw new Error("Can't "+t+". Story is in the middle of a ContinueAsync(). Make more ContinueAsync() calls or a single Continue() call beforehand.")}},{key:"ChoosePath",value:function(t,e){var n=!(1<arguments.length&&void 0!==e)||e;this.state.SetChosenPath(t,n),this.VisitChangedContainersDueToDivert()}},{key:"ChooseChoiceIndex",value:function(t){t=t;var e=this.currentChoices;this.Assert(0<=t&&t<e.length,"choice out of range");var n=e[t];return null===n.threadAtGeneration?N("choiceToChoose.threadAtGeneration"):null===n.targetPath?N("choiceToChoose.targetPath"):(this.state.callStack.currentThread=n.threadAtGeneration,void this.ChoosePath(n.targetPath))}},{key:"HasFunction",value:function(t){try{return null!=this.KnotContainerWithName(t)}catch(t){return!1}}},{key:"EvaluateFunction",value:function(t,e,n){var i=1<arguments.length&&void 0!==e?e:[],r=2<arguments.length&&void 0!==n&&n;if(this.IfAsyncWeCant("evaluate a function"),null==t)throw new Error("Function is null");if(""==t||""==t.trim())throw new Error("Function is empty or white space.");var a=this.KnotContainerWithName(t);if(null==a)throw new Error("Function doesn't exist: '"+t+"'");var s=[];s.push.apply(s,this.state.outputStream),this._state.ResetOutput(),this.state.StartFunctionEvaluationFromGame(a,i);for(var o=new x;this.canContinue;)o.Append(this.Continue());var u=o.toString();this._state.ResetOutput(s);var l=this.state.CompleteFunctionEvaluationFromGame();return r?{returned:l,output:u}:l}},{key:"EvaluateExpression",value:function(t){var e=this.state.callStack.elements.length;this.state.callStack.Push(Q.Tunnel),this._temporaryEvaluationContainer=t,this.state.GoToStart();var n=this.state.evaluationStack.length;return this.Continue(),this._temporaryEvaluationContainer=null,this.state.callStack.elements.length>e&&this.state.PopCallStack(),n<this.state.evaluationStack.length?this.state.PopEvaluationStack():null}},{key:"CallExternalFunction",value:function(t,n){if(null===t)return N("funcName");var i=this._externals.get(t),r=null;if(void 0===i){if(this.allowExternalFunctionFallbacks)return r=this.KnotContainerWithName(t),this.Assert(null!==r,"Trying to call EXTERNAL function '"+t+"' which has not been bound, and fallback ink function could not be found."),this.state.callStack.Push(Q.Function,void 0,this.state.outputStream.length),void(this.state.divertedPointer=nt.StartOf(r));this.Assert(!1,"Trying to call EXTERNAL function '"+t+"' which has not been bound (and ink fallbacks disabled).")}for(var a=[],s=0;s<n;++s){var o=T(this.state.PopEvaluationStack(),D).valueObject;a.push(o)}a.reverse();var u=i(a),l=null;null!=u?(l=D.Create(u),this.Assert(null!==l,"Could not create ink value from returned object of type "+e(u))):l=new ot,this.state.PushEvaluationStack(l)}},{key:"BindExternalFunctionGeneral",value:function(t,e){this.IfAsyncWeCant("bind an external function"),this.Assert(!this._externals.has(t),"Function '"+t+"' has already been bound."),this._externals.set(t,e)}},{key:"TryCoerce",value:function(t){return t}},{key:"BindExternalFunction",value:function(t,e){var n=this;this.Assert(null!=e,"Can't bind a null function"),this.BindExternalFunctionGeneral(t,(function(t){n.Assert(t.length>=e.length,"External function expected "+e.length+" arguments");for(var i=[],r=0,a=t.length;r<a;r++)i[r]=n.TryCoerce(t[r]);return e.apply(null,i)}))}},{key:"UnbindExternalFunction",value:function(t){this.IfAsyncWeCant("unbind an external a function"),this.Assert(this._externals.has(t),"Function '"+t+"' has not been bound."),this._externals.delete(t)}},{key:"ValidateExternalBindings",value:function(t,e){var n,i=null,r=null,a=e||new Set;if(t instanceof H&&(i=t),t instanceof A&&(r=t),null===i&&null===r)this.ValidateExternalBindings(this._mainContentContainer,a),this._hasValidatedExternals=!0,0==a.size?this._hasValidatedExternals=!0:(n="Error: Missing function binding for external",n+=1<a.size?"s":"",n+=": '",n+=Array.from(a).join("', '"),n+="' ",n+=this.allowExternalFunctionFallbacks?", and no fallback ink function found.":" (ink fallbacks disabled)",this.Error(n));else if(null!=i){var s,o=y(i.content);try{for(o.s();!(s=o.n()).done;){var u=s.value;null!=u&&u.hasValidName||this.ValidateExternalBindings(u,a)}}catch(t){o.e(t)}finally{o.f()}var l,h=y(i.namedContent);try{for(h.s();!(l=h.n()).done;){var c=v(l.value,2)[1];this.ValidateExternalBindings(_(c,A),a)}}catch(t){h.e(t)}finally{h.f()}}else if(null!=r){var f=_(r,it);if(f&&f.isExternal){var d=f.targetPathString;if(null===d)return N("name");this._externals.has(d)||this.allowExternalFunctionFallbacks&&this.mainContentContainer.namedContent.has(d)||a.add(d)}}}},{key:"ObserveVariable",value:function(t,e){if(this.IfAsyncWeCant("observe a new variable"),null===this._variableObservers&&(this._variableObservers=new Map),!this.state.variablesState.GlobalVariableExistsWithName(t))throw new F("Cannot observe variable '"+t+"' because it wasn't declared in the ink story.");this._variableObservers.has(t)?this._variableObservers.get(t).push(e):this._variableObservers.set(t,[e])}},{key:"ObserveVariables",value:function(t,e){for(var n=0,i=t.length;n<i;n++)this.ObserveVariable(t[n],e[n])}},{key:"RemoveVariableObserver",value:function(t,e){var n;if(this.IfAsyncWeCant("remove a variable observer"),null!==this._variableObservers)if(void 0!==e)this._variableObservers.has(e)&&(n=this._variableObservers.get(e),null!==t?n.splice(n.indexOf(t),1):this._variableObservers.delete(e));else if(null!==t){var i,r=y(this._variableObservers.keys());try{for(r.s();!(i=r.n()).done;){var a=i.value,s=this._variableObservers.get(a);s.splice(s.indexOf(t),1)}}catch(t){r.e(t)}finally{r.f()}}}},{key:"VariableStateDidChangeEvent",value:function(t,e){if(null!==this._variableObservers){var n=this._variableObservers.get(t);if(void 0!==n){if(!(e instanceof D))throw new Error("Tried to get the value of a variable that isn't a standard type");var i,r=T(e,D),a=y(n);try{for(a.s();!(i=a.n()).done;)(0,i.value)(t,r.valueObject)}catch(t){a.e(t)}finally{a.f()}}}}},{key:"TagsForContentAtPath",value:function(t){return this.TagsAtStartOfFlowContainerWithPathString(t)}},{key:"TagsAtStartOfFlowContainerWithPathString",value:function(t){var e=new C(t),n=this.ContentAtPath(e).container;if(null===n)return N("flowContainer");for(;;){var i=n.content[0];if(!(i instanceof H))break;n=i}var r,a=null,s=y(n.content);try{for(s.s();!(r=s.n()).done;){var o=_(r.value,lt);if(!o)break;null==a&&(a=[]),a.push(o.text)}}catch(t){s.e(t)}finally{s.f()}return a}},{key:"BuildStringOfHierarchy",value:function(){var t=new x;return this.mainContentContainer.BuildStringOfHierarchy(t,0,this.state.currentPointer.Resolve()),t.toString()}},{key:"BuildStringOfContainer",value:function(t){var e=new x;return t.BuildStringOfHierarchy(e,0,this.state.currentPointer.Resolve()),e.toString()}},{key:"NextContent",value:function(){var t;this.state.previousPointer=this.state.currentPointer.copy(),(this.state.divertedPointer.isNull||(this.state.currentPointer=this.state.divertedPointer.copy(),this.state.divertedPointer=nt.Null,this.VisitChangedContainersDueToDivert(),this.state.currentPointer.isNull))&&(this.IncrementContentPointer()||(t=!1,this.state.callStack.CanPop(Q.Function)?(this.state.PopCallStack(Q.Function),this.state.inExpressionEvaluation&&this.state.PushEvaluationStack(new ot),t=!0):this.state.callStack.canPopThread?(this.state.callStack.PopThread(),t=!0):this.state.TryExitFunctionEvaluationFromGame(),t&&!this.state.currentPointer.isNull&&this.NextContent()))}},{key:"IncrementContentPointer",value:function(){var t=!0,e=this.state.callStack.currentElement.currentPointer.copy();if(e.index++,null===e.container)return N("pointer.container");for(;e.index>=e.container.content.length;){t=!1;var n=_(e.container.parent,H);if(n instanceof H==0)break;var i=n.content.indexOf(e.container);if(-1==i)break;if((e=new nt(n,i)).index++,t=!0,null===e.container)return N("pointer.container")}return t||(e=nt.Null),this.state.callStack.currentElement.currentPointer=e.copy(),t}},{key:"TryFollowDefaultInvisibleChoice",value:function(){var t=this._state.currentChoices,e=t.filter((function(t){return t.isInvisibleDefault}));if(0==e.length||t.length>e.length)return!1;var n=e[0];return null===n.targetPath?N("choice.targetPath"):null===n.threadAtGeneration?N("choice.threadAtGeneration"):(this.state.callStack.currentThread=n.threadAtGeneration,this.ChoosePath(n.targetPath,!1),!0)}},{key:"NextSequenceShuffleIndex",value:function(){var t=_(this.state.PopEvaluationStack(),G);if(!(t instanceof G))return this.Error("expected number of elements in sequence for shuffle index"),0;var e=this.state.currentPointer.container;if(null===e)return N("seqContainer");if(null===t.value)return N("numElementsIntVal.value");var n=t.value,i=T(this.state.PopEvaluationStack(),G).value;if(null===i)return N("seqCount");for(var r=i/n,a=i%n,s=e.path.toString(),o=0,u=0,l=s.length;u<l;u++)o+=s.charCodeAt(u)||0;for(var h=o+r+this.state.storySeed,c=new yt(Math.floor(h)),f=[],v=0;v<n;++v)f.push(v);for(var d=0;d<=a;++d){var p=c.next()%f.length,y=f[p];if(f.splice(p,1),d==a)return y}throw new Error("Should never reach here")}},{key:"Error",value:function(t,e){var n=1<arguments.length&&void 0!==e&&e,i=new F(t);throw i.useEndLineNumber=n,i}},{key:"Warning",value:function(t){this.AddError(t,!0)}},{key:"AddError",value:function(t,e,n){var i,r=1<arguments.length&&void 0!==e&&e,a=2<arguments.length&&void 0!==n&&n,s=this.currentDebugMetadata,o=r?"WARNING":"ERROR";t=null!=s?(i=a?s.endLineNumber:s.startLineNumber,"RUNTIME "+o+": '"+s.fileName+"' line "+i+": "+t):this.state.currentPointer.isNull?"RUNTIME "+o+": "+t:"RUNTIME "+o+": ("+this.state.currentPointer+"): "+t,this.state.AddError(t,r),r||this.state.ForceEnd()}},{key:"Assert",value:function(t,e){var n=1<arguments.length&&void 0!==e?e:null;if(0==t)throw null==n&&(n="Story assert"),new Error(n+" "+this.currentDebugMetadata)}},{key:"currentChoices",get:function(){var t=[];if(null===this._state)return N("this._state");var e,n=y(this._state.currentChoices);try{for(n.s();!(e=n.n()).done;){var i=e.value;i.isInvisibleDefault||(i.index=t.length,t.push(i))}}catch(t){n.e(t)}finally{n.f()}return t}},{key:"currentText",get:function(){return this.IfAsyncWeCant("call currentText since it's a work in progress"),this.state.currentText}},{key:"currentTags",get:function(){return this.IfAsyncWeCant("call currentTags since it's a work in progress"),this.state.currentTags}},{key:"currentErrors",get:function(){return this.state.currentErrors}},{key:"currentWarnings",get:function(){return this.state.currentWarnings}},{key:"hasError",get:function(){return this.state.hasError}},{key:"hasWarning",get:function(){return this.state.hasWarning}},{key:"variablesState",get:function(){return this.state.variablesState}},{key:"listDefinitions",get:function(){return this._listDefinitions}},{key:"state",get:function(){return this._state}},{key:"canContinue",get:function(){return this.state.canContinue}},{key:"asyncContinueComplete",get:function(){return!this._asyncContinueActive}},{key:"globalTags",get:function(){return this.TagsAtStartOfFlowContainerWithPathString("")}},{key:"currentDebugMetadata",get:function(){var t=this.state.currentPointer;if(!t.isNull&&null!==t.Resolve()&&null!==(n=t.Resolve().debugMetadata))return n;for(var e=this.state.callStack.elements.length-1;0<=e;--e)if(!(t=this.state.callStack.elements[e].currentPointer).isNull&&null!==t.Resolve()&&null!==(n=t.Resolve().debugMetadata))return n;for(var n,i=this.state.outputStream.length-1;0<=i;--i)if(null!==(n=this.state.outputStream[i].debugMetadata))return n;return null}},{key:"mainContentContainer",get:function(){return this._temporaryEvaluationContainer?this._temporaryEvaluationContainer:this._mainContentContainer}}]),i}(),t.Story.inkVersionCurrent=19,St=t.Story||(t.Story={}),(kt=St.OutputStateChange||(St.OutputStateChange={}))[kt.NoChange=0]="NoChange",kt[kt.ExtendedBeyondNewline=1]="ExtendedBeyondNewline",kt[kt.NewlineRemoved=2]="NewlineRemoved",t.InkList=W,Object.defineProperty(t,"__esModule",{value:!0})}(e)}},e={};function n(i){if(e[i])return e[i].exports;var r=e[i]={exports:{}};return t[i].call(r.exports,r,r.exports,n),r.exports}return n.d=(t,e)=>{for(var i in e)n.o(e,i)&&!n.o(t,i)&&Object.defineProperty(t,i,{enumerable:!0,get:e[i]})},n.o=(t,e)=>Object.prototype.hasOwnProperty.call(t,e),n.r=t=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(t,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(t,"__esModule",{value:!0})},n(914)})()}));
//# sourceMappingURL=atrament.js.map